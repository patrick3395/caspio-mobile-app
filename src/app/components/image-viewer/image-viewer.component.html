<div class="image-viewer-wrapper">
  <!-- Fixed Header with proper positioning -->
  <div class="viewer-header">
    <div class="header-content">
      <!-- Left side navigation -->
      <div class="header-left">
        <ion-button 
          fill="clear" 
          (click)="previousImage()" 
          [disabled]="!hasPrevious()" 
          class="nav-btn">
          <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
      
      <!-- Center title -->
      <div class="header-center">
        <div class="document-title">{{ getCurrentTitle() }}</div>
        <div class="image-counter" *ngIf="hasMultipleImages()">
          {{ currentIndex + 1 }} / {{ getAllImages().length }}
        </div>
      </div>
      
      <!-- Right side actions -->
      <div class="header-right">
        <ion-button 
          fill="clear" 
          (click)="nextImage()" 
          [disabled]="!hasNext()" 
          class="nav-btn">
          <ion-icon name="chevron-forward" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button 
          fill="clear" 
          (click)="dismiss()" 
          class="close-btn">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="viewer-content">
    <!-- Annotation Toolbar (only when editing) -->
    <div class="annotation-bar" *ngIf="isAnnotating">
      <div class="annotation-tools-wrapper">
        <div class="tool-group">
          <button 
            [class.active]="annotationTool === 'pen'"
            (click)="selectTool('pen')"
            class="tool-btn">
            <ion-icon name="pencil"></ion-icon>
          </button>
          <button 
            [class.active]="annotationTool === 'arrow'"
            (click)="selectTool('arrow')"
            class="tool-btn">
            <ion-icon name="arrow-forward"></ion-icon>
          </button>
          <button 
            [class.active]="annotationTool === 'rectangle'"
            (click)="selectTool('rectangle')"
            class="tool-btn">
            <ion-icon name="square-outline"></ion-icon>
          </button>
          <button 
            [class.active]="annotationTool === 'circle'"
            (click)="selectTool('circle')"
            class="tool-btn">
            <ion-icon name="ellipse-outline"></ion-icon>
          </button>
          <button 
            [class.active]="annotationTool === 'text'"
            (click)="selectTool('text')"
            class="tool-btn">
            <ion-icon name="text"></ion-icon>
          </button>
        </div>
        
        <div class="tool-divider"></div>
        
        <div class="tool-group">
          <input 
            type="color" 
            [(ngModel)]="annotationColor" 
            class="color-input">
          <input 
            type="range" 
            min="1" 
            max="10" 
            [(ngModel)]="lineWidth" 
            class="width-slider">
        </div>
        
        <div class="tool-divider"></div>
        
        <div class="tool-group">
          <button 
            (click)="undoAnnotation()"
            [disabled]="!canUndo()"
            class="tool-btn">
            <ion-icon name="arrow-undo"></ion-icon>
          </button>
          <button 
            (click)="clearAnnotations()"
            class="tool-btn">
            <ion-icon name="trash-outline"></ion-icon>
          </button>
          <button 
            (click)="saveAnnotatedImage()"
            class="tool-btn save-btn">
            <ion-icon name="checkmark"></ion-icon>
            Save
          </button>
        </div>
      </div>
    </div>
    
    <!-- Image Display Area -->
    <div class="image-container" [class.editing]="isAnnotating">
      <div class="image-wrapper" #imageWrapper>
        <img 
          [src]="getCurrentImageUrl()" 
          [alt]="getCurrentTitle()" 
          class="displayed-image"
          #mainImage
          (load)="onImageLoad()"
          (error)="onImageError()">
        
        <!-- Canvas overlay for annotations -->
        <canvas 
          #annotationCanvas
          class="annotation-layer"
          *ngIf="isAnnotating"
          (mousedown)="startDrawing($event)"
          (mousemove)="draw($event)"
          (mouseup)="stopDrawing($event)"
          (mouseleave)="stopDrawing($event)"
          (touchstart)="handleTouchStart($event)"
          (touchmove)="handleTouchMove($event)"
          (touchend)="handleTouchEnd($event)">
        </canvas>
      </div>
      
      <!-- Loading indicator -->
      <div class="loading-indicator" *ngIf="imageLoading">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading image...</p>
      </div>
      
      <!-- Error state -->
      <div class="error-state" *ngIf="imageError">
        <ion-icon name="image-outline" class="error-icon"></ion-icon>
        <p>Unable to load image</p>
        <button (click)="retryImageLoad()" class="retry-btn">
          <ion-icon name="refresh"></ion-icon>
          Retry
        </button>
      </div>
    </div>
    
    <!-- Thumbnail Strip -->
    <div class="thumbnail-strip" *ngIf="hasMultipleImages() && !isAnnotating">
      <div class="thumbnails-wrapper">
        <div 
          *ngFor="let img of getAllImages(); let i = index" 
          class="thumbnail"
          [class.active]="i === currentIndex"
          (click)="selectImage(i)">
          <img [src]="img.url" [alt]="img.title">
          <span class="thumb-number">{{ i + 1 }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Action Bar -->
  <div class="action-bar">
    <div class="file-info">
      <ion-icon name="document-outline"></ion-icon>
      <span>{{ getCurrentFilename() }}</span>
    </div>
    
    <div class="action-buttons">
      <button 
        (click)="toggleAnnotation()" 
        class="action-btn"
        [class.active]="isAnnotating">
        <ion-icon name="create-outline"></ion-icon>
      </button>
      <button 
        (click)="downloadImage()" 
        class="action-btn">
        <ion-icon name="download-outline"></ion-icon>
      </button>
      <button 
        (click)="toggleFullscreen()" 
        class="action-btn">
        <ion-icon [name]="isFullscreen ? 'contract-outline' : 'expand-outline'"></ion-icon>
      </button>
    </div>
  </div>
</div>