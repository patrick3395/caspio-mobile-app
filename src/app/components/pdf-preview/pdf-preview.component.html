<ion-header>
  <ion-toolbar style="--background: #F15A27;">
    <ion-title style="color: white;">PDF Report Preview</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="generatePDF()" fill="clear" style="color: white;">
        <ion-icon name="download-outline" slot="start"></ion-icon>
        Generate PDF
      </ion-button>
      <ion-button (click)="dismiss()" fill="clear" style="color: white;">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="pdf-preview-content">
  <div class="pdf-container">
    <!-- Cover Page Preview -->
    <div class="pdf-page cover-page">
      <div class="company-header">
        <h1>NOBLE PROPERTY INSPECTIONS</h1>
        <div class="company-contact">
          <p>936-202-8013 | info@noblepropertyinspections.com</p>
          <p>www.noblepropertyinspections.com</p>
        </div>
      </div>
      
      <div class="report-title-section">
        <h2 class="report-title">{{ serviceData?.serviceName || 'SERVICE' }}</h2>
        <h2 class="report-subtitle">INSPECTION REPORT</h2>
      </div>
      
      <div class="property-photo-container">
        <img 
          [src]="getPrimaryPhotoUrl()" 
          alt="Property"
          (error)="handleImageError($event)"
          (load)="handleImageLoad($event)"
          [class.loading]="primaryPhotoLoading"
          class="property-photo" />
      </div>
      
      <div class="property-info-box">
        <h3 class="property-address">{{ projectData?.address || 'Property Address' }}</h3>
        <p class="property-location">{{ projectData?.city }}, {{ projectData?.state }} {{ projectData?.zip }}</p>
        
        <div class="client-info">
          <p><strong>Client:</strong> {{ projectData?.clientName || 'N/A' }}</p>
          <p><strong>Agent:</strong> {{ projectData?.agentName || 'N/A' }}</p>
          <p><strong>Inspection Date:</strong> {{ getFormattedDate(projectData?.inspectionDate) }}</p>
        </div>
      </div>
      
      <div class="inspector-footer">
        <p class="inspector-title">Inspected By:</p>
        <p class="inspector-name">{{ projectData?.inspectorName || 'N/A' }}</p>
        <p>{{ projectData?.companyName || 'Noble Property Inspections' }}</p>
        <p>{{ projectData?.inspectorEmail || 'info@noblepropertyinspections.com' }}</p>
      </div>
    </div>
    
    <!-- Executive Summary Page -->
    <div class="pdf-page content-page">
      <div class="page-header">
        <h2>EXECUTIVE SUMMARY</h2>
        <div class="header-line"></div>
      </div>
      
      <div class="page-content">
        <div class="summary-section">
          <p>This Engineers Foundation Evaluation Report provides a comprehensive assessment of the structural foundation systems for the property listed herein.</p>
          
          <p>The evaluation was conducted in accordance with professional engineering standards and includes detailed observations, measurements, and recommendations.</p>
          
          <h3>Key Areas of Assessment:</h3>
          <ul class="assessment-list">
            <li>Foundation type and condition assessment</li>
            <li>Structural systems evaluation including comments, limitations, and deficiencies</li>
            <li>Detailed elevation plot measurements for all inspected areas</li>
            <li>Photographic documentation of findings</li>
            <li>Professional recommendations for maintenance or repairs</li>
          </ul>
          
          <div class="summary-stats">
            <h3>Inspection Summary:</h3>
            <div class="stat-grid">
              <div class="stat-item">
                <span class="stat-label">Areas Inspected:</span>
                <span class="stat-value">{{ structuralData?.length || 0 }} categories</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Rooms Evaluated:</span>
                <span class="stat-value">{{ elevationData?.length || 0 }} rooms</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Visual Findings:</span>
                <span class="stat-value">{{ countVisualFindings() }} items</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Photos Included:</span>
                <span class="stat-value">{{ countTotalPhotos() }} records</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Table of Contents Page -->
    <div class="pdf-page content-page">
      <div class="page-header">
        <h2>TABLE OF CONTENTS</h2>
        <div class="header-line"></div>
      </div>
      
      <div class="page-content">
        <div class="toc-container">
          <div class="toc-item">
            <span class="toc-title">1. Executive Summary</span>
            <span class="toc-dots"></span>
            <span class="toc-page">2</span>
          </div>
          <div class="toc-item">
            <span class="toc-title">2. Project Information</span>
            <span class="toc-dots"></span>
            <span class="toc-page">4</span>
          </div>
          <div class="toc-item">
            <span class="toc-title">3. Service Details</span>
            <span class="toc-dots"></span>
            <span class="toc-page">5</span>
          </div>
          <div class="toc-item" *ngFor="let category of structuralData; let i = index">
            <span class="toc-title">{{ 4 + i }}. {{ category.name }}</span>
            <span class="toc-dots"></span>
            <span class="toc-page">{{ 6 + i }}</span>
          </div>
          <div class="toc-item" *ngIf="hasElevationData">
            <span class="toc-title">{{ 4 + (structuralData?.length || 0) }}. Elevation Plot Data</span>
            <span class="toc-dots"></span>
            <span class="toc-page">{{ getElevationPageNumber() }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Project Information Page -->
    <div class="pdf-page content-page">
      <div class="page-header">
        <h2>PROJECT INFORMATION</h2>
        <div class="header-line"></div>
      </div>
      
      <div class="page-content">
        <div class="info-table">
          <div class="info-row">
            <div class="info-label">Project ID</div>
            <div class="info-value">{{ projectData?.projectId || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Property Address</div>
            <div class="info-value">{{ projectData?.fullAddress || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Client Name</div>
            <div class="info-value">{{ projectData?.clientName || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Agent Name</div>
            <div class="info-value">{{ projectData?.agentName || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Inspector Name</div>
            <div class="info-value">{{ projectData?.inspectorName || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Year Built</div>
            <div class="info-value">{{ projectData?.yearBuilt || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Square Feet</div>
            <div class="info-value">{{ projectData?.squareFeet || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Type of Building</div>
            <div class="info-value">{{ projectData?.typeOfBuilding || 'Single Family' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Building Style</div>
            <div class="info-value">{{ projectData?.style || 'N/A' }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Service Details Page -->
    <div class="pdf-page content-page">
      <div class="page-header">
        <h2>SERVICE & INSPECTION DETAILS</h2>
        <div class="header-line"></div>
      </div>
      
      <div class="page-content">
        <div class="info-table">
          <div class="info-row">
            <div class="info-label">Date of Inspection</div>
            <div class="info-value">{{ getFormattedDate(projectData?.inspectionDate) }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">In Attendance</div>
            <div class="info-value">{{ projectData?.inAttendance || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Weather Conditions</div>
            <div class="info-value">{{ projectData?.weatherConditions || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Outdoor Temperature</div>
            <div class="info-value">{{ projectData?.outdoorTemperature || 'N/A' }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Occupancy/Furnishings</div>
            <div class="info-value">{{ projectData?.occupancyFurnishings || 'N/A' }}</div>
          </div>
          <div class="info-row" *ngIf="projectData?.firstFoundationType">
            <div class="info-label">Primary Foundation Type</div>
            <div class="info-value">{{ projectData.firstFoundationType }}</div>
          </div>
          <div class="info-row" *ngIf="projectData?.secondFoundationType">
            <div class="info-label">Secondary Foundation Type</div>
            <div class="info-value">{{ projectData.secondFoundationType }}{{ projectData.secondFoundationRooms ? ' (' + projectData.secondFoundationRooms + ')' : '' }}</div>
          </div>
          <div class="info-row" *ngIf="projectData?.thirdFoundationType">
            <div class="info-label">Third Foundation Type</div>
            <div class="info-value">{{ projectData.thirdFoundationType }}{{ projectData.thirdFoundationRooms ? ' (' + projectData.thirdFoundationRooms + ')' : '' }}</div>
          </div>
          <div class="info-row" *ngIf="projectData?.ownerOccupantInterview">
            <div class="info-label">Owner/Occupant Interview</div>
            <div class="info-value">{{ projectData.ownerOccupantInterview }}</div>
          </div>
        </div>
        
        <div class="service-notes" *ngIf="serviceData?.Notes">
          <h3>Service Notes:</h3>
          <p>{{ serviceData.Notes }}</p>
        </div>
      </div>
    </div>
    
    <!-- Structural Systems Pages -->
    <div class="pdf-page content-page" *ngFor="let category of structuralData">
      <div class="page-header">
        <h2>{{ category.name | uppercase }}</h2>
        <div class="header-line"></div>
      </div>
      
      <div class="page-content">
        <!-- Comments Section -->
        <div class="visual-section" *ngIf="category.comments && category.comments.length > 0">
          <div class="section-header comments-header">
            <h3>COMMENTS</h3>
          </div>
          <div class="visual-items">
            <div class="visual-item" *ngFor="let item of category.comments">
              <div class="visual-item-header">
                <h4 class="visual-name">{{ item.name }}</h4>
              </div>
              <p class="visual-text" *ngIf="item.text">{{ item.text }}</p>
              <div class="photo-grid" *ngIf="item.photos && item.photos.length > 0">
                <div class="photo-item" *ngFor="let photo of item.photos">
                  <img 
                    [src]="getPhotoUrl(photo)" 
                    [alt]="photo.caption || 'Photo'"
                    (error)="handleImageError($event)"
                    (load)="handleImageLoad($event)"
                    class="loading" />
                  <p class="photo-caption" *ngIf="photo.caption">{{ photo.caption }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Limitations Section -->
        <div class="visual-section" *ngIf="category.limitations && category.limitations.length > 0">
          <div class="section-header limitations-header">
            <h3>LIMITATIONS</h3>
          </div>
          <div class="visual-items">
            <div class="visual-item" *ngFor="let item of category.limitations">
              <div class="visual-item-header">
                <h4 class="visual-name">{{ item.name }}</h4>
              </div>
              <p class="visual-text" *ngIf="item.text">{{ item.text }}</p>
              <div class="photo-grid" *ngIf="item.photos && item.photos.length > 0">
                <div class="photo-item" *ngFor="let photo of item.photos">
                  <img 
                    [src]="getPhotoUrl(photo)" 
                    [alt]="photo.caption || 'Photo'"
                    (error)="handleImageError($event)"
                    (load)="handleImageLoad($event)"
                    class="loading" />
                  <p class="photo-caption" *ngIf="photo.caption">{{ photo.caption }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Deficiencies Section -->
        <div class="visual-section" *ngIf="category.deficiencies && category.deficiencies.length > 0">
          <div class="section-header deficiencies-header">
            <h3>DEFICIENCIES</h3>
          </div>
          <div class="visual-items">
            <div class="visual-item" *ngFor="let item of category.deficiencies">
              <div class="visual-item-header">
                <h4 class="visual-name">{{ item.name }}</h4>
              </div>
              <p class="visual-text" *ngIf="item.text">{{ item.text }}</p>
              <div class="photo-grid" *ngIf="item.photos && item.photos.length > 0">
                <div class="photo-item" *ngFor="let photo of item.photos">
                  <img 
                    [src]="getPhotoUrl(photo)" 
                    [alt]="photo.caption || 'Photo'"
                    (error)="handleImageError($event)"
                    (load)="handleImageLoad($event)"
                    class="loading" />
                  <p class="photo-caption" *ngIf="photo.caption">{{ photo.caption }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Elevation Plot Pages -->
    <div class="pdf-page content-page elevation-plot-page" *ngIf="elevationData && elevationData.length > 0">
      <div class="page-header">
        <h2>ELEVATION PLOT DATA</h2>
        <div class="header-line"></div>
        <p class="section-subtitle">Foundation elevation measurements and observations</p>
      </div>
      
      <div class="page-content">
        <div class="elevation-summary" *ngIf="elevationData.length > 0">
          <div class="summary-stats">
            <div class="stat">
              <span class="stat-label">Total Rooms:</span>
              <span class="stat-value">{{ elevationData.length }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Total Measurements:</span>
              <span class="stat-value">{{ getTotalMeasurements() }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Photos Documented:</span>
              <span class="stat-value">{{ getTotalElevationPhotos() }}</span>
            </div>
          </div>
        </div>

        <div class="room-elevation-section" *ngFor="let room of elevationData; let i = index">
          <div class="room-elevation-header">
            <div class="room-number">Room {{ i + 1 }}</div>
            <h3 class="room-name">{{ room.name }}</h3>
            <div class="room-badge" *ngIf="room.fdf && room.fdf !== 'None'">
              FDF: {{ room.fdf }}
            </div>
          </div>
          
          <!-- Room Notes Section -->
          <div class="room-notes-section" *ngIf="room.notes">
            <div class="notes-label">
              <ion-icon name="document-text-outline"></ion-icon>
              Room Notes
            </div>
            <div class="notes-content">{{ room.notes }}</div>
          </div>
          
          <!-- Elevation Measurements Section -->
          <div class="measurements-section" *ngIf="room.points && room.points.length > 0">
            <h4 class="measurements-title">
              <ion-icon name="analytics-outline"></ion-icon>
              Elevation Measurements
            </h4>
            
            <div class="measurements-grid">
              <div class="measurement-card" *ngFor="let point of room.points">
                <div class="measurement-header">
                  <span class="point-name">{{ point.name }}</span>
                  <span class="point-value" [class.has-value]="point.value">
                    {{ point.value ? point.value + '"' : '--' }}
                  </span>
                </div>
                
                <!-- Point-specific photos if available -->
                <div class="point-photos" *ngIf="point.photos && point.photos.length > 0">
                  <div class="point-photo-grid">
                    <div class="point-photo-item" *ngFor="let photo of point.photos">
                      <img 
                        [src]="getPhotoUrl(photo)" 
                        [alt]="'Photo for ' + point.name"
                        (error)="handleImageError($event)"
                        (load)="handleImageLoad($event)"
                        class="loading" />
                      <p class="point-photo-caption" *ngIf="photo.annotation">
                        {{ photo.annotation }}
                      </p>
                    </div>
                  </div>
                </div>
                
                <!-- Photo indicator if photos exist but aren't displayed inline -->
                <div class="photo-indicator" *ngIf="!point.photos && point.photoCount > 0">
                  <ion-icon name="camera"></ion-icon>
                  <span>{{ point.photoCount }} photo{{ point.photoCount > 1 ? 's' : '' }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Room Photos Section -->
          <div class="room-photos-section" *ngIf="room.photos && room.photos.length > 0">
            <h4 class="photos-title">
              <ion-icon name="images-outline"></ion-icon>
              Room Documentation Photos
            </h4>
            <div class="room-photo-grid">
              <div class="room-photo-item" *ngFor="let photo of room.photos">
                <div class="photo-wrapper">
                  <img 
                    [src]="getPhotoUrl(photo)" 
                    [alt]="photo.caption || 'Room Photo'"
                    (error)="handleImageError($event)"
                    (load)="handleImageLoad($event)"
                    class="loading" />
                  <div class="photo-info" *ngIf="photo.pointName || photo.caption">
                    <span class="photo-point" *ngIf="photo.pointName">
                      {{ photo.pointName }}{{ photo.pointValue ? ': ' + photo.pointValue + '"' : '' }}
                    </span>
                    <span class="photo-annotation" *ngIf="photo.caption">
                      {{ photo.caption }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- No data message -->
          <div class="no-data-message" *ngIf="(!room.points || room.points.length === 0) && (!room.photos || room.photos.length === 0)">
            <ion-icon name="information-circle-outline"></ion-icon>
            <span>No elevation data recorded for this room</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>