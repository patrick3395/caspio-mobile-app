<ion-header class="page-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" fill="clear">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen="true">
  <!-- Loading state -->
  <div *ngIf="loading" class="project-skeleton">
    <ion-skeleton-text animated class="skeleton-hero"></ion-skeleton-text>
    <div class="skeleton-section" *ngFor="let _ of [0,1,2,3]">
      <ion-skeleton-text animated class="skeleton-title"></ion-skeleton-text>
      <div class="skeleton-row" *ngFor="let __ of [0,1,2]">
        <ion-skeleton-text animated class="skeleton-label"></ion-skeleton-text>
        <ion-skeleton-text animated class="skeleton-value"></ion-skeleton-text>
      </div>
    </div>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !loading" class="error-container">
    <ion-text color="danger">
      <h2>Project Not Found</h2>
      <p>The requested project could not be found.</p>
    </ion-text>
    <ion-button (click)="goBack()" color="primary">Back to Projects</ion-button>
  </div>

  <!-- Project details -->
  <div *ngIf="project && !loading && !error" class="project-container">
    <!-- Property Photo Header -->
    <div class="street-view-header" style="position: relative;">
      <img [src]="getPropertyPhotoUrl()" 
           alt="Property Photo"
           (error)="onPhotoError($event)">
      <!-- Replace Photo Button -->
      <ion-button class="replace-photo-btn"
                  fill="solid"
                  color="primary"
                  size="small"
                  *ngIf="!isReadOnly"
                  (click)="replacePhoto()"
                  style="position: absolute; bottom: 10px; right: 10px; z-index: 10;">
        <ion-icon name="camera" slot="start"></ion-icon>
        Replace Photo
      </ion-button>
      <!-- Read-only indicator overlaying the photo -->
      <div *ngIf="isReadOnly" class="read-only-banner">
        <div class="read-only-content">
          <ion-icon name="eye-outline"></ion-icon>
          <span>Project is not active</span>
        </div>
        <button class="reactivate-btn" (click)="addAdditionalService()">
          <ion-icon name="add-circle-outline"></ion-icon>
          Add Service
        </button>
      </div>
    </div>

    <!-- Project Information Section -->
    <div class="info-section">
      <h2 class="section-title">Project Information</h2>

      <!-- Mobile layout -->
      <div *ngIf="!platform.isWeb()">
        <!-- Company (admin view only) -->
        <div class="info-row" *ngIf="isCompanyOne && projectCompanyName">
          <span class="info-label">Company:</span>
          <span class="info-value company-name">{{ projectCompanyName }}</span>
        </div>
        <div class="info-row address-row">
          <span class="info-label">Address:</span>
          <span class="info-value">{{ project.Address || 'Not specified' }}, {{ getCityStateZip() }}</span>
          <button class="edit-address-btn-inline" (click)="openEditAddressModal()" title="Edit Address">
            <ion-icon name="create-outline"></ion-icon>
          </button>
        </div>
      </div>

      <!-- Web layout -->
      <div *ngIf="platform.isWeb()">
        <!-- Company (admin view only) -->
        <div class="info-row-single" *ngIf="isCompanyOne && projectCompanyName">
          <span class="info-label">Company:</span>
          <span class="info-value company-name">{{ projectCompanyName }}</span>
        </div>
        <div class="info-row-single address-row">
          <span class="info-label">Address:</span>
          <span class="info-value">{{ project.Address || 'Not specified' }}, {{ getCityStateZip() }}</span>
          <button class="edit-address-btn-inline" (click)="openEditAddressModal()" title="Edit Address">
            <ion-icon name="create-outline"></ion-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Deliverables Section -->
    <div class="info-section" *ngIf="showDeliverablesTable && getDeliverablesServices().length > 0">
      <h2 class="section-title">Deliverables</h2>

      <!-- Full Table (CompanyID = 1) -->
      <table class="deliverables-table" *ngIf="isCompanyOne">
        <tbody *ngFor="let service of getDeliverablesServices(); trackBy: trackTemplateService" class="deliverable-group">
          <!-- Service Header Row -->
          <tr class="deliverable-row service-row clickable" (click)="toggleDeliverableExpanded(service)">
            <td class="service-header" colspan="2">
              <div class="service-header-content">
                <div class="service-name-section">
                  <ion-icon [name]="isDeliverableExpanded(service) ? 'chevron-down' : 'chevron-forward'" class="expand-icon"></ion-icon>
                  <span *ngIf="service.typeShort">{{ service.typeShort }} - </span>{{ service.typeName }}
                  <span *ngIf="getServiceCount(service.offersId) > 1" class="instance-number">
                    #{{ getServiceInstanceNumber(service) }}
                  </span>
                </div>
              </div>
            </td>
          </tr>

          <!-- Status Row -->
          <tr class="deliverable-row field-row" *ngIf="isDeliverableExpanded(service)">
            <td class="field-label-cell">Status</td>
            <td class="field-value-cell">
              <select
                class="deliverable-select"
                [ngModel]="service.StatusID"
                (ngModelChange)="updateServiceStatus(service, $event)"
                [disabled]="isReadOnly">
                <option [ngValue]="null">Select status...</option>
                <option *ngFor="let status of statusOptions" [ngValue]="status.StatusID">
                  {{ status.Status_Admin }}
                </option>
              </select>
            </td>
          </tr>

          <!-- Deliverable Row -->
          <tr class="deliverable-row field-row" *ngIf="isDeliverableExpanded(service)">
            <td class="field-label-cell">Deliverable</td>
            <td class="field-value-cell deliverable-file-cell">
              <div class="file-upload-container">
                <!-- Action buttons when file exists -->
                <div *ngIf="hasDeliverable(service)" class="deliverable-actions">
                  <ion-button size="small" fill="clear" class="orange-icon" (click)="viewDeliverableFile(service)" title="View">
                    <ion-icon name="eye-outline"></ion-icon>
                  </ion-button>
                  <ion-button size="small" fill="clear" class="orange-icon" *ngIf="!isReadOnly" (click)="deleteDeliverableFile(service)" title="Delete">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>
                  <ion-button size="small" fill="clear" class="orange-icon" (click)="downloadDeliverableFile(service)" title="Download">
                    <ion-icon name="download-outline"></ion-icon>
                  </ion-button>
                </div>

                <!-- Upload button -->
                <div *ngIf="!isReadOnly">
                  <input
                    #deliverableFileInput
                    type="file"
                    style="display: none"
                    (change)="uploadDeliverableFile(service, $event)"
                    accept="*/*">
                  <ion-button size="small" fill="clear" class="orange-icon" (click)="deliverableFileInput.click()" title="Upload">
                    <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
                    Upload
                  </ion-button>
                </div>
              </div>
            </td>
          </tr>

          <!-- Notes to Engineer Row -->
          <tr class="deliverable-row field-row" *ngIf="isDeliverableExpanded(service)">
            <td class="field-label-cell">Notes to Engineer / Reviewer</td>
            <td class="field-value-cell">
              <textarea
                class="deliverable-textarea"
                [value]="service.EngNotes || ''"
                (blur)="updateDeliverableField(service, 'EngNotes', $any($event.target).value)"
                [disabled]="isReadOnly"
                [readonly]="isReadOnly"
                placeholder="Enter notes"
                rows="2"></textarea>
            </td>
          </tr>

          <!-- Notes to Inspector Row -->
          <tr class="deliverable-row field-row" *ngIf="isDeliverableExpanded(service)">
            <td class="field-label-cell">Notes to Inspector</td>
            <td class="field-value-cell">
              <textarea
                class="deliverable-textarea"
                [value]="service.InspectorNotes || ''"
                (blur)="updateDeliverableField(service, 'InspectorNotes', $any($event.target).value)"
                [disabled]="isReadOnly"
                [readonly]="isReadOnly"
                placeholder="Enter notes"
                rows="2"></textarea>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Reduced Table (Other Companies) -->
      <table class="deliverables-table" *ngIf="!isCompanyOne">
        <tbody *ngFor="let service of getDeliverablesServices(); trackBy: trackTemplateService" class="deliverable-group">
          <!-- Service Header Row -->
          <tr class="deliverable-row service-row clickable" (click)="toggleDeliverableExpanded(service)">
            <td class="service-header" colspan="2">
              <div class="service-header-content">
                <div class="service-name-section">
                  <ion-icon [name]="isDeliverableExpanded(service) ? 'chevron-down' : 'chevron-forward'" class="expand-icon"></ion-icon>
                  <span *ngIf="service.typeShort">{{ service.typeShort }} - </span>{{ service.typeName }}
                  <span *ngIf="getServiceCount(service.offersId) > 1" class="instance-number">
                    #{{ getServiceInstanceNumber(service) }}
                  </span>
                </div>
              </div>
            </td>
          </tr>

          <!-- Status Row (Client view - read-only display of Status_Client) -->
          <tr class="deliverable-row field-row" *ngIf="isDeliverableExpanded(service)">
            <td class="field-label-cell">Status</td>
            <td class="field-value-cell">
              <span class="status-display">{{ getStatusClientById(service.StatusID) || 'Pending' }}</span>
            </td>
          </tr>

          <!-- Deliverable Row -->
          <tr class="deliverable-row field-row" *ngIf="isDeliverableExpanded(service)">
            <td class="field-label-cell">Deliverable</td>
            <td class="field-value-cell deliverable-file-cell">
              <div class="file-upload-container">
                <!-- Action buttons when file exists -->
                <div *ngIf="hasDeliverable(service)" class="deliverable-actions">
                  <ion-button size="small" fill="clear" class="orange-icon" (click)="viewDeliverableFile(service)" title="View">
                    <ion-icon name="eye-outline"></ion-icon>
                  </ion-button>
                  <ion-button size="small" fill="clear" class="orange-icon" *ngIf="!isReadOnly" (click)="deleteDeliverableFile(service)" title="Delete">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>
                  <ion-button size="small" fill="clear" class="orange-icon" (click)="downloadDeliverableFile(service)" title="Download">
                    <ion-icon name="download-outline"></ion-icon>
                  </ion-button>
                </div>

                <!-- Upload button -->
                <div *ngIf="!isReadOnly">
                  <input
                    #deliverableFileInput2
                    type="file"
                    style="display: none"
                    (change)="uploadDeliverableFile(service, $event)"
                    accept="*/*">
                  <ion-button size="small" fill="clear" class="orange-icon" (click)="deliverableFileInput2.click()" title="Upload">
                    <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
                    Upload
                  </ion-button>
                </div>
              </div>
            </td>
          </tr>

          <!-- Notes to Inspector Row -->
          <tr class="deliverable-row field-row" *ngIf="isDeliverableExpanded(service)">
            <td class="field-label-cell">Notes to Inspector</td>
            <td class="field-value-cell">
              <textarea
                class="deliverable-textarea"
                [value]="service.InspectorNotes || ''"
                (blur)="updateDeliverableField(service, 'InspectorNotes', $any($event.target).value)"
                [disabled]="isReadOnly"
                [readonly]="isReadOnly"
                placeholder="Enter notes"
                rows="2"></textarea>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Service Selection Section -->
    <div class="info-section">
      <div class="section-header-with-total">
        <h2 class="section-title">Services</h2>
        <div *ngIf="selectedServices.length > 0" class="header-total-with-button">
          <div class="header-total">
            ${{ calculateServicesTotal() | number:'1.2-2' }}
          </div>

          <button class="pay-now-btn" (click)="openPaymentModal()" *ngIf="calculateServicesTotal() > 0 && !isReadOnly">
            <ion-icon name="card-outline"></ion-icon>
            Pay Now
          </button>

          <button class="pdf-btn" (click)="generateServicePDF(); $event.stopPropagation()" title="Generate PDF"
                  *ngIf="getServicesForTemplates().length > 0">
            <ion-icon name="document-text-outline"></ion-icon>
            <span class="btn-text">PDF</span>
          </button>

          <!-- Sync/Save Buttons (mobile only) -->
          <div class="sync-save-buttons" *ngIf="!isWeb">
            <button class="save-btn"
                    (click)="saveToCloud(); $event.stopPropagation()"
                    [disabled]="isSaving"
                    title="Push pending changes to cloud">
              <ion-icon [name]="isSaving ? 'sync' : 'cloud-upload-outline'"
                        [class.spinning]="isSaving"></ion-icon>
              <span class="btn-text">Save</span>
            </button>
          </div>
        </div>
      </div>
      <div class="section-divider"></div>
      
      <!-- Loading services -->
      <div *ngIf="loadingServices" class="services-loading">
        <ion-spinner name="crescent"></ion-spinner>
        <span>Loading services...</span>
      </div>
      
      <!-- Unified expandable services list -->
      <div *ngIf="!loadingServices" class="services-list">
        <div *ngFor="let offer of getSortedOffers(); trackBy: trackByOfferId"
             class="service-list-item"
             [class.has-selection]="isServiceSelected(offer.OffersID)">
          <!-- Service header row (always visible) -->
          <div class="service-header-row" 
               (click)="toggleServiceExpanded(offer)"
               [class.selected]="isServiceSelected(offer.OffersID)">
            <div class="service-name">
              {{ offer.TypeShort ? offer.TypeShort + ' - ' + offer.TypeName : (offer.TypeName || offer.Service_Name || offer.Description) }}
            </div>
            <div class="service-controls-inline" *ngIf="isServiceSelected(offer.OffersID) && !isReadOnly">
              <ion-button size="small" 
                          fill="clear"
                          (click)="removeOneServiceInstance(offer.OffersID, $event)"
                          [disabled]="updatingServices || getServiceCount(offer.OffersID) <= 0">
                <ion-icon name="remove-circle-outline"></ion-icon>
              </ion-button>
              <span class="count-display">{{ getServiceCount(offer.OffersID) }}</span>
              <ion-button size="small" 
                          fill="clear"
                          (click)="duplicateService(offer.OffersID, offer.TypeName, $event)"
                          [disabled]="updatingServices">
                <ion-icon name="add-circle-outline"></ion-icon>
              </ion-button>
            </div>
            <div class="service-toggle">
              <ion-icon [name]="isServiceSelected(offer.OffersID) ? 'chevron-down' : 'add-circle-outline'"></ion-icon>
            </div>
          </div>
          
          <!-- Expanded details (only when selected) -->
          <div *ngIf="isServiceSelected(offer.OffersID)" class="service-details">
            <ng-container *ngFor="let service of getServiceInstances(offer.OffersID); let i = index">
                <div class="service-number-header" *ngIf="getServiceInstances(offer.OffersID).length > 1">#{{ i + 1 }}</div>
                <div class="instance-fields">
                  <div class="field-group">
                    <label>Inspection Date</label>
                    <input
                      type="date"
                      class="date-input"
                      [value]="formatDateForInput(service.dateOfInspection)"
                      (change)="updateServiceDateFromInput(service, $event)"
                      [disabled]="updatingServices || isReadOnly"
                      [readonly]="isReadOnly">
                    <span *ngIf="service.saving" class="saving-indicator">
                      <ion-spinner name="dots"></ion-spinner>
                    </span>
                    <span *ngIf="service.saved" class="saved-indicator">
                      <ion-icon name="checkmark-circle" color="success"></ion-icon>
                    </span>
                  </div>

                  <div class="field-group">
                    <label>Price</label>
                    <input
                      *ngIf="isCompanyOne && !isReadOnly"
                      type="number"
                      class="date-input"
                      step="0.01"
                      [value]="getServicePrice(service)"
                      (blur)="updateServicePrice(service, $event)">
                    <div *ngIf="!isCompanyOne || isReadOnly" class="price-display">
                      ${{ getServicePrice(service) | number:'1.2-2' }}
                    </div>
                  </div>
                </div>

                <!-- Reports sub-section (only for services with templates, i.e. NOT DCR/EIR) -->
                <div class="service-reports-section" *ngIf="hasTemplate(service)">
                  <h3 class="sub-section-title">Reports</h3>
                  <div class="templates-container">
                    <div class="template-bar"
                         (click)="handleTemplateClick(service, $event)">
                      <div class="template-progress"
                           [style.width.%]="getTemplateProgress(service)">
                      </div>
                      <div class="template-content">
                        <div class="template-name">
                          <img *ngIf="service.typeIconUrl" [src]="service.typeIconUrl" class="report-icon" alt="">
                          <ion-icon *ngIf="!service.typeIconUrl" name="document-text" class="report-icon-fallback"></ion-icon>
                          <span class="service-title">
                            <span *ngIf="service.typeShort">{{ service.typeShort }} - </span>{{ service.typeName }}
                          </span>
                        </div>
                        <div *ngIf="service.StatusID || service.Status" class="report-status-container">
                          <span class="report-status">
                            {{ getStatusClientById(service.StatusID) || service.Status }}
                          </span>
                          <span *ngIf="service.StatusDateTime" class="status-datetime">
                            {{ service.StatusDateTime | date:'short' }}
                          </span>
                        </div>
                        <div class="template-icons">
                          <ion-icon name="chevron-forward" class="status-arrow"></ion-icon>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Support Documents sub-section -->
                <div class="service-documents-section" *ngIf="getServiceDocumentGroup(service) as serviceDoc">
                  <h3 class="sub-section-title">Support Documents</h3>
                  <table class="documents-table">
                    <tbody class="support-doc-group">
                      <ng-container *ngIf="serviceDoc.documents.length > 0; else noInstanceDocs">
                        <tr class="support-doc-row doc-row" *ngFor="let doc of serviceDoc.documents; trackBy: trackDocument" [class.pending]="!doc.uploaded">
                          <td class="doc-info-cell">
                            <div class="doc-title">
                              {{ doc.title }}
                              <span class="required-indicator" *ngIf="doc.required" style="color: #F15A27; margin-left: 4px;">*</span>
                            </div>
                            <div class="doc-filename" *ngIf="doc.uploaded && (doc.linkName || doc.filename)">
                              {{ doc.linkName || doc.filename }}
                            </div>
                            <div class="doc-status" *ngIf="!doc.uploaded && isReadOnly">
                              Awaiting upload
                            </div>
                          </td>
                          <td class="doc-actions-cell">
                            <ion-button size="small" fill="clear" class="orange-icon" *ngIf="doc.uploaded" (click)="viewDocument(doc)">
                              <ion-icon name="eye-outline"></ion-icon>
                            </ion-button>
                            <ion-button size="small" fill="clear" class="orange-icon" *ngIf="!isReadOnly"
                                        (click)="editLink(serviceDoc.serviceId, doc)" title="Edit Link">
                              <ion-icon name="create-outline"></ion-icon>
                            </ion-button>
                            <ion-button size="small" fill="clear" class="orange-icon" *ngIf="!isReadOnly"
                                        (click)="uploadDocument(serviceDoc.serviceId, serviceDoc.typeId, doc)" title="Upload Document">
                              <ion-icon name="cloud-upload-outline"></ion-icon>
                            </ion-button>
                            <ion-button size="small" fill="clear" class="orange-icon" *ngIf="!isReadOnly"
                                        (click)="doc.uploaded ? deleteRequiredDocument(serviceDoc.serviceId, doc) : removePendingDocument(serviceDoc.serviceId, doc)" title="Delete">
                              <ion-icon name="trash-outline"></ion-icon>
                            </ion-button>
                          </td>
                        </tr>
                      </ng-container>

                      <ng-template #noInstanceDocs>
                        <tr class="support-doc-row doc-row no-docs">
                          <td class="doc-info-cell">
                            <span class="no-docs-text">No documents uploaded</span>
                          </td>
                          <td class="doc-actions-cell">
                            <span class="no-docs-text">--</span>
                          </td>
                        </tr>
                      </ng-template>

                      <tr class="support-doc-row add-row">
                        <td class="doc-info-cell">
                          <a class="add-doc-link" *ngIf="!isReadOnly" (click)="showOptionalDocuments(serviceDoc)">+ Add Document</a>
                          <span *ngIf="isReadOnly" class="add-doc-link disabled">+ Add Document</span>
                        </td>
                        <td class="doc-actions-cell add-doc-actions"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Submit button -->
                <div class="submit-button-container" *ngIf="!isReadOnly">
                  <button class="submit-report-btn"
                          [class.finalized]="isSubmitButtonEnabled(service)"
                          (click)="handleSubmitClick(service)">
                    {{ hasBeenSubmitted(service) ? 'Resubmit' : 'Submit' }}
                  </button>
                  <div *ngIf="hasBeenSubmitted(service)" class="submitted-note">
                    Submitted {{ service.StatusDateTime | date:'short' }}
                  </div>
                </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="info-section">
      <h2 class="section-title">Notes</h2>

      <div class="notes-container">
        <textarea
          class="notes-textarea"
          [(ngModel)]="project.Notes"
          (blur)="updateNotes()"
          [disabled]="isReadOnly"
          [readonly]="isReadOnly"
          placeholder="Add notes for this project...">
        </textarea>
        <span *ngIf="savingNotes" class="saving-indicator">
          <ion-spinner name="dots"></ion-spinner>
          Saving...
        </span>
      </div>
    </div>
  </div>

  <!-- File upload input (hidden) -->
  <input 
    #fileInput 
    type="file" 
    style="display: none" 
    (change)="handleFileSelect($event)"
    accept="image/*,.pdf,.doc,.docx">
</ion-content>

<!-- Optional Documents Modal -->
<ion-modal #optionalDocsModal>
  <ng-template>
    <ion-header>
      <ion-toolbar class="centered-title-toolbar">
        <ion-title>Add Document</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeOptionalDocsModal()" style="--color: #F15A27;">
            <ion-icon name="close" slot="icon-only" style="color: #F15A27;"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list>
        <!-- Custom document option at top with generous spacing from header -->
        <ion-item button (click)="promptForCustomDocument()" class="custom-document-item">
          <ion-label>
            <h2>Custom Document</h2>
            <p>Optional</p>
          </ion-label>
        </ion-item>

        <ion-item-divider style="margin-top: 16px;">
          <ion-label>Suggested Documents</ion-label>
        </ion-item-divider>

        <ion-item *ngFor="let doc of optionalDocumentsList" (click)="addOptionalDocument(doc)">
          <ion-label>
            <h2>{{ doc.title }}</h2>
            <p>{{ doc.required ? 'Required' : 'Optional' }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Bottom tab bar -->
<ion-tab-bar slot="bottom" class="page-tab-bar custom-tab-bar">
  <ion-tab-button class="tab-button" (click)="router.navigateByUrl('/tabs/active-projects')">
    <ion-icon name="document-text-outline" class="tab-icon"></ion-icon>
    <ion-label class="tab-label">Active</ion-label>
  </ion-tab-button>
  <ion-tab-button class="tab-button" (click)="router.navigateByUrl('/tabs/all-projects')">
    <ion-icon name="folder-outline" class="tab-icon"></ion-icon>
    <ion-label class="tab-label">Complete</ion-label>
  </ion-tab-button>
  <ion-tab-button class="tab-button" (click)="router.navigateByUrl('/tabs/help-guide')">
    <ion-icon name="help-circle-outline" class="tab-icon"></ion-icon>
    <ion-label class="tab-label">Help</ion-label>
  </ion-tab-button>
  <ion-tab-button class="tab-button" (click)="router.navigateByUrl('/tabs/company')">
    <ion-icon name="people-outline" class="tab-icon"></ion-icon>
    <ion-label class="tab-label">Company</ion-label>
  </ion-tab-button>
</ion-tab-bar>

<!-- Hidden file input for photo replacement - no capture attribute for iOS native picker -->
<input #photoInput type="file" accept="image/*" style="display: none" (change)="onPhotoSelected($event)">


