<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" color="primary">
        <ion-icon name="arrow-back"></ion-icon>
        Back to Projects
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading state -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading project...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !loading" class="error-container">
    <ion-text color="danger">
      <h2>Project Not Found</h2>
      <p>The requested project could not be found.</p>
    </ion-text>
    <ion-button (click)="goBack()" color="primary">Back to Projects</ion-button>
  </div>

  <!-- Project details -->
  <div *ngIf="project && !loading && !error" class="project-container">
    <!-- Street View Header -->
    <div class="street-view-header">
      <img [src]="getStreetViewUrl()" alt="Street View">
    </div>

    <!-- Project Information Section -->
    <div class="info-section">
      <h2 class="section-title">Project Information</h2>
      
      <div class="info-row">
        <span class="info-label">Address:</span>
        <span class="info-value">{{ project.Address || 'Not specified' }}</span>
      </div>
      
      <div class="info-row">
        <span class="info-label">City, State:</span>
        <span class="info-value">{{ getCityState() }}</span>
      </div>
      
      <div class="info-row">
        <span class="info-label">Inspection Date:</span>
        <span class="info-value">{{ formatDate(project.InspectionDate) }}</span>
      </div>
      
      <div class="info-row">
        <span class="info-label">Project ID:</span>
        <span class="info-value">#{{ project.PK_ID || project.ProjectID }}</span>
      </div>
    </div>

    <!-- Service Selection Section -->
    <div class="info-section">
      <h2 class="section-title">Services</h2>
      
      <!-- Loading services -->
      <div *ngIf="loadingServices" class="services-loading">
        <ion-spinner name="crescent"></ion-spinner>
        <span>Loading services...</span>
      </div>
      
      <!-- Service checkboxes -->
      <div *ngIf="!loadingServices" class="services-grid">
        <div *ngFor="let offer of availableOffers" class="service-item">
          <ion-checkbox 
            [checked]="isServiceSelected(offer.OffersID)"
            (ionChange)="toggleService($event, offer)"
            [disabled]="updatingServices">
          </ion-checkbox>
          <label (click)="toggleServiceByLabel(offer)">{{ offer.TypeName || offer.Service_Name || offer.Description }}</label>
        </div>
      </div>
      
      <!-- Selected Services Table -->
      <div *ngIf="selectedServices.length > 0" class="selected-services-table">
        <h3>Selected Services & Inspection Dates</h3>
        <div class="services-table">
          <div class="table-header">
            <div class="col-service">Service</div>
            <div class="col-date col-date-header">Date</div>
            <div class="col-actions">Actions</div>
          </div>
          <div *ngFor="let service of selectedServices" class="table-row">
            <div class="col-service">
              {{ service.typeName }}
              <span *ngIf="getServiceCount(service.offersId) > 1" class="instance-badge">
                #{{ getServiceInstanceNumber(service) }}
              </span>
            </div>
            <div class="col-date">
              <input 
                type="date" 
                class="date-input"
                [value]="formatDateForInput(service.dateOfInspection)"
                (change)="updateServiceDateFromInput(service, $event)"
                [disabled]="updatingServices">
              <span *ngIf="service.saving" class="saving-indicator">
                <ion-spinner name="dots"></ion-spinner>
              </span>
              <span *ngIf="service.saved" class="saved-indicator">
                <ion-icon name="checkmark-circle" color="success"></ion-icon>
              </span>
            </div>
            <div class="col-actions">
              <ion-button 
                size="small" 
                fill="clear" 
                color="danger"
                (click)="removeServiceInstance(service)"
                [disabled]="updatingServices">
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
              <ion-button 
                size="small" 
                fill="clear" 
                color="primary"
                (click)="duplicateService(service.offersId, service.typeName)"
                [disabled]="updatingServices">
                <ion-icon name="copy-outline"></ion-icon>
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Required Documents Section -->
    <div class="info-section">
      <h2 class="section-title">Required Documents</h2>
      
      <!-- Loading documents -->
      <div *ngIf="loadingDocuments" class="documents-loading">
        <ion-spinner name="crescent"></ion-spinner>
        <span>Loading documents...</span>
      </div>
      
      <!-- No services selected -->
      <div *ngIf="!loadingDocuments && selectedServices.length === 0" class="no-services-message">
        <ion-text color="medium">
          <p>Please select services above to see required documents.</p>
        </ion-text>
      </div>
      
      <!-- Documents table -->
      <div *ngIf="!loadingDocuments && selectedServices.length > 0" class="documents-table">
        <div class="doc-header">
          <div>Service</div>
          <div>Document</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        
        <!-- Dynamic documents based on selected services -->
        <div *ngFor="let serviceDoc of serviceDocuments" class="service-doc-group">
          <div *ngFor="let doc of serviceDoc.documents; let isFirst = first; let isLast = last" class="doc-row">
            <div class="doc-service">
              <div *ngIf="isFirst">
                {{ serviceDoc.serviceName }}
                <span *ngIf="serviceDoc.instanceNumber > 1" class="instance-badge">
                  #{{ serviceDoc.instanceNumber }}
                </span>
              </div>
            </div>
            <div>
              {{ doc.title }}
              <a *ngIf="!doc.required && !doc.uploaded" 
                 (click)="removeOptionalDocument(serviceDoc.serviceId, doc)"
                 class="remove-doc-link">
                Remove
              </a>
            </div>
            <div>
              <span class="status-badge" [ngClass]="{
                'status-uploaded': doc.uploaded,
                'status-required': !doc.uploaded && doc.required,
                'status-optional': !doc.uploaded && !doc.required
              }">
                {{ doc.uploaded ? 'Uploaded' : (doc.required ? 'Required' : 'Optional') }}
              </span>
            </div>
            <div>
              <!-- Upload button for documents without files -->
              <ion-button 
                *ngIf="!doc.uploaded"
                size="small" 
                fill="solid" 
                color="primary" 
                (click)="uploadDocument(serviceDoc.serviceId, serviceDoc.typeId, doc)">
                Upload
              </ion-button>
              
              <!-- Actions for uploaded documents -->
              <div *ngIf="doc.uploaded" class="uploaded-actions">
                <ion-button 
                  size="small" 
                  fill="clear" 
                  color="primary" 
                  (click)="viewDocument(doc)">
                  View
                </ion-button>
                <ion-button 
                  size="small" 
                  fill="clear" 
                  color="warning" 
                  (click)="replaceDocument(doc)">
                  Replace
                </ion-button>
                <ion-button 
                  size="small" 
                  fill="clear" 
                  color="success" 
                  (click)="uploadAdditionalFile(serviceDoc.serviceId, serviceDoc.typeId, doc)">
                  + Add
                </ion-button>
              </div>
            </div>
          </div>
          
          <!-- Add optional documents link -->
          <div class="doc-row add-doc-row">
            <div></div>
            <div colspan="3">
              <a (click)="showOptionalDocuments(serviceDoc)" class="add-doc-link">
                + Add Document
              </a>
            </div>
            <div style="display: none;"></div>
            <div style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Templates Section -->
    <div class="info-section" *ngIf="selectedServices.length > 0">
      <h2 class="section-title">Templates</h2>
      
      <div class="templates-table">
        <div class="template-header">
          <div class="template-col">Service</div>
          <div class="template-col">Instance</div>
          <div class="template-col">Action</div>
        </div>
        
        <div *ngFor="let service of selectedServices" class="template-row">
          <div class="template-col">{{ service.typeName }}</div>
          <div class="template-col">
            <span *ngIf="getServiceCount(service.offersId) > 1">
              Instance {{ getServiceInstanceNumber(service) }}
            </span>
            <span *ngIf="getServiceCount(service.offersId) === 1">-</span>
          </div>
          <div class="template-col">
            <ion-button 
              size="small" 
              fill="solid" 
              color="success" 
              (click)="openTemplate(service)">
              Open Template
            </ion-button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- File upload input (hidden) -->
  <input 
    #fileInput 
    type="file" 
    style="display: none" 
    (change)="handleFileSelect($event)"
    accept="image/*,.pdf,.doc,.docx">
</ion-content>

<!-- Optional Documents Modal -->
<ion-modal #optionalDocsModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Add Document</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeOptionalDocsModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list>
        <ion-item *ngFor="let doc of optionalDocumentsList" (click)="addOptionalDocument(doc)">
          <ion-label>
            <h2>{{ doc.title }}</h2>
            <p>{{ doc.required ? 'Required' : 'Optional' }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>