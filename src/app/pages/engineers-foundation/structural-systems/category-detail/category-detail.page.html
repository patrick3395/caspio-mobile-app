<div class="page-container">
  <!-- Hidden file input for camera/gallery -->
  <input #fileInput type="file" style="display: none;" (change)="onFileSelected($event)" accept="image/*">

  <div class="header-section">
    <div style="display: flex; align-items: center; gap: 12px;">
      <ion-icon name="arrow-back" style="font-size: 28px; color: var(--noble-orange, #F15A27); cursor: pointer;" (click)="goBack()"></ion-icon>
      <h1 style="margin: 0;">{{ categoryName }}</h1>
    </div>
  </div>

  <div class="content-section">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading items...</p>
    </div>

    <!-- Category Content -->
    <div *ngIf="!loading" class="category-content">

      <ion-accordion-group>
        <!-- General Information Section -->
        <ion-accordion *ngIf="organizedData.comments">
          <ion-item slot="header" lines="none" style="--background: transparent;">
            <ion-label>
              <h4 class="type-header" style="margin: 8px 0; font-size: 18px; font-weight: 600; color: var(--noble-orange, #F15A27);">
                General Information
              </h4>
            </ion-label>
            <button class="add-visual-btn" slot="end" (click)="addCustomVisual(categoryName, 'Comment'); $event.stopPropagation()" title="Add custom general information">
              <ion-icon name="add-circle-outline"></ion-icon>
            </button>
          </ion-item>
          <div slot="content" class="accordion-content">
            <div class="type-section">
              <div *ngIf="organizedData.comments.length === 0" class="no-items-message">
                No general information yet. Click + to add one.
              </div>
              <div class="template-item" *ngFor="let item of organizedData.comments; trackBy: trackByItemId">
          <div class="visual-item-container" [class.selected]="isItemSelected(categoryName, item.id)">

            <!-- Yes/No questions - vertical layout with dropdown below -->
            <div class="answer-type-1-container" *ngIf="item.answerType === 1">
              <div class="item-header" (click)="showFullText(item)">
                <h3 class="item-name">
                  {{ item.name }}
                  <span class="required-indicator" *ngIf="item.required">*</span>
                </h3>
              </div>
              <div class="item-text-wrapper" (click)="showFullText(item)">
                <p class="item-text">{{ item.originalText }}</p>
              </div>
              <div class="dropdown-container" (click)="$event.stopPropagation()">
                <select
                  [(ngModel)]="item.answer"
                  (ngModelChange)="onAnswerChange(categoryName, item)"
                  [disabled]="isItemSaving(categoryName, item.id)"
                  class="styled-input">
                  <option value="">-- Select --</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
              </div>
            </div>

            <!-- Multi-select questions - show checkboxes for each option -->
            <div class="multi-select-container" *ngIf="item.answerType === 2">
              <ion-item lines="none" class="checkbox-item">
                <ion-label class="item-label">
                  <h3>
                    {{ item.name }}
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <div class="item-text-wrapper">
                    <p class="item-text">{{ item.text }}</p>
                  </div>
                </ion-label>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end"></ion-spinner>
              </ion-item>
              <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]; trackBy: trackByOption" class="option-item">
                  <ion-checkbox
                    slot="start"
                    [checked]="isOptionSelectedV1(item, option)"
                    (ionChange)="onOptionToggle(categoryName, item, option, $event)"
                    [disabled]="isItemSaving(categoryName, item.id)">
                  </ion-checkbox>
                  <ion-label>{{ option }}</ion-label>
                </ion-item>
              </div>
              <!-- Custom input for "Other" option -->
              <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                <input type="text"
                       [(ngModel)]="item.otherValue"
                       (blur)="onMultiSelectOtherChange(categoryName, item)"
                       (click)="$event.stopPropagation()"
                       placeholder="Please specify..."
                       class="styled-input other-input">
              </div>
              <div class="no-options-message" *ngIf="!visualDropdownOptions[item.templateId] || visualDropdownOptions[item.templateId].length === 0">
                <p>No options available for this item</p>
              </div>
            </div>

            <!-- Text questions - checkbox behavior with camera buttons -->
            <ion-item lines="none"
                      class="checkbox-item with-camera"
                      [class.has-photos]="getPhotosForVisual(categoryName, item.id).length > 0"
                      *ngIf="!item.answerType || item.answerType === 0"
                      style="min-height: 100px; align-items: flex-start; position: relative;">
              <ion-checkbox
                slot="start"
                [checked]="isItemSelected(categoryName, item.id)"
                [disabled]="isItemSaving(categoryName, item.id)"
                (ionChange)="toggleItemSelection(categoryName, item.id)"
                style="margin-top: 8px;">
              </ion-checkbox>
              <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                <ion-label class="item-label" (click)="showFullText(item)">
                  <h3>
                    {{ item.name }}
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <p class="item-text">{{ item.text }}</p>
                </ion-label>
                <!-- Camera and Gallery buttons below text -->
                <div *ngIf="isItemSelected(categoryName, item.id)" style="display: flex; gap: 16px; margin-top: 6px; align-items: center; flex-wrap: nowrap; justify-content: flex-end; padding-right: 8px;">
                  <button class="camera-button-structural"
                          (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()"
                          title="Take photo from camera"
                          style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                    <ion-icon name="camera" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                  </button>
                  <button class="camera-button-structural"
                          (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()"
                          title="Select from gallery"
                          style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                    <ion-icon name="images" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                  </button>
                </div>
              </div>
              <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end" style="margin-top: 8px;"></ion-spinner>
            </ion-item>

            <!-- Image preview section below the item (only for text questions) -->
            <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0) && (getPhotosForVisual(categoryName, item.id).length > 0 || isLoadingPhotosForVisual(categoryName, item.id) || isUploadingPhotos(categoryName, item.id))" style="position: relative;">
              <!-- Upload status indicator -->
              <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                <ion-spinner name="dots" color="primary"></ion-spinner>
                <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
              </div>
              <div class="image-preview-container">
                <!-- Skeleton loaders when photos are loading -->
                <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-caption"></div>
                  </div>
                </ng-container>
                <!-- Actual photos when loaded -->
                <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                       [class.uploading]="photo.uploading"
                       [class.annotated]="photo.hasAnnotations">
                    <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'"
                         width="90" height="90"
                         [alt]="photo.name"
                         (mousedown)="saveScrollBeforePhotoClick($event)"
                         (click)="viewPhoto(photo, categoryName, item.id, $event)"
                         (error)="handleImageError($event, photo)"
                         [class.has-annotations]="photo.hasAnnotations">
                    <div class="upload-indicator" *ngIf="photo.uploading">
                      <ion-spinner name="crescent" color="light"></ion-spinner>
                    </div>
                    <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                      <ion-icon name="close"></ion-icon>
                    </button>
                    <button
                      class="room-photo-caption"
                      (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                      {{ photo.caption || 'Caption' }}
                    </button>
                  </div>
                </ng-container>
              </div>
              <!-- Photo count badge in bottom right -->
              <div *ngIf="getPhotosForVisual(categoryName, item.id).length > 0"
                   style="position: absolute; bottom: 8px; right: 8px; background: #F15A27; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; z-index: 10;">
                {{ getPhotosForVisual(categoryName, item.id).length }}
              </div>
            </div>
          </div>
        </div>
            </div> <!-- Close type-section -->
          </div> <!-- Close accordion-content -->
        </ion-accordion>

        <!-- Limitations Section -->
        <ion-accordion *ngIf="organizedData.limitations">
          <ion-item slot="header" lines="none" style="--background: transparent;">
            <ion-label>
              <h4 class="type-header" style="margin: 8px 0; font-size: 18px; font-weight: 600; color: var(--noble-orange, #F15A27);">
                Limitations
              </h4>
            </ion-label>
            <button class="add-visual-btn" slot="end" (click)="addCustomVisual(categoryName, 'Limitation'); $event.stopPropagation()" title="Add custom limitation">
              <ion-icon name="add-circle-outline"></ion-icon>
            </button>
          </ion-item>
          <div slot="content" class="accordion-content">
            <div class="type-section">
              <div *ngIf="organizedData.limitations.length === 0" class="no-items-message">
                No limitations yet. Click + to add one.
              </div>
              <div class="template-item" *ngFor="let item of organizedData.limitations; trackBy: trackByItemId">
          <div class="visual-item-container" [class.selected]="isItemSelected(categoryName, item.id)">

            <!-- Yes/No questions -->
            <div class="answer-type-1-container" *ngIf="item.answerType === 1">
              <div class="item-header" (click)="showFullText(item)">
                <h3 class="item-name">
                  {{ item.name }}
                  <span class="required-indicator" *ngIf="item.required">*</span>
                </h3>
              </div>
              <div class="item-text-wrapper" (click)="showFullText(item)">
                <p class="item-text">{{ item.originalText }}</p>
              </div>
              <div class="dropdown-container">
                <select
                  [(ngModel)]="item.answer"
                  (ngModelChange)="onAnswerChange(categoryName, item)"
                  [disabled]="isItemSaving(categoryName, item.id)"
                  class="styled-input">
                  <option value="">-- Select --</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
              </div>
            </div>

            <!-- Multi-select questions -->
            <div class="multi-select-container" *ngIf="item.answerType === 2">
              <ion-item lines="none" class="checkbox-item">
                <ion-label class="item-label">
                  <h3>
                    {{ item.name }}
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <div class="item-text-wrapper">
                    <p class="item-text">{{ item.text }}</p>
                  </div>
                </ion-label>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end"></ion-spinner>
              </ion-item>
              <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]; trackBy: trackByOption" class="option-item">
                  <ion-checkbox
                    slot="start"
                    [checked]="isOptionSelectedV1(item, option)"
                    (ionChange)="onOptionToggle(categoryName, item, option, $event)"
                    [disabled]="isItemSaving(categoryName, item.id)">
                  </ion-checkbox>
                  <ion-label>{{ option }}</ion-label>
                </ion-item>
              </div>
              <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                <input type="text"
                       [(ngModel)]="item.otherValue"
                       (blur)="onMultiSelectOtherChange(categoryName, item)"
                       placeholder="Please specify..."
                       class="styled-input other-input">
              </div>
            </div>

            <!-- Text questions with camera buttons -->
            <ion-item lines="none"
                      class="checkbox-item with-camera"
                      [class.has-photos]="getPhotosForVisual(categoryName, item.id).length > 0"
                      *ngIf="!item.answerType || item.answerType === 0"
                      style="min-height: 100px; align-items: flex-start; position: relative;">
              <ion-checkbox
                slot="start"
                [checked]="isItemSelected(categoryName, item.id)"
                [disabled]="isItemSaving(categoryName, item.id)"
                (ionChange)="toggleItemSelection(categoryName, item.id)"
                style="margin-top: 8px;">
              </ion-checkbox>
              <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                <ion-label class="item-label" (click)="showFullText(item)">
                  <h3>
                    {{ item.name }}
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <p class="item-text">{{ item.text }}</p>
                </ion-label>
                <!-- Camera and Gallery buttons -->
                <div *ngIf="isItemSelected(categoryName, item.id)" style="display: flex; gap: 16px; margin-top: 6px; align-items: center; flex-wrap: nowrap; justify-content: flex-end; padding-right: 8px;">
                  <button class="camera-button-structural"
                          (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()"
                          title="Take photo from camera"
                          style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                    <ion-icon name="camera" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                  </button>
                  <button class="camera-button-structural"
                          (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()"
                          title="Select from gallery"
                          style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                    <ion-icon name="images" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                  </button>
                </div>
              </div>
              <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end" style="margin-top: 8px;"></ion-spinner>
            </ion-item>

            <!-- Image preview section (Limitations) -->
            <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0) && (getPhotosForVisual(categoryName, item.id).length > 0 || isLoadingPhotosForVisual(categoryName, item.id) || isUploadingPhotos(categoryName, item.id))" style="position: relative;">
              <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                <ion-spinner name="dots" color="primary"></ion-spinner>
                <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
              </div>
              <div class="image-preview-container">
                <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-caption"></div>
                  </div>
                </ng-container>
                <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                       [class.uploading]="photo.uploading"
                       [class.annotated]="photo.hasAnnotations">
                    <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'"
                         width="90" height="90"
                         [alt]="photo.name"
                         (mousedown)="saveScrollBeforePhotoClick($event)"
                         (click)="viewPhoto(photo, categoryName, item.id, $event)"
                         (error)="handleImageError($event, photo)"
                         [class.has-annotations]="photo.hasAnnotations">
                    <div class="upload-indicator" *ngIf="photo.uploading">
                      <ion-spinner name="crescent" color="light"></ion-spinner>
                    </div>
                    <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                      <ion-icon name="close"></ion-icon>
                    </button>
                    <button
                      class="room-photo-caption"
                      (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                      {{ photo.caption || 'Caption' }}
                    </button>
                  </div>
                </ng-container>
              </div>
              <div *ngIf="getPhotosForVisual(categoryName, item.id).length > 0"
                   style="position: absolute; bottom: 8px; right: 8px; background: #F15A27; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; z-index: 10;">
                {{ getPhotosForVisual(categoryName, item.id).length }}
              </div>
            </div>
          </div>
        </div>
            </div> <!-- Close type-section -->
          </div> <!-- Close accordion-content -->
        </ion-accordion>

        <!-- Deficiencies Section -->
        <ion-accordion *ngIf="organizedData.deficiencies">
          <ion-item slot="header" lines="none" style="--background: transparent;">
            <ion-label>
              <h4 class="type-header" style="margin: 8px 0; font-size: 18px; font-weight: 600; color: var(--noble-orange, #F15A27);">
                Deficiencies
              </h4>
            </ion-label>
            <button class="add-visual-btn" slot="end" (click)="addCustomVisual(categoryName, 'Deficiency'); $event.stopPropagation()" title="Add custom deficiency">
              <ion-icon name="add-circle-outline"></ion-icon>
            </button>
          </ion-item>
          <div slot="content" class="accordion-content">
            <div class="type-section">
              <div *ngIf="organizedData.deficiencies.length === 0" class="no-items-message">
                No deficiencies yet. Click + to add one.
              </div>
              <div class="template-item" *ngFor="let item of organizedData.deficiencies; trackBy: trackByItemId">
          <div class="visual-item-container" [class.selected]="isItemSelected(categoryName, item.id)">

            <!-- Yes/No questions -->
            <div class="answer-type-1-container" *ngIf="item.answerType === 1">
              <div class="item-header" (click)="showFullText(item)">
                <h3 class="item-name">
                  {{ item.name }}
                  <span class="required-indicator" *ngIf="item.required">*</span>
                </h3>
              </div>
              <div class="item-text-wrapper" (click)="showFullText(item)">
                <p class="item-text">{{ item.originalText }}</p>
              </div>
              <div class="dropdown-container">
                <select
                  [(ngModel)]="item.answer"
                  (ngModelChange)="onAnswerChange(categoryName, item)"
                  [disabled]="isItemSaving(categoryName, item.id)"
                  class="styled-input">
                  <option value="">-- Select --</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
              </div>
            </div>

            <!-- Multi-select questions -->
            <div class="multi-select-container" *ngIf="item.answerType === 2">
              <ion-item lines="none" class="checkbox-item">
                <ion-label class="item-label">
                  <h3>
                    {{ item.name }}
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <div class="item-text-wrapper">
                    <p class="item-text">{{ item.text }}</p>
                  </div>
                </ion-label>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end"></ion-spinner>
              </ion-item>
              <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]; trackBy: trackByOption" class="option-item">
                  <ion-checkbox
                    slot="start"
                    [checked]="isOptionSelectedV1(item, option)"
                    (ionChange)="onOptionToggle(categoryName, item, option, $event)"
                    [disabled]="isItemSaving(categoryName, item.id)">
                  </ion-checkbox>
                  <ion-label>{{ option }}</ion-label>
                </ion-item>
              </div>
              <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                <input type="text"
                       [(ngModel)]="item.otherValue"
                       (blur)="onMultiSelectOtherChange(categoryName, item)"
                       placeholder="Please specify..."
                       class="styled-input other-input">
              </div>
            </div>

            <!-- Text questions with camera buttons -->
            <ion-item lines="none"
                      class="checkbox-item with-camera"
                      [class.has-photos]="getPhotosForVisual(categoryName, item.id).length > 0"
                      *ngIf="!item.answerType || item.answerType === 0"
                      style="min-height: 100px; align-items: flex-start; position: relative;">
              <ion-checkbox
                slot="start"
                [checked]="isItemSelected(categoryName, item.id)"
                [disabled]="isItemSaving(categoryName, item.id)"
                (ionChange)="toggleItemSelection(categoryName, item.id)"
                style="margin-top: 8px;">
              </ion-checkbox>
              <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                <ion-label class="item-label" (click)="showFullText(item)">
                  <h3>
                    {{ item.name }}
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <p class="item-text">{{ item.text }}</p>
                </ion-label>
                <!-- Camera and Gallery buttons -->
                <div *ngIf="isItemSelected(categoryName, item.id)" style="display: flex; gap: 16px; margin-top: 6px; align-items: center; flex-wrap: nowrap; justify-content: flex-end; padding-right: 8px;">
                  <button class="camera-button-structural"
                          (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()"
                          title="Take photo from camera"
                          style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                    <ion-icon name="camera" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                  </button>
                  <button class="camera-button-structural"
                          (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()"
                          title="Select from gallery"
                          style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                    <ion-icon name="images" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                  </button>
                </div>
              </div>
              <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end" style="margin-top: 8px;"></ion-spinner>
            </ion-item>

            <!-- Image preview section (Deficiencies) -->
            <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0) && (getPhotosForVisual(categoryName, item.id).length > 0 || isLoadingPhotosForVisual(categoryName, item.id) || isUploadingPhotos(categoryName, item.id))" style="position: relative;">
              <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                <ion-spinner name="dots" color="primary"></ion-spinner>
                <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
              </div>
              <div class="image-preview-container">
                <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-caption"></div>
                  </div>
                </ng-container>
                <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                       [class.uploading]="photo.uploading"
                       [class.annotated]="photo.hasAnnotations">
                    <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'"
                         width="90" height="90"
                         [alt]="photo.name"
                         (mousedown)="saveScrollBeforePhotoClick($event)"
                         (click)="viewPhoto(photo, categoryName, item.id, $event)"
                         (error)="handleImageError($event, photo)"
                         [class.has-annotations]="photo.hasAnnotations">
                    <div class="upload-indicator" *ngIf="photo.uploading">
                      <ion-spinner name="crescent" color="light"></ion-spinner>
                    </div>
                    <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                      <ion-icon name="close"></ion-icon>
                    </button>
                    <button
                      class="room-photo-caption"
                      (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                      {{ photo.caption || 'Caption' }}
                    </button>
                  </div>
                </ng-container>
              </div>
              <div *ngIf="getPhotosForVisual(categoryName, item.id).length > 0"
                   style="position: absolute; bottom: 8px; right: 8px; background: #F15A27; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; z-index: 10;">
                {{ getPhotosForVisual(categoryName, item.id).length }}
              </div>
            </div>
          </div>
        </div>
            </div> <!-- Close type-section -->
          </div> <!-- Close accordion-content -->
        </ion-accordion>

      </ion-accordion-group>

    </div>
  </div>
</div>
