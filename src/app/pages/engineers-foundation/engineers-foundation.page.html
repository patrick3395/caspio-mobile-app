<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/active-projects"></ion-back-button>
    </ion-buttons>
    <ion-title>Engineer's Foundation Evaluation</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="saveTemplate()">
        <ion-icon name="save-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="template-container">
    <!-- Save status indicator -->
    <div class="save-status" *ngIf="saveStatus" [class.info]="saveStatusType === 'info'" 
         [class.success]="saveStatusType === 'success'" [class.error]="saveStatusType === 'error'">
      {{ saveStatus }}
    </div>

    <!-- Project Information Section (Shared across all services) -->
    <div class="section-card project-info-card">
      <div class="section-header project-header" (click)="toggleSection('project')">
        <div class="section-info">
          <div class="section-title">
            <span class="section-icon">üè†</span>
            Project Information
          </div>
          <div class="section-description">Core property and inspection details - Project #{{ projectId }}</div>
        </div>
        <div class="section-status">
          <span class="completion-indicator" [class.complete]="getProjectCompletion() === 100">
            {{getProjectCompletion()}}% Complete
          </span>
          <ion-icon [name]="expandedSections['project'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>
      
      <div class="section-content" *ngIf="expandedSections['project']">
        <!-- People & Roles -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="people-outline"></ion-icon>
            People & Roles
          </h3>
          <div class="form-grid three-col">
            <!-- Client Name -->
            <div class="form-group" [class.filled]="projectData.ClientName">
              <label>
                <ion-icon name="person-outline"></ion-icon>
                Client Name
              </label>
              <input type="text" [(ngModel)]="projectData.ClientName" name="ClientName"
                     (ngModelChange)="onProjectFieldChange('ClientName', $event)"
                     placeholder="Enter client name"
                     class="styled-input">
            </div>

            <!-- Agent Name -->
            <div class="form-group" [class.filled]="projectData.AgentName">
              <label>
                <ion-icon name="briefcase-outline"></ion-icon>
                Agent Name
              </label>
              <input type="text" [(ngModel)]="projectData.AgentName" name="AgentName"
                     (ngModelChange)="onProjectFieldChange('AgentName', $event)"
                     placeholder="Enter agent name"
                     class="styled-input">
            </div>

            <!-- Inspector Name -->
            <div class="form-group" [class.filled]="projectData.InspectorName">
              <label>
                <ion-icon name="clipboard-outline"></ion-icon>
                Inspector Name
              </label>
              <input type="text" [(ngModel)]="projectData.InspectorName" name="InspectorName"
                     (ngModelChange)="onProjectFieldChange('InspectorName', $event)"
                     placeholder="Enter inspector name"
                     class="styled-input">
            </div>

            <!-- In Attendance -->
            <div class="form-group full-width" [class.filled]="projectData.InAttendance">
              <label>
                <ion-icon name="people-circle-outline"></ion-icon>
                In Attendance
              </label>
              <input type="text" [(ngModel)]="projectData.InAttendance" name="InAttendance"
                     (ngModelChange)="onProjectFieldChange('InAttendance', $event)"
                     placeholder="Who was present during inspection"
                     class="styled-input">
            </div>
          </div>
        </div>

        <!-- Property Details -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="home-outline"></ion-icon>
            Property Details
          </h3>
          <div class="form-grid three-col">

            <!-- Year Built -->
            <div class="form-group" [class.filled]="projectData.YearBuilt">
              <label>
                <ion-icon name="calendar-outline"></ion-icon>
                Year Built
              </label>
              <input type="text" [(ngModel)]="projectData.YearBuilt" name="YearBuilt"
                     (ngModelChange)="onProjectFieldChange('YearBuilt', $event)"
                     placeholder="e.g., 1985"
                     class="styled-input">
            </div>

            <!-- Square Feet -->
            <div class="form-group" [class.filled]="projectData.SquareFeet">
              <label>
                <ion-icon name="resize-outline"></ion-icon>
                Square Feet
              </label>
              <input type="text" [(ngModel)]="projectData.SquareFeet" name="SquareFeet"
                     (ngModelChange)="onProjectFieldChange('SquareFeet', $event)"
                     placeholder="e.g., 2500"
                     class="styled-input">
            </div>

            <!-- Type of Building -->
            <div class="form-group" [class.filled]="projectData.TypeOfBuilding">
              <label>
                <ion-icon name="business-outline"></ion-icon>
                Building Type
              </label>
              <select [(ngModel)]="projectData.TypeOfBuilding" name="TypeOfBuilding"
                      (ngModelChange)="onProjectFieldChange('TypeOfBuilding', $event)"
                      class="styled-input">
                <option value="">Select type</option>
                <option value="Single Family">Single Family</option>
                <option value="Multi Family">Multi Family</option>
                <option value="Townhouse">Townhouse</option>
                <option value="Condominium">Condominium</option>
                <option value="Commercial">Commercial</option>
              </select>
            </div>

            <!-- Style -->
            <div class="form-group" [class.filled]="projectData.Style">
              <label>
                <ion-icon name="color-palette-outline"></ion-icon>
                Style
              </label>
              <select [(ngModel)]="projectData.Style" name="Style"
                      (ngModelChange)="onProjectFieldChange('Style', $event)"
                      class="styled-input">
                <option value="">Select style</option>
                <option value="Ranch">Ranch</option>
                <option value="Two Story">Two Story</option>
                <option value="Split Level">Split Level</option>
                <option value="Colonial">Colonial</option>
                <option value="Contemporary">Contemporary</option>
                <option value="Traditional">Traditional</option>
              </select>
            </div>

            <!-- Occupancy Furnishings -->
            <div class="form-group" [class.filled]="projectData.OccupancyFurnishings">
              <label>
                <ion-icon name="bed-outline"></ion-icon>
                Occupancy Status
              </label>
              <select [(ngModel)]="projectData.OccupancyFurnishings" name="OccupancyFurnishings"
                      (ngModelChange)="onProjectFieldChange('OccupancyFurnishings', $event)"
                      class="styled-input">
                <option value="">Select status</option>
                <option value="Occupied - Furnished">Occupied - Furnished</option>
                <option value="Occupied - Unfurnished">Occupied - Unfurnished</option>
                <option value="Vacant - Furnished">Vacant - Furnished</option>
                <option value="Vacant - Unfurnished">Vacant - Unfurnished</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Environmental Conditions -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="partly-sunny-outline"></ion-icon>
            Environmental Conditions
          </h3>
          <div class="form-grid two-col">

            <!-- Weather Conditions -->
            <div class="form-group" [class.filled]="projectData.WeatherConditions">
              <label>
                <ion-icon name="cloud-outline"></ion-icon>
                Weather Conditions
              </label>
              <select [(ngModel)]="projectData.WeatherConditions" name="WeatherConditions"
                      (ngModelChange)="onProjectFieldChange('WeatherConditions', $event)"
                      class="styled-input">
                <option value="">Select weather</option>
                <option value="Clear">Clear</option>
                <option value="Partly Cloudy">Partly Cloudy</option>
                <option value="Cloudy">Cloudy</option>
                <option value="Light Rain">Light Rain</option>
                <option value="Heavy Rain">Heavy Rain</option>
                <option value="Windy">Windy</option>
                <option value="Foggy">Foggy</option>
              </select>
            </div>

            <!-- Outdoor Temperature -->
            <div class="form-group" [class.filled]="projectData.OutdoorTemperature">
              <label>
                <ion-icon name="thermometer-outline"></ion-icon>
                Outdoor Temperature
              </label>
              <input type="text" [(ngModel)]="projectData.OutdoorTemperature" name="OutdoorTemperature"
                     (ngModelChange)="onProjectFieldChange('OutdoorTemperature', $event)"
                     placeholder="e.g., 75¬∞F"
                     class="styled-input">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Structural Systems Section -->
    <div class="section-card">
      <div class="section-header" (click)="toggleSection('structural')">
        <div class="section-info">
          <div class="section-title">
            <ion-icon name="construct-outline"></ion-icon>
            Structural Systems
          </div>
          <div class="section-description">Foundation observations and measurements</div>
        </div>
        <div class="section-toggle">
          <span class="completion-badge" [class.complete]="getSectionCompletion('structural') === 100">
            {{ getSectionCompletion('structural') }}%
          </span>
          <ion-icon [name]="expandedSections['structural'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>

      <div class="section-content" *ngIf="expandedSections['structural']">
        <!-- Visual Categories from Services_Visuals_Templates -->
        <div class="categories-container" *ngIf="visualCategories.length > 0">
          <h3 class="categories-title">Visual Categories</h3>
          
          <!-- Category Accordion -->
          <ion-accordion-group>
            <ion-accordion *ngFor="let category of visualCategories" [value]="category">
              <ion-item slot="header" color="light">
                <ion-label>
                  <h2>{{ category }}</h2>
                  <p>{{ getTemplatesCountForCategory(category) }} items</p>
                </ion-label>
              </ion-item>
              
              <div class="category-content" slot="content">
                <!-- Comments Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].comments && organizedData[category].comments.length > 0">
                  <h4 class="type-header">Comments</h4>
                  <div class="template-item" *ngFor="let item of organizedData[category].comments">
                    <ion-item lines="none" class="checkbox-item">
                      <ion-checkbox 
                        slot="start" 
                        [checked]="isItemSelected(category, item.id)"
                        [disabled]="isItemSaving(category, item.id)"
                        (ionChange)="toggleItemSelection(category, item.id)">
                      </ion-checkbox>
                      <ion-label class="item-label" (click)="showFullText(item)">
                        <h3>{{ item.name }}</h3>
                        <p class="item-text clickable" *ngIf="item.text">{{ item.text }}</p>
                      </ion-label>
                      <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      <div class="photo-actions" *ngIf="isItemSelected(category, item.id)">
                        <!-- Upload button if no photos -->
                        <ion-button 
                          *ngIf="getPhotoCount(category, item.id) === 0"
                          size="small" 
                          fill="outline" 
                          color="primary" 
                          (click)="uploadDocument(category, item.id, item)">
                          <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
                        </ion-button>
                        
                        <!-- Photo display with icons if photos exist -->
                        <div class="photo-display" *ngIf="getPhotoCount(category, item.id) > 0">
                          <div class="photo-item" *ngFor="let photo of getPhotosForVisual(category, item.id)">
                            <span class="photo-name">{{ photo.name || 'Photo' }}</span>
                            <div class="photo-icons">
                              <ion-button size="small" fill="clear" (click)="viewPhoto(photo, category, item.id)" title="View">
                                <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                              <ion-button size="small" fill="clear" (click)="replacePhoto(photo, category, item.id)" title="Replace">
                                <ion-icon name="swap-horizontal-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                              <ion-button size="small" fill="clear" (click)="addAnotherPhoto(category, item.id)" title="Add Another">
                                <ion-icon name="add-circle-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </ion-item>
                  </div>
                </div>
                
                <!-- Limitations Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].limitations && organizedData[category].limitations.length > 0">
                  <h4 class="type-header">Limitations</h4>
                  <div class="template-item" *ngFor="let item of organizedData[category].limitations">
                    <ion-item lines="none" class="checkbox-item">
                      <ion-checkbox 
                        slot="start" 
                        [checked]="isItemSelected(category, item.id)"
                        [disabled]="isItemSaving(category, item.id)"
                        (ionChange)="toggleItemSelection(category, item.id)">
                      </ion-checkbox>
                      <ion-label class="item-label" (click)="showFullText(item)">
                        <h3>{{ item.name }}</h3>
                        <p class="item-text clickable" *ngIf="item.text">{{ item.text }}</p>
                      </ion-label>
                      <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      <div class="photo-actions" *ngIf="isItemSelected(category, item.id)">
                        <!-- Upload button if no photos -->
                        <ion-button 
                          *ngIf="getPhotoCount(category, item.id) === 0"
                          size="small" 
                          fill="outline" 
                          color="primary" 
                          (click)="uploadDocument(category, item.id, item)">
                          <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
                        </ion-button>
                        
                        <!-- Photo display with icons if photos exist -->
                        <div class="photo-display" *ngIf="getPhotoCount(category, item.id) > 0">
                          <div class="photo-item" *ngFor="let photo of getPhotosForVisual(category, item.id)">
                            <span class="photo-name">{{ photo.name || 'Photo' }}</span>
                            <div class="photo-icons">
                              <ion-button size="small" fill="clear" (click)="viewPhoto(photo, category, item.id)" title="View">
                                <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                              <ion-button size="small" fill="clear" (click)="replacePhoto(photo, category, item.id)" title="Replace">
                                <ion-icon name="swap-horizontal-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                              <ion-button size="small" fill="clear" (click)="addAnotherPhoto(category, item.id)" title="Add Another">
                                <ion-icon name="add-circle-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </ion-item>
                  </div>
                </div>
                
                <!-- Deficiencies Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].deficiencies && organizedData[category].deficiencies.length > 0">
                  <h4 class="type-header">Deficiencies</h4>
                  <div class="template-item" *ngFor="let item of organizedData[category].deficiencies">
                    <ion-item lines="none" class="checkbox-item">
                      <ion-checkbox 
                        slot="start" 
                        [checked]="isItemSelected(category, item.id)"
                        [disabled]="isItemSaving(category, item.id)"
                        (ionChange)="toggleItemSelection(category, item.id)">
                      </ion-checkbox>
                      <ion-label class="item-label" (click)="showFullText(item)">
                        <h3>{{ item.name }}</h3>
                        <p class="item-text clickable" *ngIf="item.text">{{ item.text }}</p>
                      </ion-label>
                      <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      <div class="photo-actions" *ngIf="isItemSelected(category, item.id)">
                        <!-- Upload button if no photos -->
                        <ion-button 
                          *ngIf="getPhotoCount(category, item.id) === 0"
                          size="small" 
                          fill="outline" 
                          color="primary" 
                          (click)="uploadDocument(category, item.id, item)">
                          <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
                        </ion-button>
                        
                        <!-- Photo display with icons if photos exist -->
                        <div class="photo-display" *ngIf="getPhotoCount(category, item.id) > 0">
                          <div class="photo-item" *ngFor="let photo of getPhotosForVisual(category, item.id)">
                            <span class="photo-name">{{ photo.name || 'Photo' }}</span>
                            <div class="photo-icons">
                              <ion-button size="small" fill="clear" (click)="viewPhoto(photo, category, item.id)" title="View">
                                <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                              <ion-button size="small" fill="clear" (click)="replacePhoto(photo, category, item.id)" title="Replace">
                                <ion-icon name="swap-horizontal-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                              <ion-button size="small" fill="clear" (click)="addAnotherPhoto(category, item.id)" title="Add Another">
                                <ion-icon name="add-circle-outline" slot="icon-only"></ion-icon>
                              </ion-button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </ion-item>
                  </div>
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </div>

        <!-- Loading indicator if categories haven't loaded yet -->
        <div class="placeholder-message" *ngIf="visualCategories.length === 0">
          <ion-spinner name="crescent"></ion-spinner>
          Loading visual categories...
        </div>
      </div>
    </div>

    <!-- Elevation Plot Section -->
    <div class="section-card">
      <div class="section-header" (click)="toggleSection('elevation')">
        <div class="section-info">
          <div class="section-title">
            <ion-icon name="analytics-outline"></ion-icon>
            Elevation Plot
          </div>
          <div class="section-description">Floor elevation measurements and analysis</div>
        </div>
        <div class="section-toggle">
          <span class="completion-badge" [class.complete]="getSectionCompletion('elevation') === 100">
            {{ getSectionCompletion('elevation') }}%
          </span>
          <ion-icon [name]="expandedSections['elevation'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>

      <div class="section-content" *ngIf="expandedSections['elevation']">
        <!-- Elevation measurements grid -->
        <div class="elevation-controls">
          <ion-button size="small" (click)="addElevationReading()">
            <ion-icon name="add" slot="start"></ion-icon>
            Add Reading
          </ion-button>
          <ion-button size="small" (click)="clearElevationReadings()" color="danger">
            <ion-icon name="trash" slot="start"></ion-icon>
            Clear All
          </ion-button>
        </div>

        <div class="elevation-grid" *ngIf="elevationReadings.length > 0">
          <div class="elevation-header">
            <div>Location</div>
            <div>Reading (inches)</div>
            <div>Actions</div>
          </div>
          <div class="elevation-row" *ngFor="let reading of elevationReadings; let i = index">
            <input type="text" [(ngModel)]="reading.location" placeholder="Room/Location">
            <input type="number" [(ngModel)]="reading.value" placeholder="0.0" step="0.1">
            <ion-button size="small" fill="clear" color="danger" (click)="removeElevationReading(i)">
              <ion-icon name="close-circle-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <div class="form-group">
          <label>Elevation Analysis</label>
          <ion-textarea [(ngModel)]="formData.elevationAnalysis" 
                        rows="6" 
                        placeholder="Enter analysis of elevation data...">
          </ion-textarea>
        </div>

        <!-- Placeholder for more fields you'll specify -->
        <div class="placeholder-message">
          Additional elevation plot fields will be added here based on your specifications.
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="form-actions">
      <ion-button expand="block" size="large" (click)="submitTemplate()">
        Submit Evaluation
      </ion-button>
    </div>
  </div>
  
  <!-- File upload input (hidden) -->
  <input 
    #fileInput 
    type="file" 
    style="display: none" 
    (change)="handleFileSelect($event)"
    accept="image/*,.pdf,.doc,.docx">
</ion-content>