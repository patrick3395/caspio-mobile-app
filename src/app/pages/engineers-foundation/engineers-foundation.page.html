<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/active-projects"></ion-back-button>
    </ion-buttons>
    <ion-title>Engineer's Foundation Evaluation</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="generatePDF()">
        <ion-icon name="document-text-outline"></ion-icon>
        <span style="margin-left: 5px;">PDF</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="template-container">
    <!-- Version Header -->
    <div class="version-header">Version 1.4.178 - Complete Elevation Plot v1.4.65 restoration</div>
    
    <!-- Save status indicator -->
    <div class="save-status" *ngIf="saveStatus" [class.info]="saveStatusType === 'info'" 
         [class.success]="saveStatusType === 'success'" [class.error]="saveStatusType === 'error'">
      {{ saveStatus }}
    </div>

    <!-- Project Information Section (Shared across all services) -->
    <div class="section-card">
      <div class="section-header" data-section="project" (click)="toggleSection('project')">
        <div class="section-info">
          <div class="section-title" [class.complete]="getProjectCompletion() === 100">
            <ion-icon name="information-circle-outline"></ion-icon>
            Project Information
          </div>
        </div>
        <div class="section-toggle">
          <span class="completion-badge" [class.complete]="getProjectCompletion() === 100">
            {{ getProjectCompletion() }}%
          </span>
          <ion-icon [name]="expandedSections['project'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>
      
      <div class="section-content" [class.expanded]="expandedSections['project']">
        <!-- People & Roles -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="people-outline"></ion-icon>
            People & Roles
          </h3>
          <div class="form-grid three-col">
            <!-- Client Name -->
            <div class="form-group" [class.filled]="projectData.ClientName">
              <label>
                <ion-icon name="person-outline"></ion-icon>
                Client Name<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.ClientName" name="ClientName"
                     (ngModelChange)="onProjectFieldChange('ClientName', $event)"
                     placeholder="Enter client name"
                     required
                     class="styled-input">
            </div>

            <!-- Agent Name -->
            <div class="form-group" [class.filled]="projectData.AgentName">
              <label>
                <ion-icon name="briefcase-outline"></ion-icon>
                Agent Name<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.AgentName" name="AgentName"
                     (ngModelChange)="onProjectFieldChange('AgentName', $event)"
                     placeholder="Enter agent name"
                     required
                     class="styled-input">
            </div>

            <!-- Inspector Name -->
            <div class="form-group" [class.filled]="projectData.InspectorName">
              <label>
                <ion-icon name="clipboard-outline"></ion-icon>
                Inspector Name<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.InspectorName" name="InspectorName"
                     (ngModelChange)="onProjectFieldChange('InspectorName', $event)"
                     placeholder="Enter inspector name"
                     required
                     class="styled-input">
            </div>

            <!-- In Attendance -->
            <div class="form-group full-width" [class.filled]="serviceData.InAttendance">
              <label>
                <ion-icon name="people-circle-outline"></ion-icon>
                In Attendance<span class="required">*</span>
              </label>
              <select [(ngModel)]="serviceData.InAttendance" name="InAttendance"
                      (ngModelChange)="onServiceFieldChange('InAttendance', $event)"
                      required
                      class="styled-input">
                <option value="">Select who was present</option>
                <option *ngFor="let option of inAttendanceOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Property Details -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="home-outline"></ion-icon>
            Property Details
          </h3>
          <div class="form-grid three-col">

            <!-- Year Built -->
            <div class="form-group" [class.filled]="projectData.YearBuilt">
              <label>
                <ion-icon name="calendar-outline"></ion-icon>
                Year Built<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.YearBuilt" name="YearBuilt"
                     (ngModelChange)="onProjectFieldChange('YearBuilt', $event)"
                     placeholder="e.g., 1985"
                     required
                     class="styled-input">
            </div>

            <!-- Square Feet -->
            <div class="form-group" [class.filled]="projectData.SquareFeet">
              <label>
                <ion-icon name="resize-outline"></ion-icon>
                Square Feet<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.SquareFeet" name="SquareFeet"
                     (ngModelChange)="onProjectFieldChange('SquareFeet', $event)"
                     placeholder="e.g., 2500"
                     required
                     class="styled-input">
            </div>

            <!-- Type of Building -->
            <div class="form-group" [class.filled]="projectData.TypeOfBuilding">
              <label>
                <ion-icon name="business-outline"></ion-icon>
                Building Type<span class="required">*</span>
              </label>
              <select [(ngModel)]="projectData.TypeOfBuilding" name="TypeOfBuilding"
                      (ngModelChange)="onProjectFieldChange('TypeOfBuilding', $event)"
                      required
                      class="styled-input">
                <option value="">Select type</option>
                <option *ngFor="let option of typeOfBuildingOptions" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Style -->
            <div class="form-group" [class.filled]="projectData.Style">
              <label>
                <ion-icon name="home-outline"></ion-icon>
                Style<span class="required">*</span>
              </label>
              <select [(ngModel)]="projectData.Style" name="Style"
                      (ngModelChange)="onProjectFieldChange('Style', $event)"
                      required
                      class="styled-input">
                <option value="">Select style</option>
                <option *ngFor="let option of styleOptions" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Occupancy Furnishings -->
            <div class="form-group" [class.filled]="serviceData.OccupancyFurnishings">
              <label>
                <ion-icon name="bed-outline"></ion-icon>
                Occupancy Status<span class="required">*</span>
              </label>
              <select [(ngModel)]="serviceData.OccupancyFurnishings" name="OccupancyFurnishings"
                      (ngModelChange)="onServiceFieldChange('OccupancyFurnishings', $event)"
                      required
                      class="styled-input">
                <option value="">Select status</option>
                <option *ngFor="let option of occupancyFurnishingsOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Environmental Conditions -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="partly-sunny-outline"></ion-icon>
            Environmental Conditions
          </h3>
          <div class="form-grid two-col">

            <!-- Weather Conditions -->
            <div class="form-group" [class.filled]="serviceData.WeatherConditions">
              <label>
                <ion-icon name="cloud-outline"></ion-icon>
                Weather Conditions<span class="required">*</span>
              </label>
              <select [(ngModel)]="serviceData.WeatherConditions" name="WeatherConditions"
                      (ngModelChange)="onServiceFieldChange('WeatherConditions', $event)"
                      required
                      class="styled-input">
                <option value="">Select weather</option>
                <option *ngFor="let option of weatherConditionsOptions" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Outdoor Temperature -->
            <div class="form-group" [class.filled]="serviceData.OutdoorTemperature">
              <label>
                <ion-icon name="thermometer-outline"></ion-icon>
                Outdoor Temperature<span class="required">*</span>
              </label>
              <select [(ngModel)]="serviceData.OutdoorTemperature" name="OutdoorTemperature"
                      (ngModelChange)="onServiceFieldChange('OutdoorTemperature', $event)"
                      required
                      class="styled-input">
                <option value="">Select temperature</option>
                <option *ngFor="let option of outdoorTemperatureOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Foundation Details -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="layers-outline"></ion-icon>
            Foundation Details
          </h3>
          <div class="form-grid two-col">
            
            <!-- First Foundation Type -->
            <div class="form-group" [class.filled]="serviceData.FirstFoundationType">
              <label>
                <ion-icon name="construct-outline"></ion-icon>
                First Foundation Type
              </label>
              <select [(ngModel)]="serviceData.FirstFoundationType" name="FirstFoundationType"
                      (ngModelChange)="onServiceFieldChange('FirstFoundationType', $event)"
                      class="styled-input">
                <option value="">Select type</option>
                <option *ngFor="let option of firstFoundationTypeOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
            
            <!-- Second Foundation Type -->
            <div class="form-group" [class.filled]="serviceData.SecondFoundationType">
              <label>
                <ion-icon name="construct-outline"></ion-icon>
                Second Foundation Type
              </label>
              <select [(ngModel)]="serviceData.SecondFoundationType" name="SecondFoundationType"
                      (ngModelChange)="onServiceFieldChange('SecondFoundationType', $event)"
                      class="styled-input">
                <option value="">Select type (if applicable)</option>
                <option *ngFor="let option of secondFoundationTypeOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
            
            <!-- Second Foundation Rooms -->
            <div class="form-group" [class.filled]="serviceData.SecondFoundationRooms"
                 *ngIf="serviceData.SecondFoundationType && serviceData.SecondFoundationType !== 'None'">
              <label>
                <ion-icon name="home-outline"></ion-icon>
                Second Foundation Rooms
              </label>
              <select [(ngModel)]="serviceData.SecondFoundationRooms" name="SecondFoundationRooms"
                      (ngModelChange)="onServiceFieldChange('SecondFoundationRooms', $event)"
                      class="styled-input">
                <option value="">Select rooms</option>
                <option *ngFor="let option of secondFoundationRoomsOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
            
            <!-- Third Foundation Type -->
            <div class="form-group" [class.filled]="serviceData.ThirdFoundationType">
              <label>
                <ion-icon name="construct-outline"></ion-icon>
                Third Foundation Type
              </label>
              <select [(ngModel)]="serviceData.ThirdFoundationType" name="ThirdFoundationType"
                      (ngModelChange)="onServiceFieldChange('ThirdFoundationType', $event)"
                      class="styled-input">
                <option value="">Select type (if applicable)</option>
                <option *ngFor="let option of thirdFoundationTypeOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
            
            <!-- Third Foundation Rooms -->
            <div class="form-group" [class.filled]="serviceData.ThirdFoundationRooms"
                 *ngIf="serviceData.ThirdFoundationType && serviceData.ThirdFoundationType !== 'None'">
              <label>
                <ion-icon name="home-outline"></ion-icon>
                Third Foundation Rooms
              </label>
              <select [(ngModel)]="serviceData.ThirdFoundationRooms" name="ThirdFoundationRooms"
                      (ngModelChange)="onServiceFieldChange('ThirdFoundationRooms', $event)"
                      class="styled-input">
                <option value="">Select rooms</option>
                <option *ngFor="let option of thirdFoundationRoomsOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
            
            <!-- Owner/Occupant Interview -->
            <div class="form-group" [class.filled]="serviceData.OwnerOccupantInterview">
              <label>
                <ion-icon name="chatbubbles-outline"></ion-icon>
                Owner/Occupant Interview
              </label>
              <select [(ngModel)]="serviceData.OwnerOccupantInterview" name="OwnerOccupantInterview"
                      (ngModelChange)="onServiceFieldChange('OwnerOccupantInterview', $event)"
                      class="styled-input">
                <option value="">Select status</option>
                <option *ngFor="let option of ownerOccupantInterviewOptions" [value]="option">{{ option }}</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Structural Systems Section -->
    <div class="section-card">
      <div class="section-header" data-section="structural" (click)="toggleSection('structural')">
        <div class="section-info">
          <div class="section-title" [class.complete]="getSectionCompletion('structural') === 100">
            <ion-icon name="construct-outline"></ion-icon>
            Structural Systems
          </div>
        </div>
        <div class="section-toggle">
          <span class="completion-badge" [class.complete]="getSectionCompletion('structural') === 100">
            {{ getSectionCompletion('structural') }}%
          </span>
          <ion-icon [name]="expandedSections['structural'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>

      <div class="section-content" [class.expanded]="expandedSections['structural']">
        <!-- Visual Categories from Services_Visuals_Templates -->
        <div class="categories-container" *ngIf="visualCategories.length > 0">
          
          <!-- Category Accordion -->
          <ion-accordion-group #visualAccordionGroup (ionChange)="onAccordionChange($event)">
            <ion-accordion *ngFor="let category of visualCategories; trackBy: trackByCategory" [value]="category">
              <ion-item slot="header" color="light">
                <ion-label>
                  <h2 style="font-size: 15px; font-weight: 600;">{{ category }}</h2>
                  <p style="font-size: 12px; color: #666;">{{ getTemplatesCountForCategory(category) }} items</p>
                </ion-label>
              </ion-item>
              
              <div class="category-content" slot="content">
                <!-- Comments Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].comments">
                  <h4 class="type-header">
                    Comments
                    <button class="add-visual-btn" (click)="addCustomVisual(category, 'Comment')" title="Add custom comment">
                      <ion-icon name="add-circle-outline"></ion-icon>
                    </button>
                  </h4>
                  <div *ngIf="organizedData[category].comments.length === 0" class="no-items-message">
                    No comments yet. Click + to add one.
                  </div>
                  <div class="template-item" *ngFor="let item of organizedData[category].comments">
                    <div class="visual-item-container" [class.selected]="isItemSelected(category, item.id)">
                      <!-- Yes/No questions - no checkbox, direct dropdown -->
                      <ion-item lines="none" class="checkbox-item" *ngIf="item.answerType === 1">
                        <ion-label class="item-label">
                          <h3>
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                          <p class="item-text" *ngIf="item.text">{{ item.text }}</p>
                        </ion-label>
                        <ion-select 
                          [(ngModel)]="item.text" 
                          placeholder="Select"
                          interface="popover"
                          (ionChange)="onAnswerChange(category, item)"
                          [disabled]="isItemSaving(category, item.id)"
                          slot="end"
                          class="answer-select">
                          <ion-select-option value="">None</ion-select-option>
                          <ion-select-option value="Yes">Yes</ion-select-option>
                          <ion-select-option value="No">No</ion-select-option>
                        </ion-select>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      </ion-item>
                      
                      <!-- Multi-select questions - show checkboxes for each option -->
                      <div class="multi-select-container" *ngIf="item.answerType === 2">
                        <ion-item lines="none" class="checkbox-item">
                          <ion-label class="item-label">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <p class="item-text" *ngIf="item.text">{{ item.text }}</p>
                          </ion-label>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                        </ion-item>
                        <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                          <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]" class="option-item">
                            <ion-checkbox 
                              slot="start"
                              [checked]="isOptionSelected(item, option)"
                              (ionChange)="onOptionToggle(category, item, option, $event)"
                              [disabled]="isItemSaving(category, item.id)">
                            </ion-checkbox>
                            <ion-label>{{ option }}</ion-label>
                          </ion-item>
                        </div>
                        <div class="no-options-message" *ngIf="!visualDropdownOptions[item.templateId] || visualDropdownOptions[item.templateId].length === 0">
                          <p>No options available for this item</p>
                        </div>
                      </div>
                      
                      <!-- Text questions - keep original checkbox behavior -->
                      <ion-item lines="none" class="checkbox-item" *ngIf="!item.answerType || item.answerType === 0">
                        <ion-checkbox 
                          slot="start" 
                          [checked]="isItemSelected(category, item.id)"
                          [disabled]="isItemSaving(category, item.id)"
                          (ionChange)="toggleItemSelection(category, item.id)">
                        </ion-checkbox>
                        <ion-label class="item-label" (click)="showFullText(item)">
                          <h3>
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                          <p class="item-text clickable" *ngIf="item.text" title="Click to view/edit full text">{{ item.text }}</p>
                        </ion-label>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      </ion-item>
                      
                      <!-- Image preview section below the item (only for text questions) -->
                      <div class="image-preview-section" *ngIf="isItemSelected(category, item.id) && (!item.answerType || item.answerType === 0)">
                        <!-- Upload status indicator -->
                        <div class="upload-status" *ngIf="isUploadingPhotos(category, item.id)">
                          <ion-spinner name="dots" color="primary"></ion-spinner>
                          <span>Uploading {{ getUploadingCount(category, item.id) }} photo(s)...</span>
                        </div>
                        <div class="image-preview-container">
                          <div class="image-preview" *ngFor="let photo of getPhotosForVisual(category, item.id)" [class.uploading]="photo.uploading">
                            <img [src]="photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'" 
                                 [alt]="photo.name" 
                                 (click)="viewPhoto(photo, category, item.id)"
                                 (error)="handleImageError($event, photo)">
                            <div class="upload-indicator" *ngIf="photo.uploading">
                              <ion-spinner name="crescent" color="light"></ion-spinner>
                            </div>
                            <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, category, item.id); $event.stopPropagation()" title="Delete">
                              <ion-icon name="close"></ion-icon>
                            </button>
                            <input 
                              type="text" 
                              class="image-caption" 
                              [(ngModel)]="photo.caption" 
                              (blur)="saveCaption(photo, category, item.id)"
                              (click)="$event.stopPropagation()"
                              placeholder="Add caption..."
                              maxlength="255">
                          </div>
                          <button class="add-more-btn" (click)="addAnotherPhoto(category, item.id)" title="Add more photos (multiple selection supported)">
                            <ion-icon name="add-circle-outline"></ion-icon>
                            <span>Add Photos</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Limitations Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].limitations">
                  <h4 class="type-header">
                    Limitations
                    <button class="add-visual-btn" (click)="addCustomVisual(category, 'Limitation')" title="Add custom limitation">
                      <ion-icon name="add-circle-outline"></ion-icon>
                    </button>
                  </h4>
                  <div *ngIf="organizedData[category].limitations.length === 0" class="no-items-message">
                    No limitations yet. Click + to add one.
                  </div>
                  <div class="template-item" *ngFor="let item of organizedData[category].limitations">
                    <div class="visual-item-container" [class.selected]="isItemSelected(category, item.id)">
                      <!-- Yes/No questions - no checkbox, direct dropdown -->
                      <ion-item lines="none" class="checkbox-item" *ngIf="item.answerType === 1">
                        <ion-label class="item-label">
                          <h3>
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                          <p class="item-text" *ngIf="item.text">{{ item.text }}</p>
                        </ion-label>
                        <ion-select 
                          [(ngModel)]="item.text" 
                          placeholder="Select"
                          interface="popover"
                          (ionChange)="onAnswerChange(category, item)"
                          [disabled]="isItemSaving(category, item.id)"
                          slot="end"
                          class="answer-select">
                          <ion-select-option value="">None</ion-select-option>
                          <ion-select-option value="Yes">Yes</ion-select-option>
                          <ion-select-option value="No">No</ion-select-option>
                        </ion-select>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      </ion-item>
                      
                      <!-- Multi-select questions - show checkboxes for each option -->
                      <div class="multi-select-container" *ngIf="item.answerType === 2">
                        <ion-item lines="none" class="checkbox-item">
                          <ion-label class="item-label">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <p class="item-text" *ngIf="item.text">{{ item.text }}</p>
                          </ion-label>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                        </ion-item>
                        <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                          <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]" class="option-item">
                            <ion-checkbox 
                              slot="start"
                              [checked]="isOptionSelected(item, option)"
                              (ionChange)="onOptionToggle(category, item, option, $event)"
                              [disabled]="isItemSaving(category, item.id)">
                            </ion-checkbox>
                            <ion-label>{{ option }}</ion-label>
                          </ion-item>
                        </div>
                        <div class="no-options-message" *ngIf="!visualDropdownOptions[item.templateId] || visualDropdownOptions[item.templateId].length === 0">
                          <p>No options available for this item</p>
                        </div>
                      </div>
                      
                      <!-- Text questions - keep original checkbox behavior -->
                      <ion-item lines="none" class="checkbox-item" *ngIf="!item.answerType || item.answerType === 0">
                        <ion-checkbox 
                          slot="start" 
                          [checked]="isItemSelected(category, item.id)"
                          [disabled]="isItemSaving(category, item.id)"
                          (ionChange)="toggleItemSelection(category, item.id)">
                        </ion-checkbox>
                        <ion-label class="item-label" (click)="showFullText(item)">
                          <h3>
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                          <p class="item-text clickable" *ngIf="item.text" title="Click to view/edit full text">{{ item.text }}</p>
                        </ion-label>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      </ion-item>
                      
                      <!-- Image preview section below the item (only for text questions) -->
                      <div class="image-preview-section" *ngIf="isItemSelected(category, item.id) && (!item.answerType || item.answerType === 0)">
                        <!-- Upload status indicator -->
                        <div class="upload-status" *ngIf="isUploadingPhotos(category, item.id)">
                          <ion-spinner name="dots" color="primary"></ion-spinner>
                          <span>Uploading {{ getUploadingCount(category, item.id) }} photo(s)...</span>
                        </div>
                        <div class="image-preview-container">
                          <div class="image-preview" *ngFor="let photo of getPhotosForVisual(category, item.id)" [class.uploading]="photo.uploading">
                            <img [src]="photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'" 
                                 [alt]="photo.name" 
                                 (click)="viewPhoto(photo, category, item.id)"
                                 (error)="handleImageError($event, photo)">
                            <div class="upload-indicator" *ngIf="photo.uploading">
                              <ion-spinner name="crescent" color="light"></ion-spinner>
                            </div>
                            <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, category, item.id); $event.stopPropagation()" title="Delete">
                              <ion-icon name="close"></ion-icon>
                            </button>
                            <input 
                              type="text" 
                              class="image-caption" 
                              [(ngModel)]="photo.caption" 
                              (blur)="saveCaption(photo, category, item.id)"
                              (click)="$event.stopPropagation()"
                              placeholder="Add caption..."
                              maxlength="255">
                          </div>
                          <button class="add-more-btn" (click)="addAnotherPhoto(category, item.id)" title="Add more photos (multiple selection supported)">
                            <ion-icon name="add-circle-outline"></ion-icon>
                            <span>Add Photos</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Deficiencies Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].deficiencies">
                  <h4 class="type-header">
                    Deficiencies
                    <button class="add-visual-btn" (click)="addCustomVisual(category, 'Deficiency')" title="Add custom deficiency">
                      <ion-icon name="add-circle-outline"></ion-icon>
                    </button>
                  </h4>
                  <div *ngIf="organizedData[category].deficiencies.length === 0" class="no-items-message">
                    No deficiencies yet. Click + to add one.
                  </div>
                  <div class="template-item" *ngFor="let item of organizedData[category].deficiencies">
                    <div class="visual-item-container" [class.selected]="isItemSelected(category, item.id)">
                      <!-- Yes/No questions - no checkbox, direct dropdown -->
                      <ion-item lines="none" class="checkbox-item" *ngIf="item.answerType === 1">
                        <ion-label class="item-label">
                          <h3>
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                          <p class="item-text" *ngIf="item.text">{{ item.text }}</p>
                        </ion-label>
                        <ion-select 
                          [(ngModel)]="item.text" 
                          placeholder="Select"
                          interface="popover"
                          (ionChange)="onAnswerChange(category, item)"
                          [disabled]="isItemSaving(category, item.id)"
                          slot="end"
                          class="answer-select">
                          <ion-select-option value="">None</ion-select-option>
                          <ion-select-option value="Yes">Yes</ion-select-option>
                          <ion-select-option value="No">No</ion-select-option>
                        </ion-select>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      </ion-item>
                      
                      <!-- Multi-select questions - show checkboxes for each option -->
                      <div class="multi-select-container" *ngIf="item.answerType === 2">
                        <ion-item lines="none" class="checkbox-item">
                          <ion-label class="item-label">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <p class="item-text" *ngIf="item.text">{{ item.text }}</p>
                          </ion-label>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                        </ion-item>
                        <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                          <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]" class="option-item">
                            <ion-checkbox 
                              slot="start"
                              [checked]="isOptionSelected(item, option)"
                              (ionChange)="onOptionToggle(category, item, option, $event)"
                              [disabled]="isItemSaving(category, item.id)">
                            </ion-checkbox>
                            <ion-label>{{ option }}</ion-label>
                          </ion-item>
                        </div>
                        <div class="no-options-message" *ngIf="!visualDropdownOptions[item.templateId] || visualDropdownOptions[item.templateId].length === 0">
                          <p>No options available for this item</p>
                        </div>
                      </div>
                      
                      <!-- Text questions - keep original checkbox behavior -->
                      <ion-item lines="none" class="checkbox-item" *ngIf="!item.answerType || item.answerType === 0">
                        <ion-checkbox 
                          slot="start" 
                          [checked]="isItemSelected(category, item.id)"
                          [disabled]="isItemSaving(category, item.id)"
                          (ionChange)="toggleItemSelection(category, item.id)">
                        </ion-checkbox>
                        <ion-label class="item-label" (click)="showFullText(item)">
                          <h3>
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                          <p class="item-text clickable" *ngIf="item.text" title="Click to view/edit full text">{{ item.text }}</p>
                        </ion-label>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                      </ion-item>
                      
                      <!-- Image preview section below the item (only for text questions) -->
                      <div class="image-preview-section" *ngIf="isItemSelected(category, item.id) && (!item.answerType || item.answerType === 0)">
                        <!-- Upload status indicator -->
                        <div class="upload-status" *ngIf="isUploadingPhotos(category, item.id)">
                          <ion-spinner name="dots" color="primary"></ion-spinner>
                          <span>Uploading {{ getUploadingCount(category, item.id) }} photo(s)...</span>
                        </div>
                        <div class="image-preview-container">
                          <div class="image-preview" *ngFor="let photo of getPhotosForVisual(category, item.id)" [class.uploading]="photo.uploading">
                            <img [src]="photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'" 
                                 [alt]="photo.name" 
                                 (click)="viewPhoto(photo, category, item.id)"
                                 (error)="handleImageError($event, photo)">
                            <div class="upload-indicator" *ngIf="photo.uploading">
                              <ion-spinner name="crescent" color="light"></ion-spinner>
                            </div>
                            <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, category, item.id); $event.stopPropagation()" title="Delete">
                              <ion-icon name="close"></ion-icon>
                            </button>
                            <input 
                              type="text" 
                              class="image-caption" 
                              [(ngModel)]="photo.caption" 
                              (blur)="saveCaption(photo, category, item.id)"
                              (click)="$event.stopPropagation()"
                              placeholder="Add caption..."
                              maxlength="255">
                          </div>
                          <button class="add-more-btn" (click)="addAnotherPhoto(category, item.id)" title="Add more photos (multiple selection supported)">
                            <ion-icon name="add-circle-outline"></ion-icon>
                            <span>Add Photos</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </div>

        <!-- Loading indicator if categories haven't loaded yet -->
        <div class="placeholder-message" *ngIf="visualCategories.length === 0">
          <ion-spinner name="crescent"></ion-spinner>
          Loading visual categories...
        </div>
      </div>
    </div>

    <!-- Elevation Plot Section -->
    <div class="section-card">
      <div class="section-header" data-section="elevation" (click)="toggleSection('elevation')">
        <div class="section-info">
          <div class="section-title" [class.complete]="getSectionCompletion('elevation') === 100">
            <ion-icon name="analytics-outline"></ion-icon>
            Elevation Plot
          </div>
        </div>
        <div class="section-toggle">
          <span class="completion-badge" [class.complete]="getSectionCompletion('elevation') === 100">
            {{ getSectionCompletion('elevation') }}%
          </span>
          <ion-icon [name]="expandedSections['elevation'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>

      <div class="section-content" [class.expanded]="expandedSections['elevation']">
        <!-- Room selection checkboxes -->
        <div class="room-selection" *ngIf="roomTemplates.length > 0">
          <h3 class="room-header">Select Rooms to Evaluate:</h3>
          <div class="room-grid">
            <ion-item *ngFor="let room of roomTemplates; trackBy: trackByRoomName" lines="none" class="room-checkbox">
              <ion-checkbox 
                [(ngModel)]="room.selected" 
                (ionChange)="onRoomSelectionChange(room)"
                slot="start">
              </ion-checkbox>
              <ion-label>
                {{ room.RoomName }}
                <span class="point-count" *ngIf="room.PointCount">({{ room.PointCount }} points)</span>
              </ion-label>
            </ion-item>
          </div>
        </div>

        <!-- Add Room button - always visible -->
        <div class="add-room-container">
          <button class="add-room-button" (click)="showAddRoomDialog()">
            <ion-icon name="add-circle-outline"></ion-icon>
            Add Room
          </button>
        </div>

        <!-- Selected rooms details -->
        <div class="selected-rooms" *ngIf="getSelectedRooms().length > 0">
          <h3 class="selected-rooms-header">Room Details:</h3>
          
          <div class="room-details" *ngFor="let room of getSelectedRooms(); let i = index">
            <div class="room-details-header">
              <h4 class="room-name">
                <ion-icon name="home-outline"></ion-icon>
                {{ room.RoomName }}
              </h4>
              <button class="remove-room-btn" (click)="removeRoom(room.RoomName)" title="Remove room">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>
            
            <!-- FDF Input Section -->
            <div class="fdf-input-section">
              <div class="fdf-input-container">
                <label class="fdf-label">
                  <ion-icon name="calculator-outline"></ion-icon>
                  Floor Differential Factor:
                </label>
                <ion-select 
                  [(ngModel)]="roomElevationData[room.RoomName].fdf" 
                  placeholder="Select FDF value"
                  interface="popover"
                  (ionChange)="onFDFChange(room.RoomName)"
                  class="fdf-select"
                  [disabled]="isRoomSaving(room.RoomName)">
                  <ion-select-option *ngFor="let option of getFDFOptionsForRoom(room.RoomName)" [value]="option">
                    {{ option }}
                  </ion-select-option>
                </ion-select>
                <span class="fdf-help-text" *ngIf="!roomElevationData[room.RoomName].fdf">
                  Select a value to calculate elevation differentials
                </span>
              </div>
            </div>

            <!-- Elevation Points Section -->
            <div class="elevation-points-section">
              <div class="points-section-header">
                <h5 class="points-header">
                  <ion-icon name="location-outline"></ion-icon>
                  Elevation Points
                </h5>
                <button class="add-point-btn" (click)="addCustomPoint(room.RoomName)" title="Add custom elevation point">
                  <ion-icon name="add-circle-outline"></ion-icon>
                  Add Point
                </button>
              </div>
              
              <!-- Points List -->
              <div class="elevation-points-list" *ngIf="roomElevationData[room.RoomName]?.elevationPoints?.length > 0">
                <div class="point-item" *ngFor="let point of roomElevationData[room.RoomName].elevationPoints; let pointIndex = index">
                  <div class="point-row">
                    <div class="point-info">
                      <span class="point-number">{{ pointIndex + 1 }}.</span>
                      <span class="point-name">{{ point.name }}</span>
                      <span class="photo-indicator" *ngIf="point.photos && point.photos.length > 0">
                        <ion-icon name="image-outline"></ion-icon>
                        {{ point.photos.length }}
                      </span>
                    </div>
                    
                    <div class="point-actions">
                      <!-- Elevation input -->
                      <div class="elevation-input">
                        <input 
                          type="number" 
                          [(ngModel)]="point.elevation" 
                          (blur)="onElevationChange(room.RoomName, point)"
                          placeholder="0.00"
                          class="elevation-value"
                          step="0.01">
                        <span class="elevation-unit">inches</span>
                      </div>
                      
                      <!-- Camera button -->
                      <button class="camera-button" 
                              (click)="capturePhotoForPoint(room.RoomName, point, $event)" 
                              title="Add Photos">
                        <ion-icon name="camera-outline"></ion-icon>
                        <span *ngIf="point.photoCount > 0" class="photo-count-badge">{{ point.photoCount }}</span>
                      </button>
                      
                      <!-- Delete point button -->
                      <button class="delete-point-btn" 
                              (click)="deleteElevationPoint(room.RoomName, point)" 
                              title="Delete point">
                        <ion-icon name="close-circle-outline"></ion-icon>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Photo previews for this point -->
                  <div class="photo-previews" *ngIf="point.photos && point.photos.length > 0">
                    <div class="photo-preview" *ngFor="let photo of point.photos">
                      <img [src]="photo.thumbnailUrl || photo.url" 
                           [alt]="photo.name" 
                           (click)="viewRoomPhoto(photo, room.RoomName, point)"
                           (error)="handleImageError($event, photo)">
                      <button class="delete-photo-btn" 
                              (click)="deleteRoomPhoto(photo, room.RoomName, point); $event.stopPropagation()" 
                              title="Delete photo">
                        <ion-icon name="close"></ion-icon>
                      </button>
                      <input 
                        type="text" 
                        class="photo-caption" 
                        [(ngModel)]="photo.caption" 
                        (blur)="saveRoomPhotoCaption(photo, room.RoomName, point)"
                        (click)="$event.stopPropagation()"
                        placeholder="Add caption..."
                        maxlength="255">
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- No points message -->
              <div class="no-points-message" *ngIf="!roomElevationData[room.RoomName]?.elevationPoints || roomElevationData[room.RoomName].elevationPoints.length === 0">
                <ion-icon name="location-outline"></ion-icon>
                <p>No elevation points added yet. Click "Add Point" to create measurement points.</p>
              </div>
            </div>

            <!-- Room Notes Section -->
            <div class="room-notes-section">
              <label class="notes-label">
                <ion-icon name="create-outline"></ion-icon>
                Notes:
              </label>
              <ion-textarea 
                [(ngModel)]="roomElevationData[room.RoomName].notes" 
                rows="4"
                placeholder="Add notes for {{ room.RoomName }}... (e.g., observations, special conditions, etc.)"
                (ionBlur)="onRoomNotesChange(room.RoomName)"
                class="notes-textarea">
              </ion-textarea>
            </div>
            
            <!-- Room calculations summary -->
            <div class="room-summary" *ngIf="roomElevationData[room.RoomName]?.elevationPoints?.length > 0 && roomElevationData[room.RoomName].fdf">
              <div class="summary-item">
                <span class="summary-label">Total Points:</span>
                <span class="summary-value">{{ roomElevationData[room.RoomName].elevationPoints.length }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">FDF Value:</span>
                <span class="summary-value">{{ roomElevationData[room.RoomName].fdf }}</span>
              </div>
              <div class="summary-item" *ngIf="getRoomMaxDifferential(room.RoomName) !== null">
                <span class="summary-label">Max Differential:</span>
                <span class="summary-value" [class.warning]="getRoomMaxDifferential(room.RoomName) > 1.0">
                  {{ getRoomMaxDifferential(room.RoomName) | number:'1.2-2' }} inches
                </span>
              </div>
            </div>
            
            <!-- Save status indicator -->
            <div class="save-status-inline" *ngIf="isRoomSaving(room.RoomName)">
              <ion-spinner name="crescent"></ion-spinner>
              <span>Saving room data...</span>
            </div>
          </div>
        </div>

        <!-- No selected rooms message -->
        <div class="no-selected-rooms" *ngIf="roomTemplates.length > 0 && getSelectedRooms().length === 0">
          <ion-icon name="checkbox-outline"></ion-icon>
          <p>Select rooms above to add elevation measurements</p>
        </div>

        <!-- No rooms available message -->
        <div class="no-rooms-message" *ngIf="roomTemplates.length === 0">
          <ion-icon name="home-outline"></ion-icon>
          <p>No room templates found. Click "Add Room" to select from available templates.</p>
        </div>
      </div>
    </div>

  </div>
  
  <!-- File upload input (hidden, supports multiple files) -->
  <input 
    #fileInput 
    type="file" 
    multiple
    style="display: none" 
    (change)="handleFileSelect($event)"
    accept="image/*,.pdf,.doc,.docx">

  <!-- Floating Back to Top Button -->
  <button class="floating-back-to-top" (click)="scrollToCurrentSectionTop()" [class.visible]="showBackToTop">
    <ion-icon name="arrow-up"></ion-icon>
  </button>
</ion-content>