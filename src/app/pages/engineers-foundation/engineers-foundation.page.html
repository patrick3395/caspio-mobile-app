<ion-header>
  <ion-toolbar color="primary" class="template-toolbar">
    <div slot="start" style="pointer-events: auto; z-index: 10001;">
      <button id="eng-back-btn" 
              (click)="goBack($event)"
              type="button"
              style="cursor: pointer;">
        <ion-icon name="arrow-back" style="pointer-events: none;"></ion-icon>
      </button>
    </div>
    <ion-title class="toolbar-title">
      {{ platform.isWeb() ? typeFull : typeShort }}
      <ion-icon *ngIf="serviceData?.ReportFinalized" name="checkmark-circle" class="finalized-check-icon"></ion-icon>
    </ion-title>
    <div slot="end" class="template-toolbar-actions">
      <button id="eng-pdf-btn" (click)="generatePDF()">
        <ion-icon name="document-text-outline"></ion-icon>
      </button>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Auto-Sync OFF Warning Banner - Fixed at top (Mobile only) -->
  <div class="offline-warning-banner-fixed" *ngIf="manualOffline && !platform.isWeb()">
    <ion-icon name="warning"></ion-icon>
    <div class="warning-content">
      <strong>Auto-Sync is OFF</strong>
      <span>Changes saved locally</span>
    </div>
    <button class="enable-sync-btn" (click)="toggleManualOffline()">
      <ion-icon name="cloud-upload"></ion-icon>
      Enable
    </button>
  </div>

  <div class="template-container" [class.has-banner]="manualOffline">

    <!-- Project Information Section (Shared across all services) -->
    <div class="section-card">
      <div class="section-header" data-section="project" (click)="toggleSection('project')">
        <div class="section-info">
          <div class="section-title">
            <ion-icon name="information-circle-outline"></ion-icon>
            Project Information
          </div>
        </div>
        <div class="section-toggle">
          <ion-icon [name]="expandedSections['project'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>
      
      <div class="section-content" *ngIf="expandedSections['project']">
        <!-- People -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="people-outline"></ion-icon>
            People
          </h3>
          <div class="form-grid three-col">
            <!-- Client Name -->
            <div class="form-group" [class.filled]="projectData.ClientName">
              <label>
                <ion-icon name="person-outline"></ion-icon>
                Client Name<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.ClientName" name="ClientName"
                     (ngModelChange)="onProjectFieldChange('ClientName', $event)"
                     placeholder="Enter client name"
                     required
                     class="styled-input">
            </div>

            <!-- Agent Name -->
            <div class="form-group" [class.filled]="projectData.AgentName">
              <label>
                <ion-icon name="briefcase-outline"></ion-icon>
                Agent Name
              </label>
              <input type="text" [(ngModel)]="projectData.AgentName" name="AgentName"
                     (ngModelChange)="onProjectFieldChange('AgentName', $event)"
                     placeholder="Enter agent name"
                     class="styled-input">
            </div>

            <!-- Inspector Name -->
            <div class="form-group" [class.filled]="projectData.InspectorName">
              <label>
                <ion-icon name="clipboard-outline"></ion-icon>
                Inspector Name<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.InspectorName" name="InspectorName"
                     (ngModelChange)="onProjectFieldChange('InspectorName', $event)"
                     placeholder="Enter inspector name"
                     required
                     class="styled-input">
            </div>

            <!-- In Attendance - Multi-Select -->
            <div class="form-group full-width" [class.filled]="inAttendanceSelections && inAttendanceSelections.length > 0">
              <label>
                <ion-icon name="people-circle-outline"></ion-icon>
                In Attendance
              </label>
              <div class="multi-select-container-inline">
                <div class="multi-select-options-inline">
                  <div class="option-item-inline" *ngFor="let option of inAttendanceOptions; trackBy: trackByOption">
                    <ion-checkbox
                      [checked]="isInAttendanceSelected(option)"
                      (ionChange)="onInAttendanceToggle(option, $event)">
                    </ion-checkbox>
                    <ion-label>{{ option }}</ion-label>
                  </div>
                </div>
                <!-- Custom input for "Other" option -->
                <div class="other-input-container" *ngIf="isInAttendanceSelected('Other')">
                  <input type="text"
                         [(ngModel)]="inAttendanceOtherValue"
                         (blur)="onInAttendanceOtherChange()"
                         (click)="$event.stopPropagation()"
                         placeholder="Please specify..."
                         class="styled-input other-input">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Property Details -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="home-outline"></ion-icon>
            Property Details
          </h3>
          <div class="form-grid three-col">

            <!-- Year Built -->
            <div class="form-group" [class.filled]="projectData.YearBuilt">
              <label>
                <ion-icon name="calendar-outline"></ion-icon>
                Year Built<span class="required">*</span>
              </label>
              <input type="text" [(ngModel)]="projectData.YearBuilt" name="YearBuilt"
                     (ngModelChange)="onYearBuiltChange($event)"
                     (blur)="formatYearBuilt()"
                     placeholder="e.g., 1985"
                     maxlength="4"
                     required
                     class="styled-input">
            </div>

            <!-- Square Feet -->
            <div class="form-group" [class.filled]="projectData.SquareFeet">
              <label>
                <ion-icon name="resize-outline"></ion-icon>
                Square Feet<span class="required">*</span>
              </label>
              <input type="tel" [(ngModel)]="projectData.SquareFeet" name="SquareFeet"
                     (ngModelChange)="onSquareFeetChange($event)"
                     (blur)="formatSquareFeet()"
                     placeholder="e.g., 2,500"
                     pattern="[0-9,]*"
                     inputmode="numeric"
                     required
                     class="styled-input">
            </div>

            <!-- Type of Building -->
            <div class="form-group" [class.filled]="projectData.TypeOfBuilding">
              <label>
                <ion-icon name="business-outline"></ion-icon>
                Building Type<span class="required">*</span>
              </label>
              <select [(ngModel)]="projectData.TypeOfBuilding" name="TypeOfBuilding"
                      (ngModelChange)="onProjectFieldChange('TypeOfBuilding', $event)"
                      required
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of typeOfBuildingOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Style -->
            <div class="form-group" [class.filled]="projectData.Style">
              <label>
                <ion-icon name="home-outline"></ion-icon>
                Style<span class="required">*</span>
              </label>
              <select [(ngModel)]="projectData.Style" name="Style"
                      (ngModelChange)="onProjectFieldChange('Style', $event)"
                      required
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of styleOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Occupancy Furnishings -->
            <div class="form-group" [class.filled]="serviceData.OccupancyFurnishings">
              <label>
                <ion-icon name="bed-outline"></ion-icon>
                Occupancy Status<span class="required">*</span>
              </label>
              <select [(ngModel)]="serviceData.OccupancyFurnishings" name="OccupancyFurnishings"
                      (ngModelChange)="onServiceFieldChange('OccupancyFurnishings', $event)"
                      required
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of occupancyFurnishingsOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Environmental Conditions -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="partly-sunny-outline"></ion-icon>
            Environmental Conditions
          </h3>
          <div class="form-grid two-col">

            <!-- Weather Conditions -->
            <div class="form-group" [class.filled]="serviceData.WeatherConditions">
              <label>
                <ion-icon name="cloud-outline"></ion-icon>
                Weather Conditions<span class="required">*</span>
              </label>
              <select [(ngModel)]="serviceData.WeatherConditions" name="WeatherConditions"
                      (ngModelChange)="onServiceFieldChange('WeatherConditions', $event)"
                      required
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of weatherConditionsOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Outdoor Temperature -->
            <div class="form-group" [class.filled]="serviceData.OutdoorTemperature">
              <label>
                <ion-icon name="thermometer-outline"></ion-icon>
                Outdoor Temperature<span class="required">*</span>
              </label>
              <select [(ngModel)]="serviceData.OutdoorTemperature" name="OutdoorTemperature"
                      (ngModelChange)="onServiceFieldChange('OutdoorTemperature', $event)"
                      required
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of outdoorTemperatureOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Foundation Details -->
        <div class="info-group">
          <h3 class="group-title">
            <ion-icon name="layers-outline"></ion-icon>
            Foundation Details
          </h3>
          <div class="form-grid two-col">
            
            <!-- First Foundation Type -->
            <div class="form-group" [class.filled]="serviceData.FirstFoundationType">
              <label class="has-help">
                <span class="label-main">
                  <ion-icon name="construct-outline"></ion-icon>
                  First Foundation Type
                </span>
                <button type="button"
                        class="help-icon-button"
                        (click)="openHelp(5, 'First Foundation Type Help'); $event.preventDefault(); $event.stopPropagation();"
                        title="First Foundation Type Help"
                        aria-label="First Foundation Type Help">
                  <ion-icon name="information-circle-outline"></ion-icon>
                </button>
              </label>
              <select [(ngModel)]="serviceData.FirstFoundationType" name="FirstFoundationType"
                      (ngModelChange)="onServiceFieldChange('FirstFoundationType', $event)"
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of firstFoundationTypeOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Second Foundation Type -->
            <div class="form-group" [class.filled]="serviceData.SecondFoundationType">
              <label class="has-help">
                <span class="label-main">
                  <ion-icon name="construct-outline"></ion-icon>
                  Second Foundation Type
                </span>
                <button type="button"
                        class="help-icon-button"
                        (click)="openHelp(4, 'Secondary Foundation Help'); $event.preventDefault(); $event.stopPropagation();"
                        title="Secondary Foundation Help"
                        aria-label="Secondary Foundation Help">
                  <ion-icon name="information-circle-outline"></ion-icon>
                </button>
              </label>
              <select [(ngModel)]="serviceData.SecondFoundationType" name="SecondFoundationType"
                      (ngModelChange)="onServiceFieldChange('SecondFoundationType', $event)"
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of secondFoundationTypeOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Second Foundation Rooms - Multi-Select -->
            <div class="form-group" [class.filled]="secondFoundationRoomsSelections && secondFoundationRoomsSelections.length > 0"
                 *ngIf="serviceData.SecondFoundationType && serviceData.SecondFoundationType !== 'None' && serviceData.SecondFoundationType !== 'Other'">
              <label>
                <ion-icon name="home-outline"></ion-icon>
                Second Foundation Rooms
              </label>
              <div class="multi-select-container-inline">
                <div class="multi-select-options-inline">
                  <div class="option-item-inline" *ngFor="let option of secondFoundationRoomsOptions; trackBy: trackByOption">
                    <ion-checkbox
                      [checked]="isSecondFoundationRoomsSelected(option)"
                      (ionChange)="onSecondFoundationRoomsToggle(option, $event)">
                    </ion-checkbox>
                    <ion-label>{{ option }}</ion-label>
                  </div>
                </div>
                <!-- Custom input for "Other" option -->
                <div class="other-input-container" *ngIf="isSecondFoundationRoomsSelected('Other')">
                  <input type="text"
                         [(ngModel)]="secondFoundationRoomsOtherValue"
                         (blur)="onSecondFoundationRoomsOtherChange()"
                         (click)="$event.stopPropagation()"
                         placeholder="Please specify..."
                         class="styled-input other-input">
                </div>
              </div>
            </div>

            <!-- Third Foundation Type -->
            <div class="form-group" [class.filled]="serviceData.ThirdFoundationType"
                 *ngIf="serviceData.SecondFoundationType && serviceData.SecondFoundationType !== 'None' && serviceData.SecondFoundationType !== '' && serviceData.SecondFoundationType !== 'Other'">
              <label>
                <ion-icon name="construct-outline"></ion-icon>
                Third Foundation Type
              </label>
              <select [(ngModel)]="serviceData.ThirdFoundationType" name="ThirdFoundationType"
                      (ngModelChange)="onServiceFieldChange('ThirdFoundationType', $event)"
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of thirdFoundationTypeOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Third Foundation Rooms - Multi-Select -->
            <div class="form-group" [class.filled]="thirdFoundationRoomsSelections && thirdFoundationRoomsSelections.length > 0"
                 *ngIf="serviceData.ThirdFoundationType && serviceData.ThirdFoundationType !== 'None' && serviceData.ThirdFoundationType !== 'Other'">
              <label>
                <ion-icon name="home-outline"></ion-icon>
                Third Foundation Rooms
              </label>
              <div class="multi-select-container-inline">
                <div class="multi-select-options-inline">
                  <div class="option-item-inline" *ngFor="let option of thirdFoundationRoomsOptions; trackBy: trackByOption">
                    <ion-checkbox
                      [checked]="isThirdFoundationRoomsSelected(option)"
                      (ionChange)="onThirdFoundationRoomsToggle(option, $event)">
                    </ion-checkbox>
                    <ion-label>{{ option }}</ion-label>
                  </div>
                </div>
                <!-- Custom input for "Other" option -->
                <div class="other-input-container" *ngIf="isThirdFoundationRoomsSelected('Other')">
                  <input type="text"
                         [(ngModel)]="thirdFoundationRoomsOtherValue"
                         (blur)="onThirdFoundationRoomsOtherChange()"
                         (click)="$event.stopPropagation()"
                         placeholder="Please specify..."
                         class="styled-input other-input">
                </div>
              </div>
            </div>

            <!-- Owner/Occupant Interview -->
            <div class="form-group" [class.filled]="serviceData.OwnerOccupantInterview">
              <label>
                <ion-icon name="chatbubbles-outline"></ion-icon>
                Owner/Occupant Interview
              </label>
              <select [(ngModel)]="serviceData.OwnerOccupantInterview" name="OwnerOccupantInterview"
                      (ngModelChange)="onServiceFieldChange('OwnerOccupantInterview', $event)"
                      class="styled-input">
                <option value="">-- Select --</option>
                <option *ngFor="let option of ownerOccupantInterviewOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Structural Systems Section -->
    <div class="section-card structural-section">
      <div class="section-header" data-section="structural" (click)="toggleSection('structural')">
        <div class="section-info">
          <div class="section-title">
            <ion-icon name="construct-outline"></ion-icon>
            Structural Systems
          </div>
        </div>
        <div class="section-toggle">
          <ion-icon [name]="expandedSections['structural'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>

      <div class="section-content" *ngIf="expandedSections['structural']">
        <!-- Visual Assessment Location -->
        <div class="info-group">
          <div class="form-grid">
            <div class="form-group full-width" [class.filled]="serviceData.StructuralSystemsStatus">
              <label>
                Where will you provide the Visuals<span class="required">*</span>
              </label>
              <p class="field-description">
                If you are providing the visuals in the inspection report select "Provided in Property Inspection Report"
              </p>
              <select #structuralStatusSelect
                      [(ngModel)]="serviceData.StructuralSystemsStatus"
                      (ngModelChange)="onStructuralSystemsStatusChange($event)"
                      class="styled-input">
                <option value="">-- Select --</option>
                <option value="Provided in Property Inspection Report">Provided in Property Inspection Report</option>
                <option value="Completed Here">Completed Here</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Visual Categories from Services_Visuals_Templates - Only show when Completed Here -->
        <div class="categories-container" *ngIf="visualCategories.length > 0 && serviceData.StructuralSystemsStatus === 'Completed Here'">
          
          <!-- Category Accordion -->
          <ion-accordion-group #visualAccordionGroup multiple="true" (ionChange)="onAccordionChange($event)">
            <ion-accordion *ngFor="let category of visualCategories; trackBy: trackByCategory" [value]="category">
              <ion-item slot="header" color="light">
                <ion-label>
                  <h2 style="font-size: 15px; font-weight: 600;">{{ category }}</h2>
                  <p style="font-size: 12px; color: #666;">{{ getDeficienciesCountForCategory(category) }} {{ getDeficienciesCountForCategory(category) === 1 ? 'deficiency' : 'deficiencies' }}</p>
                </ion-label>
              </ion-item>
              
              <div class="category-content" slot="content">
                <!-- General Information Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].comments">
                  <h4 class="type-header">
                    General Information
                    <button class="add-visual-btn" (click)="addCustomVisual(category, 'Comment')" title="Add custom general information">
                      <ion-icon name="add-circle-outline"></ion-icon>
                    </button>
                  </h4>
                  <div *ngIf="organizedData[category].comments.length === 0" class="no-items-message">
                    No general information yet. Click + to add one.
                  </div>
                  <div class="template-item" *ngFor="let item of organizedData[category].comments; trackBy: trackByItemId">
                    <div class="visual-item-container" [class.selected]="isItemSelected(category, item.id)">
                      <!-- Yes/No questions - vertical layout with dropdown below -->
                      <div class="answer-type-1-container" *ngIf="item.answerType === 1">
                        <div class="item-header" (click)="showFullText(item)">
                          <h3 class="item-name">
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                        </div>
                        <div class="item-text-wrapper" (click)="showFullText(item)">
                          <p class="item-text">{{ item.originalText }}</p>
                        </div>
                        <div class="dropdown-container" (click)="$event.stopPropagation()">
                          <select
                            [(ngModel)]="item.answer"
                            (ngModelChange)="onAnswerChange(category, item)"
                            [disabled]="isItemSaving(category, item.id)"
                            class="styled-input">
                            <option value="">-- Select --</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                          </select>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
                        </div>
                      </div>
                      
                      <!-- Multi-select questions - show checkboxes for each option -->
                      <div class="multi-select-container" *ngIf="item.answerType === 2">
                        <ion-item lines="none" class="checkbox-item">
                          <ion-label class="item-label">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <div class="item-text-wrapper">
                              <p class="item-text">{{ item.text }}</p>
                            </div>
                          </ion-label>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                        </ion-item>
                        <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                          <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]; trackBy: trackByOption" class="option-item">
                            <ion-checkbox
                              slot="start"
                              [checked]="isOptionSelectedV1(item, option)"
                              (ionChange)="onOptionToggle(category, item, option, $event)"
                              [disabled]="isItemSaving(category, item.id)">
                            </ion-checkbox>
                            <ion-label>{{ option }}</ion-label>
                          </ion-item>
                        </div>
                        <!-- Custom input for "Other" option -->
                        <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                          <input type="text"
                                 [(ngModel)]="item.otherValue"
                                 (blur)="onMultiSelectOtherChange(category, item)"
                                 (click)="$event.stopPropagation()"
                                 placeholder="Please specify..."
                                 class="styled-input other-input">
                        </div>
                        <div class="no-options-message" *ngIf="!visualDropdownOptions[item.templateId] || visualDropdownOptions[item.templateId].length === 0">
                          <p>No options available for this item</p>
                          <p style="font-size: 11px; color: #999; margin-top: 8px;">DEBUG: {{ getDropdownDebugInfo(item) }}</p>
                        </div>
                      </div>
                      
                      <!-- Text questions - keep original checkbox behavior -->
                      <ion-item lines="none"
                                class="checkbox-item with-camera"
                                [class.has-photos]="getPhotosForVisual(category, item.id).length > 0"
                                *ngIf="!item.answerType || item.answerType === 0"
                                style="min-height: 100px; align-items: flex-start; position: relative;">
                        <ion-checkbox
                          slot="start"
                          [checked]="isItemSelected(category, item.id)"
                          [disabled]="isItemSaving(category, item.id)"
                          (ionChange)="toggleItemSelection(category, item.id)"
                          style="margin-top: 8px;">
                        </ion-checkbox>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                          <ion-label class="item-label" (click)="showFullText(item)">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <p class="item-text">{{ item.text }}</p>
                          </ion-label>
                          <!-- Camera and Gallery buttons below text -->
                          <div *ngIf="isItemSelected(category, item.id)" style="display: flex; gap: 16px; margin-top: 6px; align-items: center; flex-wrap: nowrap; justify-content: flex-end; padding-right: 8px;">
                            <button class="camera-button-structural"
                                    (click)="addPhotoFromCamera(category, item.id); $event.stopPropagation()"
                                    title="Take photo from camera"
                                    style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                              <ion-icon name="camera" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                            </button>
                            <button class="camera-button-structural"
                                    (click)="addPhotoFromGallery(category, item.id); $event.stopPropagation()"
                                    title="Select from gallery"
                                    style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                              <ion-icon name="images" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                            </button>
                          </div>
                        </div>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end" style="margin-top: 8px;"></ion-spinner>
                      </ion-item>
                      
                      <!-- Image preview section below the item (only for text questions) -->
                      <div class="image-preview-section" *ngIf="isItemSelected(category, item.id) && (!item.answerType || item.answerType === 0) && (getPhotosForVisual(category, item.id).length > 0 || isUploadingPhotos(category, item.id))" style="position: relative;">
                        <!-- Upload status indicator -->
                        <div class="upload-status" *ngIf="isUploadingPhotos(category, item.id)">
                          <ion-spinner name="dots" color="primary"></ion-spinner>
                          <span>Uploading {{ getUploadingCount(category, item.id) }} photo(s)...</span>
                        </div>
                        <div class="image-preview-container">
                          <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(category, item.id); trackBy: trackByPhotoId"
                               [class.uploading]="photo.uploading"
                               [class.annotated]="photo.hasAnnotations">
                            <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'"
                                 width="90" height="90"
                                 [alt]="photo.name"
                                 (click)="viewPhoto(photo, category, item.id)"
                                 (error)="handleImageError($event, photo)"
                                 [class.has-annotations]="photo.hasAnnotations">
                            <div class="upload-indicator" *ngIf="photo.uploading">
                              <ion-spinner name="crescent" color="light"></ion-spinner>
                            </div>
                            <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, category, item.id); $event.stopPropagation()" title="Delete">
                              <ion-icon name="close"></ion-icon>
                            </button>
                            <button
                              class="room-photo-caption"
                              (click)="openCaptionPopup(photo, category, item.id); $event.stopPropagation()">
                              {{ photo.caption || 'Caption' }}
                            </button>
                          </div>
                          <!-- Camera button moved to header, remove Add Photos button -->
                        </div>
                        <!-- Photo count badge in bottom right -->
                        <div *ngIf="getPhotosForVisual(category, item.id).length > 0"
                             style="position: absolute; bottom: 8px; right: 8px; background: #F15A27; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; z-index: 10;">
                          {{ getPhotosForVisual(category, item.id).length }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Limitations Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].limitations">
                  <h4 class="type-header">
                    Limitations
                    <button class="add-visual-btn" (click)="addCustomVisual(category, 'Limitation')" title="Add custom limitation">
                      <ion-icon name="add-circle-outline"></ion-icon>
                    </button>
                  </h4>
                  <div *ngIf="organizedData[category].limitations.length === 0" class="no-items-message">
                    No limitations yet. Click + to add one.
                  </div>
                  <div class="template-item" *ngFor="let item of organizedData[category].limitations; trackBy: trackByItemId">
                    <div class="visual-item-container" [class.selected]="isItemSelected(category, item.id)">
                      <!-- Yes/No questions - vertical layout with dropdown below -->
                      <div class="answer-type-1-container" *ngIf="item.answerType === 1">
                        <div class="item-header" (click)="showFullText(item)">
                          <h3 class="item-name">
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                        </div>
                        <div class="item-text-wrapper" (click)="showFullText(item)">
                          <p class="item-text">{{ item.originalText }}</p>
                        </div>
                        <div class="dropdown-container" (click)="$event.stopPropagation()">
                          <select
                            [(ngModel)]="item.answer"
                            (ngModelChange)="onAnswerChange(category, item)"
                            [disabled]="isItemSaving(category, item.id)"
                            class="styled-input">
                            <option value="">-- Select --</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                          </select>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
                        </div>
                      </div>
                      
                      <!-- Multi-select questions - show checkboxes for each option -->
                      <div class="multi-select-container" *ngIf="item.answerType === 2">
                        <ion-item lines="none" class="checkbox-item">
                          <ion-label class="item-label">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <div class="item-text-wrapper">
                              <p class="item-text">{{ item.text }}</p>
                            </div>
                          </ion-label>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                        </ion-item>
                        <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                          <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]; trackBy: trackByOption" class="option-item">
                            <ion-checkbox
                              slot="start"
                              [checked]="isOptionSelectedV1(item, option)"
                              (ionChange)="onOptionToggle(category, item, option, $event)"
                              [disabled]="isItemSaving(category, item.id)">
                            </ion-checkbox>
                            <ion-label>{{ option }}</ion-label>
                          </ion-item>
                        </div>
                        <!-- Custom input for "Other" option -->
                        <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                          <input type="text"
                                 [(ngModel)]="item.otherValue"
                                 (blur)="onMultiSelectOtherChange(category, item)"
                                 (click)="$event.stopPropagation()"
                                 placeholder="Please specify..."
                                 class="styled-input other-input">
                        </div>
                        <div class="no-options-message" *ngIf="!visualDropdownOptions[item.templateId] || visualDropdownOptions[item.templateId].length === 0">
                          <p>No options available for this item</p>
                          <p style="font-size: 11px; color: #999; margin-top: 8px;">DEBUG: {{ getDropdownDebugInfo(item) }}</p>
                        </div>
                      </div>
                      
                      <!-- Text questions - keep original checkbox behavior -->
                      <ion-item lines="none"
                                class="checkbox-item with-camera"
                                [class.has-photos]="getPhotosForVisual(category, item.id).length > 0"
                                *ngIf="!item.answerType || item.answerType === 0"
                                style="min-height: 100px; align-items: flex-start; position: relative;">
                        <ion-checkbox
                          slot="start"
                          [checked]="isItemSelected(category, item.id)"
                          [disabled]="isItemSaving(category, item.id)"
                          (ionChange)="toggleItemSelection(category, item.id)"
                          style="margin-top: 8px;">
                        </ion-checkbox>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                          <ion-label class="item-label" (click)="showFullText(item)">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <p class="item-text">{{ item.text }}</p>
                          </ion-label>
                          <!-- Camera and Gallery buttons below text -->
                          <div *ngIf="isItemSelected(category, item.id)" style="display: flex; gap: 16px; margin-top: 6px; align-items: center; flex-wrap: nowrap; justify-content: flex-end; padding-right: 8px;">
                            <button class="camera-button-structural"
                                    (click)="addPhotoFromCamera(category, item.id); $event.stopPropagation()"
                                    title="Take photo from camera"
                                    style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                              <ion-icon name="camera" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                            </button>
                            <button class="camera-button-structural"
                                    (click)="addPhotoFromGallery(category, item.id); $event.stopPropagation()"
                                    title="Select from gallery"
                                    style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                              <ion-icon name="images" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                            </button>
                          </div>
                        </div>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end" style="margin-top: 8px;"></ion-spinner>
                      </ion-item>
                      
                      <!-- Image preview section below the item (only for text questions) -->
                      <div class="image-preview-section" *ngIf="isItemSelected(category, item.id) && (!item.answerType || item.answerType === 0) && (getPhotosForVisual(category, item.id).length > 0 || isUploadingPhotos(category, item.id))" style="position: relative;">
                        <!-- Upload status indicator -->
                        <div class="upload-status" *ngIf="isUploadingPhotos(category, item.id)">
                          <ion-spinner name="dots" color="primary"></ion-spinner>
                          <span>Uploading {{ getUploadingCount(category, item.id) }} photo(s)...</span>
                        </div>
                        <div class="image-preview-container">
                          <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(category, item.id); trackBy: trackByPhotoId"
                               [class.uploading]="photo.uploading"
                               [class.annotated]="photo.hasAnnotations">
                            <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'"
                                 width="90" height="90"
                                 [alt]="photo.name"
                                 (click)="viewPhoto(photo, category, item.id)"
                                 (error)="handleImageError($event, photo)"
                                 [class.has-annotations]="photo.hasAnnotations">
                            <div class="upload-indicator" *ngIf="photo.uploading">
                              <ion-spinner name="crescent" color="light"></ion-spinner>
                            </div>
                            <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, category, item.id); $event.stopPropagation()" title="Delete">
                              <ion-icon name="close"></ion-icon>
                            </button>
                            <button
                              class="room-photo-caption"
                              (click)="openCaptionPopup(photo, category, item.id); $event.stopPropagation()">
                              {{ photo.caption || 'Caption' }}
                            </button>
                          </div>
                          <!-- Camera button moved to header, remove Add Photos button -->
                        </div>
                        <!-- Photo count badge in bottom right -->
                        <div *ngIf="getPhotosForVisual(category, item.id).length > 0"
                             style="position: absolute; bottom: 8px; right: 8px; background: #F15A27; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; z-index: 10;">
                          {{ getPhotosForVisual(category, item.id).length }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Deficiencies Section -->
                <div class="type-section" *ngIf="organizedData[category] && organizedData[category].deficiencies">
                  <h4 class="type-header">
                    Deficiencies
                    <button class="add-visual-btn" (click)="addCustomVisual(category, 'Deficiency')" title="Add custom deficiency">
                      <ion-icon name="add-circle-outline"></ion-icon>
                    </button>
                  </h4>
                  <div *ngIf="organizedData[category].deficiencies.length === 0" class="no-items-message">
                    No deficiencies yet. Click + to add one.
                  </div>
                  <div class="template-item" *ngFor="let item of organizedData[category].deficiencies; trackBy: trackByItemId">
                    <div class="visual-item-container" [class.selected]="isItemSelected(category, item.id)">
                      <!-- Yes/No questions - vertical layout with dropdown below -->
                      <div class="answer-type-1-container" *ngIf="item.answerType === 1">
                        <div class="item-header" (click)="showFullText(item)">
                          <h3 class="item-name">
                            {{ item.name }}
                            <span class="required-indicator" *ngIf="item.required">*</span>
                          </h3>
                        </div>
                        <div class="item-text-wrapper" (click)="showFullText(item)">
                          <p class="item-text">{{ item.originalText }}</p>
                        </div>
                        <div class="dropdown-container" (click)="$event.stopPropagation()">
                          <select
                            [(ngModel)]="item.answer"
                            (ngModelChange)="onAnswerChange(category, item)"
                            [disabled]="isItemSaving(category, item.id)"
                            class="styled-input">
                            <option value="">-- Select --</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                          </select>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
                        </div>
                      </div>
                      
                      <!-- Multi-select questions - show checkboxes for each option -->
                      <div class="multi-select-container" *ngIf="item.answerType === 2">
                        <ion-item lines="none" class="checkbox-item">
                          <ion-label class="item-label">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <div class="item-text-wrapper">
                              <p class="item-text">{{ item.text }}</p>
                            </div>
                          </ion-label>
                          <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end"></ion-spinner>
                        </ion-item>
                        <div class="multi-select-options" *ngIf="visualDropdownOptions[item.templateId] && visualDropdownOptions[item.templateId].length > 0">
                          <ion-item lines="none" *ngFor="let option of visualDropdownOptions[item.templateId]; trackBy: trackByOption" class="option-item">
                            <ion-checkbox
                              slot="start"
                              [checked]="isOptionSelectedV1(item, option)"
                              (ionChange)="onOptionToggle(category, item, option, $event)"
                              [disabled]="isItemSaving(category, item.id)">
                            </ion-checkbox>
                            <ion-label>{{ option }}</ion-label>
                          </ion-item>
                        </div>
                        <!-- Custom input for "Other" option -->
                        <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                          <input type="text"
                                 [(ngModel)]="item.otherValue"
                                 (blur)="onMultiSelectOtherChange(category, item)"
                                 (click)="$event.stopPropagation()"
                                 placeholder="Please specify..."
                                 class="styled-input other-input">
                        </div>
                        <div class="no-options-message" *ngIf="!visualDropdownOptions[item.templateId] || visualDropdownOptions[item.templateId].length === 0">
                          <p>No options available for this item</p>
                          <p style="font-size: 11px; color: #999; margin-top: 8px;">DEBUG: {{ getDropdownDebugInfo(item) }}</p>
                        </div>
                      </div>
                      
                      <!-- Text questions - keep original checkbox behavior -->
                      <ion-item lines="none"
                                class="checkbox-item with-camera"
                                [class.has-photos]="getPhotosForVisual(category, item.id).length > 0"
                                *ngIf="!item.answerType || item.answerType === 0"
                                style="min-height: 100px; align-items: flex-start; position: relative;">
                        <ion-checkbox
                          slot="start"
                          [checked]="isItemSelected(category, item.id)"
                          [disabled]="isItemSaving(category, item.id)"
                          (ionChange)="toggleItemSelection(category, item.id)"
                          style="margin-top: 8px;">
                        </ion-checkbox>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                          <ion-label class="item-label" (click)="showFullText(item)">
                            <h3>
                              {{ item.name }}
                              <span class="required-indicator" *ngIf="item.required">*</span>
                            </h3>
                            <p class="item-text">{{ item.text }}</p>
                          </ion-label>
                          <!-- Camera and Gallery buttons below text -->
                          <div *ngIf="isItemSelected(category, item.id)" style="display: flex; gap: 16px; margin-top: 6px; align-items: center; flex-wrap: nowrap; justify-content: flex-end; padding-right: 8px;">
                            <button class="camera-button-structural"
                                    (click)="addPhotoFromCamera(category, item.id); $event.stopPropagation()"
                                    title="Take photo from camera"
                                    style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                              <ion-icon name="camera" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                            </button>
                            <button class="camera-button-structural"
                                    (click)="addPhotoFromGallery(category, item.id); $event.stopPropagation()"
                                    title="Select from gallery"
                                    style="position: static !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; outline: none !important;">
                              <ion-icon name="images" style="font-size: 32px; color: var(--noble-orange, #F15A27);"></ion-icon>
                            </button>
                          </div>
                        </div>
                        <ion-spinner *ngIf="isItemSaving(category, item.id)" name="crescent" slot="end" style="margin-top: 8px;"></ion-spinner>
                      </ion-item>
                      
                      <!-- Image preview section below the item (only for text questions) -->
                      <div class="image-preview-section" *ngIf="isItemSelected(category, item.id) && (!item.answerType || item.answerType === 0) && (getPhotosForVisual(category, item.id).length > 0 || isUploadingPhotos(category, item.id))" style="position: relative;">
                        <!-- Upload status indicator -->
                        <div class="upload-status" *ngIf="isUploadingPhotos(category, item.id)">
                          <ion-spinner name="dots" color="primary"></ion-spinner>
                          <span>Uploading {{ getUploadingCount(category, item.id) }} photo(s)...</span>
                        </div>
                        <div class="image-preview-container">
                          <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(category, item.id); trackBy: trackByPhotoId"
                               [class.uploading]="photo.uploading"
                               [class.annotated]="photo.hasAnnotations">
                            <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.png'"
                                 width="90" height="90"
                                 [alt]="photo.name"
                                 (click)="viewPhoto(photo, category, item.id)"
                                 (error)="handleImageError($event, photo)"
                                 [class.has-annotations]="photo.hasAnnotations">
                            <div class="upload-indicator" *ngIf="photo.uploading">
                              <ion-spinner name="crescent" color="light"></ion-spinner>
                            </div>
                            <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, category, item.id); $event.stopPropagation()" title="Delete">
                              <ion-icon name="close"></ion-icon>
                            </button>
                            <button
                              class="room-photo-caption"
                              (click)="openCaptionPopup(photo, category, item.id); $event.stopPropagation()">
                              {{ photo.caption || 'Caption' }}
                            </button>
                          </div>
                          <!-- Camera button moved to header, remove Add Photos button -->
                        </div>
                        <!-- Photo count badge in bottom right -->
                        <div *ngIf="getPhotosForVisual(category, item.id).length > 0"
                             style="position: absolute; bottom: 8px; right: 8px; background: #F15A27; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; z-index: 10;">
                          {{ getPhotosForVisual(category, item.id).length }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </div>

        <!-- Loading indicator if categories haven't loaded yet -->
        <div class="placeholder-message" *ngIf="visualCategories.length === 0">
          <ion-spinner name="crescent"></ion-spinner>
          Loading visual categories...
        </div>
      </div>
    </div>

    <!-- Elevation Plot Section -->
    <div class="section-card">
      <div class="section-header" data-section="elevation" (click)="toggleSection('elevation')">
        <div class="section-info">
          <div class="section-title">
            <ion-icon name="analytics-outline"></ion-icon>
            Elevation Plot
          </div>
        </div>
        <div class="section-toggle">
          <ion-icon [name]="expandedSections['elevation'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
      </div>

      <div class="section-content" *ngIf="expandedSections['elevation']">
        <!-- Room-based elevation measurements -->
        <div class="room-elevations-container">
          
          <!-- Base Station Section -->
          <div class="elevation-subsection">
            <h3 class="subsection-header">Base Station</h3>
            
            <div class="room-templates-list">
              <ng-container *ngFor="let room of roomTemplates; trackBy: trackByRoomName">
              <div class="room-item-container" 
                   [class.selected]="isRoomSelected(room.RoomName)"
                   *ngIf="isBaseStation(room.RoomName)">
              
              <!-- Room card header with checkbox and collapse in header -->
              <div class="room-card-header" style="position: relative; cursor: pointer;" (click)="handleRoomHeaderClick(room.RoomName, $event)">
                <ion-item lines="none" class="checkbox-item" [button]="false" [detail]="false">
                  <ion-checkbox
                    slot="start"
                    [checked]="isRoomSelected(room.RoomName)"
                    [disabled]="isRoomSaving(room.RoomName) || renamingRooms[room.RoomName]"
                    (ionChange)="handleRoomCheckboxChange(room.RoomName, $event)"
                    (click)="$event.stopPropagation(); $event.stopImmediatePropagation()">
                  </ion-checkbox>
                  <ion-label class="item-label">
                    <h3>
                      {{ room.RoomName }}
                      <span class="required-indicator" *ngIf="isBaseStation(room.RoomName)" style="color: #F15A27 !important;">*</span>
                    </h3>
                    <p class="item-text">{{ room.PointCount || 0 }} elevation points</p>
                  </ion-label>
                  <ion-spinner *ngIf="isRoomSaving(room.RoomName)" name="crescent" slot="end"></ion-spinner>
                  <!-- Collapse/expand icon in header when room is selected -->
                  <ion-icon *ngIf="isRoomSelected(room.RoomName)"
                            slot="end"
                            [name]="isRoomExpanded(room.RoomName) ? 'chevron-up' : 'chevron-down'"
                            (click)="handleRoomExpandClick(room.RoomName, $event)"
                            style="cursor: pointer; font-size: 24px; color: var(--ion-color-medium);">
                  </ion-icon>
                </ion-item>
                <!-- Room action buttons OUTSIDE ion-item (Webapp only - Mobile shows below when expanded, hidden for Base Station) -->
                <div class="room-actions-external" *ngIf="platform.isWeb() && !isBaseStation(room.RoomName)" 
                     style="position: absolute; right: 50px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 4px; z-index: 100; pointer-events: auto;">
                  <!-- Rename button -->
                  <button class="room-action-btn" 
                          (click)="renameRoom(room.RoomName, $event)"
                          title="Rename Room"
                          type="button"
                          style="background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 6px; cursor: pointer; display: flex; align-items: center; border-radius: 4px; pointer-events: auto;">
                    <ion-icon name="create-outline" style="font-size: 18px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move up button -->
                  <button class="room-action-btn" 
                          (click)="moveRoomUp(room.RoomName, $event)"
                          [disabled]="getRoomIndex(room.RoomName) === 0"
                          title="Move Up"
                          type="button"
                          style="background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 6px; cursor: pointer; display: flex; align-items: center; border-radius: 4px; pointer-events: auto;">
                    <ion-icon name="arrow-up-outline" style="font-size: 18px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move down button -->
                  <button class="room-action-btn" 
                          (click)="moveRoomDown(room.RoomName, $event)"
                          [disabled]="getRoomIndex(room.RoomName) === roomTemplates.length - 1"
                          title="Move Down"
                          type="button"
                          style="background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 6px; cursor: pointer; display: flex; align-items: center; border-radius: 4px; pointer-events: auto;">
                    <ion-icon name="arrow-down-outline" style="font-size: 18px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                </div>
              </div>
              
              <!-- Show room content only when selected and expanded -->
              <div class="room-card-content" *ngIf="isRoomSelected(room.RoomName) && isRoomExpanded(room.RoomName)">

                <!-- Room action buttons (Mobile only - shows under header when expanded, hidden for Base Station) -->
                <div class="room-actions-mobile" *ngIf="!platform.isWeb() && !isBaseStation(room.RoomName)" 
                     style="display: flex; justify-content: center; gap: 8px; padding: 8px 12px; margin-bottom: 12px; background: #f9f9f9; border-radius: 8px;"
                     (click)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                     (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();">
                  <!-- Rename button -->
                  <button class="room-action-btn-mobile" 
                          (click)="renameRoom(room.RoomName, $event)"
                          (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                          title="Rename Room"
                          type="button"
                          style="background: white; border: 1px solid #ddd; padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; width: 40px; height: 40px;">
                    <ion-icon name="create-outline" style="font-size: 20px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move up button -->
                  <button class="room-action-btn-mobile" 
                          (click)="moveRoomUp(room.RoomName, $event)"
                          (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                          [disabled]="getRoomIndex(room.RoomName) === 0"
                          title="Move Up"
                          type="button"
                          style="background: white; border: 1px solid #ddd; padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; width: 40px; height: 40px;">
                    <ion-icon name="arrow-up-outline" style="font-size: 20px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move down button -->
                  <button class="room-action-btn-mobile" 
                          (click)="moveRoomDown(room.RoomName, $event)"
                          (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                          [disabled]="getRoomIndex(room.RoomName) === roomTemplates.length - 1"
                          title="Move Down"
                          type="button"
                          style="background: white; border: 1px solid #ddd; padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; width: 40px; height: 40px;">
                    <ion-icon name="arrow-down-outline" style="font-size: 20px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                </div>

                <!-- Flooring Difference Factor Section (hidden for Base Station) -->
                <div class="room-section-delimiter" *ngIf="!isBaseStation(room.RoomName)">
                  <span class="delimiter-label">Flooring Difference Factor</span>
                  <button type="button"
                          (click)="openHelp(1, 'FDF Help')"
                          title="FDF Help"
                          style="margin-left: 8px; background: transparent; border: none; padding: 2px;">
                    <ion-icon name="information-circle-outline" style="font-size: 18px; color: var(--ion-color-primary);"></ion-icon>
                  </button>
                </div>

                <!-- Flooring Difference Factor dropdown - compact inline (hidden for Base Station) -->
                <div class="fdf-dropdown-container" *ngIf="!isBaseStation(room.RoomName)">
                  <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 6px;">
                    FDF:<span style="color: #F15A27; margin-left: 2px;">*</span>
                  </label>
                  <select [(ngModel)]="roomElevationData[room.RoomName].fdf"
                          (ngModelChange)="onFDFChange(room.RoomName)"
                          class="styled-input"
                          style="max-width: 100%;">
                    <option value="">-- Select --</option>
                    <option *ngFor="let option of getFDFOptionsForRoom(room.RoomName); trackBy: trackByOption" [value]="option">
                      {{ option }}
                    </option>
                  </select>
                </div>

                <!-- FDF Photos Section (hidden for Base Station) -->
                <div class="fdf-photos-container" *ngIf="!isBaseStation(room.RoomName)" style="margin-top: 10px;">
                  <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #666;">FDF Photos:</div>
                  <div class="fdf-photos-row" style="display: flex; gap: 8px; flex-wrap: nowrap;">
                    <!-- Top Photo Column -->
                    <div class="fdf-photo-column" style="flex: 1; min-width: 0; border: 2px solid #ddd; border-radius: 8px; padding: 8px; background: #f9f9f9;">
                      <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px; text-align: center;">Top</div>
                      <div style="display: flex; gap: 3px; margin-bottom: 6px;">
                        <button (click)="takeFDFPhotoCamera(room.RoomName, 'Top')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; position: relative;">
                          <ion-icon name="camera" style="font-size: 14px;"></ion-icon>
                        </button>
                        <button (click)="takeFDFPhotoGallery(room.RoomName, 'Top')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center;">
                          <ion-icon name="images" style="font-size: 14px;"></ion-icon>
                        </button>
                      </div>
                      <!-- Top Photo Thumbnail - Match Structural Systems structure -->
                      <div *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.top" class="image-preview fdf-photo-preview"
                           [class.uploading]="roomElevationData[room.RoomName]?.fdfPhotos?.topUploading"
                           style="margin-top: 12px; display: flex !important; flex-direction: column !important; align-items: center !important; margin-left: auto !important; margin-right: auto !important;">
                        <img [src]="roomElevationData[room.RoomName]?.fdfPhotos?.topDisplayUrl || roomElevationData[room.RoomName]?.fdfPhotos?.topUrl || 'assets/img/photo-placeholder.png'"
                             width="90" height="90"
                             (click)="annotateFDFPhoto(room.RoomName, 'Top')"
                             alt="Top"
                             [class.has-annotations]="roomElevationData[room.RoomName]?.fdfPhotos?.topHasAnnotations">
                        <div class="upload-indicator" *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.topUploading">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn"
                                *ngIf="!roomElevationData[room.RoomName]?.fdfPhotos?.topUploading"
                                (click)="deleteFDFPhoto(room.RoomName, 'Top', $event); $event.stopPropagation()"
                                title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <!-- Caption text underneath FDF Top photo -->
                        <button
                          class="room-photo-caption"
                          (click)="openFDFCaptionPopup(room.RoomName, 'Top'); $event.stopPropagation()">
                          {{ getFdfPhotoCaption(room.RoomName, 'Top') || 'Caption' }}
                        </button>
                      </div>
                    </div>
                    
                    <!-- Bottom Photo Column -->
                    <div class="fdf-photo-column" style="flex: 1; min-width: 0; border: 2px solid #ddd; border-radius: 8px; padding: 8px; background: #f9f9f9;">
                      <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px; text-align: center;">Bottom</div>
                      <div style="display: flex; gap: 3px; margin-bottom: 6px;">
                        <button (click)="takeFDFPhotoCamera(room.RoomName, 'Bottom')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; position: relative;">
                          <ion-icon name="camera" style="font-size: 14px;"></ion-icon>
                        </button>
                        <button (click)="takeFDFPhotoGallery(room.RoomName, 'Bottom')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center;">
                          <ion-icon name="images" style="font-size: 14px;"></ion-icon>
                        </button>
                      </div>
                      <!-- Bottom Photo Thumbnail - Match Structural Systems structure -->
                      <div *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.bottom" class="image-preview fdf-photo-preview"
                           [class.uploading]="roomElevationData[room.RoomName]?.fdfPhotos?.bottomUploading"
                           style="margin-top: 12px; display: flex !important; flex-direction: column !important; align-items: center !important; margin-left: auto !important; margin-right: auto !important;">
                        <img [src]="roomElevationData[room.RoomName]?.fdfPhotos?.bottomDisplayUrl || roomElevationData[room.RoomName]?.fdfPhotos?.bottomUrl || 'assets/img/photo-placeholder.png'"
                             width="90" height="90"
                             (click)="annotateFDFPhoto(room.RoomName, 'Bottom')"
                             alt="Bottom"
                             [class.has-annotations]="roomElevationData[room.RoomName]?.fdfPhotos?.bottomHasAnnotations">
                        <div class="upload-indicator" *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.bottomUploading">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn"
                                *ngIf="!roomElevationData[room.RoomName]?.fdfPhotos?.bottomUploading"
                                (click)="deleteFDFPhoto(room.RoomName, 'Bottom', $event); $event.stopPropagation()"
                                title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <!-- Caption text underneath FDF Bottom photo -->
                        <button
                          class="room-photo-caption"
                          (click)="openFDFCaptionPopup(room.RoomName, 'Bottom'); $event.stopPropagation()">
                          {{ getFdfPhotoCaption(room.RoomName, 'Bottom') || 'Caption' }}
                        </button>
                      </div>
                    </div>
                    
                    <!-- Location Photo Column -->
                    <div class="fdf-photo-column" style="flex: 1; min-width: 0; border: 2px solid #ddd; border-radius: 8px; padding: 8px; background: #f9f9f9;">
                      <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px; text-align: center;">Location</div>
                      <div style="display: flex; gap: 3px; margin-bottom: 6px;">
                        <button (click)="takeFDFPhotoCamera(room.RoomName, 'Threshold')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; position: relative;">
                          <ion-icon name="camera" style="font-size: 14px;"></ion-icon>
                        </button>
                        <button (click)="takeFDFPhotoGallery(room.RoomName, 'Threshold')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center;">
                          <ion-icon name="images" style="font-size: 14px;"></ion-icon>
                        </button>
                      </div>
                      <!-- Location Photo Thumbnail - Match Structural Systems structure -->
                      <div *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.threshold" class="image-preview fdf-photo-preview"
                           [class.uploading]="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUploading"
                           style="margin-top: 12px; display: flex !important; flex-direction: column !important; align-items: center !important; margin-left: auto !important; margin-right: auto !important;">
                        <img [src]="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdDisplayUrl || roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUrl || 'assets/img/photo-placeholder.png'"
                             width="90" height="90"
                             (click)="annotateFDFPhoto(room.RoomName, 'Threshold')"
                             alt="Location"
                             [class.has-annotations]="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdHasAnnotations">
                        <div class="upload-indicator" *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUploading">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn"
                                *ngIf="!roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUploading"
                                (click)="deleteFDFPhoto(room.RoomName, 'Threshold', $event); $event.stopPropagation()"
                                title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <!-- Caption text underneath FDF Location photo -->
                        <button
                          class="room-photo-caption"
                          (click)="openFDFCaptionPopup(room.RoomName, 'Threshold'); $event.stopPropagation()">
                          {{ getFdfPhotoCaption(room.RoomName, 'Threshold') || 'Caption' }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Measurements Section -->
                <div class="room-section-delimiter measurement-header" style="margin-top: 15px;">
                  <span class="delimiter-label">Measurements</span>
                  <div class="delimiter-actions">
                    <button type="button"
                            [attr.data-help-id]="isBaseStation(room.RoomName) ? 2 : 3"
                            (click)="openHelp(isBaseStation(room.RoomName) ? 2 : 3, isBaseStation(room.RoomName) ? 'Base Station Location Help' : 'Elevation Measurements Help')"
                            [title]="isBaseStation(room.RoomName) ? 'Base Station Location Help' : 'Elevation Measurements Help'"
                            [attr.aria-label]="isBaseStation(room.RoomName) ? 'Base Station Location Help' : 'Elevation Measurements Help'"
                            style="margin-left: 8px; background: transparent; border: none; padding: 2px;">
                      <ion-icon name="information-circle-outline" style="font-size: 18px; color: var(--ion-color-primary);"></ion-icon>
                    </button>
                  </div>
                </div>

                <!-- Elevation Points with Location and Measurement photos - like FDF section -->
                <div class="elevation-points-container" *ngIf="roomElevationData[room.RoomName]?.elevationPoints?.length > 0">
                  <div class="elevation-points-grid">
                    <div class="elevation-point-card" *ngFor="let point of roomElevationData[room.RoomName].elevationPoints; trackBy: trackByPointName">
                      <div class="point-header">
                        <span class="point-label" [title]="point.name">{{ point.name }}</span>
                        <button class="delete-point-btn"
                                (click)="deleteElevationPoint(room.RoomName, point)"
                                title="Delete Point">
                          <ion-icon name="trash-outline"></ion-icon>
                        </button>
                      </div>
                      
                      <!-- Measurement and Location Photos -->
                      <div style="margin-top: 12px; display: flex; gap: 12px;">
                        <!-- Measurement Photo Container -->
                        <div style="flex: 1; border: 2px solid #ddd; border-radius: 12px; padding: 12px; background: #f9f9f9;">
                          <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center;">Measurement</div>
                          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button (click)="capturePointPhotoCamera(room.RoomName, point, 'Measurement', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative;">
                              <ion-icon name="camera" style="font-size: 24px;"></ion-icon>
                              <ion-icon *ngIf="getPointPhotoByType(point, 'Measurement')" name="checkmark-circle" class="checkmark-icon" style="color: #4CAF50; position: absolute; top: 4px; right: 4px; font-size: 14px;"></ion-icon>
                            </button>
                            <button (click)="capturePointPhotoGallery(room.RoomName, point, 'Measurement', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;">
                              <ion-icon name="images" style="font-size: 24px;"></ion-icon>
                            </button>
                          </div>
                          <!-- Measurement Photo Thumbnail -->
                          <div *ngIf="getPointPhotoByType(point, 'Measurement')" style="display: flex; flex-direction: column; align-items: center; margin-top: 8px;">
                            <div class="image-preview fdf-photo-preview"
                                 [class.uploading]="getPointPhotoByType(point, 'Measurement').uploading">
                              <img [src]="getPointPhotoByType(point, 'Measurement').displayUrl || getPointPhotoByType(point, 'Measurement').thumbnailUrl || getPointPhotoByType(point, 'Measurement').url"
                                   width="90" height="90"
                                   (click)="viewRoomPhoto(getPointPhotoByType(point, 'Measurement'), room.RoomName, point)"
                                   alt="Measurement">
                              <div class="upload-indicator" *ngIf="getPointPhotoByType(point, 'Measurement').uploading">
                                <ion-spinner name="crescent" color="light"></ion-spinner>
                              </div>
                              <button class="delete-btn"
                                      *ngIf="!getPointPhotoByType(point, 'Measurement').uploading"
                                      (click)="deleteRoomPhoto(getPointPhotoByType(point, 'Measurement'), room.RoomName, point); $event.stopPropagation()"
                                      title="Delete">
                                <ion-icon name="close"></ion-icon>
                              </button>
                            </div>
                            <!-- Caption text underneath photo -->
                            <button
                              class="room-photo-caption"
                              (click)="openRoomPointCaptionPopup(getPointPhotoByType(point, 'Measurement'), room.RoomName, point); $event.stopPropagation()">
                              {{ getPointPhotoByType(point, 'Measurement').caption || 'Caption' }}
                            </button>
                          </div>
                        </div>

                        <!-- Location Photo Container -->
                        <div style="flex: 1; border: 2px solid #ddd; border-radius: 12px; padding: 12px; background: #f9f9f9;">
                          <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center;">Location</div>
                          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button (click)="capturePointPhotoCamera(room.RoomName, point, 'Location', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative;">
                              <ion-icon name="camera" style="font-size: 24px;"></ion-icon>
                              <ion-icon *ngIf="getPointPhotoByType(point, 'Location')" name="checkmark-circle" class="checkmark-icon" style="color: #4CAF50; position: absolute; top: 4px; right: 4px; font-size: 14px;"></ion-icon>
                            </button>
                            <button (click)="capturePointPhotoGallery(room.RoomName, point, 'Location', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;">
                              <ion-icon name="images" style="font-size: 24px;"></ion-icon>
                            </button>
                          </div>
                          <!-- Location Photo Thumbnail -->
                          <div *ngIf="getPointPhotoByType(point, 'Location')" style="display: flex; flex-direction: column; align-items: center; margin-top: 8px;">
                            <div class="image-preview fdf-photo-preview"
                                 [class.uploading]="getPointPhotoByType(point, 'Location').uploading">
                              <img [src]="getPointPhotoByType(point, 'Location').displayUrl || getPointPhotoByType(point, 'Location').thumbnailUrl || getPointPhotoByType(point, 'Location').url"
                                   width="90" height="90"
                                   (click)="viewRoomPhoto(getPointPhotoByType(point, 'Location'), room.RoomName, point)"
                                   alt="Location">
                              <div class="upload-indicator" *ngIf="getPointPhotoByType(point, 'Location').uploading">
                                <ion-spinner name="crescent" color="light"></ion-spinner>
                              </div>
                              <button class="delete-btn"
                                      *ngIf="!getPointPhotoByType(point, 'Location').uploading"
                                      (click)="deleteRoomPhoto(getPointPhotoByType(point, 'Location'), room.RoomName, point); $event.stopPropagation()"
                                      title="Delete">
                                <ion-icon name="close"></ion-icon>
                              </button>
                            </div>
                            <!-- Caption text underneath photo -->
                            <button
                              class="room-photo-caption"
                              (click)="openRoomPointCaptionPopup(getPointPhotoByType(point, 'Location'), room.RoomName, point); $event.stopPropagation()">
                              {{ getPointPhotoByType(point, 'Location').caption || 'Caption' }}
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Add point button at bottom right (hidden for Base Station) -->
                <div style="display: flex; justify-content: flex-end; margin-top: 10px;" *ngIf="!isBaseStation(room.RoomName)">
                  <button class="add-point-button" (click)="addCustomPoint(room.RoomName)"
                            style="background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 13px; color: #000;">
                      <ion-icon name="add-circle-outline" style="margin-right: 3px; vertical-align: middle; color: #000;"></ion-icon>
                      Add Measurement
                    </button>
                  </div>

                <!-- Notes Section -->
                <div class="room-section-delimiter" style="margin-top: 15px;">
                  <span class="delimiter-label">Notes</span>
                </div>
                
                <!-- Room-specific notes - compact -->
                <div class="room-notes">
                  <ion-textarea [(ngModel)]="roomElevationData[room.RoomName].notes" 
                                rows="2"
                                placeholder="Notes for {{ room.RoomName }}..."
                                (ionBlur)="onRoomNotesChange(room.RoomName)"
                                style="font-size: 13px;">
                  </ion-textarea>
                </div>
              </div>
            </div>
              </ng-container>
          </div>
          
          <!-- Add Base Station button -->
          <div class="add-room-container" style="margin-top: 12px; margin-bottom: 20px; text-align: center;">
            <button class="add-room-button" (click)="addBaseStation()"
                    style="background: white; border: 1px solid #ddd; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: #000;">
              <ion-icon name="add-circle-outline" style="margin-right: 6px; vertical-align: middle; font-size: 16px; color: #000;"></ion-icon>
              Add Base Station
            </button>
          </div>
          </div>
          
          <!-- Rooms Section -->
          <div class="elevation-subsection" style="margin-top: 24px;">
            <h3 class="subsection-header">Rooms</h3>
            
            <div class="room-templates-list">
              <ng-container *ngFor="let room of roomTemplates; trackBy: trackByRoomName">
              <div class="room-item-container" 
                   [class.selected]="isRoomSelected(room.RoomName)"
                   *ngIf="!isBaseStation(room.RoomName)">
              
              <!-- Room card header with checkbox and collapse in header -->
              <div class="room-card-header" style="position: relative; cursor: pointer;" (click)="handleRoomHeaderClick(room.RoomName, $event)">
                <ion-item lines="none" class="checkbox-item" [button]="false" [detail]="false">
                  <ion-checkbox
                    slot="start"
                    [checked]="isRoomSelected(room.RoomName)"
                    [disabled]="isRoomSaving(room.RoomName) || renamingRooms[room.RoomName]"
                    (ionChange)="handleRoomCheckboxChange(room.RoomName, $event)"
                    (click)="$event.stopPropagation(); $event.stopImmediatePropagation()">
                  </ion-checkbox>
                  <ion-label class="item-label">
                    <h3>
                      {{ room.RoomName }}
                      <span class="required-indicator" *ngIf="isBaseStation(room.RoomName)" style="color: #F15A27 !important;">*</span>
                    </h3>
                    <p class="item-text">{{ room.PointCount || 0 }} elevation points</p>
                  </ion-label>
                  <ion-spinner *ngIf="isRoomSaving(room.RoomName)" name="crescent" slot="end"></ion-spinner>
                  <!-- Collapse/expand icon in header when room is selected -->
                  <ion-icon *ngIf="isRoomSelected(room.RoomName)"
                            slot="end"
                            [name]="isRoomExpanded(room.RoomName) ? 'chevron-up' : 'chevron-down'"
                            (click)="handleRoomExpandClick(room.RoomName, $event)"
                            style="cursor: pointer; font-size: 24px; color: var(--ion-color-medium);">
                  </ion-icon>
                </ion-item>
                <!-- Room action buttons OUTSIDE ion-item (Webapp only - Mobile shows below when expanded, hidden for Base Station) -->
                <div class="room-actions-external" *ngIf="platform.isWeb() && !isBaseStation(room.RoomName)" 
                     style="position: absolute; right: 50px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 4px; z-index: 100; pointer-events: auto;">
                  <!-- Rename button -->
                  <button class="room-action-btn" 
                          (click)="renameRoom(room.RoomName, $event)"
                          title="Rename Room"
                          type="button"
                          style="background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 6px; cursor: pointer; display: flex; align-items: center; border-radius: 4px; pointer-events: auto;">
                    <ion-icon name="create-outline" style="font-size: 18px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move up button -->
                  <button class="room-action-btn" 
                          (click)="moveRoomUp(room.RoomName, $event)"
                          [disabled]="getRoomIndex(room.RoomName) === 0"
                          title="Move Up"
                          type="button"
                          style="background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 6px; cursor: pointer; display: flex; align-items: center; border-radius: 4px; pointer-events: auto;">
                    <ion-icon name="arrow-up-outline" style="font-size: 18px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move down button -->
                  <button class="room-action-btn" 
                          (click)="moveRoomDown(room.RoomName, $event)"
                          [disabled]="getRoomIndex(room.RoomName) === roomTemplates.length - 1"
                          title="Move Down"
                          type="button"
                          style="background: rgba(255,255,255,0.9); border: 1px solid #ddd; padding: 6px; cursor: pointer; display: flex; align-items: center; border-radius: 4px; pointer-events: auto;">
                    <ion-icon name="arrow-down-outline" style="font-size: 18px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                </div>
              </div>
              
              <!-- Show room content only when selected and expanded -->
              <div class="room-card-content" *ngIf="isRoomSelected(room.RoomName) && isRoomExpanded(room.RoomName)">

                <!-- Room action buttons (Mobile only - shows under header when expanded, hidden for Base Station) -->
                <div class="room-actions-mobile" *ngIf="!platform.isWeb() && !isBaseStation(room.RoomName)" 
                     style="display: flex; justify-content: center; gap: 8px; padding: 8px 12px; margin-bottom: 12px; background: #f9f9f9; border-radius: 8px;"
                     (click)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                     (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();">
                  <!-- Rename button -->
                  <button class="room-action-btn-mobile" 
                          (click)="renameRoom(room.RoomName, $event)"
                          (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                          title="Rename Room"
                          type="button"
                          style="background: white; border: 1px solid #ddd; padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; width: 40px; height: 40px;">
                    <ion-icon name="create-outline" style="font-size: 20px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move up button -->
                  <button class="room-action-btn-mobile" 
                          (click)="moveRoomUp(room.RoomName, $event)"
                          (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                          [disabled]="getRoomIndex(room.RoomName) === 0"
                          title="Move Up"
                          type="button"
                          style="background: white; border: 1px solid #ddd; padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; width: 40px; height: 40px;">
                    <ion-icon name="arrow-up-outline" style="font-size: 20px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                  <!-- Move down button -->
                  <button class="room-action-btn-mobile" 
                          (click)="moveRoomDown(room.RoomName, $event)"
                          (touchstart)="$event.stopPropagation(); $event.stopImmediatePropagation();"
                          [disabled]="getRoomIndex(room.RoomName) === roomTemplates.length - 1"
                          title="Move Down"
                          type="button"
                          style="background: white; border: 1px solid #ddd; padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; width: 40px; height: 40px;">
                    <ion-icon name="arrow-down-outline" style="font-size: 20px; color: var(--ion-color-medium); pointer-events: none;"></ion-icon>
                  </button>
                </div>

                <!-- Flooring Difference Factor Section -->
                <div class="room-section-delimiter">
                  <span class="delimiter-label">Flooring Difference Factor</span>
                  <button type="button"
                          (click)="openHelp(1, 'FDF Help')"
                          title="FDF Help"
                          style="margin-left: 8px; background: transparent; border: none; padding: 2px;">
                    <ion-icon name="information-circle-outline" style="font-size: 18px; color: var(--ion-color-primary);"></ion-icon>
                  </button>
                </div>
                
                <!-- FDF Dropdown Selector -->
                <div class="form-group" [class.filled]="roomElevationData[room.RoomName]?.fdf" style="margin-bottom: 16px;">
                  <label>
                    <ion-icon name="layers-outline"></ion-icon>
                    FDF
                  </label>
                  <select [(ngModel)]="roomElevationData[room.RoomName].fdf" 
                          (ngModelChange)="onFDFChange(room.RoomName)"
                          class="styled-input"
                          required>
                    <option value="">-- Select --</option>
                    <option *ngFor="let option of fdfOptions; trackBy: trackByOption" [value]="option">{{ option }}</option>
                  </select>
                </div>

                <!-- FDF Photos Row (conditional based on FDF dropdown) -->
                <div class="fdf-photos-container" *ngIf="shouldShowFDFPhotos(room.RoomName)">
                  <div class="fdf-photos-row" style="display: flex; gap: 12px;">
                    <!-- Top Photo Column -->
                    <div class="fdf-photo-column" style="flex: 1; min-width: 0; border: 2px solid #ddd; border-radius: 8px; padding: 8px; background: #f9f9f9;">
                      <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px; text-align: center;">Top</div>
                      <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                        <button (click)="takeFDFPhotoCamera(room.RoomName, 'Top')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 10px 6px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; position: relative;">
                          <ion-icon name="camera" style="font-size: 20px;"></ion-icon>
                        </button>
                        <button (click)="takeFDFPhotoGallery(room.RoomName, 'Top')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 10px 6px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center;">
                          <ion-icon name="images" style="font-size: 20px;"></ion-icon>
                        </button>
                      </div>
                      <!-- Top Photo Thumbnail - Match Structural Systems structure -->
                      <div *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.top" class="image-preview fdf-photo-preview"
                           [class.uploading]="roomElevationData[room.RoomName]?.fdfPhotos?.topUploading"
                           style="margin-top: 12px; display: flex !important; flex-direction: column !important; align-items: center !important; margin-left: auto !important; margin-right: auto !important;">
                        <img [src]="roomElevationData[room.RoomName]?.fdfPhotos?.topDisplayUrl || roomElevationData[room.RoomName]?.fdfPhotos?.topUrl || 'assets/img/photo-placeholder.png'"
                             width="90" height="90"
                             (click)="annotateFDFPhoto(room.RoomName, 'Top')"
                             alt="Top"
                             [class.has-annotations]="roomElevationData[room.RoomName]?.fdfPhotos?.topHasAnnotations">
                        <div class="upload-indicator" *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.topUploading">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn"
                                *ngIf="!roomElevationData[room.RoomName]?.fdfPhotos?.topUploading"
                                (click)="deleteFDFPhoto(room.RoomName, 'Top', $event); $event.stopPropagation()"
                                title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <!-- Caption text underneath FDF Top photo -->
                        <button
                          class="room-photo-caption"
                          (click)="openFDFCaptionPopup(room.RoomName, 'Top'); $event.stopPropagation()">
                          {{ getFdfPhotoCaption(room.RoomName, 'Top') || 'Caption' }}
                        </button>
                      </div>
                    </div>
                    
                    <!-- Bottom Photo Column -->
                    <div class="fdf-photo-column" style="flex: 1; min-width: 0; border: 2px solid #ddd; border-radius: 8px; padding: 8px; background: #f9f9f9;">
                      <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px; text-align: center;">Bottom</div>
                      <div style="display: flex; gap: 3px; margin-bottom: 6px;">
                        <button (click)="takeFDFPhotoCamera(room.RoomName, 'Bottom')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; position: relative;">
                          <ion-icon name="camera" style="font-size: 14px;"></ion-icon>
                        </button>
                        <button (click)="takeFDFPhotoGallery(room.RoomName, 'Bottom')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center;">
                          <ion-icon name="images" style="font-size: 14px;"></ion-icon>
                        </button>
                      </div>
                      <!-- Bottom Photo Thumbnail - Match Structural Systems structure -->
                      <div *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.bottom" class="image-preview fdf-photo-preview"
                           [class.uploading]="roomElevationData[room.RoomName]?.fdfPhotos?.bottomUploading"
                           style="margin-top: 12px; display: flex !important; flex-direction: column !important; align-items: center !important; margin-left: auto !important; margin-right: auto !important;">
                        <img [src]="roomElevationData[room.RoomName]?.fdfPhotos?.bottomDisplayUrl || roomElevationData[room.RoomName]?.fdfPhotos?.bottomUrl || 'assets/img/photo-placeholder.png'"
                             width="90" height="90"
                             (click)="annotateFDFPhoto(room.RoomName, 'Bottom')"
                             alt="Bottom"
                             [class.has-annotations]="roomElevationData[room.RoomName]?.fdfPhotos?.bottomHasAnnotations">
                        <div class="upload-indicator" *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.bottomUploading">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn"
                                *ngIf="!roomElevationData[room.RoomName]?.fdfPhotos?.bottomUploading"
                                (click)="deleteFDFPhoto(room.RoomName, 'Bottom', $event); $event.stopPropagation()"
                                title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <!-- Caption text underneath FDF Bottom photo -->
                        <button
                          class="room-photo-caption"
                          (click)="openFDFCaptionPopup(room.RoomName, 'Bottom'); $event.stopPropagation()">
                          {{ getFdfPhotoCaption(room.RoomName, 'Bottom') || 'Caption' }}
                        </button>
                      </div>
                    </div>
                    
                    <!-- Location Photo Column -->
                    <div class="fdf-photo-column" style="flex: 1; min-width: 0; border: 2px solid #ddd; border-radius: 8px; padding: 8px; background: #f9f9f9;">
                      <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px; text-align: center;">Location</div>
                      <div style="display: flex; gap: 3px; margin-bottom: 6px;">
                        <button (click)="takeFDFPhotoCamera(room.RoomName, 'Threshold')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; position: relative;">
                          <ion-icon name="camera" style="font-size: 14px;"></ion-icon>
                        </button>
                        <button (click)="takeFDFPhotoGallery(room.RoomName, 'Threshold')"
                                class="fdf-photo-button"
                                style="flex: 1; padding: 4px 2px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center;">
                          <ion-icon name="images" style="font-size: 14px;"></ion-icon>
                        </button>
                      </div>
                      <!-- Location Photo Thumbnail - Match Structural Systems structure -->
                      <div *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.threshold" class="image-preview fdf-photo-preview"
                           [class.uploading]="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUploading"
                           style="margin-top: 12px; display: flex !important; flex-direction: column !important; align-items: center !important; margin-left: auto !important; margin-right: auto !important;">
                        <img [src]="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdDisplayUrl || roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUrl || 'assets/img/photo-placeholder.png'"
                             width="90" height="90"
                             (click)="annotateFDFPhoto(room.RoomName, 'Threshold')"
                             alt="Location"
                             [class.has-annotations]="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdHasAnnotations">
                        <div class="upload-indicator" *ngIf="roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUploading">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn"
                                *ngIf="!roomElevationData[room.RoomName]?.fdfPhotos?.thresholdUploading"
                                (click)="deleteFDFPhoto(room.RoomName, 'Threshold', $event); $event.stopPropagation()"
                                title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <!-- Caption text underneath FDF Location photo -->
                        <button
                          class="room-photo-caption"
                          (click)="openFDFCaptionPopup(room.RoomName, 'Threshold'); $event.stopPropagation()">
                          {{ getFdfPhotoCaption(room.RoomName, 'Threshold') || 'Caption' }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Measurements Section -->
                <div class="room-section-delimiter measurement-header" style="margin-top: 15px;">
                  <span class="delimiter-label">Measurements</span>
                  <div class="delimiter-actions">
                    <button type="button"
                            [attr.data-help-id]="isBaseStation(room.RoomName) ? 2 : 3"
                            (click)="openHelp(isBaseStation(room.RoomName) ? 2 : 3, isBaseStation(room.RoomName) ? 'Base Station Location Help' : 'Elevation Measurements Help')"
                            title="Elevation Help"
                            style="background: transparent; border: none; padding: 4px; cursor: pointer;">
                      <ion-icon name="information-circle-outline" style="font-size: 18px; color: var(--ion-color-primary);"></ion-icon>
                    </button>
                  </div>
                </div>

                <!-- Elevation Points with Location and Measurement photos - like FDF section -->
                <div class="elevation-points-container" *ngIf="roomElevationData[room.RoomName]?.elevationPoints?.length > 0">
                  <div class="elevation-points-grid">
                    <div class="elevation-point-card" *ngFor="let point of roomElevationData[room.RoomName].elevationPoints; trackBy: trackByPointName">
                      <div class="point-header">
                        <span class="point-label" [title]="point.name">{{ point.name }}</span>
                        <button class="delete-point-btn"
                                (click)="deleteElevationPoint(room.RoomName, point)"
                                title="Delete Point">
                          <ion-icon name="trash-outline"></ion-icon>
                        </button>
                      </div>
                      
                      <!-- Measurement and Location Photos -->
                      <div style="margin-top: 12px; display: flex; gap: 12px;">
                        <!-- Measurement Photo Container -->
                        <div style="flex: 1; border: 2px solid #ddd; border-radius: 12px; padding: 12px; background: #f9f9f9;">
                          <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center;">Measurement</div>
                          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button (click)="capturePointPhotoCamera(room.RoomName, point, 'Measurement', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative;">
                              <ion-icon name="camera" style="font-size: 24px;"></ion-icon>
                              <ion-icon *ngIf="getPointPhotoByType(point, 'Measurement')" name="checkmark-circle" class="checkmark-icon" style="color: #4CAF50; position: absolute; top: 4px; right: 4px; font-size: 14px;"></ion-icon>
                            </button>
                            <button (click)="capturePointPhotoGallery(room.RoomName, point, 'Measurement', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;">
                              <ion-icon name="images" style="font-size: 24px;"></ion-icon>
                            </button>
                          </div>
                          <!-- Measurement Photo Thumbnail -->
                          <div *ngIf="getPointPhotoByType(point, 'Measurement')" style="display: flex; flex-direction: column; align-items: center; margin-top: 8px;">
                            <div class="image-preview fdf-photo-preview"
                                 [class.uploading]="getPointPhotoByType(point, 'Measurement').uploading">
                              <img [src]="getPointPhotoByType(point, 'Measurement').displayUrl || getPointPhotoByType(point, 'Measurement').thumbnailUrl || getPointPhotoByType(point, 'Measurement').url"
                                   width="90" height="90"
                                   (click)="viewRoomPhoto(getPointPhotoByType(point, 'Measurement'), room.RoomName, point)"
                                   alt="Measurement">
                              <div class="upload-indicator" *ngIf="getPointPhotoByType(point, 'Measurement').uploading">
                                <ion-spinner name="crescent" color="light"></ion-spinner>
                              </div>
                              <button class="delete-btn"
                                      *ngIf="!getPointPhotoByType(point, 'Measurement').uploading"
                                      (click)="deleteRoomPhoto(getPointPhotoByType(point, 'Measurement'), room.RoomName, point); $event.stopPropagation()"
                                      title="Delete">
                                <ion-icon name="close"></ion-icon>
                              </button>
                            </div>
                            <!-- Caption text underneath photo -->
                            <button
                              class="room-photo-caption"
                              (click)="openRoomPointCaptionPopup(getPointPhotoByType(point, 'Measurement'), room.RoomName, point); $event.stopPropagation()">
                              {{ getPointPhotoByType(point, 'Measurement').caption || 'Caption' }}
                            </button>
                          </div>
                        </div>

                        <!-- Location Photo Container -->
                        <div style="flex: 1; border: 2px solid #ddd; border-radius: 12px; padding: 12px; background: #f9f9f9;">
                          <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center;">Location</div>
                          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button (click)="capturePointPhotoCamera(room.RoomName, point, 'Location', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; position: relative;">
                              <ion-icon name="camera" style="font-size: 24px;"></ion-icon>
                              <ion-icon *ngIf="getPointPhotoByType(point, 'Location')" name="checkmark-circle" class="checkmark-icon" style="color: #4CAF50; position: absolute; top: 4px; right: 4px; font-size: 14px;"></ion-icon>
                            </button>
                            <button (click)="capturePointPhotoGallery(room.RoomName, point, 'Location', $event)"
                                    class="fdf-photo-button measurement-photo-btn"
                                    style="flex: 1; padding: 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;">
                              <ion-icon name="images" style="font-size: 24px;"></ion-icon>
                            </button>
                          </div>
                          <!-- Location Photo Thumbnail -->
                          <div *ngIf="getPointPhotoByType(point, 'Location')" style="display: flex; flex-direction: column; align-items: center; margin-top: 8px;">
                            <div class="image-preview fdf-photo-preview"
                                 [class.uploading]="getPointPhotoByType(point, 'Location').uploading">
                              <img [src]="getPointPhotoByType(point, 'Location').displayUrl || getPointPhotoByType(point, 'Location').thumbnailUrl || getPointPhotoByType(point, 'Location').url"
                                   width="90" height="90"
                                   (click)="viewRoomPhoto(getPointPhotoByType(point, 'Location'), room.RoomName, point)"
                                   alt="Location">
                              <div class="upload-indicator" *ngIf="getPointPhotoByType(point, 'Location').uploading">
                                <ion-spinner name="crescent" color="light"></ion-spinner>
                              </div>
                              <button class="delete-btn"
                                      *ngIf="!getPointPhotoByType(point, 'Location').uploading"
                                      (click)="deleteRoomPhoto(getPointPhotoByType(point, 'Location'), room.RoomName, point); $event.stopPropagation()"
                                      title="Delete">
                                <ion-icon name="close"></ion-icon>
                              </button>
                            </div>
                            <!-- Caption text underneath photo -->
                            <button
                              class="room-photo-caption"
                              (click)="openRoomPointCaptionPopup(getPointPhotoByType(point, 'Location'), room.RoomName, point); $event.stopPropagation()">
                              {{ getPointPhotoByType(point, 'Location').caption || 'Caption' }}
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Add point button at bottom right (hidden for Base Station) -->
                <div style="display: flex; justify-content: flex-end; margin-top: 10px;" *ngIf="!isBaseStation(room.RoomName)">
                  <button class="add-point-button" (click)="addCustomPoint(room.RoomName)"
                            style="background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 13px; color: #000;">
                      <ion-icon name="add-circle-outline" style="margin-right: 3px; vertical-align: middle; color: #000;"></ion-icon>
                      Add Measurement
                    </button>
                  </div>

                <!-- Notes Section -->
                <div class="room-section-delimiter" style="margin-top: 15px;">
                  <span class="delimiter-label">Notes</span>
                </div>
                
                <!-- Room-specific notes - compact -->
                <div class="room-notes">
                  <ion-textarea [(ngModel)]="roomElevationData[room.RoomName].notes" 
                                rows="2"
                                placeholder="Notes for {{ room.RoomName }}..."
                                (ionBlur)="onRoomNotesChange(room.RoomName)"
                                style="font-size: 13px;">
                  </ion-textarea>
                </div>
              </div>
            </div>
              </ng-container>
          </div>
          
          <!-- Add Room button - at bottom of Rooms section -->
          <div class="add-room-container" style="margin-top: 20px; margin-bottom: 30px; text-align: center;">
            <button class="add-room-button" (click)="showAddRoomDialog()"
                    style="background: white; border: 1px solid #ddd; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #000; transition: all 0.3s ease;">
              <ion-icon name="add-circle-outline" style="margin-right: 6px; vertical-align: middle; font-size: 18px; color: #000;"></ion-icon>
              Add Room
            </button>
          </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Finalize Report Button -->
    <div class="finalize-button-container">
      <button class="finalize-button"
              [class.incomplete]="!canFinalizeReport()"
              [disabled]="!canFinalizeReport()"
              (click)="finalizeReport()">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <span>{{ isReportFinalized() ? 'Update' : 'Finalize Report' }}</span>
      </button>
    </div>
  </div>

  <!-- File upload input (hidden, supports multiple files) -->
  <input 
    #fileInput 
    type="file" 
    multiple
    style="display: none" 
    (change)="handleFileSelect($event)"
    accept="image/*,.pdf,.doc,.docx">

  <!-- No dynamic spacer needed - padding-bottom on container handles it -->

  <!-- Footer with Auto-Sync and Back to Top (Mobile only) -->
  <div *ngIf="!platform.isWeb()" class="sync-control-bar">
    <button
      type="button"
      class="offline-toggle-button"
      (click)="toggleManualOffline()"
      [attr.aria-pressed]="manualOffline"
      [attr.aria-label]="manualOffline ? 'Enable auto-sync' : 'Disable auto-sync'"
    >
      <ion-icon [name]="manualOffline ? 'cloud-upload' : 'cloud-offline'"></ion-icon>
    </button>
    
    <button class="floating-back-to-top" 
            [class.hide-on-web]="platform.isWeb()"
            (click)="scrollToCurrentSectionTop()">
      <ion-icon name="arrow-up"></ion-icon>
    </button>
  </div>
</ion-content>



