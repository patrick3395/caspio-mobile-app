<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/active-projects"></ion-back-button>
    </ion-buttons>
    <ion-title>Template Form</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="template-container">
    <!-- Save status indicator -->
    <div class="save-status" *ngIf="saveStatus" [class.info]="saveStatusType === 'info'" 
         [class.success]="saveStatusType === 'success'" [class.error]="saveStatusType === 'error'">
      {{ saveStatus }}
    </div>
    
    <!-- Progress dots -->
    <div class="progress-dots">
      <span class="dot" [class.active]="currentSection === 1" 
            [class.completed]="sectionProgress.general > 80 && sectionProgress.information > 80"
            (click)="goToSection(1)"></span>
      <span class="dot" [class.active]="currentSection === 2" 
            [class.completed]="sectionProgress.structural > 80"
            (click)="goToSection(2)"></span>
      <span class="dot" [class.active]="currentSection === 3" 
            [class.completed]="sectionProgress.elevation > 80"
            (click)="goToSection(3)"></span>
    </div>

    <form (ngSubmit)="submitForm()">
      <!-- Information Section -->
      <div class="section-card">
        <div class="section-header" (click)="toggleSection(1)">
          <div class="section-info">
            <div class="section-title">
              <span class="section-icon">📋</span>
              Information
            </div>
            <div class="section-description">Project details and contact information</div>
          </div>
          <ion-icon [name]="expandedSections[1] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
        
        <div class="section-content" *ngIf="expandedSections[1]">
          <!-- General Subsection -->
          <div class="subsection-card">
            <div class="subsection-header" (click)="toggleSubsection('general')">
              <span class="subsection-title">General (Service_EFE Data)</span>
              <span class="completion-badge">{{getGeneralCompletion()}}%</span>
              <ion-icon [name]="expandedSubsections['general'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
            </div>
            
            <div class="subsection-content" *ngIf="expandedSubsections['general']">
              <div class="form-row">
                <ion-item [class.completed]="hasValue('primaryPhoto')">
                  <ion-label position="stacked" [class.completed]="hasValue('primaryPhoto')">
                    <span *ngIf="hasValue('primaryPhoto')">✓ </span>Primary Photo
                  </ion-label>
                  <input type="file" (change)="onFileSelected($event, 'primaryPhoto')" accept="image/*">
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item [class.completed]="hasValue('inspectionDate')">
                  <ion-label position="stacked" [class.completed]="hasValue('inspectionDate')">
                    <span *ngIf="hasValue('inspectionDate')">✓ </span>Date of Inspection
                  </ion-label>
                  <ion-datetime [(ngModel)]="formData.inspectionDate" name="inspectionDate" 
                                displayFormat="MM/DD/YYYY"
                                (ionChange)="onFieldChange('inspectionDate', $event.detail.value)"
                                [class.has-value]="hasValue('inspectionDate')"></ion-datetime>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item [class.completed]="hasValue('buildingType')">
                  <ion-label position="stacked" [class.completed]="hasValue('buildingType')">
                    <span *ngIf="hasValue('buildingType')">✓ </span>Type of Building
                  </ion-label>
                  <ion-select [(ngModel)]="formData.buildingType" name="buildingType"
                              (ionChange)="onFieldChange('buildingType', $event.detail.value)"
                              [class.has-value]="hasValue('buildingType')">
                    <ion-select-option value="Single Family">Single Family</ion-select-option>
                    <ion-select-option value="Multi Family">Multi Family</ion-select-option>
                    <ion-select-option value="Commercial">Commercial</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Style</ion-label>
                  <ion-select [(ngModel)]="formData.style" name="style">
                    <ion-select-option value="Select Style">Select Style</ion-select-option>
                    <ion-select-option value="Ranch">Ranch</ion-select-option>
                    <ion-select-option value="Two Story">Two Story</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">In Attendance</ion-label>
                  <ion-textarea [(ngModel)]="formData.attendance" name="attendance" placeholder="Names of people present"></ion-textarea>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Weather Conditions</ion-label>
                  <ion-select [(ngModel)]="formData.weather" name="weather">
                    <ion-select-option value="Select Weather">Select Weather</ion-select-option>
                    <ion-select-option value="Clear">Clear</ion-select-option>
                    <ion-select-option value="Cloudy">Cloudy</ion-select-option>
                    <ion-select-option value="Rainy">Rainy</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Outdoor Temperature (°F)</ion-label>
                  <ion-input [(ngModel)]="formData.temperature" name="temperature" type="number" placeholder="e.g., 75"></ion-input>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Occupancy/Furnishings</ion-label>
                  <ion-select [(ngModel)]="formData.occupancy" name="occupancy">
                    <ion-select-option value="Select Status">Select Status</ion-select-option>
                    <ion-select-option value="Occupied">Occupied</ion-select-option>
                    <ion-select-option value="Vacant">Vacant</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
            </div>
          </div>

          <!-- Information Subsection -->
          <div class="subsection-card">
            <div class="subsection-header" (click)="toggleSubsection('information')">
              <span class="subsection-title">Information</span>
              <ion-icon [name]="expandedSubsections['information'] ? 'chevron-up' : 'chevron-down'"></ion-icon>
            </div>
            
            <div class="subsection-content" *ngIf="expandedSubsections['information']">
              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Company</ion-label>
                  <ion-select [(ngModel)]="formData.company" name="company">
                    <ion-select-option value="Noble Property Inspections">Noble Property Inspections</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">User</ion-label>
                  <ion-select [(ngModel)]="formData.user" name="user">
                    <ion-select-option value="Patrick Bullock">Patrick Bullock</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Date of Request</ion-label>
                  <ion-datetime [(ngModel)]="formData.date" name="date" displayFormat="MM/DD/YYYY"></ion-datetime>
                </ion-item>
              </div>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Requested Address</ion-label>
                  <ion-input [(ngModel)]="formData.requestedAddress" name="requestedAddress"></ion-input>
                </ion-item>
              </div>

              <ion-row>
                <ion-col size="6">
                  <ion-item>
                    <ion-label position="stacked">City</ion-label>
                    <ion-input [(ngModel)]="formData.city" name="city"></ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="3">
                  <ion-item>
                    <ion-label position="stacked">State</ion-label>
                    <ion-select [(ngModel)]="formData.state" name="state">
                      <ion-select-option value="TX">TX</ion-select-option>
                    </ion-select>
                  </ion-item>
                </ion-col>
                <ion-col size="3">
                  <ion-item>
                    <ion-label position="stacked">Zip</ion-label>
                    <ion-input [(ngModel)]="formData.zip" name="zip"></ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>

              <div class="form-row">
                <ion-item>
                  <ion-label position="stacked">Service Type</ion-label>
                  <ion-select [(ngModel)]="formData.serviceType" name="serviceType">
                    <ion-select-option value="Engineers Foundation Evaluation">Engineer's Foundation Evaluation</ion-select-option>
                    <ion-select-option value="Engineers Damaged Truss Evaluation">Engineer's Damaged Truss Evaluation</ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Structural Systems Section -->
      <div class="section-card">
        <div class="section-header" (click)="toggleSection(2)">
          <div class="section-info">
            <div class="section-title">
              <span class="section-icon">🏗️</span>
              Structural Systems
            </div>
            <div class="section-description">Upload inspection reports and documents</div>
          </div>
          <ion-icon [name]="expandedSections[2] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
        
        <div class="section-content" *ngIf="expandedSections[2]">
          <div class="form-row">
            <ion-item>
              <ion-label position="stacked">Home Inspection Report</ion-label>
              <input type="file" (change)="onFileSelected($event, 'homeInspection')" accept=".pdf,.doc,.docx">
              <p class="file-hint">Upload inspection report or provide link below</p>
            </ion-item>
          </div>

          <div class="form-row">
            <ion-item>
              <ion-label position="stacked">or Home Inspection Link</ion-label>
              <ion-input [(ngModel)]="formData.homeInspectionLink" name="homeInspectionLink" placeholder="Enter link"></ion-input>
            </ion-item>
          </div>

          <div class="form-row">
            <ion-item>
              <ion-label position="stacked">Engineer's Evaluation Report</ion-label>
              <input type="file" (change)="onFileSelected($event, 'engineerReport')" accept=".pdf,.doc,.docx">
            </ion-item>
          </div>

          <div class="form-row">
            <ion-item>
              <ion-label position="stacked">or Engineer's Evaluation Link</ion-label>
              <ion-input [(ngModel)]="formData.engineerLink" name="engineerLink" placeholder="Enter link"></ion-input>
            </ion-item>
          </div>

          <div class="form-row">
            <ion-item>
              <ion-label position="stacked">Support Document</ion-label>
              <input type="file" (change)="onFileSelected($event, 'supportDoc')" accept=".pdf,.doc,.docx">
            </ion-item>
          </div>
        </div>
      </div>

      <!-- Elevation Plot Section -->
      <div class="section-card">
        <div class="section-header" (click)="toggleSection(3)">
          <div class="section-info">
            <div class="section-title">
              <span class="section-icon">📊</span>
              Elevation Plot
            </div>
            <div class="section-description">Additional notes and measurements</div>
          </div>
          <ion-icon [name]="expandedSections[3] ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </div>
        
        <div class="section-content" *ngIf="expandedSections[3]">
          <div class="form-row">
            <ion-item>
              <ion-label position="stacked">Notes</ion-label>
              <ion-textarea [(ngModel)]="formData.notes" name="notes" rows="6" placeholder="Enter any additional notes or observations"></ion-textarea>
            </ion-item>
          </div>
        </div>
      </div>

      <!-- Service Fee and Submit -->
      <div class="footer-section">
        <div class="service-fee">
          Service Fee: <span class="fee-amount">${{serviceFee}}</span>
        </div>
        <ion-button expand="block" type="submit" color="primary" size="large">
          Submit
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>