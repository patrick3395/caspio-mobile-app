<div class="page-container">
  <div class="content-section">
    <!-- WEBAPP: Skeleton loaders -->
    <div *ngIf="loading && isWeb" class="skeleton-category-container">
      <div class="skeleton-search-bar"></div>
      <div class="skeleton-accordion-section" *ngFor="let section of [1,2,3]">
        <div class="skeleton-accordion-header">
          <div class="skeleton-badge"></div>
          <div class="skeleton-section-title"></div>
        </div>
        <div class="skeleton-accordion-content">
          <div class="skeleton-visual-item" *ngFor="let item of [1,2,3,4]">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-item-content">
              <div class="skeleton-item-title"></div>
              <div class="skeleton-item-text"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Content -->
    <div *ngIf="!loading" class="category-content fade-in">

      <!-- Search Bar -->
      <div class="search-container">
        <div class="search-input-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input
            type="text"
            class="search-input"
            placeholder="Search by title or description..."
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()">
          <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()" title="Clear search">
            <ion-icon name="close-circle"></ion-icon>
          </button>
        </div>
      </div>

      <!-- White container wrapper -->
      <div class="white-container">

        <!-- Information Section -->
        <ng-container *ngTemplateOutlet="sectionTemplate; context: {
          $implicit: organizedData.comments,
          sectionName: 'information',
          sectionTitle: 'Information',
          badgeClass: 'info',
          itemType: 'Comment'
        }"></ng-container>

        <!-- Limitations Section -->
        <ng-container *ngTemplateOutlet="sectionTemplate; context: {
          $implicit: organizedData.limitations,
          sectionName: 'limitations',
          sectionTitle: 'Limitations',
          badgeClass: 'limitation',
          itemType: 'Limitation'
        }"></ng-container>

        <!-- Deficiencies Section -->
        <ng-container *ngTemplateOutlet="sectionTemplate; context: {
          $implicit: organizedData.deficiencies,
          sectionName: 'deficiencies',
          sectionTitle: 'Deficiencies',
          badgeClass: 'deficiency',
          itemType: 'Deficiency'
        }"></ng-container>

      </div>
    </div>
  </div>

  <!-- Debug FAB Button (only if config has debug panel enabled) -->
  <div class="debug-fab" *ngIf="config?.categoryDetailFeatures?.hasDebugPanel" (click)="showDebugPanel()">
    <ion-icon name="bug-outline"></ion-icon>
    <span class="debug-count" *ngIf="debugLogs.length > 0">{{ debugLogs.length }}</span>
  </div>

  <!-- Debug Popup Panel -->
  <div class="debug-panel" *ngIf="showDebugPopup && config?.categoryDetailFeatures?.hasDebugPanel">
    <div class="debug-panel-header">
      <h3>Debug Log ({{ debugLogs.length }} entries)</h3>
      <button (click)="toggleDebugPopup()">Close</button>
    </div>
    <div class="debug-panel-content">
      <div *ngFor="let log of debugLogs" class="debug-entry" [ngClass]="log.type.toLowerCase()">
        <span class="debug-time">{{ log.time }}</span>
        <span class="debug-type">{{ log.type }}</span>
        <span class="debug-message">{{ log.message }}</span>
      </div>
      <div *ngIf="debugLogs.length === 0" class="debug-empty">
        No debug entries yet
      </div>
    </div>
    <div class="debug-panel-footer">
      <button (click)="debugLogs = []">Clear Log</button>
    </div>
  </div>
</div>

<!-- Section Template (DRY - used for all three sections) -->
<ng-template #sectionTemplate let-items let-sectionName="sectionName" let-sectionTitle="sectionTitle" let-badgeClass="badgeClass" let-itemType="itemType">
  <div class="simple-accordion" *ngIf="items">
    <div class="simple-accordion-header">
      <div class="accordion-header-content">
        <div class="icon-container">
          <span class="count-badge" [ngClass]="badgeClass">
            <span *ngIf="badgeClass === 'deficiency'">{{ getSelectedCount(items) }}</span>
            <ng-container *ngIf="badgeClass !== 'deficiency'">{{ getSelectedCount(items) }}</ng-container>
          </span>
        </div>
        <span class="type-header">{{ sectionTitle }}</span>
      </div>
      <div class="accordion-header-actions">
        <button class="add-visual-btn" (click)="addCustomVisual(categoryName, itemType)" [title]="'Add custom ' + itemType.toLowerCase()">
          <ion-icon name="add-circle-outline"></ion-icon>
        </button>
      </div>
    </div>
    <div class="simple-accordion-content">
      <div class="type-section">
        <ng-container *ngIf="{ list: filterItems(items) } as filtered">
          <div *ngIf="filtered.list.length === 0 && !searchTerm" class="no-items-message">
            No {{ sectionTitle.toLowerCase() }} yet.<br>Click + to add one.
          </div>
          <div *ngIf="filtered.list.length === 0 && searchTerm" class="no-items-message">
            No results found for "{{ searchTerm }}"
          </div>
          <div class="template-item" *ngFor="let item of filtered.list; trackBy: trackByItemId">
            <ng-container *ngTemplateOutlet="visualItemTemplate; context: { $implicit: item }"></ng-container>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Visual Item Template (DRY - used for each item in all sections) -->
<ng-template #visualItemTemplate let-item>
  <div class="visual-item-container" [class.selected]="isItemSelected(categoryName, item.lookupId)">

    <!-- Yes/No questions - answerType 1 -->
    <div class="answer-type-1-container" *ngIf="item.answerType === 1">
      <div class="item-header" (click)="toggleItemSelection(categoryName, item.lookupId); $event.stopPropagation()">
        <h3 class="item-name">
          <span [innerHTML]="highlightText(item.name)"></span>
          <span class="required-indicator" *ngIf="item.required">*</span>
        </h3>
      </div>
      <div class="item-text-wrapper" (click)="toggleItemSelection(categoryName, item.lookupId); $event.stopPropagation()">
        <p class="item-text" [innerHTML]="highlightText(item.originalText)"></p>
      </div>
      <div class="dropdown-container" (click)="$event.stopPropagation()">
        <select
          [(ngModel)]="item.answer"
          (ngModelChange)="onAnswerChange(categoryName, item); $event?.stopPropagation()"
          (change)="$event.stopPropagation()"
          [disabled]="isItemSaving(categoryName, item.lookupId)"
          class="styled-input">
          <option value="">-- Select --</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
        <ion-spinner *ngIf="isItemSaving(categoryName, item.lookupId)" name="crescent" class="saving-spinner"></ion-spinner>
      </div>
    </div>

    <!-- Multi-select questions - answerType 2 -->
    <div class="multi-select-container" *ngIf="item.answerType === 2">
      <div class="multi-select-header" [class.has-photos]="getPhotosForVisual(categoryName, item.lookupId).length > 0">
        <div class="multi-select-title">
          <h3>
            <span [innerHTML]="highlightText(item.name)"></span>
            <span class="required-indicator" *ngIf="item.required">*</span>
          </h3>
          <div class="item-text-wrapper">
            <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
          </div>
        </div>
        <div class="multi-select-indicators">
          <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.lookupId) > 0">
            <span class="photo-count">
              <ion-icon name="images"></ion-icon>
              {{ getTotalPhotoCount(categoryName, item.lookupId) }}
            </span>
          </div>
          <ion-spinner *ngIf="isItemSaving(categoryName, item.lookupId)" name="crescent"></ion-spinner>
        </div>
      </div>
      <div class="multi-select-options" *ngIf="getDropdownOptions(item.templateId).length > 0">
        <ion-item lines="none" *ngFor="let option of getDropdownOptions(item.templateId); trackBy: trackByOption" class="option-item">
          <ion-checkbox
            slot="start"
            [checked]="isOptionSelected(item, option)"
            (ionChange)="onOptionToggle(categoryName, item, option, $event); $event.stopPropagation()">
          </ion-checkbox>
          <ion-label>{{ option }}</ion-label>
        </ion-item>
      </div>
      <!-- Custom input for "Other" option -->
      <div class="other-input-container other-input-inline" *ngIf="isOptionSelected(item, 'Other')">
        <input type="text"
               [(ngModel)]="item.otherValue"
               (keyup.enter)="addMultiSelectOther(categoryName, item)"
               (click)="$event.stopPropagation()"
               placeholder="Type and press Enter..."
               class="styled-input other-input">
        <button class="add-btn-inline" (click)="addMultiSelectOther(categoryName, item)" title="Add">
          <ion-icon name="add"></ion-icon>
        </button>
      </div>
      <div class="no-options-message" *ngIf="getDropdownOptions(item.templateId).length === 0">
        <p>No options available for this item</p>
      </div>

      <!-- Action button grid for multi-select -->
      <ng-container *ngIf="isItemSelected(categoryName, item.lookupId)">
        <ng-container *ngTemplateOutlet="actionButtonsTemplate; context: { $implicit: item }"></ng-container>
        <ng-container *ngIf="isPhotosExpanded(categoryName, item.lookupId)">
          <ng-container *ngTemplateOutlet="photoPreviewTemplate; context: { $implicit: item }"></ng-container>
        </ng-container>
      </ng-container>
    </div>

    <!-- Checkbox questions - answerType 0 or undefined -->
    <ion-item lines="none"
              class="checkbox-item with-camera"
              [class.has-photos]="getPhotosForVisual(categoryName, item.lookupId).length > 0"
              *ngIf="!item.answerType || item.answerType === 0">
      <ion-checkbox
        slot="start"
        [checked]="isItemSelected(categoryName, item.lookupId)"
        [disabled]="isItemSaving(categoryName, item.lookupId)"
        (ionChange)="toggleItemSelection(categoryName, item.lookupId); $event.stopPropagation()">
      </ion-checkbox>
      <div style="flex: 1; display: flex; align-items: center;">
        <ion-label class="item-label" (click)="toggleItemSelection(categoryName, item.lookupId); $event.stopPropagation()" style="flex: 1;">
          <h3>
            <span [innerHTML]="highlightText(item.name)"></span>
            <span class="required-indicator" *ngIf="item.required">*</span>
          </h3>
          <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
        </ion-label>
        <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.lookupId) > 0">
          <span class="photo-count">
            <ion-icon name="images"></ion-icon>
            {{ getTotalPhotoCount(categoryName, item.lookupId) }}
          </span>
        </div>
      </div>
      <ion-spinner *ngIf="isItemSaving(categoryName, item.lookupId)" name="crescent" slot="end"></ion-spinner>
    </ion-item>

    <!-- Action buttons and photo preview for checkbox items -->
    <ng-container *ngIf="isItemSelected(categoryName, item.lookupId) && (!item.answerType || item.answerType === 0)">
      <ng-container *ngTemplateOutlet="actionButtonsTemplate; context: { $implicit: item }"></ng-container>
      <ng-container *ngIf="isPhotosExpanded(categoryName, item.lookupId)">
        <ng-container *ngTemplateOutlet="photoPreviewTemplate; context: { $implicit: item }"></ng-container>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<!-- Action Buttons Template -->
<ng-template #actionButtonsTemplate let-item>
  <div class="action-button-grid">
    <button class="action-btn" *ngIf="!isWeb" (click)="addPhotoFromCamera(categoryName, item.lookupId); $event.stopPropagation()">
      <ion-icon name="camera"></ion-icon>
      <span>Camera</span>
    </button>
    <button class="action-btn" (click)="addPhotoFromGallery(categoryName, item.lookupId); $event.stopPropagation()">
      <ion-icon name="images"></ion-icon>
      <span>Gallery</span>
    </button>
    <button class="action-btn secondary"
            (click)="togglePhotoExpansion(categoryName, item.lookupId); $event.stopPropagation()">
      <ion-icon [name]="isPhotosExpanded(categoryName, item.lookupId) ? 'chevron-up' : 'eye'"></ion-icon>
      <span>View ({{ getTotalPhotoCount(categoryName, item.lookupId) }})</span>
    </button>
    <button class="action-btn" (click)="openVisualDetail(categoryName, item); $event.stopPropagation()">
      <ion-icon name="arrow-forward"></ion-icon>
      <span>Details</span>
    </button>
  </div>
</ng-template>

<!-- Photo Preview Template -->
<ng-template #photoPreviewTemplate let-item>
  <div class="image-preview-section" style="position: relative;">
    <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.lookupId)">
      <ion-spinner name="dots" color="primary"></ion-spinner>
      <span>Uploading {{ getUploadingCount(categoryName, item.lookupId) }} photo(s)...</span>
    </div>
    <div class="image-preview-container">
      <!-- Skeleton loaders when photos are loading -->
      <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.lookupId)">
        <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.lookupId); let i = index">
          <div class="skeleton-image"></div>
          <div class="skeleton-caption"></div>
        </div>
      </ng-container>
      <!-- Actual photos when loaded -->
      <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.lookupId)">
        <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.lookupId); trackBy: trackByPhotoId"
             [class.uploading]="photo.uploading"
             [class.loading-image]="photo.loading"
             [class.annotated]="photo.hasAnnotations"
             [class.skeleton-loader]="photo.isSkeleton">
          <ng-container *ngIf="photo.isSkeleton">
            <div class="skeleton-image"></div>
            <div class="skeleton-caption"></div>
          </ng-container>
          <ng-container *ngIf="!photo.isSkeleton">
            <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.svg'"
                 width="90" height="90"
                 [alt]="photo.name"
                 (click)="viewPhoto(photo, categoryName, item.lookupId, $event)"
                 (error)="handleImageError($event, photo)"
                 [class.has-annotations]="photo.hasAnnotations"
                 [class.loading]="photo.displayState === 'remote_loading' || photo.loading">
            <div class="upload-indicator" *ngIf="photo.uploading || photo.displayState === 'remote_loading'">
              <ion-spinner name="crescent" color="light"></ion-spinner>
            </div>
            <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.lookupId); $event.stopPropagation()" title="Delete">
              <ion-icon name="close"></ion-icon>
            </button>
            <button
              class="room-photo-caption"
              (click)="openCaptionPopup(photo, categoryName, item.lookupId); $event.stopPropagation()">
              {{ photo.caption || 'Caption' }}
            </button>
          </ng-container>
        </div>
      </ng-container>
    </div>
  </div>
</ng-template>
