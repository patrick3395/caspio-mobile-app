
<ion-header class="custom-header">
  <ion-toolbar class="action-toolbar">
    <ion-title>{{ isCompanyOne ? 'Noble Client Management' : 'Company' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- CRM View for Company ID 1 -->
  <div *ngIf="isCompanyOne" class="page-shell">
    <!-- Global Company Filter -->
    <div class="global-company-filter">
      <div class="filter-header">
        <h3>Filter by Company</h3>
        <button *ngIf="globalCompanyFilterId" (click)="clearGlobalCompanyFilter()" class="clear-filter-btn">
          <ion-icon name="close-circle"></ion-icon>
          Clear Filter
        </button>
      </div>

      <div class="search-container">
        <ion-searchbar
          [(ngModel)]="globalCompanySearchTerm"
          (ionInput)="onGlobalCompanySearch($event.detail.value)"
          (ionFocus)="showCompanySuggestions = true"
          placeholder="Search companies"
          [class.has-selection]="globalCompanyFilterId !== null">
        </ion-searchbar>

        <!-- Autocomplete dropdown -->
        <div class="company-suggestions" *ngIf="showCompanySuggestions && filteredCompanySuggestions.length > 0 && !globalCompanyFilterId">
          <div
            *ngFor="let company of filteredCompanySuggestions"
            class="suggestion-item"
            (click)="selectGlobalCompany(company.CompanyID, company.CompanyName)">
            <div class="company-info">
              <strong>{{ company.CompanyName }}</strong>
              <span class="company-location">{{ buildCompanyAddress(company) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Active filter indicator -->
      <div class="active-filter-badge" *ngIf="globalCompanyFilterId">
        <ion-icon name="filter"></ion-icon>
        <span>Showing data for: <strong>{{ globalCompanySearchTerm }}</strong></span>
      </div>
    </div>

    <div class="tab-button-grid">
      <button class="tab-button" [class.active]="selectedTab === 'companies'" (click)="selectTab('companies')">
        <ion-icon name="business-outline"></ion-icon>
        <span>Companies</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'contacts'" (click)="selectTab('contacts')">
        <ion-icon name="people-outline"></ion-icon>
        <span>Contacts</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'tasks'" (click)="selectTab('tasks')">
        <ion-icon name="checkbox-outline"></ion-icon>
        <span>Tasks</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'meetings'" (click)="selectTab('meetings')">
        <ion-icon name="calendar-outline"></ion-icon>
        <span>Meetings</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'communications'" (click)="selectTab('communications')">
        <ion-icon name="chatbubbles-outline"></ion-icon>
        <span>Touches</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'invoices'" (click)="selectTab('invoices')">
        <ion-icon name="receipt-outline"></ion-icon>
        <span>Invoices</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'metrics'" (click)="selectTab('metrics')">
        <ion-icon name="analytics-outline"></ion-icon>
        <span>Metrics</span>
      </button>
    </div>
    <div *ngIf="selectedTab === 'companies'" class="tab-content companies-tab">
      <div class="companies-search-container">
        <ion-searchbar
          [(ngModel)]="companyFilters.search"
          (ionChange)="applyCompanyFilters()"
          placeholder="Search companies"
          animated="true"
          class="modern-search">
        </ion-searchbar>
      </div>

      <div class="stage-rollups" *ngIf="stageGroups.length; else emptyCompanies">
        <div class="stage-container" *ngFor="let group of stageGroups; trackBy: trackByStage">
          <div class="stage-header" (click)="toggleStageExpand(group.stage, $event)">
            <div class="stage-info">
              <h3 class="stage-name">{{ formatStageName(group.stage) }}</h3>
              <span class="stage-count">{{ group.companies.length }} {{ group.companies.length === 1 ? 'company' : 'companies' }}</span>
            </div>
            <div class="stage-expand-toggle">
              <ion-icon [name]="isStageExpanded(group.stage) ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
            </div>
          </div>

          <div class="companies-list" *ngIf="isStageExpanded(group.stage)">
            <div class="company-rollup"
                 *ngFor="let company of group.companies; trackBy: trackByCompany"
                 [class.selected]="company.CompanyID === selectedCompanyId"
                 [class.expanded]="isCompanyExpanded(company)">

              <div class="rollup-header" (click)="toggleCompanyExpand(company, $event)">
                <div class="company-info">
                  <h4 class="company-name">{{ company.CompanyName }}</h4>
                  <p class="company-location">{{ buildCompanyAddress(company) || 'No address' }}</p>
                </div>
                <div class="rollup-metrics">
                  <button
                    class="filter-toggle-btn"
                    (click)="applyCompanyFilter(company, $event)"
                    [class.active]="globalCompanyFilterId === company.CompanyID"
                    title="Filter all data to this company">
                    <ion-icon name="funnel-outline"></ion-icon>
                  </button>
                  <button class="expand-toggle" (click)="toggleCompanyExpand(company, $event)">
                    <ion-icon [name]="isCompanyExpanded(company) ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
                  </button>
                </div>
              </div>

              <div class="rollup-content" *ngIf="isCompanyExpanded(company)">
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Onboarding Date</label>
                    <p>{{ formatDate(company.DateOnboarded) || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Onboarding Stage</label>
                    <p>{{ company['Onboarding Stage'] || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Software</label>
                    <p>{{ company.SoftwareID || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Size</label>
                    <p>{{ company.Size || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Franchise</label>
                    <p>{{ company.Franchise ? 'Yes' : 'No' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Lead Source</label>
                    <p>{{ company.LeadSource || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Company Phone</label>
                    <p>
                      <a *ngIf="company.Phone" [href]="'tel:' + company.Phone" class="phone-link">
                        {{ formatPhone(company.Phone) }}
                      </a>
                      <span *ngIf="!company.Phone">Not provided</span>
                    </p>
                  </div>
                  <div class="detail-col">
                    <label>Company Email</label>
                    <p class="wrap-text">{{ company.Email || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>CC Email</label>
                    <p class="wrap-text">{{ company.CC_Email || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Website</label>
                    <p class="wrap-text">{{ company.Website || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Address</label>
                    <p>{{ company.Address || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>City</label>
                    <p>{{ company.City || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>State</label>
                    <p>{{ company.State || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Zip</label>
                    <p>{{ company.Zip || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Contract Document</label>
                    <p>{{ company.Contract || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col" style="grid-column: 1 / -1;">
                    <label>Service Area(s)</label>
                    <p class="wrap-text">{{ company.ServiceArea || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col" style="grid-column: 1 / -1;">
                    <label>Notes</label>
                    <p class="wrap-text">{{ company.Notes || 'No notes' }}</p>
                  </div>
                </div>
                <div class="rollup-actions">
                  <button class="action-btn" (click)="editCompany(company, $event)">
                    <ion-icon name="create-outline"></ion-icon>
                    <span>Edit Company</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyCompanies>
        <div class="empty-state-modern">
          <div class="empty-icon-wrapper">
            <ion-icon name="business"></ion-icon>
          </div>
          <h3>No companies found</h3>
          <p>Try adjusting your search or filters to find companies</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'contacts'" class="tab-content contacts-tab">
      <div class="contacts-search-container">
        <ion-searchbar
          [value]="contactsSearchTerm"
          (ionInput)="onContactSearchChange($event.detail.value)"
          (ionClear)="onContactSearchChange('')"
          placeholder="Search contacts by name"
          animated="true">
        </ion-searchbar>
      </div>

      <div class="contact-groups" *ngIf="paginatedContactGroups.length; else emptyContacts">
        <div class="pagination-controls" *ngIf="totalContactPages > 1">
          <button class="pagination-btn arrow-only" (click)="prevContactPage()" [disabled]="currentContactPage === 1">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </button>
          <span class="page-indicator">{{ currentContactPage }} of {{ totalContactPages }}</span>
          <button class="pagination-btn arrow-only" (click)="nextContactPage()" [disabled]="currentContactPage === totalContactPages">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </button>
        </div>
        <div class="contact-group" *ngFor="let group of paginatedContactGroups; trackBy: trackByContactGroup">
          <div class="contact-group-header">
            <h4>{{ group.companyName }}</h4>
            <div class="metric-badge">
              <ion-icon name="people-outline"></ion-icon>
              <span>{{ group.contacts.length }}</span>
            </div>
          </div>
          <div class="responsive-table dark-outline">
            <table>
              <thead>
                <tr>
                  <th>Contact</th>
                  <th>Phone</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let contact of group.contacts; trackBy: trackByContact">
                  <td>
                    <button type="button" class="contact-name-button" (click)="openContactModal(contact)">
                      {{ contact.Name }}
                    </button>
                    <ion-chip *ngIf="contact.PrimaryContact" color="success" size="small">Primary</ion-chip>
                  </td>
                  <td>
                    <a *ngIf="contact.Phone1" [href]="'tel:' + contact.Phone1" class="phone-link">
                      {{ formatPhone(contact.Phone1) }}
                    </a>
                    <span *ngIf="!contact.Phone1">—</span>
                  </td>
                  <td>
                    <a *ngIf="contact.Email" [href]="'mailto:' + contact.Email">{{ contact.Email }}</a>
                    <span *ngIf="!contact.Email">—</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <ng-template #emptyContacts>
        <div class="empty-tab-state">
          <ion-icon name="people-outline"></ion-icon>
          <h3>No contacts match your filters</h3>
          <p>Adjust the filters or search criteria.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'tasks'" class="tab-content tasks-tab">
      <div class="tasks-filters">
        <ion-searchbar
          [(ngModel)]="taskFilters.search"
          (ionChange)="applyTaskFilters()"
          placeholder="Search tasks"
          animated="true">
        </ion-searchbar>

        <div class="filter-group">
          <label for="status-filter">Status</label>
          <select
            id="status-filter"
            [(ngModel)]="taskFilters.status"
            (ngModelChange)="applyTaskFilters()"
            class="styled-input">
            <option value="all">All</option>
            <option value="open">Open</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="assignee-filter">Assignee</label>
          <select
            id="assignee-filter"
            [(ngModel)]="taskFilters.assignedTo"
            (ngModelChange)="applyTaskFilters()"
            class="styled-input">
            <option value="all">All assignees</option>
            <option *ngFor="let person of taskAssignees" [value]="person">{{ person }}</option>
          </select>
        </div>

        <div class="task-time-tabs">
          <button class="time-tab" [class.active]="taskFilters.timeframe === 'overdue'" (click)="setTaskTimeframe('overdue')">
            Overdue
          </button>
          <button class="time-tab" [class.active]="taskFilters.timeframe === 'past'" (click)="setTaskTimeframe('past')">
            Past
          </button>
          <button class="time-tab" [class.active]="taskFilters.timeframe === '7day'" (click)="setTaskTimeframe('7day')">
            7 Day
          </button>
          <button class="time-tab" [class.active]="taskFilters.timeframe === 'all'" (click)="setTaskTimeframe('all')">
            All
          </button>
        </div>
      </div>

      <div *ngIf="filteredTasks.length; else emptyTasks" class="tasks-grid">
        <ion-card *ngFor="let task of paginatedTasks; trackBy: trackByTask" class="task-card" [class.completed]="task.completed" [class.overdue]="task.isOverdue">
          <ion-item lines="none" class="task-card-header">
            <ion-checkbox
              slot="start"
              [checked]="task.completed"
              [disabled]="isTaskUpdating(task)"
              (ionChange)="toggleTaskCompletion(task, $event.detail.checked)">
            </ion-checkbox>
            <ion-label>
              <h4>{{ task.assignTo || 'Unassigned' }} • {{ task.communicationType || 'General' }}</h4>
              <p>{{ task.assignmentShort || task.assignment || 'No details provided' }}</p>
            </ion-label>
            <ion-badge color="success" *ngIf="task.completed">Completed</ion-badge>
            <ion-badge color="danger" *ngIf="!task.completed && task.isOverdue">Overdue</ion-badge>
          </ion-item>
          <ion-card-content>
            <div class="task-meta">
              <span><ion-icon name="calendar-outline"></ion-icon>{{ formatDate(task.dueDate) }}</span>
              <span *ngIf="task.notes"><ion-icon name="document-text-outline"></ion-icon>{{ task.notes }}</span>
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(task.CompanyID) }}</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
      <!-- Pagination controls for Tasks -->
      <div class="pagination-controls" *ngIf="filteredTasks.length > tasksPerPage">
        <button (click)="prevTaskPage()" [disabled]="currentTaskPage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentTaskPage }} of {{ totalTaskPages }}</span>
        <button (click)="nextTaskPage()" [disabled]="currentTaskPage === totalTaskPages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>
      <ng-template #emptyTasks>
        <div class="empty-tab-state">
          <ion-icon name="checkbox-outline"></ion-icon>
          <h3>No tasks match your filters</h3>
          <p>Try expanding your filters or change the scope.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'meetings'" class="tab-content meetings-tab">
      <div class="meetings-filters">
        <ion-searchbar
          [(ngModel)]="meetingFilters.search"
          (ionChange)="applyMeetingFilters()"
          placeholder="Search subjects or attendees"
          animated="true">
        </ion-searchbar>
        <ion-segment size="small" [(ngModel)]="meetingFilters.timeframe" (ionChange)="applyMeetingFilters()">
          <ion-segment-button value="upcoming">
            <ion-label>Upcoming</ion-label>
          </ion-segment-button>
          <ion-segment-button value="past">
            <ion-label>Past</ion-label>
          </ion-segment-button>
          <ion-segment-button value="all">
            <ion-label>All</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <div *ngIf="filteredMeetings.length; else emptyMeetings" class="timeline">
        <div class="timeline-item" *ngFor="let meeting of paginatedMeetings">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <div class="timeline-header">
              <h4>{{ meeting.subject }}</h4>
              <span>{{ formatDate(meeting.startDate) }}</span>
            </div>
            <p>{{ meeting.description || 'No description provided.' }}</p>
            <div class="timeline-meta">
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(meeting.CompanyID) }}</span>
              <span><ion-icon name="people-outline"></ion-icon>{{ meeting.attendees.length ? meeting.attendees.join(', ') : 'No attendees listed' }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Pagination controls for Meetings -->
      <div class="pagination-controls" *ngIf="filteredMeetings.length > meetingsPerPage">
        <button (click)="prevMeetingPage()" [disabled]="currentMeetingPage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentMeetingPage }} of {{ totalMeetingPages }}</span>
        <button (click)="nextMeetingPage()" [disabled]="currentMeetingPage === totalMeetingPages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>
      <ng-template #emptyMeetings>
        <div class="empty-tab-state">
          <ion-icon name="calendar-outline"></ion-icon>
          <h3>No meetings to display</h3>
          <p>Schedule or log meetings to see them here.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'communications'" class="tab-content communications-tab">
      <div class="section-header">
        <div>
          <h3>Touches</h3>
          <p>Communication history across all companies</p>
        </div>
        <ion-searchbar
          [(ngModel)]="communicationSearchTerm"
          (ionChange)="applyCommunicationFilters()"
          placeholder="Search notes or outcomes"
          animated="true">
        </ion-searchbar>
      </div>

      <div *ngIf="filteredCommunications.length; else emptyCommunications" class="communications-timeline">
        <div class="communication-card" *ngFor="let comm of paginatedCommunications">
          <div class="communication-header">
            <h4>{{ comm.communicationType }}</h4>
            <span>{{ formatDate(comm.date) }}</span>
          </div>
          <p>{{ comm.notes || 'No notes added.' }}</p>
          <div class="communication-meta">
            <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(comm.CompanyID) }}</span>
            <span><ion-icon name="swap-horizontal-outline"></ion-icon>{{ comm.outcome }}</span>
            <span *ngIf="comm.channels.length"><ion-icon name="share-social-outline"></ion-icon>{{ comm.channels.join(', ') }}</span>
          </div>
        </div>
      </div>
      <!-- Pagination controls for Communications -->
      <div class="pagination-controls" *ngIf="filteredCommunications.length > communicationsPerPage">
        <button (click)="prevCommunicationPage()" [disabled]="currentCommunicationPage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentCommunicationPage }} of {{ totalCommunicationPages }}</span>
        <button (click)="nextCommunicationPage()" [disabled]="currentCommunicationPage === totalCommunicationPages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>
      <ng-template #emptyCommunications>
        <div class="empty-tab-state">
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          <h3>No touches found</h3>
          <p>Log calls, emails or messages to build your timeline.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'metrics'" class="tab-content metrics-tab">
      <div class="section-header">
        <div>
          <h3>Metrics</h3>
          <p>Business metrics and analytics</p>
        </div>
      </div>

      <div class="empty-tab-state">
        <ion-icon name="analytics-outline"></ion-icon>
        <h3>Metrics Dashboard Coming Soon</h3>
        <p>Key performance indicators and analytics will be displayed here.</p>
      </div>
    </div>
    <div *ngIf="selectedTab === 'invoices'" class="tab-content invoices-tab">
      <div class="invoice-filters">
        <ion-searchbar
          [(ngModel)]="invoiceSearchTerm"
          (ionChange)="categorizeInvoices()"
          placeholder="Search invoice, project, or company"
          animated="true">
        </ion-searchbar>
        <div class="invoice-tabs">
          <button class="invoice-tab" [class.active]="invoiceViewMode === 'open'" (click)="setInvoiceViewMode('open')">
            Open
          </button>
          <button class="invoice-tab" [class.active]="invoiceViewMode === 'past'" (click)="setInvoiceViewMode('past')">
            Past
          </button>
          <button class="invoice-tab" [class.active]="invoiceViewMode === 'unpaid'" (click)="setInvoiceViewMode('unpaid')">
            Unpaid
          </button>
        </div>
      </div>

      <div class="invoice-summary">
        <div class="summary-row">
          <div class="summary-pill">
            <span>Total</span>
            <strong>{{ formatCurrency(invoiceMetrics.total) }}</strong>
          </div>
          <div class="summary-pill success">
            <span>Paid</span>
            <strong>{{ formatCurrency(invoiceMetrics.paid) }}</strong>
          </div>
        </div>
        <div class="summary-row">
          <div class="summary-pill warning full-width">
            <span>Outstanding</span>
            <strong>{{ formatCurrency(invoiceMetrics.outstanding) }}</strong>
          </div>
        </div>
      </div>

      <ng-container *ngIf="openInvoices.length || unpaidInvoices.length || paidInvoiceGroups.length; else emptyInvoices">
        <div class="invoice-section" *ngIf="invoiceViewMode === 'open' && openInvoices.length">
          <div class="responsive-table">
            <table>
              <thead>
                <tr>
                  <th>Project Date</th>
                  <th>Project Address</th>
                  <th>Amount Due</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pair of openInvoices">
                  <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                  <td>{{ pair.positive.Address || '—' }}</td>
                  <td>{{ formatCurrency(pair.netAmount) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="invoice-section" *ngIf="invoiceViewMode === 'unpaid' && unpaidInvoices.length">
          <div class="responsive-table">
            <table>
              <thead>
                <tr>
                  <th>Project Date</th>
                  <th>Project Address</th>
                  <th>Amount Due</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pair of unpaidInvoices">
                  <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                  <td>{{ pair.positive.Address || '—' }}</td>
                  <td>{{ formatCurrency(pair.netAmount) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="invoice-section" *ngIf="invoiceViewMode === 'past' && paidInvoiceGroups.length">
          <div class="invoice-paid-groups">
            <div class="invoice-group-card" *ngFor="let group of paginatedPaidGroups">
              <div class="invoice-group-header">
                <h5>{{ group.companyName }}</h5>
                <span>{{ group.items.length }} {{ group.items.length === 1 ? 'project' : 'projects' }}</span>
              </div>
              <div class="responsive-table slim">
                <table>
                  <thead>
                    <tr>
                      <th>Project Date</th>
                      <th>Project Address</th>
                      <th>Amount Due</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let pair of group.items">
                      <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                      <td>{{ pair.positive.Address || '—' }}</td>
                      <td>{{ formatCurrency(pair.netAmount) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- Pagination controls for Invoices -->
      <div class="pagination-controls" *ngIf="(openInvoices.length || unpaidInvoices.length || paidInvoiceGroups.length) && totalInvoicePages > 1">
        <button (click)="prevInvoicePage()" [disabled]="currentInvoicePage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentInvoicePage }} of {{ totalInvoicePages }}</span>
        <button (click)="nextInvoicePage()" [disabled]="currentInvoicePage === totalInvoicePages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>

      <ng-template #emptyInvoices>
        <div class="empty-tab-state">
          <ion-icon name="receipt-outline"></ion-icon>
          <h3>No invoices found</h3>
          <p>Once invoices are generated they will appear here.</p>
        </div>
      </ng-template>
    </div>

    <!-- Bottom spacer to ensure full scrolling on mobile -->
    <div class="bottom-spacer"></div>
  </div>

  <!-- Organization Users View for non-Company 1 users -->
  <div *ngIf="!isCompanyOne" class="page-shell">
    <div class="section-header">
      <div>
        <h3>Organization Users</h3>
        <p>View users in your organization</p>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="empty-state-modern">
      <ion-spinner name="crescent"></ion-spinner>
      <h3>Loading users...</h3>
    </div>

    <!-- Users List -->
    <div *ngIf="!isLoading && organizationUsers.length > 0" class="responsive-table">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Role</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of organizationUsers">
            <td>{{ user.Name }}</td>
            <td><a [href]="'mailto:' + user.Email">{{ user.Email }}</a></td>
            <td>{{ user.Phone || '—' }}</td>
            <td>{{ user.Role || '—' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && organizationUsers.length === 0" class="empty-state-modern">
      <div class="empty-icon-wrapper">
        <ion-icon name="people"></ion-icon>
      </div>
      <h3>No users found</h3>
      <p>No users found in your organization</p>
    </div>
  </div>
</ion-content>

<ion-modal [isOpen]="isContactModalOpen" (didDismiss)="closeContactModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ selectedContact?.Name || 'Contact Details' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeContactModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="contact-modal-content" *ngIf="selectedContact">
      <div class="contact-detail-card">
        <h4>{{ selectedContact.Name }}</h4>
        <p *ngIf="selectedContact.Goal">Goal: {{ selectedContact.Goal }}</p>
        <div class="contact-detail-grid">
          <div>
            <strong>Company</strong>
            <p>{{ getCompanyName(selectedContact.CompanyID) }}</p>
          </div>
          <div>
            <strong>Title</strong>
            <p>{{ selectedContact.Title || '—' }}</p>
          </div>
          <div>
            <strong>Email</strong>
            <p>
              <a *ngIf="selectedContact.Email" [href]="'mailto:' + selectedContact.Email">{{ selectedContact.Email }}</a>
              <span *ngIf="!selectedContact.Email">—</span>
            </p>
          </div>
          <div>
            <strong>Phone</strong>
            <p>
              <a *ngIf="selectedContact.Phone1" [href]="'tel:' + selectedContact.Phone1" class="phone-link">
                {{ formatPhone(selectedContact.Phone1) }}
              </a>
              <span *ngIf="!selectedContact.Phone1">—</span>
            </p>
          </div>
          <div>
            <strong>Secondary Phone</strong>
            <p>
              <a *ngIf="selectedContact.Phone2" [href]="'tel:' + selectedContact.Phone2" class="phone-link">
                {{ formatPhone(selectedContact.Phone2) }}
              </a>
              <span *ngIf="!selectedContact.Phone2">—</span>
            </p>
          </div>
          <div>
            <strong>Role</strong>
            <p>{{ selectedContact.Role || '—' }}</p>
          </div>
          <div>
            <strong>Notes</strong>
            <p>{{ selectedContact.Notes || 'No notes recorded.' }}</p>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Edit Company</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditModal()">Cancel</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="saveCompanyChanges()" [strong]="true">Save</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingCompany">
      <div class="edit-form">
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company Name</label>
              <input type="text" [(ngModel)]="editingCompany.CompanyName" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Onboarding Date</label>
              <input type="date" [(ngModel)]="editingCompany.DateOnboarded" class="form-input">
            </div>
            <div class="form-field">
              <label>Onboarding Stage</label>
              <input type="text" [(ngModel)]="editingCompany['Onboarding Stage']" class="form-input">
            </div>
            <div class="form-field">
              <label>Software</label>
              <input type="text" [(ngModel)]="editingCompany.SoftwareID" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Size</label>
              <input type="text" [(ngModel)]="editingCompany.Size" class="form-input">
            </div>
            <div class="form-field">
              <label>Franchise</label>
              <ion-toggle [(ngModel)]="editingCompany.Franchise"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Lead Source</label>
              <input type="text" [(ngModel)]="editingCompany.LeadSource" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Contact Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company Phone</label>
              <input type="tel" [(ngModel)]="editingCompany.Phone" class="form-input">
            </div>
            <div class="form-field">
              <label>Company Email</label>
              <input type="email" [(ngModel)]="editingCompany.Email" class="form-input">
            </div>
            <div class="form-field">
              <label>CC Email</label>
              <input type="email" [(ngModel)]="editingCompany.CC_Email" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Website</label>
              <input type="text" [(ngModel)]="editingCompany.Website" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Address</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Address</label>
              <input type="text" [(ngModel)]="editingCompany.Address" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>City</label>
              <input type="text" [(ngModel)]="editingCompany.City" class="form-input">
            </div>
            <div class="form-field">
              <label>State</label>
              <input type="text" [(ngModel)]="editingCompany.State" class="form-input">
            </div>
            <div class="form-field">
              <label>Zip</label>
              <input type="text" [(ngModel)]="editingCompany.Zip" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Additional Details</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Service Area(s)</label>
              <textarea [(ngModel)]="editingCompany.ServiceArea" class="form-textarea" rows="3"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Contract Document</label>
              <input type="text" [(ngModel)]="editingCompany.Contract" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingCompany.Notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
