
<ion-header class="company-header">
  <ion-toolbar class="company-toolbar">
    <ion-title>
      <div class="toolbar-title">
        <span>Company CRM</span>
        <small>{{ companies.length }} companies across {{ stages.length }} stages</small>
      </div>
    </ion-title>
    <ion-buttons slot="end" class="toolbar-actions">
      <ion-select
        interface="popover"
        placeholder="Focus company"
        [value]="selectedCompanyId"
        (ionChange)="setSelectedCompany($event.detail.value)">
        <ion-select-option *ngFor="let company of companies" [value]="company.CompanyID">
          {{ company.CompanyName }}
        </ion-select-option>
      </ion-select>
      <ion-button fill="clear" color="primary" (click)="loadCompanyData()">
        <ion-icon slot="start" name="refresh-outline"></ion-icon>
        Refresh
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="page-shell">
    <ion-segment
      [(ngModel)]="selectedTab"
      (ionChange)="onTabChange($event)"
      class="company-tabs"
      scrollable
      mode="ios">
      <ion-segment-button value="companies">
        <ion-label>Companies</ion-label>
      </ion-segment-button>
      <ion-segment-button value="contacts">
        <ion-label>Contacts</ion-label>
      </ion-segment-button>
      <ion-segment-button value="tasks">
        <ion-label>Tasks</ion-label>
      </ion-segment-button>
      <ion-segment-button value="meetings">
        <ion-label>Meetings</ion-label>
      </ion-segment-button>
      <ion-segment-button value="communications">
        <ion-label>Touches</ion-label>
      </ion-segment-button>
      <ion-segment-button value="invoices">
        <ion-label>Invoices</ion-label>
      </ion-segment-button>
    </ion-segment>
    <div *ngIf="selectedTab === 'companies'" class="tab-content companies-tab">
      <div *ngIf="selectedCompany" class="selected-company-card">
        <div class="selected-company-header">
          <div>
            <h2>{{ selectedCompany.CompanyName }}</h2>
            <p>
              {{ selectedCompany.StageName }}
              <span *ngIf="selectedCompany.City || selectedCompany.State">
                • {{ selectedCompany.City || 'Location unknown' }}
                <span *ngIf="selectedCompany.State">, {{ selectedCompany.State }}</span>
              </span>
            </p>
          </div>
          <div class="selected-company-actions">
            <ion-chip *ngIf="selectedCompany.SizeLabel" color="tertiary" size="small">
              {{ selectedCompany.SizeLabel }}
            </ion-chip>
            <ion-chip *ngIf="selectedCompany.Franchise" color="success" size="small">
              Franchise Partner
            </ion-chip>
          </div>
        </div>

        <div class="snapshot-grid">
          <div class="snapshot-card" *ngFor="let item of companySnapshot">
            <ion-icon [name]="item.icon"></ion-icon>
            <div>
              <p>{{ item.label }}</p>
              <h3>{{ item.value }}</h3>
              <a *ngIf="item.hint" [href]="'mailto:' + item.hint">{{ item.hint }}</a>
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card" *ngFor="let stat of companyStats">
            <ion-icon [name]="stat.icon"></ion-icon>
            <div>
              <p>{{ stat.title }}</p>
              <h3>{{ stat.value }}</h3>
              <span *ngIf="stat.subtitle">{{ stat.subtitle }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="company-scope-toggle">
        <ion-segment
          size="small"
          [value]="companyViewScope"
          (ionChange)="onCompanyScopeChange($event)">
          <ion-segment-button value="all">
            <ion-label>All companies</ion-label>
          </ion-segment-button>
          <ion-segment-button value="noble">
            <ion-label>Noble</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <div class="stage-summary">
        <div
          class="stage-summary-card"
          *ngFor="let summary of stageSummary"
          [class.active]="summary.highlight"
          (click)="setStageFilter(summary.stage.id)">
          <div class="stage-summary-header">
            <h4>{{ summary.stage.name }}</h4>
            <span>{{ summary.count }}</span>
          </div>
          <p>{{ summary.count === 1 ? 'Company' : 'Companies' }}</p>
        </div>
      </div>

      <div class="company-filters">
        <ion-searchbar
          [(ngModel)]="companyFilters.search"
          (ionChange)="applyCompanyFilters()"
          placeholder="Search by name, city or service area"
          animated="true">
        </ion-searchbar>

        <ion-select
          label="Stage"
          interface="popover"
          [(ngModel)]="companyFilters.stage"
          (ionChange)="applyCompanyFilters()">
          <ion-select-option value="all">All stages</ion-select-option>
          <ion-select-option *ngFor="let stage of stages" [value]="stage.id">{{ stage.name }}</ion-select-option>
          <ion-select-option value="0">No stage</ion-select-option>
        </ion-select>

        <ion-select
          label="Company Size"
          interface="popover"
          [(ngModel)]="companyFilters.size"
          (ionChange)="applyCompanyFilters()">
          <ion-select-option value="all">All sizes</ion-select-option>
          <ion-select-option *ngFor="let size of uniqueCompanySizes" [value]="size">{{ size }}</ion-select-option>
        </ion-select>

        <ion-select
          label="Lead Source"
          interface="popover"
          [(ngModel)]="companyFilters.leadSource"
          (ionChange)="applyCompanyFilters()">
          <ion-select-option value="all">All sources</ion-select-option>
          <ion-select-option *ngFor="let source of uniqueLeadSources" [value]="source">{{ source }}</ion-select-option>
        </ion-select>

        <ion-toggle
          [(ngModel)]="companyFilters.onlyFranchise"
          (ionChange)="applyCompanyFilters()">Franchise only</ion-toggle>
        <ion-toggle
          [(ngModel)]="companyFilters.hasNotes"
          (ionChange)="applyCompanyFilters()">Has notes</ion-toggle>
        <ion-button fill="clear" size="small" color="medium" (click)="clearCompanyFilters()">
          Clear filters
        </ion-button>
      </div>

      <div class="stage-board">
        <div class="stage-column" *ngFor="let group of stageGroups">
          <div class="stage-column-header">
            <h4>{{ group.stage.name }}</h4>
            <span>{{ group.companies.length }}</span>
          </div>
          <div class="stage-column-body">
            <ng-container *ngIf="group.companies.length; else emptyStage">
              <div
                class="company-card"
                *ngFor="let company of group.companies"
                [class.selected]="company.CompanyID === selectedCompanyId"
                (click)="setSelectedCompany(company.CompanyID)">
                <div class="company-card-header">
                  <h5>{{ company.CompanyName }}</h5>
                  <ion-chip *ngIf="company.SizeLabel" color="tertiary" size="small">{{ company.SizeLabel }}</ion-chip>
                </div>
                <p class="company-location">
                  {{ company.City || 'Location unknown' }}
                  <span *ngIf="company.State">• {{ company.State }}</span>
                </p>
                <div class="company-card-metrics">
                  <span><ion-icon name="people-outline"></ion-icon>{{ company.contactCount }}</span>
                  <span><ion-icon name="checkbox-outline"></ion-icon>{{ company.openTasks }}</span>
                  <span><ion-icon name="chatbubble-ellipses-outline"></ion-icon>{{ company.totalTouches }}</span>
                </div>
                <div class="company-card-footer">
                  <span>{{ company.lastTouchLabel }}</span>
                  <span *ngIf="company.upcomingMeetingDate">Next: {{ formatDate(company.upcomingMeetingDate) }}</span>
                </div>
              </div>
            </ng-container>
            <ng-template #emptyStage>
              <div class="empty-column">No companies</div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="selectedTab === 'contacts'" class="tab-content contacts-tab">
      <div class="section-header">
        <div>
          <h3>Contacts</h3>
          <p>People linked to your companies</p>
        </div>
        <ion-searchbar
          [(ngModel)]="contactsSearchTerm"
          (ionChange)="applyContactFilters()"
          placeholder="Search contacts by name"
          animated="true">
        </ion-searchbar>
      </div>

      <div class="contact-groups" *ngIf="contactGroups.length; else emptyContacts">
        <div class="contact-group" *ngFor="let group of contactGroups">
          <div class="contact-group-header">
            <h4>{{ group.companyName }}</h4>
            <span>{{ group.contacts.length }} {{ group.contacts.length === 1 ? 'person' : 'people' }}</span>
          </div>
          <div class="responsive-table dark-outline">
            <table>
              <thead>
                <tr>
                  <th>Contact</th>
                  <th>Title</th>
                  <th>Phone</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let contact of group.contacts">
                  <td>
                    <strong>{{ contact.Name }}</strong>
                    <ion-chip *ngIf="contact.PrimaryContact" color="success" size="small">Primary</ion-chip>
                  </td>
                  <td>
                    <div>{{ contact.Title || '—' }}</div>
                    <small *ngIf="contact.Goal">Goal: {{ contact.Goal }}</small>
                  </td>
                  <td>{{ formatPhone(contact.Phone1) || '—' }}</td>
                  <td>
                    <a *ngIf="contact.Email" [href]="'mailto:' + contact.Email">{{ contact.Email }}</a>
                    <span *ngIf="!contact.Email">—</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <ng-template #emptyContacts>
        <div class="empty-tab-state">
          <ion-icon name="people-outline"></ion-icon>
          <h3>No contacts match your filters</h3>
          <p>Adjust the filters or search criteria.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'tasks'" class="tab-content tasks-tab">
      <div class="section-header">
        <div>
          <h3>Tasks</h3>
          <p>{{ taskMetrics.outstanding }} open · {{ taskMetrics.overdue }} overdue</p>
        </div>
        <ion-segment size="small" [(ngModel)]="taskFilters.scope" (ionChange)="applyTaskFilters()">
          <ion-segment-button value="selected" [disabled]="!selectedCompanyId">
            <ion-label>Focus company</ion-label>
          </ion-segment-button>
          <ion-segment-button value="all">
            <ion-label>All companies</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <div class="tasks-filters">
        <ion-searchbar
          [(ngModel)]="taskFilters.search"
          (ionChange)="applyTaskFilters()"
          placeholder="Search tasks"
          animated="true">
        </ion-searchbar>

        <ion-select
          label="Status"
          interface="popover"
          [(ngModel)]="taskFilters.status"
          (ionChange)="applyTaskFilters()">
          <ion-select-option value="all">All</ion-select-option>
          <ion-select-option value="open">Open</ion-select-option>
          <ion-select-option value="completed">Completed</ion-select-option>
        </ion-select>

        <ion-select
          label="Assignee"
          interface="popover"
          [(ngModel)]="taskFilters.assignedTo"
          (ionChange)="applyTaskFilters()">
          <ion-select-option value="all">All assignees</ion-select-option>
          <ion-select-option *ngFor="let person of taskAssignees" [value]="person">{{ person }}</ion-select-option>
        </ion-select>

        <ion-toggle
          [(ngModel)]="taskFilters.overdueOnly"
          (ionChange)="applyTaskFilters()">Overdue only</ion-toggle>
      </div>

      <div *ngIf="filteredTasks.length; else emptyTasks" class="tasks-grid">
        <ion-card *ngFor="let task of filteredTasks" class="task-card" [class.completed]="task.completed" [class.overdue]="task.isOverdue">
          <ion-item lines="none" class="task-card-header">
            <ion-checkbox
              slot="start"
              [checked]="task.completed"
              [disabled]="isTaskUpdating(task)"
              (ionChange)="toggleTaskCompletion(task, $event.detail.checked)">
            </ion-checkbox>
            <ion-label>
              <h4>{{ task.assignmentShort || task.assignment || 'Task' }}</h4>
              <p>{{ task.assignTo || 'Unassigned' }} • {{ task.communicationType || 'General' }}</p>
            </ion-label>
            <ion-badge color="success" *ngIf="task.completed">Completed</ion-badge>
            <ion-badge color="danger" *ngIf="!task.completed && task.isOverdue">Overdue</ion-badge>
          </ion-item>
          <ion-card-content>
            <div class="task-meta">
              <span><ion-icon name="calendar-outline"></ion-icon>{{ formatDate(task.dueDate) }}</span>
              <span *ngIf="task.notes"><ion-icon name="document-text-outline"></ion-icon>{{ task.notes }}</span>
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(task.CompanyID) }}</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
      <ng-template #emptyTasks>
        <div class="empty-tab-state">
          <ion-icon name="checkbox-outline"></ion-icon>
          <h3>No tasks match your filters</h3>
          <p>Try expanding your filters or change the scope.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'meetings'" class="tab-content meetings-tab">
      <div class="section-header">
        <div>
          <h3>Meetings</h3>
          <p>Past and upcoming touchpoints</p>
        </div>
      </div>

      <div class="meetings-filters">
        <ion-searchbar
          [(ngModel)]="meetingFilters.search"
          (ionChange)="applyMeetingFilters()"
          placeholder="Search subjects or attendees"
          animated="true">
        </ion-searchbar>
        <ion-segment size="small" [(ngModel)]="meetingFilters.timeframe" (ionChange)="applyMeetingFilters()">
          <ion-segment-button value="upcoming">
            <ion-label>Upcoming</ion-label>
          </ion-segment-button>
          <ion-segment-button value="past">
            <ion-label>Past</ion-label>
          </ion-segment-button>
          <ion-segment-button value="all">
            <ion-label>All</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <div *ngIf="filteredMeetings.length; else emptyMeetings" class="timeline">
        <div class="timeline-item" *ngFor="let meeting of filteredMeetings">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <div class="timeline-header">
              <h4>{{ meeting.subject }}</h4>
              <span>{{ formatDate(meeting.startDate) }}</span>
            </div>
            <p>{{ meeting.description || 'No description provided.' }}</p>
            <div class="timeline-meta">
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(meeting.CompanyID) }}</span>
              <span><ion-icon name="people-outline"></ion-icon>{{ meeting.attendees.length ? meeting.attendees.join(', ') : 'No attendees listed' }}</span>
            </div>
          </div>
        </div>
      </div>
      <ng-template #emptyMeetings>
        <div class="empty-tab-state">
          <ion-icon name="calendar-outline"></ion-icon>
          <h3>No meetings to display</h3>
          <p>Schedule or log meetings to see them here.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'communications'" class="tab-content communications-tab">
      <div class="section-header">
        <div>
          <h3>Touches</h3>
          <p>Communication history across all companies</p>
        </div>
        <ion-searchbar
          [(ngModel)]="communicationSearchTerm"
          (ionChange)="applyCommunicationFilters()"
          placeholder="Search notes or outcomes"
          animated="true">
        </ion-searchbar>
      </div>

      <div *ngIf="filteredCommunications.length; else emptyCommunications" class="communications-timeline">
        <div class="communication-card" *ngFor="let comm of filteredCommunications">
          <div class="communication-header">
            <h4>{{ comm.communicationType }}</h4>
            <span>{{ formatDate(comm.date) }}</span>
          </div>
          <p>{{ comm.notes || 'No notes added.' }}</p>
          <div class="communication-meta">
            <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(comm.CompanyID) }}</span>
            <span><ion-icon name="swap-horizontal-outline"></ion-icon>{{ comm.outcome }}</span>
            <span *ngIf="comm.channels.length"><ion-icon name="share-social-outline"></ion-icon>{{ comm.channels.join(', ') }}</span>
          </div>
        </div>
      </div>
      <ng-template #emptyCommunications>
        <div class="empty-tab-state">
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          <h3>No touches found</h3>
          <p>Log calls, emails or messages to build your timeline.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'invoices'" class="tab-content invoices-tab">
      <div class="section-header">
        <div>
          <h3>Invoices</h3>
          <p>{{ visibleInvoiceCount }} records · {{ formatCurrency(invoiceMetrics.total) }} billed</p>
        </div>
        <ion-searchbar
          [(ngModel)]="invoiceSearchTerm"
          (ionChange)="categorizeInvoices()"
          placeholder="Search invoice, project, or company"
          animated="true">
        </ion-searchbar>
      </div>

      <div class="invoice-summary">
        <div class="summary-pill">
          <span>Total</span>
          <strong>{{ formatCurrency(invoiceMetrics.total) }}</strong>
        </div>
        <div class="summary-pill warning">
          <span>Outstanding</span>
          <strong>{{ formatCurrency(invoiceMetrics.outstanding) }}</strong>
        </div>
        <div class="summary-pill success">
          <span>Paid</span>
          <strong>{{ formatCurrency(invoiceMetrics.paid) }}</strong>
        </div>
      </div>

      <ng-container *ngIf="openInvoices.length || unpaidInvoices.length || paidInvoiceGroups.length; else emptyInvoices">
        <div class="invoice-section" *ngIf="openInvoices.length">
          <div class="invoice-section-header">
            <h4>Open (upcoming projects)</h4>
            <span>{{ openInvoices.length }} {{ openInvoices.length === 1 ? 'invoice' : 'invoices' }}</span>
          </div>
          <div class="responsive-table">
            <table>
              <thead>
                <tr>
                  <th>Invoice</th>
                  <th>Company</th>
                  <th>Project Date</th>
                  <th>Amount</th>
                  <th>Outstanding</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pair of openInvoices">
                  <td>#{{ pair.positive.InvoiceID }}</td>
                  <td>{{ pair.positive.CompanyName }}</td>
                  <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                  <td>{{ pair.positive.AmountLabel }}</td>
                  <td>{{ formatCurrency(pair.netAmount) }}</td>
                  <td>{{ pair.positive.InvoiceNotes || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="invoice-section" *ngIf="unpaidInvoices.length">
          <div class="invoice-section-header">
            <h4>Unpaid (project complete)</h4>
            <span>{{ unpaidInvoices.length }} {{ unpaidInvoices.length === 1 ? 'invoice' : 'invoices' }}</span>
          </div>
          <div class="responsive-table">
            <table>
              <thead>
                <tr>
                  <th>Invoice</th>
                  <th>Company</th>
                  <th>Project Date</th>
                  <th>Amount</th>
                  <th>Outstanding</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pair of unpaidInvoices">
                  <td>#{{ pair.positive.InvoiceID }}</td>
                  <td>{{ pair.positive.CompanyName }}</td>
                  <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                  <td>{{ pair.positive.AmountLabel }}</td>
                  <td>{{ formatCurrency(pair.netAmount) }}</td>
                  <td>{{ pair.positive.InvoiceNotes || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="invoice-section" *ngIf="paidInvoiceGroups.length">
          <div class="invoice-section-header">
            <h4>Paid (grouped by company)</h4>
            <span>{{ paidInvoiceGroups.length }} {{ paidInvoiceGroups.length === 1 ? 'company' : 'companies' }}</span>
          </div>
          <div class="invoice-paid-groups">
            <div class="invoice-group-card" *ngFor="let group of paidInvoiceGroups">
              <div class="invoice-group-header">
                <h5>{{ group.companyName }}</h5>
                <span>{{ group.items.length }} {{ group.items.length === 1 ? 'project' : 'projects' }}</span>
              </div>
              <div class="responsive-table slim">
                <table>
                  <thead>
                    <tr>
                      <th>Invoice</th>
                      <th>Billed</th>
                      <th>Credit</th>
                      <th>Project Date</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let pair of group.items">
                      <td>#{{ pair.positive.InvoiceID }}</td>
                      <td>{{ pair.positive.AmountLabel }}</td>
                      <td>
                        {{ pair.negative ? formatCurrency((pair.negative.Fee || 0) * -1) : formatCurrency(pair.netAmount) }}
                      </td>
                      <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                      <td>{{ pair.positive.InvoiceNotes || '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #emptyInvoices>
        <div class="empty-tab-state">
          <ion-icon name="receipt-outline"></ion-icon>
          <h3>No invoices found</h3>
          <p>Once invoices are generated they will appear here.</p>
        </div>
      </ng-template>
    </div>
  </div>
</ion-content>
