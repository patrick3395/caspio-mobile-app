
<ion-header class="company-header">
  <ion-toolbar class="company-toolbar">
    <ion-title>
      <div class="toolbar-title">
        <span>Company CRM</span>
        <small>{{ companies.length }} companies across {{ stages.length }} stages</small>
      </div>
    </ion-title>
    <ion-buttons slot="end" class="toolbar-actions">
      <ion-select
        interface="popover"
        placeholder="Focus company"
        [value]="selectedCompanyId"
        (ionChange)="setSelectedCompany($event.detail.value)">
        <ion-select-option *ngFor="let company of companies" [value]="company.CompanyID">
          {{ company.CompanyName }}
        </ion-select-option>
      </ion-select>
      <ion-button fill="clear" color="primary" (click)="loadCompanyData()">
        <ion-icon slot="start" name="refresh-outline"></ion-icon>
        Refresh
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="page-shell">
    <ion-segment
      [(ngModel)]="selectedTab"
      (ionChange)="onTabChange($event)"
      class="company-tabs"
      scrollable
      mode="ios">
      <ion-segment-button value="companies">
        <ion-label>Companies</ion-label>
      </ion-segment-button>
      <ion-segment-button value="contacts">
        <ion-label>Contacts</ion-label>
      </ion-segment-button>
      <ion-segment-button value="tasks">
        <ion-label>Tasks</ion-label>
      </ion-segment-button>
      <ion-segment-button value="meetings">
        <ion-label>Meetings</ion-label>
      </ion-segment-button>
      <ion-segment-button value="communications">
        <ion-label>Touches</ion-label>
      </ion-segment-button>
      <ion-segment-button value="invoices">
        <ion-label>Invoices</ion-label>
      </ion-segment-button>
    </ion-segment>
    <div *ngIf="selectedTab === 'companies'" class="tab-content companies-tab">
      <div class="companies-search-container">
        <div class="search-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <ion-searchbar
            [(ngModel)]="companyFilters.search"
            (ionChange)="applyCompanyFilters()"
            placeholder="Search companies, stages, or contacts"
            animated="true"
            class="modern-search">
          </ion-searchbar>
        </div>
      </div>

      <div class="stage-rollups" *ngIf="stageGroups.length; else emptyCompanies">
        <div class="stage-container" *ngFor="let group of stageGroups; trackBy: trackByStage">
          <div class="stage-header">
            <div class="stage-title">
              <div class="stage-icon-wrapper">
                <ion-icon [name]="getStageIcon(group.stage.name)" class="stage-icon"></ion-icon>
              </div>
              <div class="stage-info">
                <h3 class="stage-name">{{ formatStageName(group.stage) }}</h3>
                <span class="stage-count">{{ group.companies.length }} {{ group.companies.length === 1 ? 'Company' : 'Companies' }}</span>
              </div>
            </div>
            <div class="stage-stats">
              <div class="stat-pill">
                <span class="stat-value">{{ getTotalContacts(group.companies) }}</span>
                <span class="stat-label">Contacts</span>
              </div>
              <div class="stat-pill">
                <span class="stat-value">{{ getTotalTasks(group.companies) }}</span>
                <span class="stat-label">Tasks</span>
              </div>
            </div>
          </div>

          <div class="companies-list">
            <div class="company-card-modern"
                 *ngFor="let company of group.companies; trackBy: trackByCompany"
                 [class.selected]="company.CompanyID === selectedCompanyId"
                 (click)="setSelectedCompany(company.CompanyID)">

              <div class="company-card-header">
                <div class="company-main-info">
                  <h4 class="company-name">{{ company.CompanyName }}</h4>
                  <p class="company-location">
                    <ion-icon name="location" class="inline-icon"></ion-icon>
                    {{ buildCompanyAddress(company) || 'No address' }}
                  </p>
                </div>
                <button class="expand-btn" (click)="toggleCompanyExpand(company, $event)">
                  <ion-icon [name]="isCompanyExpanded(company) ? 'chevron-up' : 'chevron-down'"></ion-icon>
                </button>
              </div>

              <div class="company-metrics">
                <div class="metric-item">
                  <ion-icon name="people" class="metric-icon"></ion-icon>
                  <span class="metric-value">{{ company.contactCount || 0 }}</span>
                  <span class="metric-label">Contacts</span>
                </div>
                <div class="metric-item" [class.has-overdue]="company.overdueTasks > 0">
                  <ion-icon name="checkmark-circle" class="metric-icon"></ion-icon>
                  <span class="metric-value">{{ company.openTasks || 0 }}</span>
                  <span class="metric-label">Tasks</span>
                </div>
                <div class="metric-item">
                  <ion-icon name="chatbubbles" class="metric-icon"></ion-icon>
                  <span class="metric-value">{{ company.totalTouches || 0 }}</span>
                  <span class="metric-label">Touches</span>
                </div>
                <div class="metric-item">
                  <ion-icon name="cash" class="metric-icon"></ion-icon>
                  <span class="metric-value">{{ formatCompactCurrency(company.invoiceTotals?.total || 0) }}</span>
                  <span class="metric-label">Revenue</span>
                </div>
              </div>

              <div class="company-expand-content" *ngIf="isCompanyExpanded(company)">
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-icon-wrapper">
                      <ion-icon name="call" class="detail-icon"></ion-icon>
                    </div>
                    <div class="detail-content">
                      <label>Phone</label>
                      <p>{{ formatPhone(company.Phone) || 'Not provided' }}</p>
                    </div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-icon-wrapper">
                      <ion-icon name="globe" class="detail-icon"></ion-icon>
                    </div>
                    <div class="detail-content">
                      <label>Website</label>
                      <p>{{ company.Website || 'Not provided' }}</p>
                    </div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-icon-wrapper">
                      <ion-icon name="flag" class="detail-icon"></ion-icon>
                    </div>
                    <div class="detail-content">
                      <label>Stage</label>
                      <p>{{ company.StageName || 'Unassigned' }}</p>
                    </div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-icon-wrapper">
                      <ion-icon name="wallet" class="detail-icon"></ion-icon>
                    </div>
                    <div class="detail-content">
                      <label>Outstanding</label>
                      <p class="text-warning">{{ formatCurrency(company.invoiceTotals?.outstanding || 0) }}</p>
                    </div>
                  </div>
                </div>

                <div class="company-actions">
                  <button class="action-btn primary" (click)="viewCompanyDetails(company, $event)">
                    <ion-icon name="eye"></ion-icon>
                    View Details
                  </button>
                  <button class="action-btn" (click)="editCompany(company, $event)">
                    <ion-icon name="create"></ion-icon>
                    Edit
                  </button>
                  <button class="action-btn" (click)="addTask(company, $event)">
                    <ion-icon name="add-circle"></ion-icon>
                    Add Task
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyCompanies>
        <div class="empty-state-modern">
          <div class="empty-icon-wrapper">
            <ion-icon name="business"></ion-icon>
          </div>
          <h3>No companies found</h3>
          <p>Try adjusting your search or filters to find companies</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'contacts'" class="tab-content contacts-tab">
      <div class="section-header">
        <div>
          <h3>Contacts</h3>
          <p>People linked to your companies</p>
        </div>
        <ion-searchbar
          [value]="contactsSearchTerm"
          (ionInput)="onContactSearchChange($event.detail.value)"
          placeholder="Search contacts by name"
          animated="true">
        </ion-searchbar>
      </div>

      <div class="contact-groups" *ngIf="contactGroups.length; else emptyContacts">
        <div class="contact-group" *ngFor="let group of contactGroups; trackBy: trackByContactGroup">
          <div class="contact-group-header">
            <h4>{{ group.companyName }}</h4>
            <span>{{ group.contacts.length }} {{ group.contacts.length === 1 ? 'person' : 'people' }}</span>
          </div>
          <div class="responsive-table dark-outline">
            <table>
              <thead>
                <tr>
                  <th>Contact</th>
                  <th>Phone</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let contact of group.contacts; trackBy: trackByContact">
                  <td>
                    <button type="button" class="contact-name-button" (click)="openContactModal(contact)">
                      {{ contact.Name }}
                    </button>
                    <ion-chip *ngIf="contact.PrimaryContact" color="success" size="small">Primary</ion-chip>
                  </td>
                  <td>{{ formatPhone(contact.Phone1) || '—' }}</td>
                  <td>
                    <a *ngIf="contact.Email" [href]="'mailto:' + contact.Email">{{ contact.Email }}</a>
                    <span *ngIf="!contact.Email">—</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <ng-template #emptyContacts>
        <div class="empty-tab-state">
          <ion-icon name="people-outline"></ion-icon>
          <h3>No contacts match your filters</h3>
          <p>Adjust the filters or search criteria.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'tasks'" class="tab-content tasks-tab">
      <div class="section-header">
        <div>
          <h3>Tasks</h3>
          <p>{{ taskMetrics.outstanding }} open · {{ taskMetrics.overdue }} overdue</p>
        </div>
      </div>

      <div class="tasks-filters">
        <ion-searchbar
          [(ngModel)]="taskFilters.search"
          (ionChange)="applyTaskFilters()"
          placeholder="Search tasks"
          animated="true">
        </ion-searchbar>

        <ion-select
          label="Status"
          interface="popover"
          [(ngModel)]="taskFilters.status"
          (ionChange)="applyTaskFilters()">
          <ion-select-option value="all">All</ion-select-option>
          <ion-select-option value="open">Open</ion-select-option>
          <ion-select-option value="completed">Completed</ion-select-option>
        </ion-select>

        <ion-select
          label="Assignee"
          interface="popover"
          [(ngModel)]="taskFilters.assignedTo"
          (ionChange)="applyTaskFilters()">
          <ion-select-option value="all">All assignees</ion-select-option>
          <ion-select-option *ngFor="let person of taskAssignees" [value]="person">{{ person }}</ion-select-option>
        </ion-select>

        <div class="tasks-toggle">
          <ion-toggle
            [(ngModel)]="taskFilters.overdueOnly"
            (ionChange)="applyTaskFilters()">Overdue only</ion-toggle>
        </div>
      </div>

      <div *ngIf="filteredTasks.length; else emptyTasks" class="tasks-grid">
        <ion-card *ngFor="let task of filteredTasks; trackBy: trackByTask" class="task-card" [class.completed]="task.completed" [class.overdue]="task.isOverdue">
          <ion-item lines="none" class="task-card-header">
            <ion-checkbox
              slot="start"
              [checked]="task.completed"
              [disabled]="isTaskUpdating(task)"
              (ionChange)="toggleTaskCompletion(task, $event.detail.checked)">
            </ion-checkbox>
            <ion-label>
              <h4>{{ task.assignTo || 'Unassigned' }} • {{ task.communicationType || 'General' }}</h4>
              <p>{{ task.assignmentShort || task.assignment || 'No details provided' }}</p>
            </ion-label>
            <ion-badge color="success" *ngIf="task.completed">Completed</ion-badge>
            <ion-badge color="danger" *ngIf="!task.completed && task.isOverdue">Overdue</ion-badge>
          </ion-item>
          <ion-card-content>
            <div class="task-meta">
              <span><ion-icon name="calendar-outline"></ion-icon>{{ formatDate(task.dueDate) }}</span>
              <span *ngIf="task.notes"><ion-icon name="document-text-outline"></ion-icon>{{ task.notes }}</span>
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(task.CompanyID) }}</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
      <ng-template #emptyTasks>
        <div class="empty-tab-state">
          <ion-icon name="checkbox-outline"></ion-icon>
          <h3>No tasks match your filters</h3>
          <p>Try expanding your filters or change the scope.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'meetings'" class="tab-content meetings-tab">
      <div class="section-header">
        <div>
          <h3>Meetings</h3>
          <p>Past and upcoming touchpoints</p>
        </div>
      </div>

      <div class="meetings-filters">
        <ion-searchbar
          [(ngModel)]="meetingFilters.search"
          (ionChange)="applyMeetingFilters()"
          placeholder="Search subjects or attendees"
          animated="true">
        </ion-searchbar>
        <ion-segment size="small" [(ngModel)]="meetingFilters.timeframe" (ionChange)="applyMeetingFilters()">
          <ion-segment-button value="upcoming">
            <ion-label>Upcoming</ion-label>
          </ion-segment-button>
          <ion-segment-button value="past">
            <ion-label>Past</ion-label>
          </ion-segment-button>
          <ion-segment-button value="all">
            <ion-label>All</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <div *ngIf="filteredMeetings.length; else emptyMeetings" class="timeline">
        <div class="timeline-item" *ngFor="let meeting of filteredMeetings">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <div class="timeline-header">
              <h4>{{ meeting.subject }}</h4>
              <span>{{ formatDate(meeting.startDate) }}</span>
            </div>
            <p>{{ meeting.description || 'No description provided.' }}</p>
            <div class="timeline-meta">
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(meeting.CompanyID) }}</span>
              <span><ion-icon name="people-outline"></ion-icon>{{ meeting.attendees.length ? meeting.attendees.join(', ') : 'No attendees listed' }}</span>
            </div>
          </div>
        </div>
      </div>
      <ng-template #emptyMeetings>
        <div class="empty-tab-state">
          <ion-icon name="calendar-outline"></ion-icon>
          <h3>No meetings to display</h3>
          <p>Schedule or log meetings to see them here.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'communications'" class="tab-content communications-tab">
      <div class="section-header">
        <div>
          <h3>Touches</h3>
          <p>Communication history across all companies</p>
        </div>
        <ion-searchbar
          [(ngModel)]="communicationSearchTerm"
          (ionChange)="applyCommunicationFilters()"
          placeholder="Search notes or outcomes"
          animated="true">
        </ion-searchbar>
      </div>

      <div *ngIf="filteredCommunications.length; else emptyCommunications" class="communications-timeline">
        <div class="communication-card" *ngFor="let comm of filteredCommunications">
          <div class="communication-header">
            <h4>{{ comm.communicationType }}</h4>
            <span>{{ formatDate(comm.date) }}</span>
          </div>
          <p>{{ comm.notes || 'No notes added.' }}</p>
          <div class="communication-meta">
            <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(comm.CompanyID) }}</span>
            <span><ion-icon name="swap-horizontal-outline"></ion-icon>{{ comm.outcome }}</span>
            <span *ngIf="comm.channels.length"><ion-icon name="share-social-outline"></ion-icon>{{ comm.channels.join(', ') }}</span>
          </div>
        </div>
      </div>
      <ng-template #emptyCommunications>
        <div class="empty-tab-state">
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          <h3>No touches found</h3>
          <p>Log calls, emails or messages to build your timeline.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'invoices'" class="tab-content invoices-tab">
      <div class="section-header">
        <div>
          <h3>Invoices</h3>
          <p>{{ visibleInvoiceCount }} records · {{ formatCurrency(invoiceMetrics.total) }} billed</p>
        </div>
        <ion-searchbar
          [(ngModel)]="invoiceSearchTerm"
          (ionChange)="categorizeInvoices()"
          placeholder="Search invoice, project, or company"
          animated="true">
        </ion-searchbar>
      </div>

      <div class="invoice-summary">
        <div class="summary-pill">
          <span>Total</span>
          <strong>{{ formatCurrency(invoiceMetrics.total) }}</strong>
        </div>
        <div class="summary-pill warning">
          <span>Outstanding</span>
          <strong>{{ formatCurrency(invoiceMetrics.outstanding) }}</strong>
        </div>
        <div class="summary-pill success">
          <span>Paid</span>
          <strong>{{ formatCurrency(invoiceMetrics.paid) }}</strong>
        </div>
      </div>

      <ng-container *ngIf="openInvoices.length || unpaidInvoices.length || paidInvoiceGroups.length; else emptyInvoices">
        <div class="invoice-section" *ngIf="openInvoices.length">
          <div class="invoice-section-header">
            <h4>Open (upcoming projects)</h4>
            <span>{{ openInvoices.length }} {{ openInvoices.length === 1 ? 'invoice' : 'invoices' }}</span>
          </div>
          <div class="responsive-table">
            <table>
              <thead>
                <tr>
                  <th>Invoice</th>
                  <th>Company</th>
                  <th>Project Date</th>
                  <th>Amount</th>
                  <th>Outstanding</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pair of openInvoices">
                  <td>#{{ pair.positive.InvoiceID }}</td>
                  <td>{{ pair.positive.CompanyName }}</td>
                  <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                  <td>{{ pair.positive.AmountLabel }}</td>
                  <td>{{ formatCurrency(pair.netAmount) }}</td>
                  <td>{{ pair.positive.InvoiceNotes || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="invoice-section" *ngIf="unpaidInvoices.length">
          <div class="invoice-section-header">
            <h4>Unpaid (project complete)</h4>
            <span>{{ unpaidInvoices.length }} {{ unpaidInvoices.length === 1 ? 'invoice' : 'invoices' }}</span>
          </div>
          <div class="responsive-table">
            <table>
              <thead>
                <tr>
                  <th>Invoice</th>
                  <th>Company</th>
                  <th>Project Date</th>
                  <th>Amount</th>
                  <th>Outstanding</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pair of unpaidInvoices">
                  <td>#{{ pair.positive.InvoiceID }}</td>
                  <td>{{ pair.positive.CompanyName }}</td>
                  <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                  <td>{{ pair.positive.AmountLabel }}</td>
                  <td>{{ formatCurrency(pair.netAmount) }}</td>
                  <td>{{ pair.positive.InvoiceNotes || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="invoice-section" *ngIf="paidInvoiceGroups.length">
          <div class="invoice-section-header">
            <h4>Paid (grouped by company)</h4>
            <span>{{ paidInvoiceGroups.length }} {{ paidInvoiceGroups.length === 1 ? 'company' : 'companies' }}</span>
          </div>
          <div class="invoice-paid-groups">
            <div class="invoice-group-card" *ngFor="let group of paidInvoiceGroups">
              <div class="invoice-group-header">
                <h5>{{ group.companyName }}</h5>
                <span>{{ group.items.length }} {{ group.items.length === 1 ? 'project' : 'projects' }}</span>
              </div>
              <div class="responsive-table slim">
                <table>
                  <thead>
                    <tr>
                      <th>Invoice</th>
                      <th>Billed</th>
                      <th>Credit</th>
                      <th>Project Date</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let pair of group.items">
                      <td>#{{ pair.positive.InvoiceID }}</td>
                      <td>{{ pair.positive.AmountLabel }}</td>
                      <td>
                        {{ pair.negative ? formatCurrency((pair.negative.Fee || 0) * -1) : formatCurrency(pair.netAmount) }}
                      </td>
                      <td>{{ formatDate(pair.projectDate || pair.positive.DateValue) }}</td>
                      <td>{{ pair.positive.InvoiceNotes || '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #emptyInvoices>
        <div class="empty-tab-state">
          <ion-icon name="receipt-outline"></ion-icon>
          <h3>No invoices found</h3>
          <p>Once invoices are generated they will appear here.</p>
        </div>
      </ng-template>
    </div>
  </div>
</ion-content>

<ion-modal [isOpen]="isContactModalOpen" (didDismiss)="closeContactModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ selectedContact?.Name || 'Contact Details' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeContactModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="contact-modal-content" *ngIf="selectedContact">
      <div class="contact-detail-card">
        <h4>{{ selectedContact.Name }}</h4>
        <p *ngIf="selectedContact.Goal">Goal: {{ selectedContact.Goal }}</p>
        <div class="contact-detail-grid">
          <div>
            <strong>Company</strong>
            <p>{{ getCompanyName(selectedContact.CompanyID) }}</p>
          </div>
          <div>
            <strong>Title</strong>
            <p>{{ selectedContact.Title || '—' }}</p>
          </div>
          <div>
            <strong>Email</strong>
            <p>
              <a *ngIf="selectedContact.Email" [href]="'mailto:' + selectedContact.Email">{{ selectedContact.Email }}</a>
              <span *ngIf="!selectedContact.Email">—</span>
            </p>
          </div>
          <div>
            <strong>Phone</strong>
            <p>{{ formatPhone(selectedContact.Phone1) || '—' }}</p>
          </div>
          <div>
            <strong>Secondary Phone</strong>
            <p>{{ formatPhone(selectedContact.Phone2) || '—' }}</p>
          </div>
          <div>
            <strong>Role</strong>
            <p>{{ selectedContact.Role || '—' }}</p>
          </div>
          <div>
            <strong>Notes</strong>
            <p>{{ selectedContact.Notes || 'No notes recorded.' }}</p>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
