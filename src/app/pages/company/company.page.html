
<ion-header class="custom-header">
  <ion-toolbar class="action-toolbar">
    <ion-title>{{ isCompanyOne ? 'Noble Client Management' : 'Company' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- CRM View for Company ID 1 -->
  <div *ngIf="isCompanyOne" class="page-shell">
    <!-- Global Company Filter -->
    <div class="global-company-filter">
      <div class="filter-header">
        <h3>Filter by Company</h3>
        <button *ngIf="globalCompanyFilterId" (click)="clearGlobalCompanyFilter()" class="clear-filter-btn">
          <ion-icon name="close-circle"></ion-icon>
          Clear Filter
        </button>
      </div>

      <div class="search-container">
        <ion-searchbar
          [(ngModel)]="globalCompanySearchTerm"
          (ionInput)="onGlobalCompanySearch($event.detail.value)"
          (ionFocus)="showCompanySuggestions = true"
          placeholder="Search companies"
          [class.has-selection]="globalCompanyFilterId !== null">
        </ion-searchbar>

        <!-- Autocomplete dropdown -->
        <div class="company-suggestions" *ngIf="showCompanySuggestions && filteredCompanySuggestions.length > 0 && !globalCompanyFilterId">
          <div
            *ngFor="let company of filteredCompanySuggestions"
            class="suggestion-item"
            (click)="selectGlobalCompany(company.CompanyID, company.CompanyName)">
            <div class="company-info">
              <strong>{{ company.CompanyName }}</strong>
              <span class="company-location">{{ buildCompanyAddress(company) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Active filter indicator -->
      <div class="active-filter-badge" *ngIf="globalCompanyFilterId">
        <ion-icon name="filter"></ion-icon>
        <span>Showing data for: <strong>{{ globalCompanySearchTerm }}</strong></span>
      </div>
    </div>

    <div class="tab-button-grid">
      <button class="tab-button" [class.active]="selectedTab === 'companies'" (click)="selectTab('companies')">
        <ion-icon name="business-outline"></ion-icon>
        <span>Companies</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'contacts'" (click)="selectTab('contacts')">
        <ion-icon name="people-outline"></ion-icon>
        <span>Contacts</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'tasks'" (click)="selectTab('tasks')">
        <ion-icon name="checkbox-outline"></ion-icon>
        <span>Tasks</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'meetings'" (click)="selectTab('meetings')">
        <ion-icon name="calendar-outline"></ion-icon>
        <span>Meetings</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'communications'" (click)="selectTab('communications')">
        <ion-icon name="chatbubbles-outline"></ion-icon>
        <span>Communication</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'invoices'" (click)="selectTab('invoices')">
        <ion-icon name="receipt-outline"></ion-icon>
        <span>Invoices</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'metrics'" (click)="selectTab('metrics')">
        <ion-icon name="analytics-outline"></ion-icon>
        <span>Metrics</span>
      </button>
      <button class="tab-button" [class.active]="selectedTab === 'users'" (click)="selectTab('users')">
        <ion-icon name="people"></ion-icon>
        <span>Users</span>
      </button>
    </div>
    <div *ngIf="selectedTab === 'companies'" class="tab-content companies-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="companyFilters.search"
              (ionChange)="applyCompanyFilters()"
              placeholder="Search companies"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddCompanyModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Company
          </ion-button>
        </div>
      </div>

      <div class="stage-rollups" *ngIf="stageGroups.length; else emptyCompanies">
        <div class="stage-container" *ngFor="let group of stageGroups; trackBy: trackByStage">
          <div class="stage-header" (click)="toggleStageExpand(group.stage, $event)">
            <div class="stage-info">
              <h3 class="stage-name">{{ formatStageName(group.stage) }}</h3>
              <span class="stage-count">{{ group.companies.length }} {{ group.companies.length === 1 ? 'company' : 'companies' }}</span>
            </div>
            <div class="stage-expand-toggle">
              <ion-icon [name]="isStageExpanded(group.stage) ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
            </div>
          </div>

          <div class="companies-list" *ngIf="isStageExpanded(group.stage)">
            <div class="company-rollup"
                 *ngFor="let company of group.companies; trackBy: trackByCompany"
                 [class.selected]="company.CompanyID === selectedCompanyId"
                 [class.expanded]="isCompanyExpanded(company)">

              <div class="rollup-header" (click)="toggleCompanyExpand(company, $event)">
                <div class="company-info">
                  <h4 class="company-name">{{ company.CompanyName }}</h4>
                  <p class="company-location">{{ buildCompanyAddress(company) || 'No address' }}</p>
                </div>
                <div class="rollup-metrics">
                  <button
                    class="filter-toggle-btn"
                    (click)="applyCompanyFilter(company, $event)"
                    [class.active]="globalCompanyFilterId === company.CompanyID"
                    title="Filter all data to this company">
                    <ion-icon name="funnel-outline"></ion-icon>
                  </button>
                  <button class="expand-toggle" (click)="toggleCompanyExpand(company, $event)">
                    <ion-icon [name]="isCompanyExpanded(company) ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
                  </button>
                </div>
              </div>

              <div class="rollup-content" *ngIf="isCompanyExpanded(company)">
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Onboarding Date</label>
                    <p>{{ formatDate(company.DateOnboarded) || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Onboarding Stage</label>
                    <p>{{ company['Onboarding Stage'] || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Software</label>
                    <p>{{ company.SoftwareID || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Size</label>
                    <p>{{ company.Size || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Franchise</label>
                    <p>{{ company.Franchise ? 'Yes' : 'No' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Lead Source</label>
                    <p>{{ company.LeadSource || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Company Phone</label>
                    <p>
                      <a *ngIf="company.Phone" [href]="'tel:' + company.Phone" class="phone-link">
                        {{ formatPhone(company.Phone) }}
                      </a>
                      <span *ngIf="!company.Phone">Not provided</span>
                    </p>
                  </div>
                  <div class="detail-col">
                    <label>Company Email</label>
                    <p class="wrap-text">{{ company.Email || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>CC Email</label>
                    <p class="wrap-text">{{ company.CC_Email || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Website</label>
                    <p class="wrap-text" *ngIf="!company.Website">Not provided</p>
                    <a *ngIf="company.Website" [href]="company.Website" target="_blank" rel="noopener noreferrer" class="website-link wrap-text">
                      {{ company.Website }}
                    </a>
                  </div>
                  <div class="detail-col">
                    <label>Address</label>
                    <p>{{ company.Address || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>City</label>
                    <p>{{ company.City || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>State</label>
                    <p>{{ company.State || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Zip</label>
                    <p>{{ company.Zip || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Contract Document</label>
                    <p>{{ company.Contract || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col" style="grid-column: 1 / -1;">
                    <label>Service Area(s)</label>
                    <p class="wrap-text">{{ company.ServiceArea || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col" style="grid-column: 1 / -1;">
                    <label>Notes</label>
                    <p class="wrap-text">{{ company.Notes || 'No notes' }}</p>
                  </div>
                </div>
                <div class="rollup-actions">
                  <button class="action-btn" (click)="editCompany(company, $event)">
                    <ion-icon name="create-outline"></ion-icon>
                    <span>Edit Company</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyCompanies>
        <div class="empty-state-modern">
          <div class="empty-icon-wrapper">
            <ion-icon name="business"></ion-icon>
          </div>
          <h3>No companies found</h3>
          <p>Try adjusting your search or filters to find companies</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'contacts'" class="tab-content contacts-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="contactsSearchTerm"
              (ionChange)="onContactSearchChange($event.detail.value)"
              placeholder="Search contacts by name"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddContactModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Contact
          </ion-button>
        </div>
      </div>

      <div class="contact-groups" *ngIf="paginatedContactGroups.length; else emptyContacts">
        <div class="contact-group" *ngFor="let group of paginatedContactGroups; trackBy: trackByContactGroup">
          <div class="contact-group-header">
            <h4>{{ group.companyName }}</h4>
            <div class="metric-badge">
              <ion-icon name="people-outline"></ion-icon>
              <span>{{ group.contacts.length }}</span>
            </div>
          </div>
          <div class="responsive-table dark-outline">
            <table>
              <thead>
                <tr>
                  <th>Contact</th>
                  <th>Title</th>
                  <th>Phone</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let contact of group.contacts; trackBy: trackByContact">
                  <td>
                    <button type="button" class="contact-name-button" (click)="openEditContactModal(contact)">
                      {{ contact.Name }}
                    </button>
                    <ion-chip *ngIf="contact.PrimaryContact" color="success" size="small">Primary</ion-chip>
                  </td>
                  <td>
                    {{ contact.Title || '—' }}
                  </td>
                  <td>
                    <a *ngIf="contact.Phone1" [href]="'tel:' + contact.Phone1" class="phone-link">
                      {{ formatPhone(contact.Phone1) }}
                    </a>
                    <span *ngIf="!contact.Phone1">—</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="pagination-controls" *ngIf="totalContactPages > 1">
          <button class="pagination-btn arrow-only" (click)="prevContactPage()" [disabled]="currentContactPage === 1">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </button>
          <span class="page-indicator">{{ currentContactPage }} of {{ totalContactPages }}</span>
          <button class="pagination-btn arrow-only" (click)="nextContactPage()" [disabled]="currentContactPage === totalContactPages">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </button>
        </div>
      </div>
      <ng-template #emptyContacts>
        <div class="empty-tab-state">
          <ion-icon name="people-outline"></ion-icon>
          <h3>No contacts match your filters</h3>
          <p>Adjust the filters or search criteria.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'tasks'" class="tab-content tasks-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="taskFilters.search"
              (ionChange)="applyTaskFilters()"
              placeholder="Search tasks"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddTaskModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Task
          </ion-button>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label for="status-filter">Status</label>
            <select
              id="status-filter"
              [(ngModel)]="taskFilters.status"
              (ngModelChange)="applyTaskFilters()"
              class="styled-input">
              <option value="all">All</option>
              <option value="open">Open</option>
              <option value="completed">Completed</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="assignee-filter">Assignee</label>
            <select
              id="assignee-filter"
              [(ngModel)]="taskFilters.assignedTo"
              (ngModelChange)="applyTaskFilters()"
              class="styled-input">
              <option value="all">All assignees</option>
              <option *ngFor="let person of taskAssignees" [value]="person">{{ person }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Timeline</label>
            <div class="task-time-tabs">
              <button class="time-tab" [class.active]="taskFilters.timeframe === 'overdue'" (click)="setTaskTimeframe('overdue')">
                Overdue
              </button>
              <button class="time-tab" [class.active]="taskFilters.timeframe === 'past'" (click)="setTaskTimeframe('past')">
                Past
              </button>
              <button class="time-tab" [class.active]="taskFilters.timeframe === '7day'" (click)="setTaskTimeframe('7day')">
                7 Day
              </button>
              <button class="time-tab" [class.active]="taskFilters.timeframe === 'all'" (click)="setTaskTimeframe('all')">
                All
              </button>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="filteredTasks.length; else emptyTasks" class="tasks-grid">
        <ion-card *ngFor="let task of paginatedTasks; trackBy: trackByTask" class="task-card clickable-card" [class.completed]="task.completed" [class.overdue]="task.isOverdue" (click)="openEditTaskModal(task)">
          <ion-item lines="none" class="task-card-header">
            <ion-checkbox
              slot="start"
              [checked]="task.completed"
              [disabled]="isTaskUpdating(task)"
              (ionChange)="toggleTaskCompletion(task, $event.detail.checked)"
              (click)="$event.stopPropagation()">
            </ion-checkbox>
            <ion-label>
              <h4>{{ getFirstName(task.assignTo) || 'Unassigned' }} • {{ task.communicationType || 'General' }}</h4>
              <p>{{ task.assignmentShort || task.assignment || 'No details provided' }}</p>
            </ion-label>
            <ion-badge class="completed-badge" *ngIf="task.completed">Completed</ion-badge>
            <ion-badge class="overdue-badge" *ngIf="!task.completed && task.isOverdue">Overdue</ion-badge>
          </ion-item>
          <ion-card-content>
            <div class="task-meta">
              <span><ion-icon name="calendar-outline"></ion-icon>{{ formatDate(task.dueDate) }}</span>
              <span *ngIf="task.notes"><ion-icon name="document-text-outline"></ion-icon>{{ task.notes }}</span>
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(task.CompanyID) }}</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
      <!-- Pagination controls for Tasks -->
      <div class="pagination-controls" *ngIf="filteredTasks.length > tasksPerPage">
        <button (click)="prevTaskPage()" [disabled]="currentTaskPage === 1" class="pagination-btn arrow-only">
          <ion-icon name="chevron-back-outline"></ion-icon>
        </button>
        <span class="page-indicator">{{ currentTaskPage }} of {{ totalTaskPages }}</span>
        <button (click)="nextTaskPage()" [disabled]="currentTaskPage === totalTaskPages" class="pagination-btn arrow-only">
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </button>
      </div>
      <ng-template #emptyTasks>
        <div class="empty-tab-state">
          <ion-icon name="checkbox-outline"></ion-icon>
          <h3>No tasks match your filters</h3>
          <p>Try expanding your filters or change the scope.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'meetings'" class="tab-content meetings-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="meetingFilters.search"
              (ionChange)="applyMeetingFilters()"
              placeholder="Search subjects or attendees"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddMeetingModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Meeting
          </ion-button>
        </div>
        <div class="filter-row">
          <div class="invoice-tabs">
            <button class="invoice-tab" [class.active]="meetingFilters.timeframe === 'upcoming'" (click)="setMeetingTimeframe('upcoming')">
              Upcoming
            </button>
            <button class="invoice-tab" [class.active]="meetingFilters.timeframe === 'past'" (click)="setMeetingTimeframe('past')">
              Past
            </button>
            <button class="invoice-tab" [class.active]="meetingFilters.timeframe === 'all'" (click)="setMeetingTimeframe('all')">
              All
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="filteredMeetings.length; else emptyMeetings" class="timeline">
        <div class="timeline-item clickable-card" *ngFor="let meeting of paginatedMeetings" (click)="openEditMeetingModal(meeting)">
          <div class="timeline-content">
            <div class="timeline-header">
              <h4>{{ meeting.subject }}</h4>
              <div class="meeting-datetime">
                <span>{{ formatDateShort(meeting.startDate) }}</span>
                <span class="meeting-time">{{ formatTime(meeting.startDate) }}</span>
              </div>
            </div>
            <p>{{ meeting.description || 'No description provided.' }}</p>
            <div class="timeline-meta">
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(meeting.CompanyID) }}</span>
              <span><ion-icon name="people-outline"></ion-icon>{{ meeting.attendees.length ? meeting.attendees.join(', ') : 'No attendees listed' }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Pagination controls for Meetings -->
      <div class="pagination-controls" *ngIf="filteredMeetings.length > meetingsPerPage">
        <button (click)="prevMeetingPage()" [disabled]="currentMeetingPage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentMeetingPage }} of {{ totalMeetingPages }}</span>
        <button (click)="nextMeetingPage()" [disabled]="currentMeetingPage === totalMeetingPages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>
      <ng-template #emptyMeetings>
        <div class="empty-tab-state">
          <ion-icon name="calendar-outline"></ion-icon>
          <h3>No meetings to display</h3>
          <p>Schedule or log meetings to see them here.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'communications'" class="tab-content communications-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="communicationSearchTerm"
              (ionChange)="applyCommunicationFilters()"
              placeholder="Search notes or outcomes"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddCommunicationModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Communication
          </ion-button>
        </div>
      </div>

      <div *ngIf="filteredCommunications.length; else emptyCommunications" class="communications-timeline">
        <div class="communication-card clickable-card" *ngFor="let comm of paginatedCommunications" (click)="openEditCommunicationModal(comm)">
          <div class="communication-header">
            <h4>{{ comm.communicationType }}</h4>
            <span>{{ formatDate(comm.date) }}</span>
          </div>
          <p>{{ comm.notes || 'No notes added.' }}</p>
          <div class="communication-meta">
            <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(comm.CompanyID) }}</span>
            <span><ion-icon name="swap-horizontal-outline"></ion-icon>{{ comm.outcome }}</span>
            <span *ngIf="comm.channels.length"><ion-icon name="share-social-outline"></ion-icon>{{ comm.channels.join(', ') }}</span>
          </div>
        </div>
      </div>
      <!-- Pagination controls for Communications -->
      <div class="pagination-controls" *ngIf="filteredCommunications.length > communicationsPerPage">
        <button (click)="prevCommunicationPage()" [disabled]="currentCommunicationPage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentCommunicationPage }} of {{ totalCommunicationPages }}</span>
        <button (click)="nextCommunicationPage()" [disabled]="currentCommunicationPage === totalCommunicationPages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>
      <ng-template #emptyCommunications>
        <div class="empty-tab-state">
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          <h3>No communication found</h3>
          <p>Log calls, emails or messages to build your timeline.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'metrics'" class="tab-content metrics-tab">
      <div class="section-header">
        <div>
          <h3>Metrics</h3>
          <p>Business metrics and analytics</p>
        </div>
      </div>

      <div class="empty-tab-state">
        <ion-icon name="analytics-outline"></ion-icon>
        <h3>Metrics Dashboard Coming Soon</h3>
        <p>Key performance indicators and analytics will be displayed here.</p>
      </div>
    </div>
    <div *ngIf="selectedTab === 'users'" class="tab-content users-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="usersSearchTerm"
              (ionChange)="onUserSearchChange($event.detail.value)"
              placeholder="Search users by name, email, or title"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddUserModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add User
          </ion-button>
        </div>
      </div>

      <div *ngIf="filteredUsers.length; else emptyUsers" class="users-grid">
        <div class="user-card" *ngFor="let user of filteredUsers">
          <div class="user-card-content">
            <div class="user-header">
              <div class="user-avatar">
                <img *ngIf="getUserHeadshot(user)" [src]="getUserHeadshot(user)" [alt]="user.Name" class="headshot-image">
                <div *ngIf="!getUserHeadshot(user)" class="headshot-placeholder">
                  <ion-icon name="person"></ion-icon>
                </div>
              </div>
              <div class="user-info">
                <h4>{{ user.Name || 'Unnamed User' }}</h4>
                <p class="user-role">{{ user.Title || 'No title assigned' }}</p>
              </div>
            </div>
            <div class="user-details">
              <div class="user-detail-item" *ngIf="user.Email">
                <ion-icon name="mail-outline"></ion-icon>
                <a [href]="'mailto:' + user.Email">{{ user.Email }}</a>
              </div>
              <div class="user-detail-item" *ngIf="user.Phone">
                <ion-icon name="call-outline"></ion-icon>
                <a [href]="'tel:' + user.Phone" class="phone-link">{{ formatPhone(user.Phone) }}</a>
              </div>
              <div class="user-detail-item">
                <ion-icon name="business-outline"></ion-icon>
                <span>{{ getCompanyName(user.CompanyID) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyUsers>
        <div class="empty-tab-state">
          <ion-icon name="people-outline"></ion-icon>
          <h3>No users found</h3>
          <p>No users match your filters or company selection.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'invoices'" class="tab-content invoices-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="invoiceSearchTerm"
              (ionChange)="categorizeInvoices()"
              placeholder="Search invoice, project, or company"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
        </div>
        <div class="filter-row">
          <div class="invoice-tabs">
            <button class="invoice-tab" [class.active]="invoiceViewMode === 'open'" (click)="setInvoiceViewMode('open')">
              Open
            </button>
            <button class="invoice-tab" [class.active]="invoiceViewMode === 'past'" (click)="setInvoiceViewMode('past')">
              Past
            </button>
            <button class="invoice-tab" [class.active]="invoiceViewMode === 'unpaid'" (click)="setInvoiceViewMode('unpaid')">
              Unpaid
            </button>
          </div>
        </div>
      </div>

      <div class="invoice-groups" *ngIf="paginatedInvoiceGroups.length; else emptyInvoices">
        <div class="invoice-group" *ngFor="let group of paginatedInvoiceGroups; trackBy: trackByInvoiceGroup">
          <div class="invoice-group-header">
            <h4>{{ group.companyName }}</h4>
            <div class="metric-badge">
              <ion-icon name="receipt-outline"></ion-icon>
              <span>{{ group.invoices.length }}</span>
            </div>
          </div>
          <div class="responsive-table dark-outline">
            <table>
              <thead>
                <tr>
                  <th>Address</th>
                  <th>Service</th>
                  <th>Amount Due</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let invoice of group.invoices; trackBy: trackByInvoice">
                  <td>
                    <button type="button" class="contact-name-button" (click)="openEditInvoiceModal(invoice)">
                      {{ invoice.positive.Address || '—' }}
                    </button>
                  </td>
                  <td>
                    {{ invoice.serviceName || '—' }}
                  </td>
                  <td>
                    {{ formatCurrency(invoice.netAmount) }}
                  </td>
                  <td>
                    <button class="pay-invoice-btn" (click)="openInvoicePaymentModal(invoice)" *ngIf="invoice.netAmount > 0">
                      <ion-icon name="card-outline"></ion-icon>
                      Pay
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="pagination-controls" *ngIf="totalInvoicePages > 1">
          <button class="pagination-btn arrow-only" (click)="prevInvoicePage()" [disabled]="currentInvoicePage === 1">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </button>
          <span class="page-indicator">{{ currentInvoicePage }} of {{ totalInvoicePages }}</span>
          <button class="pagination-btn arrow-only" (click)="nextInvoicePage()" [disabled]="currentInvoicePage === totalInvoicePages">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </button>
        </div>
      </div>

      <ng-template #emptyInvoices>
        <div class="empty-tab-state">
          <ion-icon name="receipt-outline"></ion-icon>
          <h3>No invoices found</h3>
          <p>Once invoices are generated they will appear here.</p>
        </div>
      </ng-template>
    </div>

    <!-- Bottom spacer to ensure full scrolling on mobile -->
    <div class="bottom-spacer"></div>
  </div>

  <!-- Organization Users View for non-Company 1 users -->
  <div *ngIf="!isCompanyOne" class="page-shell">
    <div class="section-header">
      <div>
        <h3>Organization Users</h3>
        <p>View users in your organization</p>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="empty-state-modern">
      <ion-spinner name="crescent"></ion-spinner>
      <h3>Loading users...</h3>
    </div>

    <!-- Users List -->
    <div *ngIf="!isLoading && organizationUsers.length > 0" class="responsive-table">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Role</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of organizationUsers">
            <td>{{ user.Name }}</td>
            <td><a [href]="'mailto:' + user.Email">{{ user.Email }}</a></td>
            <td>{{ user.Phone || '—' }}</td>
            <td>{{ user.Role || '—' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && organizationUsers.length === 0" class="empty-state-modern">
      <div class="empty-icon-wrapper">
        <ion-icon name="people"></ion-icon>
      </div>
      <h3>No users found</h3>
      <p>No users found in your organization</p>
    </div>
  </div>
</ion-content>

<ion-modal [isOpen]="isContactModalOpen" (didDismiss)="closeContactModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeContactModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>{{ selectedContact?.Name || 'Contact Details' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="openEditContactModal()" [strong]="true">
            <ion-icon slot="icon-only" name="create-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="contact-modal-content" *ngIf="selectedContact">
      <div class="contact-detail-card">
        <h4>{{ selectedContact.Name }}</h4>
        <p *ngIf="selectedContact.Goal">Goal: {{ selectedContact.Goal }}</p>
        <div class="contact-detail-grid">
          <div>
            <strong>Company</strong>
            <p>{{ getCompanyName(selectedContact.CompanyID) }}</p>
          </div>
          <div>
            <strong>Title</strong>
            <p>{{ selectedContact.Title || '—' }}</p>
          </div>
          <div>
            <strong>Email</strong>
            <p>
              <a *ngIf="selectedContact.Email" [href]="'mailto:' + selectedContact.Email">{{ selectedContact.Email }}</a>
              <span *ngIf="!selectedContact.Email">—</span>
            </p>
          </div>
          <div>
            <strong>Phone</strong>
            <p>
              <a *ngIf="selectedContact.Phone1" [href]="'tel:' + selectedContact.Phone1" class="phone-link">
                {{ formatPhone(selectedContact.Phone1) }}
              </a>
              <span *ngIf="!selectedContact.Phone1">—</span>
            </p>
          </div>
          <div>
            <strong>Secondary Phone</strong>
            <p>
              <a *ngIf="selectedContact.Phone2" [href]="'tel:' + selectedContact.Phone2" class="phone-link">
                {{ formatPhone(selectedContact.Phone2) }}
              </a>
              <span *ngIf="!selectedContact.Phone2">—</span>
            </p>
          </div>
          <div>
            <strong>Role</strong>
            <p>{{ selectedContact.Role || '—' }}</p>
          </div>
          <div>
            <strong>Notes</strong>
            <p>{{ selectedContact.Notes || 'No notes recorded.' }}</p>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Company</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveCompanyChanges()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingCompany">
      <div class="edit-form">
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company Name</label>
              <input type="text" [(ngModel)]="editingCompany.CompanyName" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Onboarding Date</label>
              <input type="date" [(ngModel)]="editingCompany.DateOnboarded" class="form-input">
            </div>
            <div class="form-field">
              <label>Onboarding Stage</label>
              <select [(ngModel)]="editingCompany['Onboarding Stage']" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let stage of stages" [value]="stage.name">
                  {{ formatStageName(stage) }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Software</label>
              <select [(ngModel)]="editingCompany.SoftwareID" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let software of softwareOptions" [value]="software">
                  {{ software }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Size</label>
              <select [(ngModel)]="editingCompany.Size" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let size of uniqueCompanySizes" [value]="size">
                  {{ size }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Franchise</label>
              <ion-toggle [(ngModel)]="editingCompany.Franchise"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Lead Source</label>
              <input type="text" [(ngModel)]="editingCompany.LeadSource" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Contact Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company Phone</label>
              <input type="tel" [(ngModel)]="editingCompany.Phone" class="form-input">
            </div>
            <div class="form-field">
              <label>Company Email</label>
              <input type="email" [(ngModel)]="editingCompany.Email" class="form-input">
            </div>
            <div class="form-field">
              <label>CC Email</label>
              <input type="email" [(ngModel)]="editingCompany.CC_Email" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Website</label>
              <input type="text" [(ngModel)]="editingCompany.Website" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Address</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Address</label>
              <input type="text" [(ngModel)]="editingCompany.Address" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>City</label>
              <input type="text" [(ngModel)]="editingCompany.City" class="form-input">
            </div>
            <div class="form-field">
              <label>State</label>
              <input type="text" [(ngModel)]="editingCompany.State" class="form-input">
            </div>
            <div class="form-field">
              <label>Zip</label>
              <input type="text" [(ngModel)]="editingCompany.Zip" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Additional Details</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Service Area(s)</label>
              <textarea [(ngModel)]="editingCompany.ServiceArea" class="form-textarea" rows="3"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Contract Document</label>
              <input type="file" (change)="onEditCompanyContractChange($event)" class="form-input" accept=".pdf,.doc,.docx">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingCompany.Notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteCompany(editingCompany, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Company
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddTaskModalOpen" (didDismiss)="closeAddTaskModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddTaskModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Task</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewTask()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newTask.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Due Date</label>
              <input type="date" [(ngModel)]="newTask.Due" class="form-input">
            </div>
            <div class="form-field">
              <label>Assign To</label>
              <select [(ngModel)]="newTask.AssignTo" class="form-input">
                <option [ngValue]="''">-- Select --</option>
                <option *ngFor="let user of taskUsers" [ngValue]="user.name">
                  {{ user.name }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Task Type</label>
              <select [(ngModel)]="newTask.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Assignment Details</label>
              <textarea [(ngModel)]="newTask.Assignment" class="form-textarea" rows="4" placeholder="Describe the task..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditTaskModalOpen" (didDismiss)="closeEditTaskModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditTaskModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Task</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedTask()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingTask.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Due Date</label>
              <input type="date" [(ngModel)]="editingTask.Due" class="form-input">
            </div>
            <div class="form-field">
              <label>Assign To</label>
              <select [(ngModel)]="editingTask.AssignTo" class="form-input">
                <option [ngValue]="''">-- Select --</option>
                <option *ngFor="let user of taskUsers" [ngValue]="user.name">
                  {{ user.name }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Task Type</label>
              <select [(ngModel)]="editingTask.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Assignment Details</label>
              <textarea [(ngModel)]="editingTask.Assignment" class="form-textarea" rows="4" placeholder="Describe the task..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="editingTaskOriginal && deleteTask(editingTaskOriginal, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Task
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddContactModalOpen" (didDismiss)="closeAddContactModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddContactModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Contact</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewContact()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newContact.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Name</label>
              <input type="text" [(ngModel)]="newContact.Name" class="form-input" placeholder="Contact name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Title</label>
              <input type="text" [(ngModel)]="newContact.Title" class="form-input" placeholder="Job title">
            </div>
            <div class="form-field">
              <label>Role</label>
              <input type="text" [(ngModel)]="newContact.Role" class="form-input" placeholder="Role">
            </div>
            <div class="form-field">
              <label>Primary Contact</label>
              <ion-toggle [(ngModel)]="newContact.PrimaryContact"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" [(ngModel)]="newContact.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="tel" [(ngModel)]="newContact.Phone1" class="form-input" placeholder="(555) 555-5555">
            </div>
            <div class="form-field">
              <label>Secondary Phone</label>
              <input type="tel" [(ngModel)]="newContact.Phone2" class="form-input" placeholder="(555) 555-5555">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="newContact.Notes" class="form-textarea" rows="4" placeholder="Additional notes about this contact..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditContactModalOpen" (didDismiss)="closeEditContactModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditContactModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Contact</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedContact()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingContact">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingContact.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Name</label>
              <input type="text" [(ngModel)]="editingContact.Name" class="form-input" placeholder="Contact name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Title</label>
              <input type="text" [(ngModel)]="editingContact.Title" class="form-input" placeholder="Job title">
            </div>
            <div class="form-field">
              <label>Role</label>
              <input type="text" [(ngModel)]="editingContact.Role" class="form-input" placeholder="Role">
            </div>
            <div class="form-field">
              <label>Primary Contact</label>
              <ion-toggle [(ngModel)]="editingContact.PrimaryContact"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" [(ngModel)]="editingContact.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="tel" [(ngModel)]="editingContact.Phone1" class="form-input" placeholder="(555) 555-5555">
            </div>
            <div class="form-field">
              <label>Secondary Phone</label>
              <input type="tel" [(ngModel)]="editingContact.Phone2" class="form-input" placeholder="(555) 555-5555">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingContact.Notes" class="form-textarea" rows="4" placeholder="Additional notes about this contact..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteContact(editingContact, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Contact
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddCompanyModalOpen" (didDismiss)="closeAddCompanyModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddCompanyModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Company</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewCompany()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company Name</label>
              <input type="text" [(ngModel)]="newCompany.CompanyName" class="form-input" placeholder="Company name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Onboarding Date</label>
              <input type="date" [(ngModel)]="newCompany.DateOnboarded" class="form-input">
            </div>
            <div class="form-field">
              <label>Onboarding Stage</label>
              <select [(ngModel)]="newCompany['Onboarding Stage']" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let stage of stages" [value]="stage.name">
                  {{ formatStageName(stage) }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Software</label>
              <select [(ngModel)]="newCompany.SoftwareID" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let software of softwareOptions" [value]="software">
                  {{ software }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Size</label>
              <select [(ngModel)]="newCompany.Size" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let size of uniqueCompanySizes" [value]="size">
                  {{ size }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Franchise</label>
              <ion-toggle [(ngModel)]="newCompany.Franchise"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Lead Source</label>
              <input type="text" [(ngModel)]="newCompany.LeadSource" class="form-input" placeholder="Source">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Contact Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company Phone</label>
              <input type="tel" [(ngModel)]="newCompany.Phone" class="form-input" placeholder="(555) 555-5555">
            </div>
            <div class="form-field">
              <label>Company Email</label>
              <input type="email" [(ngModel)]="newCompany.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>CC Email</label>
              <input type="email" [(ngModel)]="newCompany.CC_Email" class="form-input" placeholder="cc@example.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Website</label>
              <input type="text" [(ngModel)]="newCompany.Website" class="form-input" placeholder="https://example.com">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Address</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Address</label>
              <input type="text" [(ngModel)]="newCompany.Address" class="form-input" placeholder="Street address">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>City</label>
              <input type="text" [(ngModel)]="newCompany.City" class="form-input" placeholder="City">
            </div>
            <div class="form-field">
              <label>State</label>
              <input type="text" [(ngModel)]="newCompany.State" class="form-input" placeholder="State">
            </div>
            <div class="form-field">
              <label>Zip</label>
              <input type="text" [(ngModel)]="newCompany.Zip" class="form-input" placeholder="Zip code">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Additional Details</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Service Area(s)</label>
              <textarea [(ngModel)]="newCompany.ServiceArea" class="form-textarea" rows="3" placeholder="Service areas..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Contract Document</label>
              <input type="file" (change)="onNewCompanyContractChange($event)" class="form-input" accept=".pdf,.doc,.docx">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="newCompany.Notes" class="form-textarea" rows="4" placeholder="Additional notes about this company..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddMeetingModalOpen" (didDismiss)="closeAddMeetingModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddMeetingModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Meeting</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewMeeting()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newMeeting.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Subject</label>
              <input type="text" [(ngModel)]="newMeeting.Subject" class="form-input" placeholder="Meeting subject">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Start Date</label>
              <input type="datetime-local" [(ngModel)]="newMeeting.StartDate" class="form-input">
            </div>
            <div class="form-field">
              <label>End Date</label>
              <input type="datetime-local" [(ngModel)]="newMeeting.EndDate" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Description</label>
              <textarea [(ngModel)]="newMeeting.Description" class="form-textarea" rows="4" placeholder="Meeting description..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 1</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee1" class="form-input" placeholder="First attendee">
            </div>
            <div class="form-field">
              <label>Attendee 2</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee2" class="form-input" placeholder="Second attendee">
            </div>
            <div class="form-field">
              <label>Attendee 3</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee3" class="form-input" placeholder="Third attendee">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 4</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee4" class="form-input" placeholder="Fourth attendee">
            </div>
            <div class="form-field">
              <label>Attendee 5</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee5" class="form-input" placeholder="Fifth attendee">
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddCommunicationModalOpen" (didDismiss)="closeAddCommunicationModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddCommunicationModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Communication</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewCommunication()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newCommunication.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Date</label>
              <input type="datetime-local" [(ngModel)]="newCommunication.Date" class="form-input">
            </div>
            <div class="form-field">
              <label>Communication Type</label>
              <select [(ngModel)]="newCommunication.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="newCommunication.Notes" class="form-textarea" rows="4" placeholder="Communication notes..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Connected (Call)</label>
              <ion-toggle [(ngModel)]="newCommunication.Conversed"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Left Voicemail</label>
              <ion-toggle [(ngModel)]="newCommunication.LeftVM"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Also Texted</label>
              <ion-toggle [(ngModel)]="newCommunication.AlsoTexted"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Also Emailed</label>
              <ion-toggle [(ngModel)]="newCommunication.AlsoEmailed"></ion-toggle>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditCommunicationModalOpen" (didDismiss)="closeEditCommunicationModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditCommunicationModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Communication</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedCommunication()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingCommunication">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingCommunication.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Date</label>
              <input type="datetime-local" [(ngModel)]="editingCommunication.Date" class="form-input">
            </div>
            <div class="form-field">
              <label>Communication Type</label>
              <select [(ngModel)]="editingCommunication.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingCommunication.Notes" class="form-textarea" rows="4" placeholder="Communication notes..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Connected (Call)</label>
              <ion-toggle [(ngModel)]="editingCommunication.Conversed"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Left Voicemail</label>
              <ion-toggle [(ngModel)]="editingCommunication.LeftVM"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Also Texted</label>
              <ion-toggle [(ngModel)]="editingCommunication.AlsoTexted"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Also Emailed</label>
              <ion-toggle [(ngModel)]="editingCommunication.AlsoEmailed"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteCommunication(editingCommunication, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Communication
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditMeetingModalOpen" (didDismiss)="closeEditMeetingModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditMeetingModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Meeting</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedMeeting()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingMeeting">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingMeeting.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Subject</label>
              <input type="text" [(ngModel)]="editingMeeting.Subject" class="form-input" placeholder="Meeting subject">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Start Date</label>
              <input type="datetime-local" [(ngModel)]="editingMeeting.StartDate" class="form-input">
            </div>
            <div class="form-field">
              <label>End Date</label>
              <input type="datetime-local" [(ngModel)]="editingMeeting.EndDate" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Description</label>
              <textarea [(ngModel)]="editingMeeting.Description" class="form-textarea" rows="4" placeholder="Meeting description..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 1</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee1" class="form-input" placeholder="First attendee">
            </div>
            <div class="form-field">
              <label>Attendee 2</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee2" class="form-input" placeholder="Second attendee">
            </div>
            <div class="form-field">
              <label>Attendee 3</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee3" class="form-input" placeholder="Third attendee">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 4</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee4" class="form-input" placeholder="Fourth attendee">
            </div>
            <div class="form-field">
              <label>Attendee 5</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee5" class="form-input" placeholder="Fifth attendee">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteMeeting(editingMeeting, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Meeting
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditInvoiceModalOpen" (didDismiss)="closeEditInvoiceModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditInvoiceModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Invoice Details</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingInvoice">
      <div class="edit-form">
        <div class="form-section">
          <h4>Invoice Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company</label>
              <p class="read-only-field">{{ getCompanyName(editingInvoice.positive.CompanyID) }}</p>
            </div>
            <div class="form-field">
              <label>Invoice ID</label>
              <p class="read-only-field">{{ editingInvoice.positive.InvoiceID }}</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Address</label>
              <p class="read-only-field">{{ editingInvoice.positive.Address || 'Not specified' }}</p>
            </div>
            <div class="form-field">
              <label>City</label>
              <p class="read-only-field">{{ editingInvoice.positive.City || 'Not specified' }}</p>
            </div>
            <div class="form-field">
              <label>Zip</label>
              <p class="read-only-field">{{ editingInvoice.positive.Zip || 'Not specified' }}</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Service</label>
              <p class="read-only-field">{{ editingInvoice.serviceName || 'Not specified' }}</p>
            </div>
            <div class="form-field">
              <label>Date</label>
              <p class="read-only-field">{{ formatDate(editingInvoice.positive.DateValue) || 'Not specified' }}</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Amount</label>
              <p class="read-only-field">{{ formatCurrency(editingInvoice.positive.Fee) }}</p>
            </div>
            <div class="form-field">
              <label>Paid</label>
              <p class="read-only-field">{{ editingInvoice.negative ? formatCurrency(editingInvoice.negative.Fee) : '$0.00' }}</p>
            </div>
            <div class="form-field">
              <label>Amount Due</label>
              <p class="read-only-field">{{ formatCurrency(editingInvoice.netAmount) }}</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Status</label>
              <p class="read-only-field">{{ getInvoiceStatus(editingInvoice) }}</p>
            </div>
          </div>
          <div class="form-row" *ngIf="editingInvoice.positive.InvoiceNotes">
            <div class="form-field full-width">
              <label>Notes</label>
              <p class="read-only-field">{{ editingInvoice.positive.InvoiceNotes }}</p>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddUserModalOpen" (didDismiss)="closeAddUserModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddUserModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New User</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewUser()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Headshot</label>
              <div class="headshot-upload-container">
                <div class="headshot-preview-wrapper">
                  <div class="headshot-preview" (click)="userHeadshotInput.click()">
                    <img *ngIf="newUserHeadshotPreview" [src]="newUserHeadshotPreview" alt="Headshot preview" class="headshot-preview-image">
                    <div *ngIf="!newUserHeadshotPreview" class="headshot-preview-placeholder">
                      <ion-icon name="person"></ion-icon>
                    </div>
                  </div>
                  <button type="button" class="headshot-add-btn" (click)="userHeadshotInput.click()">
                    <ion-icon name="add"></ion-icon>
                  </button>
                </div>
                <input type="file" #userHeadshotInput accept="image/*" (change)="onNewUserHeadshotChange($event)" style="display: none;">
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newUser.CompanyID" class="form-input" [disabled]="true">
                <option [ngValue]="null">-- Select --</option>
                <option [ngValue]="currentUserCompanyId" selected>{{ getCompanyName(currentUserCompanyId) }}</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Name</label>
              <input type="text" [(ngModel)]="newUser.Name" class="form-input" placeholder="User name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" [(ngModel)]="newUser.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="tel" [(ngModel)]="newUser.Phone" class="form-input" placeholder="(555) 555-5555">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Title</label>
              <input type="text" [(ngModel)]="newUser.Title" class="form-input" placeholder="Job Title">
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
