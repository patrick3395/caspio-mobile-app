
<ion-header class="custom-header">
  <ion-toolbar class="action-toolbar" [class.web-centered]="isWeb">
    <ion-title>{{ isCompanyOne ? 'Noble Management' : 'Company' }}</ion-title>
    <ion-buttons slot="end">
      <button
        type="button"
        class="toolbar-btn"
        (click)="logout()"
        aria-label="Log out"
      >
        <ion-icon name="log-out-outline"></ion-icon>
      </button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- CRM View for Company ID 1 -->
  <div *ngIf="isCompanyOne" class="page-shell" [class.full-width]="adminMainTab === 'metrics'">
    <!-- Main Tab Bar -->
    <div class="admin-main-tabs">
      <button class="admin-main-tab" [class.active]="adminMainTab === 'company'" (click)="selectAdminMainTab('company')">
        <ion-icon name="business"></ion-icon>
        <span>Company</span>
      </button>
      <button class="admin-main-tab" [class.active]="adminMainTab === 'partners'" (click)="selectAdminMainTab('partners')">
        <ion-icon name="people"></ion-icon>
        <span>Partners</span>
      </button>
      <button class="admin-main-tab" [class.active]="adminMainTab === 'metrics'" (click)="selectAdminMainTab('metrics')">
        <ion-icon name="analytics"></ion-icon>
        <span>Metrics</span>
      </button>
    </div>

    <!-- Company Main Tab Content -->
    <div *ngIf="adminMainTab === 'company'" class="admin-tab-content client-tab-content">

      <!-- Details Collapsible Section -->
      <div class="collapsible-section">
        <div class="collapsible-header" (click)="adminDetailsExpanded = !adminDetailsExpanded">
          <div class="collapsible-title">
            <ion-icon [name]="adminDetailsExpanded ? 'chevron-down' : 'chevron-forward'"></ion-icon>
            <h3>Details</h3>
          </div>
          <button class="minimal-edit-btn" (click)="editAdminCompanyDetails(); $event.stopPropagation()" title="Edit Details">
            <ion-icon name="create-outline"></ion-icon>
          </button>
        </div>

        <div class="collapsible-content" [class.expanded]="adminDetailsExpanded">
          <!-- Loading State - Skeleton loader -->
          <div *ngIf="!currentCompany" class="skeleton-company-details">
            <div class="skeleton-company-header">
              <div class="skeleton-title-line"></div>
            </div>
            <div class="skeleton-detail-section">
              <div class="skeleton-section-title"></div>
              <div class="skeleton-detail-row">
                <div class="skeleton-detail-col" *ngFor="let i of [1,2,3]">
                  <div class="skeleton-label"></div>
                  <div class="skeleton-value"></div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="currentCompany" class="client-details-card">
            <div class="client-details-header">
              <div class="company-logo-container">
                <img [src]="currentCompany.Logo && !adminLogoFailed ? currentCompany.Logo : 'assets/img/company-logo-placeholder.svg'"
                     [alt]="currentCompany.CompanyName"
                     class="company-logo"
                     (error)="adminLogoFailed = true">
              </div>
              <div class="company-name-block">
                <h2>{{ currentCompany.CompanyName }}</h2>
                <p *ngIf="currentCompany.ServiceArea" class="service-area-text">{{ currentCompany.ServiceArea }}</p>
                <div class="company-meta-tags">
                  <span class="meta-tag" *ngIf="currentCompany.SoftwareID">
                    <ion-icon name="desktop-outline"></ion-icon> {{ currentCompany.SoftwareID }}
                  </span>
                  <span class="meta-tag" *ngIf="currentCompany.Size">
                    <ion-icon name="people-outline"></ion-icon> {{ currentCompany.Size }}
                  </span>
                  <span class="meta-tag" *ngIf="currentCompany.Franchise">
                    <ion-icon name="storefront-outline"></ion-icon> Franchise
                  </span>
                </div>
              </div>
            </div>

            <div class="client-details-grid">
              <div class="detail-section">
                <h4>Basic Information</h4>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Onboarding Date</label>
                    <p>{{ formatDate(currentCompany.DateOnboarded) || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Onboarding Stage</label>
                    <p>{{ currentCompany['Onboarding Stage'] || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>Lead Source</label>
                    <p>{{ currentCompany.LeadSource || 'Not provided' }}</p>
                  </div>
                </div>
              </div>

              <div class="detail-section">
                <h4>Contact Information</h4>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Phone</label>
                    <p>
                      <a *ngIf="currentCompany.Phone" [href]="'tel:' + currentCompany.Phone" class="phone-link">
                        {{ formatPhone(currentCompany.Phone) }}
                      </a>
                      <span *ngIf="!currentCompany.Phone" class="not-provided">Not provided</span>
                    </p>
                  </div>
                  <div class="detail-col">
                    <label>Email</label>
                    <p>
                      <a *ngIf="currentCompany.Email" [href]="'mailto:' + currentCompany.Email" class="email-link">{{ currentCompany.Email }}</a>
                      <span *ngIf="!currentCompany.Email" class="not-provided">Not provided</span>
                    </p>
                  </div>
                  <div class="detail-col">
                    <label>CC Email</label>
                    <p class="wrap-text">{{ currentCompany.CC_Email || currentCompany.CCEmail || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Website</label>
                    <p *ngIf="!currentCompany.Website" class="not-provided">Not provided</p>
                    <a *ngIf="currentCompany.Website" [href]="currentCompany.Website" target="_blank" rel="noopener noreferrer" class="website-link wrap-text">
                      {{ currentCompany.Website }}
                    </a>
                  </div>
                </div>
              </div>

              <div class="detail-section">
                <h4>Address</h4>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Street</label>
                    <p>{{ currentCompany.Address || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>City</label>
                    <p>{{ currentCompany.City || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col-half">
                    <label>State</label>
                    <p>{{ currentCompany.State || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col-half">
                    <label>Zip</label>
                    <p>{{ currentCompany.Zip || 'Not provided' }}</p>
                  </div>
                </div>
              </div>

              <div class="detail-section" *ngIf="currentCompany.Notes">
                <h4>Notes</h4>
                <p class="wrap-text">{{ currentCompany.Notes }}</p>
              </div>

              <div class="detail-section" *ngIf="currentCompany.Contract">
                <h4>Contract Document</h4>
                <button class="contract-view-btn" (click)="openContract(currentCompany.PK_ID, currentCompany.Contract)">
                  <ion-icon name="document-text-outline"></ion-icon> View Contract
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Collapsible Section -->
      <div class="collapsible-section">
        <div class="collapsible-header" (click)="adminUsersExpanded = !adminUsersExpanded">
          <div class="collapsible-title">
            <ion-icon [name]="adminUsersExpanded ? 'chevron-down' : 'chevron-forward'"></ion-icon>
            <h3>Users</h3>
            <span class="collapsible-count" *ngIf="!isLoading">({{ filteredUsers.length }})</span>
          </div>
          <button class="minimal-add-btn" (click)="openAddUserModal(); $event.stopPropagation()" title="Add User">
            <ion-icon name="add"></ion-icon>
          </button>
        </div>

        <div class="collapsible-content" [class.expanded]="adminUsersExpanded">
          <div class="collapsible-search-bar">
            <ion-searchbar
              [(ngModel)]="usersSearchTerm"
              (ionChange)="onUserSearchChange($event.detail.value)"
              placeholder="Search users by name, email, or title"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>

          <!-- Skeleton loaders for users -->
          <div *ngIf="isLoading" class="skeleton-users-grid">
            <div class="skeleton-user-card" *ngFor="let i of [1,2,3,4,5,6]">
              <div class="skeleton-user-header">
                <div class="skeleton-user-avatar"></div>
                <div class="skeleton-user-info">
                  <div class="skeleton-user-name"></div>
                  <div class="skeleton-user-role"></div>
                </div>
              </div>
              <div class="skeleton-user-details">
                <div class="skeleton-user-detail-item">
                  <div class="skeleton-icon"></div>
                  <div class="skeleton-detail-text"></div>
                </div>
                <div class="skeleton-user-detail-item">
                  <div class="skeleton-icon"></div>
                  <div class="skeleton-detail-text"></div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="!isLoading && filteredUsers.length; else emptyAdminUsers" class="users-grid">
            <div class="user-card" *ngFor="let user of filteredUsers">
              <div class="org-user-actions">
                <ion-icon name="create-outline" class="action-edit" (click)="openEditUserModal(user)" title="Edit user"></ion-icon>
                <ion-icon name="trash-outline" class="action-delete" (click)="deleteUser(user, $event)" title="Delete user"></ion-icon>
              </div>
              <div class="user-card-content">
                <div class="user-header">
                  <div class="user-avatar">
                    <img *ngIf="getUserHeadshot(user)" [src]="getUserHeadshot(user)" [alt]="user.Name" class="headshot-image">
                    <div *ngIf="!getUserHeadshot(user)" class="headshot-placeholder">
                      <ion-icon name="person"></ion-icon>
                    </div>
                  </div>
                  <div class="user-info">
                    <h4>{{ user.Name || 'Unnamed User' }}</h4>
                    <p class="user-role">{{ user.Title || 'No title assigned' }}</p>
                  </div>
                </div>
                <div class="user-details">
                  <div class="user-detail-item" *ngIf="user.Email">
                    <ion-icon name="mail-outline"></ion-icon>
                    <a [href]="'mailto:' + user.Email" (click)="$event.stopPropagation()">{{ user.Email }}</a>
                  </div>
                  <div class="user-detail-item" *ngIf="user.Phone">
                    <ion-icon name="call-outline"></ion-icon>
                    <a [href]="'tel:' + user.Phone" class="phone-link" (click)="$event.stopPropagation()">{{ formatPhone(user.Phone) }}</a>
                  </div>
                  <div class="user-detail-item">
                    <ion-icon name="business-outline"></ion-icon>
                    <span>{{ getCompanyName(user.CompanyID) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <ng-template #emptyAdminUsers>
            <div *ngIf="!isLoading" class="empty-state-modern">
              <div class="empty-icon-wrapper">
                <ion-icon name="people"></ion-icon>
              </div>
              <h3>No users found</h3>
              <p>No users match your search.</p>
            </div>
          </ng-template>
        </div>
      </div>

    </div>

    <!-- Partners Main Tab Content -->
    <div *ngIf="adminMainTab === 'partners'" class="admin-tab-content">
      <!-- Global Company Filter -->
      <div class="global-company-filter">
        <div class="filter-header">
          <h3>Filter by Company</h3>
          <button *ngIf="globalCompanyFilterId" (click)="clearGlobalCompanyFilter()" class="clear-filter-btn">
            <ion-icon name="close-circle"></ion-icon>
            Clear Filter
          </button>
        </div>

        <div class="search-container">
          <ion-searchbar
            [(ngModel)]="globalCompanySearchTerm"
            (ionInput)="onGlobalCompanySearch($event.detail.value)"
            (ionFocus)="showCompanySuggestions = true"
            placeholder="Search companies"
            [class.has-selection]="globalCompanyFilterId !== null">
          </ion-searchbar>

          <!-- Autocomplete dropdown -->
          <div class="company-suggestions" *ngIf="showCompanySuggestions && filteredCompanySuggestions.length > 0 && !globalCompanyFilterId">
            <div
              *ngFor="let company of filteredCompanySuggestions"
              class="suggestion-item"
              (click)="selectGlobalCompany(company.CompanyID, company.CompanyName)">
              <div class="company-info">
                <strong>{{ company.CompanyName }}</strong>
                <span class="company-location">{{ buildCompanyAddress(company) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Active filter indicator -->
        <div class="active-filter-badge" *ngIf="globalCompanyFilterId">
          <ion-icon name="filter"></ion-icon>
          <span>Showing data for: <strong>{{ globalCompanySearchTerm }}</strong></span>
        </div>
      </div>

      <div class="sub-tab-bar">
        <button class="sub-tab" [class.active]="selectedTab === 'companies'" (click)="selectTab('companies')">
          <ion-icon name="business-outline"></ion-icon>
          <span>Companies</span>
        </button>
        <button class="sub-tab" [class.active]="selectedTab === 'contacts'" (click)="selectTab('contacts')">
          <ion-icon name="people-outline"></ion-icon>
          <span>Contacts</span>
        </button>
        <button class="sub-tab" [class.active]="selectedTab === 'tasks'" (click)="selectTab('tasks')">
          <ion-icon name="checkbox-outline"></ion-icon>
          <span>Tasks</span>
        </button>
        <button class="sub-tab" [class.active]="selectedTab === 'meetings'" (click)="selectTab('meetings')">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>Meetings</span>
        </button>
        <button class="sub-tab" [class.active]="selectedTab === 'communications'" (click)="selectTab('communications')">
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <span>Comms</span>
        </button>
        <button class="sub-tab" [class.active]="selectedTab === 'invoices'" (click)="selectTab('invoices')">
          <ion-icon name="receipt-outline"></ion-icon>
          <span>Invoices</span>
        </button>
        <button class="sub-tab" [class.active]="selectedTab === 'notifications'" (click)="selectTab('notifications')">
          <ion-icon name="notifications-outline"></ion-icon>
          <span>Notifications</span>
        </button>
      </div>
    </div>
    <div *ngIf="selectedTab === 'companies'" class="tab-content companies-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="companyFilters.search"
              (ionChange)="applyCompanyFilters()"
              placeholder="Search companies"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddCompanyModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Company
          </ion-button>
        </div>
      </div>

      <!-- Skeleton loaders for companies -->
      <div *ngIf="isLoading" class="crm-skeleton-container">
        <div *ngFor="let i of [1,2,3]">
          <div class="skeleton-stage-header">
            <div class="skeleton-stage-info">
              <div class="skeleton-stage-name"></div>
              <div class="skeleton-stage-count"></div>
            </div>
            <div class="skeleton-toggle"></div>
          </div>
          <div class="crm-skeleton-container">
            <div class="skeleton-company-card" *ngFor="let j of [1,2,3]">
              <div class="skeleton-company-info">
                <div class="skeleton-company-name"></div>
                <div class="skeleton-company-location"></div>
              </div>
              <div class="skeleton-company-metrics">
                <div class="skeleton-metric"></div>
                <div class="skeleton-metric"></div>
              </div>
              <div class="skeleton-expand-btn"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="stage-rollups" *ngIf="!isLoading && stageGroups.length; else emptyCompanies">
        <div class="stage-container" *ngFor="let group of stageGroups; trackBy: trackByStage">
          <div class="stage-header" (click)="toggleStageExpand(group.stage, $event)">
            <div class="stage-info">
              <ion-icon class="collapse-chevron" [name]="isStageExpanded(group.stage) ? 'chevron-down' : 'chevron-forward'"></ion-icon>
              <h3 class="stage-name">{{ formatStageName(group.stage) }}</h3>
              <span class="stage-count">{{ group.companies.length }} {{ group.companies.length === 1 ? 'company' : 'companies' }}</span>
            </div>
          </div>

          <div class="companies-list" *ngIf="isStageExpanded(group.stage)">
            <div class="company-rollup"
                 *ngFor="let company of group.companies; trackBy: trackByCompany"
                 [class.selected]="company.CompanyID === selectedCompanyId"
                 [class.expanded]="isCompanyExpanded(company)">

              <div class="rollup-header" (click)="toggleCompanyExpand(company, $event)">
                <ion-icon class="collapse-chevron" [name]="isCompanyExpanded(company) ? 'chevron-down' : 'chevron-forward'"></ion-icon>
                <div class="company-info">
                  <h4 class="company-name">{{ company.CompanyName }}</h4>
                  <p class="company-location">{{ buildCompanyAddress(company) || 'No address' }}</p>
                </div>
                <div class="rollup-metrics">
                  <button
                    class="filter-toggle-btn"
                    (click)="applyCompanyFilter(company, $event)"
                    [class.active]="globalCompanyFilterId === company.CompanyID"
                    title="Filter all data to this company">
                    <ion-icon name="funnel-outline"></ion-icon>
                  </button>
                  <button class="filter-toggle-btn" (click)="editCompany(company, $event)" title="Edit Company">
                    <ion-icon name="create-outline"></ion-icon>
                  </button>
                </div>
              </div>

              <div class="rollup-content client-details-card" *ngIf="isCompanyExpanded(company)">
                <!-- Meta Tags -->
                <div class="client-details-header">
                  <div class="company-meta-tags">
                    <span class="meta-tag" *ngIf="resolveSoftwareName(company.SoftwareID)">
                      <ion-icon name="desktop-outline"></ion-icon> {{ resolveSoftwareName(company.SoftwareID) }}
                    </span>
                    <span class="meta-tag" *ngIf="company.Size">
                      <ion-icon name="people-outline"></ion-icon> {{ company.Size }}
                    </span>
                    <span class="meta-tag" *ngIf="company.Franchise">
                      <ion-icon name="storefront-outline"></ion-icon> Franchise
                    </span>
                    <span class="meta-tag" *ngIf="company.LeadSource">
                      <ion-icon name="trending-up-outline"></ion-icon> {{ company.LeadSource }}
                    </span>
                    <span class="meta-tag" *ngIf="company.DateOnboarded">
                      <ion-icon name="calendar-outline"></ion-icon> {{ formatDate(company.DateOnboarded) }}
                    </span>
                  </div>
                </div>

                <!-- Contact Information -->
                <div class="client-details-grid">
                  <div class="detail-section">
                    <h4>Contact Information</h4>
                    <div class="detail-row">
                      <div class="detail-col">
                        <label>Phone</label>
                        <p>
                          <a *ngIf="company.Phone" [href]="'tel:' + company.Phone" class="phone-link">{{ formatPhone(company.Phone) }}</a>
                          <span *ngIf="!company.Phone" class="not-provided">Not provided</span>
                        </p>
                      </div>
                      <div class="detail-col">
                        <label>Email</label>
                        <p>
                          <a *ngIf="company.Email" [href]="'mailto:' + company.Email" class="email-link">{{ company.Email }}</a>
                          <span *ngIf="!company.Email" class="not-provided">Not provided</span>
                        </p>
                      </div>
                      <div class="detail-col">
                        <label>CC Email</label>
                        <p class="wrap-text">{{ company.CC_Email || 'Not provided' }}</p>
                      </div>
                    </div>
                    <div class="detail-row">
                      <div class="detail-col">
                        <label>Website</label>
                        <p *ngIf="!company.Website" class="not-provided">Not provided</p>
                        <a *ngIf="company.Website" [href]="company.Website" target="_blank" rel="noopener noreferrer" class="website-link">{{ company.Website }}</a>
                      </div>
                    </div>
                  </div>

                  <!-- Address -->
                  <div class="detail-section">
                    <h4>Address</h4>
                    <div class="detail-row">
                      <div class="detail-col">
                        <label>Street</label>
                        <p>{{ company.Address || 'Not provided' }}</p>
                      </div>
                      <div class="detail-col">
                        <label>City</label>
                        <p>{{ company.City || 'Not provided' }}</p>
                      </div>
                      <div class="detail-col-half">
                        <label>State</label>
                        <p>{{ company.State || 'Not provided' }}</p>
                      </div>
                      <div class="detail-col-half">
                        <label>Zip</label>
                        <p>{{ company.Zip || 'Not provided' }}</p>
                      </div>
                    </div>
                  </div>

                  <!-- Notes -->
                  <div class="detail-section" *ngIf="company.Notes">
                    <h4>Notes</h4>
                    <p class="wrap-text">{{ company.Notes }}</p>
                  </div>

                  <!-- Contract -->
                  <div class="detail-section" *ngIf="company.Contract">
                    <h4>Contract Document</h4>
                    <button class="contract-view-btn" (click)="openContract(company.PK_ID, company.Contract)">
                      <ion-icon name="document-text-outline"></ion-icon> View Contract
                    </button>
                  </div>
                </div>

                <!-- Services Offered -->
                <div class="rollup-flat-section">
                  <h4>Services Offered</h4>
                  <div *ngIf="getCompanyOffers(company.CompanyID).length > 0; else noPartnerOffers" class="list-table services-table">
                    <div class="list-table-header">
                      <span class="lt-col lt-col-property">Service</span>
                      <span class="lt-col lt-col-amount">Fee</span>
                      <span class="lt-col lt-col-amount">Partner</span>
                    </div>
                    <div class="list-table-row" *ngFor="let offer of getCompanyOffers(company.CompanyID)">
                      <span class="lt-col lt-col-property">{{ offer.typeName }}</span>
                      <span class="lt-col lt-col-amount">
                        <span *ngIf="offer.ServiceFee"><span class="currency-sign">$</span><span class="currency-value">{{ offer.ServiceFee | number:'1.2-2' }}</span></span>
                        <span *ngIf="!offer.ServiceFee">—</span>
                      </span>
                      <span class="lt-col lt-col-amount">
                        <span *ngIf="offer.ClientFee"><span class="currency-sign">$</span><span class="currency-value">{{ offer.ClientFee | number:'1.2-2' }}</span></span>
                        <span *ngIf="!offer.ClientFee">—</span>
                      </span>
                    </div>
                  </div>
                  <ng-template #noPartnerOffers>
                    <p class="not-provided">No services configured</p>
                  </ng-template>
                </div>

                <!-- Outstanding Balance -->
                <div class="rollup-flat-section">
                  <div class="flat-section-header">
                    <h4>Outstanding Balance</h4>
                    <span class="balance-total" [class.has-balance]="getCompanyOutstandingData(company.CompanyID).balance > 0" [class.overpaid]="getCompanyOutstandingData(company.CompanyID).balance < 0">
                      <ion-spinner *ngIf="getCompanyOutstandingData(company.CompanyID).loading" name="crescent"></ion-spinner>
                      <ng-container *ngIf="!getCompanyOutstandingData(company.CompanyID).loading">
                        <span *ngIf="getCompanyOutstandingData(company.CompanyID).balance > 0">
                          {{ getCompanyOutstandingData(company.CompanyID).balance | currency:'USD':'symbol':'1.2-2' }}
                        </span>
                        <span *ngIf="getCompanyOutstandingData(company.CompanyID).balance === 0">$0.00</span>
                        <span *ngIf="getCompanyOutstandingData(company.CompanyID).balance < 0">
                          +{{ (getCompanyOutstandingData(company.CompanyID).balance * -1) | currency:'USD':'symbol':'1.2-2' }}
                        </span>
                      </ng-container>
                    </span>
                  </div>
                  <div *ngIf="getCompanyOutstandingData(company.CompanyID).invoices.length > 0" class="list-table balance-table">
                    <div class="list-table-header">
                      <span class="lt-col lt-col-property">Property</span>
                      <span class="lt-col lt-col-service">Service</span>
                      <span class="lt-col lt-col-amount">Fee</span>
                      <span class="lt-col lt-col-amount">Balance</span>
                    </div>
                    <div class="list-table-row" *ngFor="let inv of getCompanyOutstandingData(company.CompanyID).invoices">
                      <span class="lt-col lt-col-property">{{ inv.projectAddress }}</span>
                      <span class="lt-col lt-col-service">{{ inv.serviceShortNames }}</span>
                      <span class="lt-col lt-col-amount"><span class="currency-sign">$</span><span class="currency-value">{{ inv.fee | number:'1.2-2' }}</span></span>
                      <span class="lt-col lt-col-amount balance-due"><span class="currency-sign">$</span><span class="currency-value">{{ inv.balance | number:'1.2-2' }}</span></span>
                    </div>
                  </div>
                  <!-- Balance is $0.00 shown in header; no extra message needed -->
                </div>

                <!-- Payment History -->
                <div class="rollup-flat-section" *ngIf="getCompanyOutstandingData(company.CompanyID).paidInvoices.length > 0">
                  <h4>Payment History</h4>
                  <div class="list-table history-table" [class.has-action-col]="isWeb">
                    <div class="list-table-header">
                      <span class="lt-col lt-col-date">Date</span>
                      <span class="lt-col lt-col-property">Property</span>
                      <span class="lt-col lt-col-amount">Paid</span>
                      <span class="lt-col lt-col-amount">Balance</span>
                      <span class="lt-col lt-col-action" *ngIf="isWeb"></span>
                    </div>
                    <div class="list-table-row" *ngFor="let payment of getCompanyOutstandingData(company.CompanyID).paidInvoices">
                      <span class="lt-col lt-col-date">{{ payment.paidDate ? (payment.paidDate | date:'shortDate') : 'N/A' }}</span>
                      <span class="lt-col lt-col-property truncate-cell">{{ payment.projectAddress }}</span>
                      <span class="lt-col lt-col-amount"><span class="currency-sign">$</span><span class="currency-value">{{ payment.paidAmount | number:'1.2-2' }}</span></span>
                      <span class="lt-col lt-col-amount" [class.balance-due]="payment.balance > 0"><span class="currency-sign">$</span><span class="currency-value">{{ payment.balance | number:'1.2-2' }}</span></span>
                      <span class="lt-col lt-col-action" *ngIf="isWeb">
                        <button class="download-invoice-btn" (click)="downloadInvoice(payment, company.CompanyName)" title="Download Receipt">
                          <ion-icon name="download-outline"></ion-icon>
                        </button>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Autopay -->
                <div class="rollup-flat-section">
                  <h4>Autopay</h4>
                  <div class="autopay-inline">
                    <div class="autopay-inline-item">
                      <span *ngIf="company.AutopayEnabled" class="autopay-badge enabled">
                        <ion-icon name="checkmark-circle"></ion-icon> Enabled
                      </span>
                      <span *ngIf="!company.AutopayEnabled" class="autopay-badge disabled">
                        <ion-icon name="close-circle"></ion-icon> Disabled
                      </span>
                      <span *ngIf="company.AutopayReviewRequired" class="autopay-badge review">
                        <ion-icon name="eye-outline"></ion-icon> Review
                      </span>
                    </div>
                    <div class="autopay-inline-item">
                      <span *ngIf="company.StripePaymentMethodID" class="payment-method-tag stripe">
                        <ion-icon name="business-outline"></ion-icon>
                        {{ company.StripeBankName || 'Bank' }} ****{{ company.StripeBankLast4 }}
                      </span>
                      <span *ngIf="company.PayPalPayerEmail && !company.StripePaymentMethodID" class="payment-method-tag paypal">
                        <ion-icon name="logo-paypal"></ion-icon>
                        {{ company.PayPalPayerEmail }}
                      </span>
                      <span *ngIf="!company.PayPalPayerEmail && !company.StripePaymentMethodID" class="not-provided">No payment method</span>
                    </div>
                    <div class="autopay-inline-actions">
                      <button class="action-btn-sm" (click)="openStripeAchModal(company)">
                        <ion-icon name="link-outline"></ion-icon> Link
                      </button>
                      <button
                        class="action-btn-sm primary"
                        (click)="triggerAutopay(company)"
                        [disabled]="!company.AutopayEnabled || (!company.PayPalVaultToken && !company.StripePaymentMethodID) || getCompanyOutstandingData(company.CompanyID).balance <= 0">
                        {{ company.AutopayReviewRequired ? 'Approve' : 'Run' }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyCompanies>
        <div *ngIf="!isLoading" class="empty-state-modern">
          <div class="empty-icon-wrapper">
            <ion-icon name="business"></ion-icon>
          </div>
          <h3>No companies found</h3>
          <p>Try adjusting your search or filters to find companies</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'contacts'" class="tab-content contacts-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="contactsSearchTerm"
              (ionChange)="onContactSearchChange($event.detail.value)"
              placeholder="Search contacts by name"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddContactModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Contact
          </ion-button>
        </div>
      </div>

      <!-- Skeleton loaders for contacts -->
      <div *ngIf="isLoading" class="skeleton-contacts-container">
        <div class="skeleton-contact-group" *ngFor="let i of [1,2,3]">
          <div class="skeleton-contact-group-header">
            <div class="skeleton-company-name"></div>
            <div class="skeleton-badge"></div>
          </div>
          <div class="skeleton-contact-table">
            <div class="skeleton-contact-row" *ngFor="let j of [1,2]">
              <div class="skeleton-contact-name"></div>
              <div class="skeleton-contact-title"></div>
              <div class="skeleton-contact-phone"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="contact-groups" *ngIf="!isLoading && paginatedContactGroups.length; else emptyContacts">
        <div class="contact-group" *ngFor="let group of paginatedContactGroups; trackBy: trackByContactGroup">
          <div class="stage-header" (click)="toggleContactGroupExpand(group.companyName, $event)">
            <div class="stage-info">
              <ion-icon class="collapse-chevron" [name]="isContactGroupExpanded(group.companyName) ? 'chevron-down' : 'chevron-forward'"></ion-icon>
              <h3 class="stage-name">{{ group.companyName }}</h3>
              <span class="stage-count">{{ group.contacts.length }} {{ group.contacts.length === 1 ? 'contact' : 'contacts' }}</span>
            </div>
          </div>
          <div class="contact-group-body" *ngIf="isContactGroupExpanded(group.companyName)">
            <div class="list-table contacts-table">
              <div class="list-table-header">
                <span class="lt-col lt-col-property">Contact</span>
                <span class="lt-col lt-col-service">Title</span>
                <span class="lt-col lt-col-email">Email</span>
                <span class="lt-col lt-col-amount">Phone</span>
              </div>
              <div class="list-table-row" *ngFor="let contact of group.contacts; trackBy: trackByContact">
                <span class="lt-col lt-col-property contact-name-cell">
                  <button type="button" class="contact-name-button" (click)="openEditContactModal(contact)">
                    {{ contact.Name }}
                  </button>
                  <ion-icon *ngIf="contact.PrimaryContact" name="star" class="primary-indicator" title="Primary Contact"></ion-icon>
                </span>
                <span class="lt-col lt-col-service">{{ contact.Title || '—' }}</span>
                <span class="lt-col lt-col-email">
                  <a *ngIf="contact.Email" [href]="'mailto:' + contact.Email" class="email-link">{{ contact.Email }}</a>
                  <span *ngIf="!contact.Email">—</span>
                </span>
                <span class="lt-col lt-col-amount">
                  <a *ngIf="contact.Phone1" [href]="'tel:' + contact.Phone1" class="phone-link">
                    {{ formatPhone(contact.Phone1) }}
                  </a>
                  <span *ngIf="!contact.Phone1">—</span>
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="pagination-controls" *ngIf="totalContactPages > 1">
          <button class="pagination-btn arrow-only" (click)="prevContactPage()" [disabled]="currentContactPage === 1">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </button>
          <span class="page-indicator">{{ currentContactPage }} of {{ totalContactPages }}</span>
          <button class="pagination-btn arrow-only" (click)="nextContactPage()" [disabled]="currentContactPage === totalContactPages">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </button>
        </div>
      </div>
      <ng-template #emptyContacts>
        <div *ngIf="!isLoading" class="empty-tab-state">
          <ion-icon name="people-outline"></ion-icon>
          <h3>No contacts match your filters</h3>
          <p>Adjust the filters or search criteria.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'tasks'" class="tab-content tasks-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="taskFilters.search"
              (ionChange)="applyTaskFilters()"
              placeholder="Search tasks"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddTaskModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Task
          </ion-button>
        </div>
        <div class="filter-row filter-row-centered">
          <div class="filter-group">
            <label for="status-filter">Status</label>
            <select
              id="status-filter"
              [(ngModel)]="taskFilters.status"
              (ngModelChange)="applyTaskFilters()"
              class="styled-input">
              <option value="all">All</option>
              <option value="open">Open</option>
              <option value="completed">Completed</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="assignee-filter">Assignee</label>
            <select
              id="assignee-filter"
              [(ngModel)]="taskFilters.assignedTo"
              (ngModelChange)="applyTaskFilters()"
              class="styled-input">
              <option value="all">All assignees</option>
              <option *ngFor="let person of taskAssignees" [value]="person">{{ person }}</option>
            </select>
          </div>
        </div>
        <div class="invoice-tabs task-timeline-tabs">
          <button class="invoice-tab" [class.active]="taskFilters.timeframe === 'overdue'" (click)="setTaskTimeframe('overdue')">
            Overdue
          </button>
          <button class="invoice-tab" [class.active]="taskFilters.timeframe === 'past'" (click)="setTaskTimeframe('past')">
            Past
          </button>
          <button class="invoice-tab" [class.active]="taskFilters.timeframe === '7day'" (click)="setTaskTimeframe('7day')">
            7 Day
          </button>
          <button class="invoice-tab" [class.active]="taskFilters.timeframe === 'all'" (click)="setTaskTimeframe('all')">
            All
          </button>
        </div>
      </div>

      <!-- Skeleton loaders for tasks -->
      <div *ngIf="isLoading" class="skeleton-tasks-grid">
        <div class="skeleton-task-card" *ngFor="let i of [1,2,3,4,5,6]">
          <div class="skeleton-task-header">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-task-info">
              <div class="skeleton-task-title"></div>
              <div class="skeleton-task-company"></div>
            </div>
            <div class="skeleton-badge"></div>
          </div>
          <div class="skeleton-task-meta">
            <div class="skeleton-meta-line"></div>
            <div class="skeleton-meta-line"></div>
          </div>
        </div>
      </div>

      <div *ngIf="!isLoading && filteredTasks.length; else emptyTasks" class="tasks-grid">
        <ion-card *ngFor="let task of paginatedTasks; trackBy: trackByTask" class="task-card clickable-card" [class.completed]="task.completed" [class.overdue]="task.isOverdue" (click)="openEditTaskModal(task)">
          <ion-item lines="none" class="task-card-header">
            <ion-checkbox
              slot="start"
              [checked]="task.completed"
              [disabled]="isTaskUpdating(task)"
              (ionChange)="toggleTaskCompletion(task, $event.detail.checked)"
              (click)="$event.stopPropagation()">
            </ion-checkbox>
            <ion-label>
              <h4>{{ getFirstName(task.assignTo) || 'Unassigned' }} • {{ task.communicationType || 'General' }}</h4>
              <p>{{ task.assignmentShort || task.assignment || 'No details provided' }}</p>
            </ion-label>
            <ion-badge class="completed-badge" *ngIf="task.completed">Completed</ion-badge>
            <ion-badge class="overdue-badge" *ngIf="!task.completed && task.isOverdue">Overdue</ion-badge>
          </ion-item>
          <ion-card-content>
            <div class="task-meta">
              <span><ion-icon name="calendar-outline"></ion-icon>{{ formatDate(task.dueDate) }}</span>
              <span *ngIf="task.notes"><ion-icon name="document-text-outline"></ion-icon>{{ task.notes }}</span>
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(task.CompanyID) }}</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
      <!-- Pagination controls for Tasks -->
      <div class="pagination-controls" *ngIf="filteredTasks.length > tasksPerPage">
        <button (click)="prevTaskPage()" [disabled]="currentTaskPage === 1" class="pagination-btn arrow-only">
          <ion-icon name="chevron-back-outline"></ion-icon>
        </button>
        <span class="page-indicator">{{ currentTaskPage }} of {{ totalTaskPages }}</span>
        <button (click)="nextTaskPage()" [disabled]="currentTaskPage === totalTaskPages" class="pagination-btn arrow-only">
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </button>
      </div>
      <ng-template #emptyTasks>
        <div *ngIf="!isLoading" class="empty-tab-state">
          <ion-icon name="checkbox-outline"></ion-icon>
          <h3>No tasks match your filters</h3>
          <p>Try expanding your filters or change the scope.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'meetings'" class="tab-content meetings-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="meetingFilters.search"
              (ionChange)="applyMeetingFilters()"
              placeholder="Search subjects or attendees"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddMeetingModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Meeting
          </ion-button>
        </div>
        <div class="filter-row">
          <div class="invoice-tabs">
            <button class="invoice-tab" [class.active]="meetingFilters.timeframe === 'upcoming'" (click)="setMeetingTimeframe('upcoming')">
              Upcoming
            </button>
            <button class="invoice-tab" [class.active]="meetingFilters.timeframe === 'past'" (click)="setMeetingTimeframe('past')">
              Past
            </button>
            <button class="invoice-tab" [class.active]="meetingFilters.timeframe === 'all'" (click)="setMeetingTimeframe('all')">
              All
            </button>
          </div>
        </div>
      </div>

      <!-- Skeleton loaders for meetings -->
      <div *ngIf="isLoading" class="skeleton-meetings-container">
        <div class="skeleton-meeting-item" *ngFor="let i of [1,2,3,4]">
          <div class="skeleton-meeting-header">
            <div class="skeleton-meeting-subject"></div>
            <div class="skeleton-meeting-datetime">
              <div class="skeleton-date"></div>
              <div class="skeleton-time"></div>
            </div>
          </div>
          <div class="skeleton-meeting-description"></div>
          <div class="skeleton-meeting-meta">
            <div class="skeleton-meta-item"></div>
            <div class="skeleton-meta-item"></div>
          </div>
        </div>
      </div>

      <div *ngIf="!isLoading && filteredMeetings.length; else emptyMeetings" class="timeline">
        <div class="timeline-item clickable-card" *ngFor="let meeting of paginatedMeetings" (click)="openEditMeetingModal(meeting)">
          <div class="timeline-content">
            <div class="timeline-header">
              <h4>{{ meeting.subject }}</h4>
              <div class="meeting-datetime">
                <span>{{ formatDateShort(meeting.startDate) }}</span>
                <span class="meeting-time">{{ formatTime(meeting.startDate) }}</span>
              </div>
            </div>
            <p>{{ meeting.description || 'No description provided.' }}</p>
            <div class="timeline-meta">
              <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(meeting.CompanyID) }}</span>
              <span><ion-icon name="people-outline"></ion-icon>{{ meeting.attendees.length ? meeting.attendees.join(', ') : 'No attendees listed' }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Pagination controls for Meetings -->
      <div class="pagination-controls" *ngIf="filteredMeetings.length > meetingsPerPage">
        <button (click)="prevMeetingPage()" [disabled]="currentMeetingPage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentMeetingPage }} of {{ totalMeetingPages }}</span>
        <button (click)="nextMeetingPage()" [disabled]="currentMeetingPage === totalMeetingPages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>
      <ng-template #emptyMeetings>
        <div class="empty-tab-state">
          <ion-icon name="calendar-outline"></ion-icon>
          <h3>No meetings to display</h3>
          <p>Schedule or log meetings to see them here.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'communications'" class="tab-content communications-tab">
      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="communicationSearchTerm"
              (ionChange)="applyCommunicationFilters()"
              placeholder="Search notes or outcomes"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
          <ion-button size="small" (click)="openAddCommunicationModal()" class="add-button">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Communication
          </ion-button>
        </div>
      </div>

      <!-- Skeleton loaders for communications -->
      <div *ngIf="isLoading" class="skeleton-communications-container">
        <div class="skeleton-communication-card" *ngFor="let i of [1,2,3,4]">
          <div class="skeleton-communication-header">
            <div class="skeleton-comm-type"></div>
            <div class="skeleton-comm-date"></div>
          </div>
          <div class="skeleton-comm-notes"></div>
          <div class="skeleton-comm-meta">
            <div class="skeleton-meta-item"></div>
            <div class="skeleton-meta-item"></div>
            <div class="skeleton-meta-item"></div>
          </div>
        </div>
      </div>

      <div *ngIf="!isLoading && filteredCommunications.length; else emptyCommunications" class="communications-timeline">
        <div class="communication-card clickable-card" *ngFor="let comm of paginatedCommunications" (click)="openEditCommunicationModal(comm)">
          <div class="communication-header">
            <h4>{{ comm.communicationType }}</h4>
            <span>{{ formatDate(comm.date) }}</span>
          </div>
          <p>{{ comm.notes || 'No notes added.' }}</p>
          <div class="communication-meta">
            <span><ion-icon name="business-outline"></ion-icon>{{ getCompanyName(comm.CompanyID) }}</span>
            <span><ion-icon name="swap-horizontal-outline"></ion-icon>{{ comm.outcome }}</span>
            <span *ngIf="comm.channels.length"><ion-icon name="share-social-outline"></ion-icon>{{ comm.channels.join(', ') }}</span>
          </div>
        </div>
      </div>
      <!-- Pagination controls for Communications -->
      <div class="pagination-controls" *ngIf="filteredCommunications.length > communicationsPerPage">
        <button (click)="prevCommunicationPage()" [disabled]="currentCommunicationPage === 1" class="pagination-btn">
          <ion-icon name="chevron-back"></ion-icon>
          Previous
        </button>
        <span class="page-info">Page {{ currentCommunicationPage }} of {{ totalCommunicationPages }}</span>
        <button (click)="nextCommunicationPage()" [disabled]="currentCommunicationPage === totalCommunicationPages" class="pagination-btn">
          Next
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      </div>
      <ng-template #emptyCommunications>
        <div class="empty-tab-state">
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          <h3>No communication found</h3>
          <p>Log calls, emails or messages to build your timeline.</p>
        </div>
      </ng-template>
    </div>
    <div *ngIf="selectedTab === 'invoices'" class="tab-content invoices-tab">
      <!-- Autopay Ready Banner -->
      <div *ngIf="autopayDueCompanies.length > 0 && !autopayAutoCharge" class="autopay-due-banner">
        <ion-icon name="alert-circle"></ion-icon>
        <span><strong>{{ autopayDueCompanies.length }}</strong> company(s) have outstanding balances with autopay enabled. Review each company and manually run their payment.</span>
      </div>

      <!-- Global Autopay Auto-Charge Toggle -->
      <div class="autopay-system-toggle">
        <div class="setting-info">
          <ion-icon name="flash-outline"></ion-icon>
          <div>
            <span class="setting-label">Auto-Charge</span>
            <span class="setting-description">{{ autopayAutoCharge ? 'Payments auto-charge on project completion' : 'Manual trigger only — no auto-charging' }}</span>
          </div>
        </div>
        <ion-toggle [checked]="autopayAutoCharge" (ionChange)="toggleAutopaySystem($event)" mode="ios"></ion-toggle>
      </div>

      <div class="tab-header">
        <div class="search-and-action">
          <div class="search-wrapper">
            <ion-searchbar
              [(ngModel)]="invoiceSearchTerm"
              (ionChange)="categorizeInvoices()"
              placeholder="Search invoice, project, or company"
              animated="true"
              class="modern-search">
            </ion-searchbar>
          </div>
        </div>
        <div class="filter-row">
          <div class="invoice-tabs">
            <button class="invoice-tab" [class.active]="invoiceViewMode === 'open'" (click)="setInvoiceViewMode('open')">
              Open
            </button>
            <button class="invoice-tab" [class.active]="invoiceViewMode === 'past'" (click)="setInvoiceViewMode('past')">
              Past
            </button>
            <button class="invoice-tab" [class.active]="invoiceViewMode === 'unpaid'" (click)="setInvoiceViewMode('unpaid')">
              Unpaid
            </button>
          </div>
        </div>
      </div>

      <!-- Skeleton loaders for invoices -->
      <div *ngIf="isLoading" class="crm-skeleton-container">
        <div *ngFor="let i of [1,2,3]">
          <div class="skeleton-invoice-item">
            <div class="skeleton-invoice-headers">
              <div class="skeleton-header-cell"></div>
              <div class="skeleton-header-cell"></div>
              <div class="skeleton-header-cell"></div>
            </div>
            <div class="skeleton-invoice-content">
              <div class="skeleton-invoice-value">
                <div class="skeleton-value-line"></div>
                <div class="skeleton-value-line"></div>
              </div>
              <div class="skeleton-invoice-value">
                <div class="skeleton-value-line"></div>
              </div>
              <div class="skeleton-invoice-value">
                <div class="skeleton-value-line"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="invoice-groups" *ngIf="!isLoading && paginatedInvoiceGroups.length; else emptyInvoices">
        <div class="invoice-group stage-container" *ngFor="let group of paginatedInvoiceGroups; trackBy: trackByInvoiceGroup">
          <div class="stage-header" (click)="toggleInvoiceGroupExpand(group.companyName, $event)">
            <div class="stage-info">
              <ion-icon class="collapse-chevron" [name]="isInvoiceGroupExpanded(group.companyName) ? 'chevron-down' : 'chevron-forward'"></ion-icon>
              <h3 class="stage-name">{{ group.companyName }}</h3>
              <span class="stage-count">{{ group.invoices.length }} {{ group.invoices.length === 1 ? 'invoice' : 'invoices' }}</span>
            </div>
          </div>
          <div class="invoice-group-body" *ngIf="isInvoiceGroupExpanded(group.companyName)">
            <div class="list-table invoice-list-table">
              <div class="list-table-header">
                <span class="lt-col lt-col-property">Address</span>
                <span class="lt-col lt-col-service">Service</span>
                <span class="lt-col lt-col-amount">Amount Due</span>
                <span class="lt-col lt-col-action"></span>
              </div>
              <div class="list-table-row clickable-row" *ngFor="let invoice of group.invoices; trackBy: trackByInvoice" (click)="openEditInvoiceModal(invoice)">
                <span class="lt-col lt-col-property">{{ invoice.positive.Address || '—' }}</span>
                <span class="lt-col lt-col-service">{{ invoice.serviceName || '—' }}</span>
                <span class="lt-col lt-col-amount balance-due">
                  <span class="currency-sign">$</span><span class="currency-value">{{ invoice.netAmount | number:'1.2-2' }}</span>
                </span>
                <span class="lt-col lt-col-action invoice-row-actions">
                  <button class="action-btn-sm" (click)="openAddInvoiceModal(invoice); $event.stopPropagation()" title="Added Service">
                    <ion-icon name="add"></ion-icon>
                  </button>
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="pagination-controls" *ngIf="totalInvoicePages > 1">
          <button class="pagination-btn arrow-only" (click)="prevInvoicePage()" [disabled]="currentInvoicePage === 1">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </button>
          <span class="page-indicator">{{ currentInvoicePage }} of {{ totalInvoicePages }}</span>
          <button class="pagination-btn arrow-only" (click)="nextInvoicePage()" [disabled]="currentInvoicePage === totalInvoicePages">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </button>
        </div>
      </div>

      <ng-template #emptyInvoices>
        <div *ngIf="!isLoading" class="empty-tab-state">
          <ion-icon name="receipt-outline"></ion-icon>
          <h3>No invoices found</h3>
          <p>Once invoices are generated they will appear here.</p>
        </div>
      </ng-template>
    </div>

    <!-- Notifications Sub-Tab Content -->
    <div *ngIf="selectedTab === 'notifications'" class="tab-content notifications-tab">
      <!-- Auto-Notification Settings -->
      <div class="notif-card">
        <h3 class="notif-card-title">Automatic Notifications</h3>
        <p class="notif-card-desc">When enabled, all companies with registered devices will receive push notifications automatically.</p>

        <div class="notif-setting-row">
          <div class="notif-setting-info">
            <ion-icon name="checkmark-done-outline"></ion-icon>
            <div>
              <span class="notif-setting-label">Service Complete</span>
              <span class="notif-setting-desc">Notify when a service is marked complete</span>
            </div>
          </div>
          <ion-toggle [checked]="globalNotifServiceComplete" (ionChange)="toggleGlobalNotif('service_complete')" mode="ios"></ion-toggle>
        </div>

        <div class="notif-setting-row">
          <div class="notif-setting-info">
            <ion-icon name="card-outline"></ion-icon>
            <div>
              <span class="notif-setting-label">Payment Received</span>
              <span class="notif-setting-desc">Notify when an autopay payment is processed</span>
            </div>
          </div>
          <ion-toggle [checked]="globalNotifPaymentReceived" (ionChange)="toggleGlobalNotif('payment_received')" mode="ios"></ion-toggle>
        </div>
      </div>

      <!-- Send Notification -->
      <div class="notif-card">
        <h3 class="notif-card-title">Send Notification</h3>

        <!-- Target Type -->
        <div class="notif-target-toggle">
          <button class="notif-target-btn" [class.active]="notifTargetType === 'all'" (click)="setNotifTarget('all')">
            <ion-icon name="megaphone-outline"></ion-icon> All
          </button>
          <button class="notif-target-btn" [class.active]="notifTargetType === 'company'" (click)="setNotifTarget('company')">
            <ion-icon name="business-outline"></ion-icon> Company
          </button>
          <button class="notif-target-btn" [class.active]="notifTargetType === 'user'" (click)="setNotifTarget('user')">
            <ion-icon name="person-outline"></ion-icon> User
          </button>
        </div>

        <!-- Target Search (company or user) -->
        <div class="notif-field" *ngIf="notifTargetType !== 'all'">
          <label class="notif-label">{{ notifTargetType === 'company' ? 'Company' : 'User' }}</label>
          <div class="notif-search-wrapper">
            <input type="text" class="notif-input" [(ngModel)]="notifTargetSearch"
                   (input)="filterNotifTargets()"
                   [placeholder]="notifTargetType === 'company' ? 'Search companies...' : 'Search users...'"
                   autocomplete="off">
            <div class="notif-suggestions" *ngIf="notifTargetSuggestions.length > 0 && !notifTargetId">
              <button *ngFor="let item of notifTargetSuggestions" class="notif-suggestion-item" (click)="selectNotifTarget(item)">
                {{ item.label }}
              </button>
            </div>
          </div>
          <div class="notif-selected-target" *ngIf="notifTargetId">
            <span>{{ notifTargetSearch }}</span>
            <button class="notif-clear-target" (click)="notifTargetId = null; notifTargetSearch = ''">
              <ion-icon name="close-circle"></ion-icon>
            </button>
          </div>
        </div>

        <!-- Title -->
        <div class="notif-field">
          <label class="notif-label">Title</label>
          <input type="text" class="notif-input" [(ngModel)]="notifTitle" placeholder="Notification title" maxlength="100">
        </div>

        <!-- Body -->
        <div class="notif-field">
          <label class="notif-label">Message</label>
          <textarea class="notif-textarea" [(ngModel)]="notifBody" placeholder="Notification message..." rows="3" maxlength="500"></textarea>
        </div>

        <!-- Send Button -->
        <button class="notif-send-btn" [disabled]="!canSendNotification() || notifSending" (click)="sendNotification()">
          <ion-spinner *ngIf="notifSending" name="crescent"></ion-spinner>
          <span *ngIf="!notifSending">
            <ion-icon name="send"></ion-icon> {{ notifTargetType === 'all' ? 'Send to All' : 'Send Notification' }}
          </span>
        </button>
      </div>

      <!-- Notification History (session only) -->
      <div class="notif-card" *ngIf="notifHistory.length > 0">
        <h3 class="notif-card-title">Sent This Session</h3>
        <div class="notif-history-list">
          <div *ngFor="let entry of notifHistory" class="notif-history-item">
            <div class="notif-history-header">
              <span class="notif-history-title">{{ entry.title }}</span>
              <span class="notif-history-time">{{ entry.time | date:'shortTime' }}</span>
            </div>
            <div class="notif-history-body">{{ entry.body }}</div>
            <div class="notif-history-meta">
              <span class="notif-history-target">{{ entry.targetLabel }}</span>
              <span class="notif-history-result" [class.success]="entry.success" [class.failed]="!entry.success">
                {{ entry.success ? 'Sent ' + entry.sent : 'Failed' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Metrics Main Tab Content -->
    <div *ngIf="adminMainTab === 'metrics'" class="admin-tab-content metrics-tab">
      <!-- Skeleton loaders for metrics -->
      <div *ngIf="isLoading" class="skeleton-metrics-container">
        <div class="skeleton-chart-container" *ngFor="let i of [1,2]">
          <div class="skeleton-chart-header">
            <div class="skeleton-chart-title"></div>
            <div class="skeleton-chart-subtitle"></div>
          </div>
          <div class="skeleton-chart-wrapper">
            <div class="skeleton-chart"></div>
          </div>
        </div>
      </div>

      <div *ngIf="!isLoading" class="chart-container">
        <div class="chart-header">
          <h4>Revenue Over Time</h4>
          <p>Monthly invoice revenue</p>
        </div>
        <div class="chart-wrapper">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>

      <div *ngIf="!isLoading" class="chart-container">
        <div class="chart-header">
          <h4>Projects by Service Type</h4>
          <p>Completed projects and revenue by service category</p>
        </div>
        <div class="chart-wrapper">
          <canvas id="projectsByTypeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bottom spacer to ensure full scrolling on mobile -->
    <div class="bottom-spacer"></div>
  </div>

  <!-- Client View for non-Company 1 users -->
  <div *ngIf="!isCompanyOne" class="page-shell" [class.full-width]="clientTab === 'metrics'">
    <!-- Main Tab Navigation for Clients -->
    <div class="main-tab-bar">
      <button class="main-tab" [class.active]="clientTab === 'company'" (click)="selectClientTab('company')">
        <ion-icon name="business"></ion-icon>
        <span>Company</span>
      </button>
      <button class="main-tab" [class.active]="clientTab === 'payments'" (click)="selectClientTab('payments')">
        <ion-icon name="card"></ion-icon>
        <span>Payments</span>
      </button>
      <button class="main-tab" [class.active]="clientTab === 'metrics'" (click)="selectClientTab('metrics')">
        <ion-icon name="analytics"></ion-icon>
        <span>Metrics</span>
      </button>
    </div>

    <!-- Company Tab Content -->
    <div *ngIf="clientTab === 'company'" class="client-tab-content">

      <!-- Company Details Collapsible Section -->
      <div class="collapsible-section" *ngIf="clientCompany">
        <div class="collapsible-header" (click)="detailsExpanded = !detailsExpanded">
          <div class="collapsible-title">
            <ion-icon [name]="detailsExpanded ? 'chevron-down' : 'chevron-forward'"></ion-icon>
            <h3>Details</h3>
          </div>
          <button class="minimal-edit-btn" (click)="editClientCompanyDetails(); $event.stopPropagation()" title="Edit Details">
            <ion-icon name="create-outline"></ion-icon>
          </button>
        </div>

        <div class="collapsible-content" [class.expanded]="detailsExpanded">
          <div class="client-details-card">
            <div class="client-details-header">
              <div class="company-logo-container">
                <img [src]="clientCompany.Logo && !clientLogoFailed ? clientCompany.Logo : 'assets/img/company-logo-placeholder.svg'"
                     [alt]="clientCompany.CompanyName"
                     class="company-logo"
                     (error)="clientLogoFailed = true">
              </div>
              <div class="company-name-block">
                <h2>{{ clientCompany.CompanyName }}</h2>
                <p *ngIf="clientCompany.ServiceArea" class="service-area-text">{{ clientCompany.ServiceArea }}</p>
                <div class="company-meta-tags">
                  <span class="meta-tag" *ngIf="getClientSoftwareName()">
                    <ion-icon name="desktop-outline"></ion-icon> {{ getClientSoftwareName() }}
                  </span>
                  <span class="meta-tag" *ngIf="clientCompany.Size">
                    <ion-icon name="people-outline"></ion-icon> {{ clientCompany.Size }}
                  </span>
                  <span class="meta-tag" *ngIf="clientCompany.Franchise">
                    <ion-icon name="storefront-outline"></ion-icon> Franchise
                  </span>
                </div>
              </div>
            </div>

            <div class="client-details-grid">
              <div class="detail-section">
                <h4>Contact Information</h4>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Phone</label>
                    <p>
                      <a *ngIf="clientCompany.Phone" [href]="'tel:' + clientCompany.Phone" class="phone-link">
                        {{ formatPhone(clientCompany.Phone) }}
                      </a>
                      <span *ngIf="!clientCompany.Phone" class="not-provided">Not provided</span>
                    </p>
                  </div>
                  <div class="detail-col">
                    <label>Email</label>
                    <p>
                      <a *ngIf="clientCompany.Email" [href]="'mailto:' + clientCompany.Email" class="email-link">{{ clientCompany.Email }}</a>
                      <span *ngIf="!clientCompany.Email" class="not-provided">Not provided</span>
                    </p>
                  </div>
                  <div class="detail-col">
                    <label>Website</label>
                    <p *ngIf="!clientCompany.Website" class="not-provided">Not provided</p>
                    <a *ngIf="clientCompany.Website" [href]="clientCompany.Website" target="_blank" rel="noopener noreferrer" class="website-link">
                      {{ clientCompany.Website }}
                    </a>
                  </div>
                </div>
              </div>

              <div class="detail-section">
                <h4>Address</h4>
                <div class="detail-row">
                  <div class="detail-col">
                    <label>Street</label>
                    <p>{{ clientCompany.Address || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col">
                    <label>City</label>
                    <p>{{ clientCompany.City || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col-half">
                    <label>State</label>
                    <p>{{ clientCompany.State || 'Not provided' }}</p>
                  </div>
                  <div class="detail-col-half">
                    <label>Zip</label>
                    <p>{{ clientCompany.Zip || 'Not provided' }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Collapsible Section -->
      <div class="collapsible-section">
        <div class="collapsible-header" (click)="usersExpanded = !usersExpanded">
          <div class="collapsible-title">
            <ion-icon [name]="usersExpanded ? 'chevron-down' : 'chevron-forward'"></ion-icon>
            <h3>Users</h3>
            <span class="collapsible-count" *ngIf="!isLoading">({{ organizationUsers.length }})</span>
          </div>
          <button class="minimal-add-btn" (click)="openAddUserModal(); $event.stopPropagation()" title="Add User">
            <ion-icon name="add"></ion-icon>
          </button>
        </div>

        <div class="collapsible-content" [class.expanded]="usersExpanded">
          <!-- Loading State - Skeleton loader -->
          <div *ngIf="isLoading" class="skeleton-users-grid">
            <div class="skeleton-user-card" *ngFor="let i of [1,2,3,4,5,6]">
              <div class="skeleton-user-header">
                <div class="skeleton-user-avatar"></div>
                <div class="skeleton-user-info">
                  <div class="skeleton-user-name"></div>
                  <div class="skeleton-user-role"></div>
                </div>
              </div>
              <div class="skeleton-user-details">
                <div class="skeleton-user-detail-item">
                  <div class="skeleton-icon"></div>
                  <div class="skeleton-detail-text"></div>
                </div>
                <div class="skeleton-user-detail-item">
                  <div class="skeleton-icon"></div>
                  <div class="skeleton-detail-text"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Cards (matches admin portal layout) -->
          <div *ngIf="!isLoading && organizationUsers.length > 0" class="users-grid">
            <div class="user-card" *ngFor="let user of organizationUsers">
              <div class="org-user-actions">
                <ion-icon name="create-outline" class="action-edit" (click)="openEditUserModal(user)" title="Edit user"></ion-icon>
                <ion-icon name="trash-outline" class="action-delete" (click)="deleteUser(user, $event)" title="Delete user"></ion-icon>
              </div>
              <div class="user-card-content">
                <div class="user-header">
                  <div class="user-avatar">
                    <img *ngIf="getUserHeadshot(user)" [src]="getUserHeadshot(user)" [alt]="user.Name" class="headshot-image">
                    <div *ngIf="!getUserHeadshot(user)" class="headshot-placeholder">
                      <ion-icon name="person"></ion-icon>
                    </div>
                  </div>
                  <div class="user-info">
                    <h4>{{ user.Name || 'Unnamed User' }}</h4>
                    <p class="user-role">{{ user.Title || 'No title assigned' }}</p>
                  </div>
                </div>
                <div class="user-details">
                  <div class="user-detail-item" *ngIf="user.Email">
                    <ion-icon name="mail-outline"></ion-icon>
                    <a [href]="'mailto:' + user.Email" (click)="$event.stopPropagation()">{{ user.Email }}</a>
                  </div>
                  <div class="user-detail-item" *ngIf="user.Phone">
                    <ion-icon name="call-outline"></ion-icon>
                    <span>{{ user.Phone }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoading && organizationUsers.length === 0" class="empty-state-modern">
            <div class="empty-icon-wrapper">
              <ion-icon name="people"></ion-icon>
            </div>
            <h3>No users found</h3>
            <p>No users found in your organization</p>
          </div>
        </div>
      </div>

      <!-- Delete Account Section -->
      <div class="collapsible-section delete-account-section">
        <div class="collapsible-header" (click)="deleteAccountExpanded = !deleteAccountExpanded">
          <div class="collapsible-title">
            <ion-icon [name]="deleteAccountExpanded ? 'chevron-down' : 'chevron-forward'"></ion-icon>
            <h3>Account</h3>
          </div>
        </div>
        <div class="collapsible-content" [class.expanded]="deleteAccountExpanded">
          <button class="delete-account-btn" (click)="requestAccountDeletion()">
            <ion-icon name="trash-outline"></ion-icon>
            Delete Account
          </button>
        </div>
      </div>
    </div>

    <!-- Payments Tab Content -->
    <div *ngIf="clientTab === 'payments'" class="client-tab-content payments-tab">
      <!-- Outstanding Balance Section -->
      <div class="payments-section">
        <div class="section-header-row" (click)="outstandingBalanceExpanded = !outstandingBalanceExpanded">
          <div class="section-title">
            <ion-icon [name]="outstandingBalanceExpanded ? 'chevron-down' : 'chevron-forward'" class="collapse-chevron"></ion-icon>
            <h3>Outstanding Balance</h3>
          </div>
          <div class="balance-actions">
            <div class="balance-total" [class.has-balance]="getCompanyOutstandingData(currentUserCompanyId || 0).balance > 0" [class.overpaid]="getCompanyOutstandingData(currentUserCompanyId || 0).balance < 0">
              <ion-spinner *ngIf="getCompanyOutstandingData(currentUserCompanyId || 0).loading" name="crescent"></ion-spinner>
              <ng-container *ngIf="!getCompanyOutstandingData(currentUserCompanyId || 0).loading">
                <span *ngIf="getCompanyOutstandingData(currentUserCompanyId || 0).balance > 0">
                  {{ getCompanyOutstandingData(currentUserCompanyId || 0).balance | currency:'USD':'symbol':'1.2-2' }}
                </span>
                <span *ngIf="getCompanyOutstandingData(currentUserCompanyId || 0).balance === 0">$0.00</span>
                <span *ngIf="getCompanyOutstandingData(currentUserCompanyId || 0).balance < 0">
                  +{{ (getCompanyOutstandingData(currentUserCompanyId || 0).balance * -1) | currency:'USD':'symbol':'1.2-2' }}
                </span>
              </ng-container>
            </div>
            <button class="pay-now-btn" (click)="openBalancePaymentModal($event)" *ngIf="getCompanyOutstandingData(currentUserCompanyId || 0).balance > 0 && !getCompanyOutstandingData(currentUserCompanyId || 0).loading">
              <ion-icon name="card-outline"></ion-icon>
            </button>
          </div>
        </div>

        <div *ngIf="outstandingBalanceExpanded">
          <div class="unpaid-invoices-list" *ngIf="getCompanyOutstandingData(currentUserCompanyId || 0).invoices.length > 0">
            <div class="list-table">
              <div class="list-table-header">
                <span class="lt-col lt-col-property">Property</span>
                <span class="lt-col lt-col-service">Service</span>
                <span class="lt-col lt-col-amount">Fee</span>
                <span class="lt-col lt-col-amount">Balance</span>
              </div>
              <div class="list-table-row" *ngFor="let inv of getCompanyOutstandingData(currentUserCompanyId || 0).invoices">
                <span class="lt-col lt-col-property">{{ inv.projectAddress }}</span>
                <span class="lt-col lt-col-service">{{ inv.serviceShortNames }}</span>
                <span class="lt-col lt-col-amount"><span class="currency-sign">$</span><span class="currency-value">{{ inv.fee | number:'1.2-2' }}</span></span>
                <span class="lt-col lt-col-amount balance-due"><span class="currency-sign">$</span><span class="currency-value">{{ inv.balance | number:'1.2-2' }}</span></span>
              </div>
            </div>
          </div>

          <div class="no-balance-message" *ngIf="!getCompanyOutstandingData(currentUserCompanyId || 0).loading && getCompanyOutstandingData(currentUserCompanyId || 0).balance === 0">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <span>No outstanding balance - all invoices paid!</span>
          </div>
        </div>
      </div>

      <!-- Payment History Section -->
      <div class="payments-section">
        <div class="section-header-row" (click)="paymentHistoryExpanded = !paymentHistoryExpanded">
          <div class="section-title">
            <ion-icon [name]="paymentHistoryExpanded ? 'chevron-down' : 'chevron-forward'" class="collapse-chevron"></ion-icon>
            <h3>Payment History</h3>
          </div>
        </div>

        <div *ngIf="paymentHistoryExpanded">
          <div class="payment-history-list" *ngIf="getCompanyOutstandingData(currentUserCompanyId || 0).paidInvoices.length > 0">
            <div class="list-table" [class.has-action-col]="isWeb">
              <div class="list-table-header">
                <span class="lt-col lt-col-date">Date</span>
                <span class="lt-col lt-col-property">Property</span>
                <span class="lt-col lt-col-amount">Paid</span>
                <span class="lt-col lt-col-amount">Balance</span>
                <span class="lt-col lt-col-action" *ngIf="isWeb"></span>
              </div>
              <div class="list-table-row" *ngFor="let payment of getCompanyOutstandingData(currentUserCompanyId || 0).paidInvoices">
                <span class="lt-col lt-col-date">{{ payment.paidDate ? (payment.paidDate | date:'shortDate') : 'N/A' }}</span>
                <span class="lt-col lt-col-property truncate-cell">{{ payment.projectAddress }}</span>
                <span class="lt-col lt-col-amount"><span class="currency-sign">$</span><span class="currency-value">{{ payment.paidAmount | number:'1.2-2' }}</span></span>
                <span class="lt-col lt-col-amount" [class.balance-due]="payment.balance > 0"><span class="currency-sign">$</span><span class="currency-value">{{ payment.balance | number:'1.2-2' }}</span></span>
                <span class="lt-col lt-col-action" *ngIf="isWeb">
                  <button class="download-invoice-btn" (click)="downloadInvoice(payment, clientCompany?.CompanyName || 'Company')" title="Download Receipt">
                    <ion-icon name="download-outline"></ion-icon>
                  </button>
                </span>
              </div>
            </div>
          </div>

          <div class="no-payments-message" *ngIf="!getCompanyOutstandingData(currentUserCompanyId || 0).loading && getCompanyOutstandingData(currentUserCompanyId || 0).paidInvoices.length === 0">
            <ion-icon name="time-outline"></ion-icon>
            <span>No payment history yet</span>
          </div>
        </div>
      </div>

      <!-- Autopay Settings Section -->
      <div class="payments-section autopay-settings">
        <div class="section-header-row" (click)="autopaySettingsExpanded = !autopaySettingsExpanded">
          <div class="section-title">
            <ion-icon [name]="autopaySettingsExpanded ? 'chevron-down' : 'chevron-forward'" class="collapse-chevron"></ion-icon>
            <h3>Autopay Settings</h3>
          </div>
        </div>

        <div class="autopay-settings-content" *ngIf="autopaySettingsExpanded">
          <div class="autopay-fee-note">
            <ion-icon name="information-circle-outline"></ion-icon>
            <span>Autopay via <strong>PayPal</strong> will incur service fees. Autopay via <strong>ACH bank transfer</strong> will not incur service fees.</span>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <span class="setting-label">Enable Autopay</span>
              <span class="setting-description">Automatically pay invoices on a schedule</span>
            </div>
            <ion-toggle
              [ngModel]="clientCompany?.AutopayEnabled"
              (ngModelChange)="toggleAutopay($event)"
              [disabled]="!clientCompany?.PayPalVaultToken && !clientCompany?.StripePaymentMethodID">
            </ion-toggle>
          </div>

          <div class="setting-row">
            <div class="setting-info">
              <span class="setting-label">Payment Method</span>
              <span class="setting-description">Saved payment method for autopay</span>
            </div>
            <div class="payment-method-display">
              <!-- Stripe Bank Account Display -->
              <span *ngIf="clientCompany?.AutopayMethod === 'Stripe' && clientCompany?.StripeBankName" class="saved-method stripe">
                <ion-icon name="business-outline"></ion-icon>
                {{ clientCompany?.StripeBankName }} ****{{ clientCompany?.StripeBankLast4 }}
              </span>
              <!-- PayPal Display -->
              <span *ngIf="clientCompany?.AutopayMethod !== 'Stripe' && clientCompany?.PayPalPayerEmail" class="saved-method paypal">
                <ion-icon name="logo-paypal"></ion-icon>
                {{ clientCompany?.PayPalPayerEmail }}
              </span>
              <!-- Add Payment Button (no payment method saved) -->
              <button *ngIf="!clientCompany?.PayPalVaultToken && !clientCompany?.StripePaymentMethodID" class="add-payment-btn" (click)="openAddPaymentMethodModal()">
                <ion-icon name="add-circle-outline"></ion-icon>
                Add Payment Method
              </button>
              <!-- Remove Button (has payment method) -->
              <button *ngIf="clientCompany?.PayPalVaultToken || clientCompany?.StripePaymentMethodID" class="remove-payment-btn" (click)="removePaymentMethod()">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Metrics Tab Content -->
    <div *ngIf="clientTab === 'metrics'" class="client-tab-content">
      <!-- Stats Cards Row -->
      <div class="client-stats-row">
        <div class="client-stat-card total">
          <div class="stat-content">
            <span class="stat-value">{{ clientMetrics?.totalProjects || 0 }}</span>
            <span class="stat-label">Total Projects</span>
          </div>
        </div>
        <div class="client-stat-card active">
          <div class="stat-content">
            <span class="stat-value">{{ clientMetrics?.activeProjects || 0 }}</span>
            <span class="stat-label">Active</span>
          </div>
        </div>
        <div class="client-stat-card completed">
          <div class="stat-content">
            <span class="stat-value">{{ clientMetrics?.completedProjects || 0 }}</span>
            <span class="stat-label">Completed</span>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="client-charts-row">
        <!-- Projects Over Time Bar Chart -->
        <div class="client-chart-card">
          <div class="chart-header">
            <h4>Projects Over Time</h4>
            <p>Monthly project activity</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="clientProjectsChart"></canvas>
          </div>
        </div>

        <!-- Services Pie Chart -->
        <div class="client-chart-card">
          <div class="chart-header">
            <h4>Services Breakdown</h4>
            <p>Distribution by service type</p>
          </div>
          <div class="chart-wrapper pie-chart-wrapper">
            <canvas id="clientServicesChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="legal-footer">
      <a href="https://www.noble-lps.com/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
    </div>

    <!-- Bottom spacer to ensure full scrolling on mobile -->
    <div class="bottom-spacer"></div>
  </div>
</ion-content>

<ion-modal [isOpen]="isContactModalOpen" (didDismiss)="closeContactModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeContactModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>{{ selectedContact?.Name || 'Contact Details' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="openEditContactModal()" [strong]="true">
            <ion-icon slot="icon-only" name="create-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="contact-modal-content" *ngIf="selectedContact">
      <div class="contact-detail-card">
        <h4>{{ selectedContact.Name }}</h4>
        <p *ngIf="selectedContact.Goal">Goal: {{ selectedContact.Goal }}</p>
        <div class="contact-detail-grid">
          <div>
            <strong>Company</strong>
            <p>{{ getCompanyName(selectedContact.CompanyID) }}</p>
          </div>
          <div>
            <strong>Title</strong>
            <p>{{ selectedContact.Title || '—' }}</p>
          </div>
          <div>
            <strong>Email</strong>
            <p>
              <a *ngIf="selectedContact.Email" [href]="'mailto:' + selectedContact.Email">{{ selectedContact.Email }}</a>
              <span *ngIf="!selectedContact.Email">—</span>
            </p>
          </div>
          <div>
            <strong>Phone</strong>
            <p>
              <a *ngIf="selectedContact.Phone1" [href]="'tel:' + selectedContact.Phone1" class="phone-link">
                {{ formatPhone(selectedContact.Phone1) }}
              </a>
              <span *ngIf="!selectedContact.Phone1">—</span>
            </p>
          </div>
          <div>
            <strong>Secondary Phone</strong>
            <p>
              <a *ngIf="selectedContact.Phone2" [href]="'tel:' + selectedContact.Phone2" class="phone-link">
                {{ formatPhone(selectedContact.Phone2) }}
              </a>
              <span *ngIf="!selectedContact.Phone2">—</span>
            </p>
          </div>
          <div>
            <strong>Role</strong>
            <p>{{ selectedContact.Role || '—' }}</p>
          </div>
          <div>
            <strong>Notes</strong>
            <p>{{ selectedContact.Notes || 'No notes recorded.' }}</p>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Company</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveCompanyChanges()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingCompany">
      <div class="edit-form">
        <!-- Logo + Company Name Header -->
        <div class="form-section edit-logo-section">
          <div class="edit-logo-row">
            <div class="edit-logo-container">
              <img [src]="editingCompanyLogoPreview ? editingCompanyLogoPreview : (editingCompany.Logo && !editLogoFailed ? editingCompany.Logo : 'assets/img/company-logo-placeholder.svg')"
                   alt="Company Logo"
                   class="edit-logo-image"
                   (error)="editLogoFailed = true">
              <label class="edit-logo-overlay" for="logoFileInput">
                <ion-icon name="camera"></ion-icon>
              </label>
              <input type="file" id="logoFileInput" class="hidden-file-input"
                     accept="image/*" (change)="onLogoFileChange($event)">
            </div>
            <div class="edit-logo-name">
              <label>Company Name</label>
              <input type="text" [(ngModel)]="editingCompany.CompanyName" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-row" *ngIf="isCompanyOne">
            <div class="form-field">
              <label>Onboarding Date</label>
              <input type="date" [(ngModel)]="editingCompany.DateOnboarded" class="form-input">
            </div>
            <div class="form-field">
              <label>Onboarding Stage</label>
              <select [(ngModel)]="editingCompany['Onboarding Stage']" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let stage of stages" [value]="stage.name">
                  {{ formatStageName(stage) }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Software</label>
              <select [(ngModel)]="editingCompany.SoftwareID" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let software of softwareOptions" [value]="software">
                  {{ software }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row" *ngIf="!isCompanyOne">
            <div class="form-field">
              <label>Software</label>
              <select [(ngModel)]="editingCompany.SoftwareID" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let software of softwareOptions" [value]="software">
                  {{ software }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Size</label>
              <select [(ngModel)]="editingCompany.Size" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let size of uniqueCompanySizes" [value]="size">
                  {{ size }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Franchise</label>
              <ion-toggle [(ngModel)]="editingCompany.Franchise"></ion-toggle>
            </div>
          </div>
          <div class="form-row" *ngIf="isCompanyOne">
            <div class="form-field">
              <label>Size</label>
              <select [(ngModel)]="editingCompany.Size" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let size of uniqueCompanySizes" [value]="size">
                  {{ size }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Franchise</label>
              <ion-toggle [(ngModel)]="editingCompany.Franchise"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Lead Source</label>
              <input type="text" [(ngModel)]="editingCompany.LeadSource" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Contact Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company Phone</label>
              <input type="tel" [(ngModel)]="editingCompany.Phone" class="form-input">
            </div>
            <div class="form-field">
              <label>Company Email</label>
              <input type="email" [(ngModel)]="editingCompany.Email" class="form-input">
            </div>
            <div class="form-field">
              <label>CC Email</label>
              <input type="email" [(ngModel)]="editingCompany.CC_Email" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Website</label>
              <input type="text" [(ngModel)]="editingCompany.Website" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Address</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Address</label>
              <input type="text" [(ngModel)]="editingCompany.Address" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>City</label>
              <input type="text" [(ngModel)]="editingCompany.City" class="form-input">
            </div>
            <div class="form-field">
              <label>State</label>
              <input type="text" [(ngModel)]="editingCompany.State" class="form-input">
            </div>
            <div class="form-field">
              <label>Zip</label>
              <input type="text" [(ngModel)]="editingCompany.Zip" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Additional Details</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Service Area(s)</label>
              <textarea [(ngModel)]="editingCompany.ServiceArea" class="form-textarea" rows="3"></textarea>
            </div>
          </div>
          <div class="form-row" *ngIf="isCompanyOne">
            <div class="form-field full-width">
              <label>Contract Document</label>
              <div *ngIf="editingCompany.Contract && !editingCompanyContractFile" class="existing-contract">
                <button class="contract-view-btn" (click)="openContract(editingCompany.PK_ID, editingCompany.Contract)">
                  <ion-icon name="document-text-outline"></ion-icon> View Current Contract
                </button>
              </div>
              <div *ngIf="editingCompanyContractFile" class="existing-contract">
                <span class="contract-pending-name"><ion-icon name="document-attach-outline"></ion-icon> {{ editingCompanyContractFile.name }}</span>
              </div>
              <input type="file" (change)="onEditCompanyContractChange($event)" class="form-input" accept=".pdf,.doc,.docx">
            </div>
          </div>
          <div class="form-row" *ngIf="isCompanyOne">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingCompany.Notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>
        </div>

        <div class="form-section" *ngIf="isCompanyOne">
          <h4>Services Offered</h4>
          <div class="offers-edit-list">
            <div class="offers-edit-header">
              <span class="offer-col-name">Service</span>
              <span class="offer-col-fee">Fee</span>
              <span class="offer-col-fee">Partner</span>
              <span class="offer-col-action"></span>
            </div>
            <div class="offers-edit-row" *ngFor="let offer of getCompanyOffers(editingCompany.CompanyID)">
              <span class="offer-col-name">{{ offer.typeName }}</span>
              <span class="offer-col-fee">
                <div class="fee-field"><span class="fee-dollar">$</span><input type="text" inputmode="decimal" [value]="formatFee(offer.ClientFee)" (blur)="offer.ClientFee = parseFee($event)" class="form-input fee-input" placeholder="0.00"></div>
              </span>
              <span class="offer-col-fee">
                <div class="fee-field"><span class="fee-dollar">$</span><input type="text" inputmode="decimal" [value]="formatFee(offer.ServiceFee)" (blur)="offer.ServiceFee = parseFee($event)" class="form-input fee-input" placeholder="0.00"></div>
              </span>
              <span class="offer-col-action">
                <button class="offer-delete-btn" (click)="removeOfferFromCompany(offer, editingCompany.CompanyID)" title="Remove service">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </span>
            </div>
            <p *ngIf="getCompanyOffers(editingCompany.CompanyID).length === 0" class="no-data-text">No services configured</p>
          </div>
          <div class="offers-add-row">
            <select [(ngModel)]="editOfferTypeId" class="form-select-styled">
              <option [ngValue]="null">-- Select --</option>
              <option *ngFor="let t of getAvailableTypesForCompany(editingCompany.CompanyID)" [ngValue]="t.typeId">{{ t.typeName }}</option>
            </select>
            <button class="offer-add-btn" (click)="addOfferToCompany(editingCompany.CompanyID)" [disabled]="!editOfferTypeId">
              <ion-icon name="add-circle-outline"></ion-icon>
            </button>
          </div>
        </div>

        <div class="form-section" *ngIf="isCompanyOne">
          <div class="section-header-with-action">
            <h4>Users</h4>
            <button class="section-add-btn" (click)="openAddUserModal(editingCompany.CompanyID)">
              <ion-icon name="add"></ion-icon> Add
            </button>
          </div>
          <div *ngIf="getCompanyUsers(editingCompany.CompanyID).length > 0" class="company-users-list">
            <div class="company-user-row" *ngFor="let user of getCompanyUsers(editingCompany.CompanyID)">
              <div class="user-info">
                <span class="user-col-name">{{ user.Name || 'Unnamed' }}</span>
                <span class="user-col-meta">{{ user.Title || '' }}{{ user.Title && user.Email ? ' · ' : '' }}{{ user.Email || '' }}</span>
                <span class="user-col-phone" *ngIf="user.Phone">{{ formatPhone(user.Phone) }}</span>
              </div>
              <span class="user-col-actions">
                <button class="user-action-btn" (click)="openEditUserModal(user)" title="Edit user">
                  <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="user-action-btn delete" (click)="deleteUser(user, $event)" title="Delete user">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </span>
            </div>
          </div>
          <p *ngIf="getCompanyUsers(editingCompany.CompanyID).length === 0" class="no-data-text">No users</p>
        </div>


        <div class="form-section" *ngIf="isCompanyOne">
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteCompany(editingCompany, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Company
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddTaskModalOpen" (didDismiss)="closeAddTaskModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddTaskModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Task</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewTask()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newTask.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Due Date</label>
              <input type="date" [(ngModel)]="newTask.Due" class="form-input">
            </div>
            <div class="form-field">
              <label>Assign To</label>
              <select [(ngModel)]="newTask.AssignTo" class="form-input">
                <option [ngValue]="''">-- Select --</option>
                <option *ngFor="let user of taskUsers" [ngValue]="user.name">
                  {{ user.name }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Task Type</label>
              <select [(ngModel)]="newTask.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Assignment Details</label>
              <textarea [(ngModel)]="newTask.Assignment" class="form-textarea" rows="4" placeholder="Describe the task..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditTaskModalOpen" (didDismiss)="closeEditTaskModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditTaskModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Task</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedTask()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingTask.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Due Date</label>
              <input type="date" [(ngModel)]="editingTask.Due" class="form-input">
            </div>
            <div class="form-field">
              <label>Assign To</label>
              <select [(ngModel)]="editingTask.AssignTo" class="form-input">
                <option [ngValue]="''">-- Select --</option>
                <option *ngFor="let user of taskUsers" [ngValue]="user.name">
                  {{ user.name }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Task Type</label>
              <select [(ngModel)]="editingTask.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Assignment Details</label>
              <textarea [(ngModel)]="editingTask.Assignment" class="form-textarea" rows="4" placeholder="Describe the task..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="editingTaskOriginal && deleteTask(editingTaskOriginal, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Task
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddContactModalOpen" (didDismiss)="closeAddContactModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddContactModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Contact</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewContact()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newContact.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Name</label>
              <input type="text" [(ngModel)]="newContact.Name" class="form-input" placeholder="Contact name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Title</label>
              <input type="text" [(ngModel)]="newContact.Title" class="form-input" placeholder="Job title">
            </div>
            <div class="form-field">
              <label>Role</label>
              <input type="text" [(ngModel)]="newContact.Role" class="form-input" placeholder="Role">
            </div>
            <div class="form-field">
              <label>Primary Contact</label>
              <ion-toggle [(ngModel)]="newContact.PrimaryContact"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" [(ngModel)]="newContact.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="tel" [(ngModel)]="newContact.Phone1" class="form-input" placeholder="(555) 555-5555">
            </div>
            <div class="form-field">
              <label>Secondary Phone</label>
              <input type="tel" [(ngModel)]="newContact.Phone2" class="form-input" placeholder="(555) 555-5555">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="newContact.Notes" class="form-textarea" rows="4" placeholder="Additional notes about this contact..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditContactModalOpen" (didDismiss)="closeEditContactModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditContactModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Contact</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedContact()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingContact">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingContact.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Name</label>
              <input type="text" [(ngModel)]="editingContact.Name" class="form-input" placeholder="Contact name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Title</label>
              <input type="text" [(ngModel)]="editingContact.Title" class="form-input" placeholder="Job title">
            </div>
            <div class="form-field">
              <label>Role</label>
              <input type="text" [(ngModel)]="editingContact.Role" class="form-input" placeholder="Role">
            </div>
            <div class="form-field">
              <label>Primary Contact</label>
              <ion-toggle [(ngModel)]="editingContact.PrimaryContact"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" [(ngModel)]="editingContact.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="tel" [(ngModel)]="editingContact.Phone1" class="form-input" placeholder="(555) 555-5555">
            </div>
            <div class="form-field">
              <label>Secondary Phone</label>
              <input type="tel" [(ngModel)]="editingContact.Phone2" class="form-input" placeholder="(555) 555-5555">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingContact.Notes" class="form-textarea" rows="4" placeholder="Additional notes about this contact..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteContact(editingContact, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Contact
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddCompanyModalOpen" (didDismiss)="closeAddCompanyModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddCompanyModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Company</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewCompany()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <!-- Logo + Company Name Header -->
        <div class="form-section edit-logo-section">
          <div class="edit-logo-row">
            <div class="edit-logo-container">
              <img [src]="newCompanyLogoPreview || 'assets/img/company-logo-placeholder.svg'"
                   alt="Company Logo"
                   class="edit-logo-image">
              <label class="edit-logo-overlay" for="newCompanyLogoFileInput">
                <ion-icon name="camera"></ion-icon>
              </label>
              <input type="file" id="newCompanyLogoFileInput" class="hidden-file-input"
                     accept="image/*" (change)="onNewCompanyLogoChange($event)">
            </div>
            <div class="edit-logo-name">
              <label>Company Name</label>
              <input type="text" [(ngModel)]="newCompany.CompanyName" class="form-input" placeholder="Company name">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Onboarding Date</label>
              <input type="date" [(ngModel)]="newCompany.DateOnboarded" class="form-input">
            </div>
            <div class="form-field">
              <label>Onboarding Stage</label>
              <select [(ngModel)]="newCompany['Onboarding Stage']" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let stage of stages" [value]="stage.name">
                  {{ formatStageName(stage) }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Software</label>
              <select [(ngModel)]="newCompany.SoftwareID" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let software of softwareOptions" [value]="software">
                  {{ software }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Size</label>
              <select [(ngModel)]="newCompany.Size" class="form-input">
                <option value="">-- Select --</option>
                <option *ngFor="let size of uniqueCompanySizes" [value]="size">
                  {{ size }}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Franchise</label>
              <ion-toggle [(ngModel)]="newCompany.Franchise"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Lead Source</label>
              <input type="text" [(ngModel)]="newCompany.LeadSource" class="form-input" placeholder="Source">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Contact Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company Phone</label>
              <input type="tel" [(ngModel)]="newCompany.Phone" class="form-input" placeholder="(555) 555-5555">
            </div>
            <div class="form-field">
              <label>Company Email</label>
              <input type="email" [(ngModel)]="newCompany.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>CC Email</label>
              <input type="email" [(ngModel)]="newCompany.CC_Email" class="form-input" placeholder="cc@example.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Website</label>
              <input type="text" [(ngModel)]="newCompany.Website" class="form-input" placeholder="https://example.com">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Address</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Address</label>
              <input type="text" [(ngModel)]="newCompany.Address" class="form-input" placeholder="Street address">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>City</label>
              <input type="text" [(ngModel)]="newCompany.City" class="form-input" placeholder="City">
            </div>
            <div class="form-field">
              <label>State</label>
              <input type="text" [(ngModel)]="newCompany.State" class="form-input" placeholder="State">
            </div>
            <div class="form-field">
              <label>Zip</label>
              <input type="text" [(ngModel)]="newCompany.Zip" class="form-input" placeholder="Zip code">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Additional Details</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Service Area(s)</label>
              <textarea [(ngModel)]="newCompany.ServiceArea" class="form-textarea" rows="3" placeholder="Service areas..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Contract Document</label>
              <input type="file" (change)="onNewCompanyContractChange($event)" class="form-input" accept=".pdf,.doc,.docx">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="newCompany.Notes" class="form-textarea" rows="4" placeholder="Additional notes about this company..."></textarea>
            </div>
          </div>
        </div>
        <div class="form-section" *ngIf="isCompanyOne">
          <h4>Services Offered</h4>
          <div class="offers-edit-list">
            <div class="offers-edit-header">
              <span class="offer-col-name">Service</span>
              <span class="offer-col-fee">Fee</span>
              <span class="offer-col-fee">Partner</span>
              <span class="offer-col-action"></span>
            </div>
            <div class="offers-edit-row" *ngFor="let offer of newCompanyOffers; let i = index">
              <span class="offer-col-name">{{ offer.typeName }}</span>
              <span class="offer-col-fee">
                <div class="fee-field"><span class="fee-dollar">$</span><input type="text" inputmode="decimal" [value]="formatFee(offer.ClientFee)" (blur)="offer.ClientFee = parseFee($event)" class="form-input fee-input" placeholder="0.00"></div>
              </span>
              <span class="offer-col-fee">
                <div class="fee-field"><span class="fee-dollar">$</span><input type="text" inputmode="decimal" [value]="formatFee(offer.ServiceFee)" (blur)="offer.ServiceFee = parseFee($event)" class="form-input fee-input" placeholder="0.00"></div>
              </span>
              <span class="offer-col-action">
                <button class="offer-delete-btn" (click)="removeOfferFromNewCompany(i)" title="Remove service">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </span>
            </div>
            <p *ngIf="newCompanyOffers.length === 0" class="no-data-text">No services configured</p>
          </div>
          <div class="offers-add-row">
            <select [(ngModel)]="newCompanyOfferTypeId" class="form-select-styled">
              <option [ngValue]="null">-- Select --</option>
              <option *ngFor="let t of getAvailableTypesForNewCompany()" [ngValue]="t.typeId">{{ t.typeName }}</option>
            </select>
            <button class="offer-add-btn" (click)="addOfferToNewCompany()" [disabled]="!newCompanyOfferTypeId">
              <ion-icon name="add-circle-outline"></ion-icon>
            </button>
          </div>
        </div>
        <div class="form-section" *ngIf="isCompanyOne">
          <h4>Users</h4>
          <p class="no-data-text">Save the company first, then edit it to add users.</p>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddMeetingModalOpen" (didDismiss)="closeAddMeetingModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddMeetingModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Meeting</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewMeeting()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newMeeting.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Subject</label>
              <input type="text" [(ngModel)]="newMeeting.Subject" class="form-input" placeholder="Meeting subject">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Start Date</label>
              <input type="datetime-local" [(ngModel)]="newMeeting.StartDate" class="form-input">
            </div>
            <div class="form-field">
              <label>End Date</label>
              <input type="datetime-local" [(ngModel)]="newMeeting.EndDate" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Description</label>
              <textarea [(ngModel)]="newMeeting.Description" class="form-textarea" rows="4" placeholder="Meeting description..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 1</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee1" class="form-input" placeholder="First attendee">
            </div>
            <div class="form-field">
              <label>Attendee 2</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee2" class="form-input" placeholder="Second attendee">
            </div>
            <div class="form-field">
              <label>Attendee 3</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee3" class="form-input" placeholder="Third attendee">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 4</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee4" class="form-input" placeholder="Fourth attendee">
            </div>
            <div class="form-field">
              <label>Attendee 5</label>
              <input type="text" [(ngModel)]="newMeeting.Attendee5" class="form-input" placeholder="Fifth attendee">
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddCommunicationModalOpen" (didDismiss)="closeAddCommunicationModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddCommunicationModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New Communication</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewCommunication()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="newCommunication.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Date</label>
              <input type="datetime-local" [(ngModel)]="newCommunication.Date" class="form-input">
            </div>
            <div class="form-field">
              <label style="white-space: nowrap">Communication Type</label>
              <select [(ngModel)]="newCommunication.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="newCommunication.Notes" class="form-textarea" rows="4" placeholder="Communication notes..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Connected (Call)</label>
              <ion-toggle [(ngModel)]="newCommunication.Conversed"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Left Voicemail</label>
              <ion-toggle [(ngModel)]="newCommunication.LeftVM"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Also Texted</label>
              <ion-toggle [(ngModel)]="newCommunication.AlsoTexted"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Also Emailed</label>
              <ion-toggle [(ngModel)]="newCommunication.AlsoEmailed"></ion-toggle>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditCommunicationModalOpen" (didDismiss)="closeEditCommunicationModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditCommunicationModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Communication</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedCommunication()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingCommunication">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingCommunication.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Date</label>
              <input type="datetime-local" [(ngModel)]="editingCommunication.Date" class="form-input">
            </div>
            <div class="form-field">
              <label style="white-space: nowrap">Communication Type</label>
              <select [(ngModel)]="editingCommunication.CommunicationID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let type of communicationTypes" [ngValue]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingCommunication.Notes" class="form-textarea" rows="4" placeholder="Communication notes..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Connected (Call)</label>
              <ion-toggle [(ngModel)]="editingCommunication.Conversed"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Left Voicemail</label>
              <ion-toggle [(ngModel)]="editingCommunication.LeftVM"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Also Texted</label>
              <ion-toggle [(ngModel)]="editingCommunication.AlsoTexted"></ion-toggle>
            </div>
            <div class="form-field">
              <label>Also Emailed</label>
              <ion-toggle [(ngModel)]="editingCommunication.AlsoEmailed"></ion-toggle>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteCommunication(editingCommunication, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Communication
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditMeetingModalOpen" (didDismiss)="closeEditMeetingModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditMeetingModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Meeting</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedMeeting()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingMeeting">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <select [(ngModel)]="editingMeeting.CompanyID" class="form-input">
                <option [ngValue]="null">-- Select --</option>
                <option *ngFor="let company of companies" [ngValue]="company.CompanyID">
                  {{ company.CompanyName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Subject</label>
              <input type="text" [(ngModel)]="editingMeeting.Subject" class="form-input" placeholder="Meeting subject">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Start Date</label>
              <input type="datetime-local" [(ngModel)]="editingMeeting.StartDate" class="form-input">
            </div>
            <div class="form-field">
              <label>End Date</label>
              <input type="datetime-local" [(ngModel)]="editingMeeting.EndDate" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Description</label>
              <textarea [(ngModel)]="editingMeeting.Description" class="form-textarea" rows="4" placeholder="Meeting description..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 1</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee1" class="form-input" placeholder="First attendee">
            </div>
            <div class="form-field">
              <label>Attendee 2</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee2" class="form-input" placeholder="Second attendee">
            </div>
            <div class="form-field">
              <label>Attendee 3</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee3" class="form-input" placeholder="Third attendee">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Attendee 4</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee4" class="form-input" placeholder="Fourth attendee">
            </div>
            <div class="form-field">
              <label>Attendee 5</label>
              <input type="text" [(ngModel)]="editingMeeting.Attendee5" class="form-input" placeholder="Fifth attendee">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteMeeting(editingMeeting, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Meeting
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditInvoiceModalOpen" (didDismiss)="closeEditInvoiceModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditInvoiceModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Invoice Detail</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedInvoice()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingInvoice">
      <div class="edit-form">
        <div class="form-section">
          <h4>Fee Breakdown</h4>
          <div class="fee-breakdown-list">
            <div class="fee-breakdown-item" *ngFor="let record of editingInvoice.allPositives">
              <span class="fee-label">{{ getInvoiceLineLabel(record) }}</span>
              <div class="fee-actions">
                <span class="fee-amount">{{ formatCurrency(record.Fee) }}</span>
                <button class="fee-delete-btn" (click)="deleteInvoiceLine(record, $event)" title="Delete this line item">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </div>
            </div>
            <div class="fee-breakdown-item payment-item" *ngFor="let record of editingInvoice.allNegatives">
              <span class="fee-label">Payment</span>
              <div class="fee-actions">
                <span class="fee-amount payment-amount">{{ formatCurrency(record.Fee) }}</span>
                <button class="fee-delete-btn" (click)="deleteInvoiceLine(record, $event)" title="Delete this line item">
                  <ion-icon name="trash-outline"></ion-icon>
                </button>
              </div>
            </div>
            <div class="fee-breakdown-total">
              <span class="fee-label">Total Due</span>
              <span class="fee-amount">{{ formatCurrency(editingInvoice.netAmount) }}</span>
            </div>
          </div>
        </div>
        <div class="form-section">
          <h4>Invoice Information</h4>
          <div class="form-row">
            <div class="form-field">
              <label>Company</label>
              <p class="read-only-field">{{ getCompanyName(editingInvoice.positive.CompanyID) }}</p>
            </div>
            <div class="form-field">
              <label>Invoice ID</label>
              <p class="read-only-field">{{ editingInvoice.positive.InvoiceID }}</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Address</label>
              <input type="text" [(ngModel)]="editingInvoice.positive.Address" class="form-input" placeholder="Address">
            </div>
            <div class="form-field">
              <label>City</label>
              <input type="text" [(ngModel)]="editingInvoice.positive.City" class="form-input" placeholder="City">
            </div>
            <div class="form-field">
              <label>Zip</label>
              <input type="text" [(ngModel)]="editingInvoice.positive.Zip" class="form-input" placeholder="Zip">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Date</label>
              <input type="date" [(ngModel)]="editingInvoice.positive.Date" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="editingInvoice.positive.InvoiceNotes" class="form-textarea" rows="3" placeholder="Invoice notes..."></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="deleteInvoice(editingInvoice, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete Invoice
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddInvoiceModalOpen" (didDismiss)="closeAddInvoiceModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddInvoiceModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Added Service</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewInvoice()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <h4>Added Service</h4>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Project / Invoice Context</label>
              <p class="read-only-field">{{ newInvoiceContext }}</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Service Type</label>
              <select [(ngModel)]="addedServiceType" class="form-input">
                <option value="">-- Select --</option>
                <option value="Rush Fee">Rush Fee</option>
                <option value="Added Scope">Added Scope</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row" *ngIf="addedServiceType === 'Other'">
            <div class="form-field full-width">
              <label>Description</label>
              <input type="text" [(ngModel)]="addedServiceCustomLabel" class="form-input" placeholder="Enter description...">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Amount</label>
              <input type="number" [(ngModel)]="newInvoice.Fee" class="form-input" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-field">
              <label>Date</label>
              <input type="date" [(ngModel)]="newInvoice.Date" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea [(ngModel)]="newInvoice.InvoiceNotes" class="form-textarea" rows="3" placeholder="Invoice notes..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isAddUserModalOpen" (didDismiss)="closeAddUserModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeAddUserModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add New User</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveNewUser()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Headshot</label>
              <div class="headshot-upload-container">
                <div class="headshot-preview-wrapper">
                  <div class="headshot-preview" (click)="userHeadshotInput.click()">
                    <img *ngIf="newUserHeadshotPreview" [src]="newUserHeadshotPreview" alt="Headshot preview" class="headshot-preview-image">
                    <div *ngIf="!newUserHeadshotPreview" class="headshot-preview-placeholder">
                      <ion-icon name="person"></ion-icon>
                    </div>
                  </div>
                  <button type="button" class="headshot-add-btn" (click)="userHeadshotInput.click()">
                    <ion-icon name="add"></ion-icon>
                  </button>
                </div>
                <input type="file" #userHeadshotInput accept="image/*" (change)="onNewUserHeadshotChange($event)" style="display: none;">
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <input type="text" class="form-input" [value]="getCompanyName(newUser.CompanyID) || currentUserCompanyName || getCompanyName(currentUserCompanyId)" disabled readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Name</label>
              <input type="text" [(ngModel)]="newUser.Name" class="form-input" placeholder="User name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" [(ngModel)]="newUser.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="tel" [(ngModel)]="newUser.Phone" class="form-input" placeholder="(555) 555-5555">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Password</label>
              <input type="text" [(ngModel)]="newUser.Password" class="form-input" placeholder="Enter password">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Title</label>
              <select [(ngModel)]="newUser.Title" class="form-input">
                <option value="" disabled selected>Select Title</option>
                <option value="Owner">Owner</option>
                <option value="Manager">Manager</option>
                <option value="Admin">Admin</option>
                <option value="Inspector">Inspector</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditUserHeadshotModalOpen" (didDismiss)="closeEditUserHeadshotModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditUserHeadshotModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Update Headshot</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveUserHeadshot()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingUserHeadshot">
      <div class="edit-form">
        <div class="form-section">
          <div class="headshot-edit-info">
            <h4>{{ editingUserHeadshot.Name }}</h4>
            <p>{{ editingUserHeadshot.Title || 'No title' }}</p>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Photo</label>
              <div class="headshot-upload-container">
                <div class="headshot-preview-wrapper">
                  <div class="headshot-preview" (click)="editUserHeadshotInput.click()">
                    <img *ngIf="editUserHeadshotPreview" [src]="editUserHeadshotPreview" alt="Headshot preview" class="headshot-preview-image">
                    <div *ngIf="!editUserHeadshotPreview" class="headshot-preview-placeholder">
                      <ion-icon name="person"></ion-icon>
                    </div>
                  </div>
                  <button type="button" class="headshot-add-btn" (click)="editUserHeadshotInput.click()">
                    <ion-icon name="add"></ion-icon>
                  </button>
                </div>
                <input type="file" #editUserHeadshotInput accept="image/*" (change)="onEditUserHeadshotChange($event)" style="display: none;">
              </div>
              <p class="form-hint">Click the photo or plus button to select a new image</p>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isEditUserModalOpen" (didDismiss)="closeEditUserModal()" cssClass="fullscreen-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditUserModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit User</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="saveEditedUser()" [strong]="true">
            <ion-icon slot="icon-only" name="checkmark"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="edit-modal-content" *ngIf="editingUser">
      <div class="edit-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-field full-width">
              <label>Headshot</label>
              <div class="headshot-upload-container">
                <div class="headshot-preview-wrapper">
                  <div class="headshot-preview" (click)="editUserModalHeadshotInput.click()">
                    <img *ngIf="editUserModalHeadshotPreview || getUserHeadshot(editingUser)" [src]="editUserModalHeadshotPreview || getUserHeadshot(editingUser)" alt="Headshot preview" class="headshot-preview-image">
                    <div *ngIf="!editUserModalHeadshotPreview && !getUserHeadshot(editingUser)" class="headshot-preview-placeholder">
                      <ion-icon name="person"></ion-icon>
                    </div>
                  </div>
                  <button type="button" class="headshot-add-btn" (click)="editUserModalHeadshotInput.click()">
                    <ion-icon name="add"></ion-icon>
                  </button>
                </div>
                <input type="file" #editUserModalHeadshotInput accept="image/*" (change)="onEditUserModalHeadshotChange($event)" style="display: none;">
              </div>
              <p class="form-hint">Click the photo or plus button to update headshot</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Name</label>
              <input type="text" [(ngModel)]="editingUser.Name" class="form-input" placeholder="User name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" [(ngModel)]="editingUser.Email" class="form-input" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="tel" [(ngModel)]="editingUser.Phone" class="form-input" placeholder="(555) 555-5555">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Password</label>
              <input type="text" [(ngModel)]="editingUser.Password" class="form-input" placeholder="Enter new password">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Title</label>
              <select [(ngModel)]="editingUser.Title" class="form-input">
                <option value="" disabled>Select Title</option>
                <option value="Owner">Owner</option>
                <option value="Manager">Manager</option>
                <option value="Admin">Admin</option>
                <option value="Inspector">Inspector</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Company</label>
              <p class="read-only-field">{{ getCompanyName(editingUser.CompanyID) }}</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <button class="delete-task-btn" (click)="editingUserOriginal && deleteUser(editingUserOriginal, $event)">
                <ion-icon name="trash-outline"></ion-icon>
                Delete User
              </button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
