<div class="page-container">
  <!-- Hidden file input for camera/gallery -->
  <input #fileInput type="file" style="display: none;" accept="image/*">

  <div class="content-section">
    <!-- Loading State - Mobile only (spinner) -->
    <div *ngIf="loading && !isWeb" class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading items...</p>
    </div>

    <!-- WEBAPP: Skeleton loaders -->
    <div *ngIf="loading && isWeb" class="skeleton-category-container">
      <!-- Search bar skeleton -->
      <div class="skeleton-search-bar"></div>
      <!-- Accordion section skeletons -->
      <div class="skeleton-accordion-section" *ngFor="let section of [1,2,3]">
        <div class="skeleton-accordion-header">
          <div class="skeleton-badge"></div>
          <div class="skeleton-section-title"></div>
        </div>
        <div class="skeleton-accordion-content">
          <div class="skeleton-visual-item" *ngFor="let item of [1,2,3,4]">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-item-content">
              <div class="skeleton-item-title"></div>
              <div class="skeleton-item-text"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Content -->
    <div *ngIf="!loading" class="category-content">

      <!-- Search Bar -->
      <div class="search-container">
        <div class="search-input-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input
            type="text"
            class="search-input"
            placeholder="Search by title or description..."
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()">
          <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()" title="Clear search">
            <ion-icon name="close-circle"></ion-icon>
          </button>
        </div>
      </div>

      <!-- White container wrapper matching other pages -->
      <div class="white-container">
        <!-- Simple accordion fallback for offline reliability -->

        <!-- Information Section -->
        <div class="simple-accordion" *ngIf="organizedData.comments">
          <div class="simple-accordion-header" (click)="toggleSection('information')">
            <div class="accordion-header-content">
              <div class="icon-container">
                <span class="count-badge info">{{ organizedData.comments.length }}</span>
              </div>
              <span class="type-header">Information</span>
            </div>
            <div class="accordion-header-actions">
              <button class="add-visual-btn" (click)="addCustomVisual(categoryName, 'Comment'); $event.stopPropagation()" title="Add custom information">
                <ion-icon name="add-circle-outline"></ion-icon>
              </button>
              <ion-icon [name]="isSectionExpanded('information') ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
            </div>
          </div>
          <div class="simple-accordion-content" *ngIf="isSectionExpanded('information')">
            <div class="type-section">
              <div *ngIf="filterItems(organizedData.comments).length === 0 && !searchTerm" class="no-items-message">
                No information yet.<br>Click + to add one.
              </div>
              <div *ngIf="filterItems(organizedData.comments).length === 0 && searchTerm" class="no-items-message">
                No results found for "{{ searchTerm }}"
              </div>
              <div class="template-item" *ngFor="let item of filterItems(organizedData.comments); trackBy: trackByItemId">
          <div class="visual-item-container" [class.selected]="isItemSelected(categoryName, item.id)">

            <!-- Yes/No questions - vertical layout with dropdown below -->
            <div class="answer-type-1-container" *ngIf="item.answerType === 1">
              <div class="item-header" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
                <h3 class="item-name">
                  <span [innerHTML]="highlightText(item.name)"></span>
                  <span class="required-indicator" *ngIf="item.required">*</span>
                </h3>
              </div>
              <div class="item-text-wrapper" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
                <p class="item-text" [innerHTML]="highlightText(item.originalText)"></p>
              </div>
              <div class="dropdown-container" (click)="$event.stopPropagation()">
                <select
                  [(ngModel)]="item.answer"
                  (ngModelChange)="onAnswerChange(categoryName, item); $event?.stopPropagation()"
                  (change)="$event.stopPropagation()"
                  [disabled]="isItemSaving(categoryName, item.id)"
                  class="styled-input">
                  <option value="">-- Select --</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
              </div>
            </div>

            <!-- Multi-select questions - show checkboxes for each option -->
            <div class="multi-select-container" *ngIf="item.answerType === 2">
              <div class="multi-select-header" [class.has-photos]="getPhotosForVisual(categoryName, item.id).length > 0">
                <div class="multi-select-title">
                  <h3>
                    <span [innerHTML]="highlightText(item.name)"></span>
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <div class="item-text-wrapper">
                    <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
                  </div>
                </div>
                <div class="multi-select-indicators">
                  <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.id) > 0">
                    <span class="photo-count">
                      <ion-icon name="images"></ion-icon>
                      {{ getTotalPhotoCount(categoryName, item.id) }}
                    </span>
                  </div>
                  <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent"></ion-spinner>
                </div>
              </div>
              <div class="multi-select-options" *ngIf="getDropdownOptions(item.templateId).length > 0">
                <ion-item lines="none" *ngFor="let option of getDropdownOptions(item.templateId); trackBy: trackByOption" class="option-item">
                  <ion-checkbox
                    slot="start"
                    [checked]="isOptionSelectedV1(item, option)"
                    (ionChange)="onOptionToggle(categoryName, item, option, $event); $event.stopPropagation()"
                    [disabled]="isItemSaving(categoryName, item.id)">
                  </ion-checkbox>
                  <ion-label>{{ option }}</ion-label>
                </ion-item>
              </div>
              <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                <input type="text"
                       [(ngModel)]="item.otherValue"
                       (blur)="onMultiSelectOtherChange(categoryName, item)"
                       (click)="$event.stopPropagation()"
                       placeholder="Please specify..."
                       class="styled-input other-input">
              </div>

              <!-- Action button grid for multi-select -->
              <div class="action-button-grid" *ngIf="isItemSelected(categoryName, item.id)">
                <button class="action-btn" (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon name="camera"></ion-icon>
                  <span>Camera</span>
                </button>
                <button class="action-btn" (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon name="images"></ion-icon>
                  <span>Gallery</span>
                </button>
                <button class="action-btn secondary"
                        (click)="togglePhotoExpansion(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon [name]="isPhotosExpanded(categoryName, item.id) ? 'chevron-up' : 'eye'"></ion-icon>
                  <span>View ({{ getTotalPhotoCount(categoryName, item.id) }})</span>
                </button>
                <button class="action-btn" (click)="openVisualDetail(categoryName, item); $event.stopPropagation()">
                  <ion-icon name="arrow-forward"></ion-icon>
                  <span>Details</span>
                </button>
              </div>

              <!-- Image preview section for multi-select -->
              <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && isPhotosExpanded(categoryName, item.id)" style="position: relative;">
                <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                  <ion-spinner name="dots" color="primary"></ion-spinner>
                  <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
                </div>
                <div class="image-preview-container">
                  <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                    <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-caption"></div>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                    <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                         [class.uploading]="photo.uploading"
                         [class.annotated]="photo.hasAnnotations"
                         [class.skeleton-loader]="photo.isSkeleton">
                      <ng-container *ngIf="photo.isSkeleton">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-caption"></div>
                      </ng-container>
                      <ng-container *ngIf="!photo.isSkeleton">
                        <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.svg'"
                             width="90" height="90"
                             [alt]="photo.name"
                             (mousedown)="saveScrollBeforePhotoClick($event)"
                             (click)="viewPhoto(photo, categoryName, item.id, $event)"
                             (error)="handleImageError($event, photo)"
                             [class.has-annotations]="photo.hasAnnotations"
                             [class.loading]="photo.displayState === 'remote_loading' || photo.loading">
                        <div class="upload-indicator" *ngIf="photo.uploading || photo.displayState === 'remote_loading'">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <button
                          class="room-photo-caption"
                          (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                          {{ photo.caption || 'Caption' }}
                        </button>
                      </ng-container>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>

            <!-- Text questions - checkbox behavior with large action buttons -->
            <ion-item lines="none"
                      class="checkbox-item with-camera"
                      [class.has-photos]="getPhotosForVisual(categoryName, item.id).length > 0"
                      *ngIf="!item.answerType || item.answerType === 0">
              <ion-checkbox
                slot="start"
                [checked]="isItemSelected(categoryName, item.id)"
                [disabled]="isItemSaving(categoryName, item.id)"
                (ionChange)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
              </ion-checkbox>
              <div style="flex: 1; display: flex; align-items: center;">
                <ion-label class="item-label" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()" style="flex: 1;">
                  <h3>
                    <span [innerHTML]="highlightText(item.name)"></span>
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
                </ion-label>
                <!-- Right-aligned photo count indicator -->
                <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.id) > 0">
                  <span class="photo-count">
                    <ion-icon name="images"></ion-icon>
                    {{ getTotalPhotoCount(categoryName, item.id) }}
                  </span>
                </div>
              </div>
              <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end"></ion-spinner>
            </ion-item>

            <!-- Large action button grid - shows when item is selected -->
            <div class="action-button-grid" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0)">
              <button class="action-btn" (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()">
                <ion-icon name="camera"></ion-icon>
                <span>Camera</span>
              </button>
              <button class="action-btn" (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()">
                <ion-icon name="images"></ion-icon>
                <span>Gallery</span>
              </button>
              <button class="action-btn secondary"
                      (click)="togglePhotoExpansion(categoryName, item.id); $event.stopPropagation()">
                <ion-icon [name]="isPhotosExpanded(categoryName, item.id) ? 'chevron-up' : 'eye'"></ion-icon>
                <span>View ({{ getTotalPhotoCount(categoryName, item.id) }})</span>
              </button>
              <button class="action-btn" (click)="openVisualDetail(categoryName, item); $event.stopPropagation()">
                <ion-icon name="arrow-forward"></ion-icon>
                <span>Details</span>
              </button>
            </div>

            <!-- Image preview section - ONLY shows when expanded -->
            <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0) && isPhotosExpanded(categoryName, item.id)" style="position: relative;">
              <!-- Upload status indicator -->
              <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                <ion-spinner name="dots" color="primary"></ion-spinner>
                <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
              </div>
              <div class="image-preview-container">
                <!-- Skeleton loaders when photos are loading -->
                <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-caption"></div>
                  </div>
                </ng-container>
                <!-- Actual photos when loaded -->
                <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                       [class.uploading]="photo.uploading"
                       [class.annotated]="photo.hasAnnotations"
                       [class.skeleton-loader]="photo.isSkeleton">
                    <!-- Skeleton state - show animated placeholder -->
                    <ng-container *ngIf="photo.isSkeleton">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-caption"></div>
                    </ng-container>
                    <!-- Normal photo state -->
                    <ng-container *ngIf="!photo.isSkeleton">
                      <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.svg'"
                           width="90" height="90"
                           [alt]="photo.name"
                           (mousedown)="saveScrollBeforePhotoClick($event)"
                           (click)="viewPhoto(photo, categoryName, item.id, $event)"
                           (error)="handleImageError($event, photo)"
                           [class.has-annotations]="photo.hasAnnotations"
                           [class.loading]="photo.displayState === 'remote_loading' || photo.loading">
                      <div class="upload-indicator" *ngIf="photo.uploading || photo.displayState === 'remote_loading'">
                        <ion-spinner name="crescent" color="light"></ion-spinner>
                      </div>
                      <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                        <ion-icon name="close"></ion-icon>
                      </button>
                      <button
                        class="room-photo-caption"
                        (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                        {{ photo.caption || 'Caption' }}
                      </button>
                    </ng-container>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
            </div> <!-- Close type-section -->
          </div> <!-- Close simple-accordion-content -->
        </div> <!-- Close simple-accordion (Information) -->

        <!-- Limitations Section -->
        <div class="simple-accordion" *ngIf="organizedData.limitations">
          <div class="simple-accordion-header" (click)="toggleSection('limitations')">
            <div class="accordion-header-content">
              <div class="icon-container">
                <span class="count-badge limitation">{{ organizedData.limitations.length }}</span>
              </div>
              <span class="type-header">Limitations</span>
            </div>
            <div class="accordion-header-actions">
              <button class="add-visual-btn" (click)="addCustomVisual(categoryName, 'Limitation'); $event.stopPropagation()" title="Add custom limitation">
                <ion-icon name="add-circle-outline"></ion-icon>
              </button>
              <ion-icon [name]="isSectionExpanded('limitations') ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
            </div>
          </div>
          <div class="simple-accordion-content" *ngIf="isSectionExpanded('limitations')">
            <div class="type-section">
              <div *ngIf="filterItems(organizedData.limitations).length === 0 && !searchTerm" class="no-items-message">
                No limitations yet.<br>Click + to add one.
              </div>
              <div *ngIf="filterItems(organizedData.limitations).length === 0 && searchTerm" class="no-items-message">
                No results found for "{{ searchTerm }}"
              </div>
              <div class="template-item" *ngFor="let item of filterItems(organizedData.limitations); trackBy: trackByItemId">
          <div class="visual-item-container" [class.selected]="isItemSelected(categoryName, item.id)">

            <!-- Yes/No questions -->
            <div class="answer-type-1-container" *ngIf="item.answerType === 1">
              <div class="item-header" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
                <h3 class="item-name">
                  <span [innerHTML]="highlightText(item.name)"></span>
                  <span class="required-indicator" *ngIf="item.required">*</span>
                </h3>
              </div>
              <div class="item-text-wrapper" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
                <p class="item-text" [innerHTML]="highlightText(item.originalText)"></p>
              </div>
              <div class="dropdown-container" (click)="$event.stopPropagation()">
                <select
                  [(ngModel)]="item.answer"
                  (ngModelChange)="onAnswerChange(categoryName, item); $event?.stopPropagation()"
                  (change)="$event.stopPropagation()"
                  [disabled]="isItemSaving(categoryName, item.id)"
                  class="styled-input">
                  <option value="">-- Select --</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
              </div>
            </div>

            <!-- Multi-select questions -->
            <div class="multi-select-container" *ngIf="item.answerType === 2">
              <div class="multi-select-header">
                <div class="multi-select-title">
                  <h3>
                    <span [innerHTML]="highlightText(item.name)"></span>
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <div class="item-text-wrapper">
                    <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
                  </div>
                </div>
                <div class="multi-select-indicators">
                  <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.id) > 0">
                    <span class="photo-count">
                      <ion-icon name="images"></ion-icon>
                      {{ getTotalPhotoCount(categoryName, item.id) }}
                    </span>
                  </div>
                  <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent"></ion-spinner>
                </div>
              </div>
              <div class="multi-select-options" *ngIf="getDropdownOptions(item.templateId).length > 0">
                <ion-item lines="none" *ngFor="let option of getDropdownOptions(item.templateId); trackBy: trackByOption" class="option-item">
                  <ion-checkbox
                    slot="start"
                    [checked]="isOptionSelectedV1(item, option)"
                    (ionChange)="onOptionToggle(categoryName, item, option, $event); $event.stopPropagation()"
                    [disabled]="isItemSaving(categoryName, item.id)">
                  </ion-checkbox>
                  <ion-label>{{ option }}</ion-label>
                </ion-item>
              </div>
              <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                <input type="text"
                       [(ngModel)]="item.otherValue"
                       (blur)="onMultiSelectOtherChange(categoryName, item)"
                       (click)="$event.stopPropagation()"
                       placeholder="Please specify..."
                       class="styled-input other-input">
              </div>

              <!-- Action button grid for multi-select - shows when any option is selected -->
              <div class="action-button-grid" *ngIf="isItemSelected(categoryName, item.id)">
                <button class="action-btn" (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon name="camera"></ion-icon>
                  <span>Camera</span>
                </button>
                <button class="action-btn" (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon name="images"></ion-icon>
                  <span>Gallery</span>
                </button>
                <button class="action-btn secondary"
                        (click)="togglePhotoExpansion(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon [name]="isPhotosExpanded(categoryName, item.id) ? 'chevron-up' : 'eye'"></ion-icon>
                  <span>View ({{ getTotalPhotoCount(categoryName, item.id) }})</span>
                </button>
                <button class="action-btn" (click)="openVisualDetail(categoryName, item); $event.stopPropagation()">
                  <ion-icon name="arrow-forward"></ion-icon>
                  <span>Details</span>
                </button>
              </div>

              <!-- Image preview section for multi-select -->
              <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && isPhotosExpanded(categoryName, item.id)" style="position: relative;">
                <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                  <ion-spinner name="dots" color="primary"></ion-spinner>
                  <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
                </div>
                <div class="image-preview-container">
                  <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                    <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-caption"></div>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                    <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                         [class.uploading]="photo.uploading"
                         [class.annotated]="photo.hasAnnotations"
                         [class.skeleton-loader]="photo.isSkeleton">
                      <ng-container *ngIf="photo.isSkeleton">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-caption"></div>
                      </ng-container>
                      <ng-container *ngIf="!photo.isSkeleton">
                        <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.svg'"
                             width="90" height="90"
                             [alt]="photo.name"
                             (mousedown)="saveScrollBeforePhotoClick($event)"
                             (click)="viewPhoto(photo, categoryName, item.id, $event)"
                             (error)="handleImageError($event, photo)"
                             [class.has-annotations]="photo.hasAnnotations"
                             [class.loading]="photo.displayState === 'remote_loading' || photo.loading">
                        <div class="upload-indicator" *ngIf="photo.uploading || photo.displayState === 'remote_loading'">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <button
                          class="room-photo-caption"
                          (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                          {{ photo.caption || 'Caption' }}
                        </button>
                      </ng-container>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>

            <!-- Text questions with large action buttons -->
            <ion-item lines="none"
                      class="checkbox-item with-camera"
                      [class.has-photos]="getPhotosForVisual(categoryName, item.id).length > 0"
                      *ngIf="!item.answerType || item.answerType === 0">
              <ion-checkbox
                slot="start"
                [checked]="isItemSelected(categoryName, item.id)"
                [disabled]="isItemSaving(categoryName, item.id)"
                (ionChange)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
              </ion-checkbox>
              <div style="flex: 1; display: flex; align-items: center;">
                <ion-label class="item-label" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()" style="flex: 1;">
                  <h3>
                    <span [innerHTML]="highlightText(item.name)"></span>
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
                </ion-label>
                <!-- Right-aligned photo count indicator -->
                <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.id) > 0">
                  <span class="photo-count">
                    <ion-icon name="images"></ion-icon>
                    {{ getTotalPhotoCount(categoryName, item.id) }}
                  </span>
                </div>
              </div>
              <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end"></ion-spinner>
            </ion-item>

            <!-- Large action button grid - shows when item is selected -->
            <div class="action-button-grid" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0)">
              <button class="action-btn" (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()">
                <ion-icon name="camera"></ion-icon>
                <span>Camera</span>
              </button>
              <button class="action-btn" (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()">
                <ion-icon name="images"></ion-icon>
                <span>Gallery</span>
              </button>
              <button class="action-btn secondary"
                      (click)="togglePhotoExpansion(categoryName, item.id); $event.stopPropagation()">
                <ion-icon [name]="isPhotosExpanded(categoryName, item.id) ? 'chevron-up' : 'eye'"></ion-icon>
                <span>View ({{ getTotalPhotoCount(categoryName, item.id) }})</span>
              </button>
              <button class="action-btn" (click)="openVisualDetail(categoryName, item); $event.stopPropagation()">
                <ion-icon name="arrow-forward"></ion-icon>
                <span>Details</span>
              </button>
            </div>

            <!-- Image preview section (Limitations) - ONLY shows when expanded -->
            <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0) && isPhotosExpanded(categoryName, item.id)" style="position: relative;">
              <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                <ion-spinner name="dots" color="primary"></ion-spinner>
                <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
              </div>
              <div class="image-preview-container">
                <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-caption"></div>
                  </div>
                </ng-container>
                <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                       [class.uploading]="photo.uploading"
                       [class.annotated]="photo.hasAnnotations"
                       [class.skeleton-loader]="photo.isSkeleton">
                    <!-- Skeleton state - show animated placeholder -->
                    <ng-container *ngIf="photo.isSkeleton">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-caption"></div>
                    </ng-container>
                    <!-- Normal photo state -->
                    <ng-container *ngIf="!photo.isSkeleton">
                      <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.svg'"
                           width="90" height="90"
                           [alt]="photo.name"
                           (mousedown)="saveScrollBeforePhotoClick($event)"
                           (click)="viewPhoto(photo, categoryName, item.id, $event)"
                           (error)="handleImageError($event, photo)"
                           [class.has-annotations]="photo.hasAnnotations"
                           [class.loading]="photo.displayState === 'remote_loading' || photo.loading">
                      <div class="upload-indicator" *ngIf="photo.uploading || photo.displayState === 'remote_loading'">
                        <ion-spinner name="crescent" color="light"></ion-spinner>
                      </div>
                      <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                        <ion-icon name="close"></ion-icon>
                      </button>
                      <button
                        class="room-photo-caption"
                        (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                        {{ photo.caption || 'Caption' }}
                      </button>
                    </ng-container>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
            </div> <!-- Close type-section -->
          </div> <!-- Close simple-accordion-content -->
        </div> <!-- Close simple-accordion (Limitations) -->

        <!-- Deficiencies Section -->
        <div class="simple-accordion" *ngIf="organizedData.deficiencies">
          <div class="simple-accordion-header" (click)="toggleSection('deficiencies')">
            <div class="accordion-header-content">
              <div class="icon-container">
                <span class="count-badge deficiency"><span>{{ organizedData.deficiencies.length }}</span></span>
              </div>
              <span class="type-header">Deficiencies</span>
            </div>
            <div class="accordion-header-actions">
              <button class="add-visual-btn" (click)="addCustomVisual(categoryName, 'Deficiency'); $event.stopPropagation()" title="Add custom deficiency">
                <ion-icon name="add-circle-outline"></ion-icon>
              </button>
              <ion-icon [name]="isSectionExpanded('deficiencies') ? 'chevron-up' : 'chevron-down'" class="expand-icon"></ion-icon>
            </div>
          </div>
          <div class="simple-accordion-content" *ngIf="isSectionExpanded('deficiencies')">
            <div class="type-section">
              <div *ngIf="filterItems(organizedData.deficiencies).length === 0 && !searchTerm" class="no-items-message">
                No deficiencies yet.<br>Click + to add one.
              </div>
              <div *ngIf="filterItems(organizedData.deficiencies).length === 0 && searchTerm" class="no-items-message">
                No results found for "{{ searchTerm }}"
              </div>
              <div class="template-item" *ngFor="let item of filterItems(organizedData.deficiencies); trackBy: trackByItemId">
          <div class="visual-item-container" [class.selected]="isItemSelected(categoryName, item.id)">

            <!-- Yes/No questions -->
            <div class="answer-type-1-container" *ngIf="item.answerType === 1">
              <div class="item-header" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
                <h3 class="item-name">
                  <span [innerHTML]="highlightText(item.name)"></span>
                  <span class="required-indicator" *ngIf="item.required">*</span>
                </h3>
              </div>
              <div class="item-text-wrapper" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
                <p class="item-text" [innerHTML]="highlightText(item.originalText)"></p>
              </div>
              <div class="dropdown-container" (click)="$event.stopPropagation()">
                <select
                  [(ngModel)]="item.answer"
                  (ngModelChange)="onAnswerChange(categoryName, item); $event?.stopPropagation()"
                  (change)="$event.stopPropagation()"
                  [disabled]="isItemSaving(categoryName, item.id)"
                  class="styled-input">
                  <option value="">-- Select --</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
                <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" class="saving-spinner"></ion-spinner>
              </div>
            </div>

            <!-- Multi-select questions -->
            <div class="multi-select-container" *ngIf="item.answerType === 2">
              <div class="multi-select-header">
                <div class="multi-select-title">
                  <h3>
                    <span [innerHTML]="highlightText(item.name)"></span>
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <div class="item-text-wrapper">
                    <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
                  </div>
                </div>
                <div class="multi-select-indicators">
                  <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.id) > 0">
                    <span class="photo-count">
                      <ion-icon name="images"></ion-icon>
                      {{ getTotalPhotoCount(categoryName, item.id) }}
                    </span>
                  </div>
                  <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent"></ion-spinner>
                </div>
              </div>
              <div class="multi-select-options" *ngIf="getDropdownOptions(item.templateId).length > 0">
                <ion-item lines="none" *ngFor="let option of getDropdownOptions(item.templateId); trackBy: trackByOption" class="option-item">
                  <ion-checkbox
                    slot="start"
                    [checked]="isOptionSelectedV1(item, option)"
                    (ionChange)="onOptionToggle(categoryName, item, option, $event); $event.stopPropagation()"
                    [disabled]="isItemSaving(categoryName, item.id)">
                  </ion-checkbox>
                  <ion-label>{{ option }}</ion-label>
                </ion-item>
              </div>
              <div class="other-input-container" *ngIf="isOptionSelectedV1(item, 'Other')">
                <input type="text"
                       [(ngModel)]="item.otherValue"
                       (blur)="onMultiSelectOtherChange(categoryName, item)"
                       (click)="$event.stopPropagation()"
                       placeholder="Please specify..."
                       class="styled-input other-input">
              </div>

              <!-- Action button grid for multi-select - shows when any option is selected -->
              <div class="action-button-grid" *ngIf="isItemSelected(categoryName, item.id)">
                <button class="action-btn" (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon name="camera"></ion-icon>
                  <span>Camera</span>
                </button>
                <button class="action-btn" (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon name="images"></ion-icon>
                  <span>Gallery</span>
                </button>
                <button class="action-btn secondary"
                        (click)="togglePhotoExpansion(categoryName, item.id); $event.stopPropagation()">
                  <ion-icon [name]="isPhotosExpanded(categoryName, item.id) ? 'chevron-up' : 'eye'"></ion-icon>
                  <span>View ({{ getTotalPhotoCount(categoryName, item.id) }})</span>
                </button>
                <button class="action-btn" (click)="openVisualDetail(categoryName, item); $event.stopPropagation()">
                  <ion-icon name="arrow-forward"></ion-icon>
                  <span>Details</span>
                </button>
              </div>

              <!-- Image preview section for multi-select -->
              <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && isPhotosExpanded(categoryName, item.id)" style="position: relative;">
                <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                  <ion-spinner name="dots" color="primary"></ion-spinner>
                  <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
                </div>
                <div class="image-preview-container">
                  <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                    <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-caption"></div>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                    <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                         [class.uploading]="photo.uploading"
                         [class.annotated]="photo.hasAnnotations"
                         [class.skeleton-loader]="photo.isSkeleton">
                      <ng-container *ngIf="photo.isSkeleton">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-caption"></div>
                      </ng-container>
                      <ng-container *ngIf="!photo.isSkeleton">
                        <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.svg'"
                             width="90" height="90"
                             [alt]="photo.name"
                             (mousedown)="saveScrollBeforePhotoClick($event)"
                             (click)="viewPhoto(photo, categoryName, item.id, $event)"
                             (error)="handleImageError($event, photo)"
                             [class.has-annotations]="photo.hasAnnotations"
                             [class.loading]="photo.displayState === 'remote_loading' || photo.loading">
                        <div class="upload-indicator" *ngIf="photo.uploading || photo.displayState === 'remote_loading'">
                          <ion-spinner name="crescent" color="light"></ion-spinner>
                        </div>
                        <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                          <ion-icon name="close"></ion-icon>
                        </button>
                        <button
                          class="room-photo-caption"
                          (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                          {{ photo.caption || 'Caption' }}
                        </button>
                      </ng-container>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>

            <!-- Text questions with large action buttons -->
            <ion-item lines="none"
                      class="checkbox-item with-camera"
                      [class.has-photos]="getPhotosForVisual(categoryName, item.id).length > 0"
                      *ngIf="!item.answerType || item.answerType === 0">
              <ion-checkbox
                slot="start"
                [checked]="isItemSelected(categoryName, item.id)"
                [disabled]="isItemSaving(categoryName, item.id)"
                (ionChange)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()">
              </ion-checkbox>
              <div style="flex: 1; display: flex; align-items: center;">
                <ion-label class="item-label" (click)="toggleItemSelection(categoryName, item.id); $event.stopPropagation()" style="flex: 1;">
                  <h3>
                    <span [innerHTML]="highlightText(item.name)"></span>
                    <span class="required-indicator" *ngIf="item.required">*</span>
                  </h3>
                  <p class="item-text" [innerHTML]="highlightText(item.text)"></p>
                </ion-label>
                <!-- Right-aligned photo count indicator -->
                <div class="item-photo-indicator" *ngIf="getTotalPhotoCount(categoryName, item.id) > 0">
                  <span class="photo-count">
                    <ion-icon name="images"></ion-icon>
                    {{ getTotalPhotoCount(categoryName, item.id) }}
                  </span>
                </div>
              </div>
              <ion-spinner *ngIf="isItemSaving(categoryName, item.id)" name="crescent" slot="end"></ion-spinner>
            </ion-item>

            <!-- Large action button grid - shows when item is selected -->
            <div class="action-button-grid" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0)">
              <button class="action-btn" (click)="addPhotoFromCamera(categoryName, item.id); $event.stopPropagation()">
                <ion-icon name="camera"></ion-icon>
                <span>Camera</span>
              </button>
              <button class="action-btn" (click)="addPhotoFromGallery(categoryName, item.id); $event.stopPropagation()">
                <ion-icon name="images"></ion-icon>
                <span>Gallery</span>
              </button>
              <button class="action-btn secondary"
                      (click)="togglePhotoExpansion(categoryName, item.id); $event.stopPropagation()">
                <ion-icon [name]="isPhotosExpanded(categoryName, item.id) ? 'chevron-up' : 'eye'"></ion-icon>
                <span>View ({{ getTotalPhotoCount(categoryName, item.id) }})</span>
              </button>
              <button class="action-btn" (click)="openVisualDetail(categoryName, item); $event.stopPropagation()">
                <ion-icon name="arrow-forward"></ion-icon>
                <span>Details</span>
              </button>
            </div>

            <!-- Image preview section (Deficiencies) - ONLY shows when expanded -->
            <div class="image-preview-section" *ngIf="isItemSelected(categoryName, item.id) && (!item.answerType || item.answerType === 0) && isPhotosExpanded(categoryName, item.id)" style="position: relative;">
              <div class="upload-status" *ngIf="isUploadingPhotos(categoryName, item.id)">
                <ion-spinner name="dots" color="primary"></ion-spinner>
                <span>Uploading {{ getUploadingCount(categoryName, item.id) }} photo(s)...</span>
              </div>
              <div class="image-preview-container">
                <ng-container *ngIf="isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview skeleton-loader" *ngFor="let skeleton of getSkeletonArray(categoryName, item.id); let i = index">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-caption"></div>
                  </div>
                </ng-container>
                <ng-container *ngIf="!isLoadingPhotosForVisual(categoryName, item.id)">
                  <div class="image-preview structural-photo-preview" *ngFor="let photo of getPhotosForVisual(categoryName, item.id); trackBy: trackByPhotoId"
                       [class.uploading]="photo.uploading"
                       [class.annotated]="photo.hasAnnotations"
                       [class.skeleton-loader]="photo.isSkeleton">
                    <!-- Skeleton state - show animated placeholder -->
                    <ng-container *ngIf="photo.isSkeleton">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-caption"></div>
                    </ng-container>
                    <!-- Normal photo state -->
                    <ng-container *ngIf="!photo.isSkeleton">
                      <img [src]="photo.displayUrl || photo.thumbnailUrl || photo.url || 'assets/img/photo-placeholder.svg'"
                           width="90" height="90"
                           [alt]="photo.name"
                           (mousedown)="saveScrollBeforePhotoClick($event)"
                           (click)="viewPhoto(photo, categoryName, item.id, $event)"
                           (error)="handleImageError($event, photo)"
                           [class.has-annotations]="photo.hasAnnotations"
                           [class.loading]="photo.displayState === 'remote_loading' || photo.loading">
                      <div class="upload-indicator" *ngIf="photo.uploading || photo.displayState === 'remote_loading'">
                        <ion-spinner name="crescent" color="light"></ion-spinner>
                      </div>
                      <button class="delete-btn" *ngIf="!photo.uploading" (click)="deletePhoto(photo, categoryName, item.id); $event.stopPropagation()" title="Delete">
                        <ion-icon name="close"></ion-icon>
                      </button>
                      <button
                        class="room-photo-caption"
                        (click)="openCaptionPopup(photo, categoryName, item.id); $event.stopPropagation()">
                        {{ photo.caption || 'Caption' }}
                      </button>
                    </ng-container>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
            </div> <!-- Close type-section -->
          </div> <!-- Close simple-accordion-content -->
        </div> <!-- Close simple-accordion (Deficiencies) -->

      </div> <!-- Close white-container -->

    </div>
  </div>
</div>
