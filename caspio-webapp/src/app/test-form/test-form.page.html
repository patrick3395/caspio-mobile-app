<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>TEST Table Submission</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">TEST Form</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="form-container">
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="document-text" slot="start"></ion-icon>
          Submit Data to TEST Table
        </ion-card-title>
        <ion-card-subtitle>
          Fill out the form below to add a new record
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <!-- Loading State -->
        <div *ngIf="isLoadingSchema" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Loading table structure...</p>
        </div>

        <!-- Dynamic Form -->
        <form *ngIf="!isLoadingSchema" [formGroup]="testForm" (ngSubmit)="onSubmit()">
          
          <!-- Dynamic Fields -->
          <div *ngFor="let field of tableFields" class="form-field">
            
            <!-- Text Input -->
            <ion-item *ngIf="field.inputType === 'text' || field.inputType === 'email' || field.inputType === 'tel' || field.inputType === 'password'" 
                      class="form-item" 
                      [class.ion-invalid]="hasError(field.name, 'required') || hasError(field.name, 'email') || hasError(field.name, 'maxlength')">
              <ion-label position="stacked">
                {{ field.label }}
                <ion-text color="danger" *ngIf="field.required">*</ion-text>
              </ion-label>
              <ion-input
                [formControlName]="field.name"
                [type]="field.inputType"
                [placeholder]="'Enter ' + field.label.toLowerCase()"
                clearInput="true"
              ></ion-input>
              <ion-note slot="error" *ngIf="hasError(field.name, 'required') || hasError(field.name, 'email') || hasError(field.name, 'maxlength')">
                {{ getErrorMessage(field.name) }}
              </ion-note>
            </ion-item>

            <!-- Number Input -->
            <ion-item *ngIf="field.inputType === 'number'" 
                      class="form-item" 
                      [class.ion-invalid]="hasError(field.name, 'required')">
              <ion-label position="stacked">
                {{ field.label }}
                <ion-text color="danger" *ngIf="field.required">*</ion-text>
              </ion-label>
              <ion-input
                [formControlName]="field.name"
                type="number"
                [placeholder]="'Enter ' + field.label.toLowerCase()"
                clearInput="true"
              ></ion-input>
              <ion-note slot="error" *ngIf="hasError(field.name, 'required')">
                {{ getErrorMessage(field.name) }}
              </ion-note>
            </ion-item>

            <!-- Date Input -->
            <ion-item *ngIf="field.inputType === 'date' || field.inputType === 'datetime-local'" 
                      class="form-item" 
                      [class.ion-invalid]="hasError(field.name, 'required')">
              <ion-label position="stacked">
                {{ field.label }}
                <ion-text color="danger" *ngIf="field.required">*</ion-text>
              </ion-label>
              <ion-datetime
                [formControlName]="field.name"
                [presentation]="field.inputType === 'date' ? 'date' : 'date-time'"
                display-format="MM/DD/YYYY"
              ></ion-datetime>
              <ion-note slot="error" *ngIf="hasError(field.name, 'required')">
                {{ getErrorMessage(field.name) }}
              </ion-note>
            </ion-item>

            <!-- Textarea -->
            <ion-item *ngIf="field.inputType === 'textarea'" class="form-item">
              <ion-label position="stacked">
                {{ field.label }}
                <ion-text color="danger" *ngIf="field.required">*</ion-text>
              </ion-label>
              <ion-textarea
                [formControlName]="field.name"
                [placeholder]="'Enter ' + field.label.toLowerCase()"
                rows="3"
                autoGrow="true"
              ></ion-textarea>
              <ion-note slot="error" *ngIf="hasError(field.name, 'required')">
                {{ getErrorMessage(field.name) }}
              </ion-note>
            </ion-item>

            <!-- Select Dropdown -->
            <ion-item *ngIf="field.inputType === 'select'" 
                      class="form-item" 
                      [class.ion-invalid]="hasError(field.name, 'required')">
              <ion-label position="stacked">
                {{ field.label }}
                <ion-text color="danger" *ngIf="field.required">*</ion-text>
              </ion-label>
              <ion-select 
                [formControlName]="field.name" 
                [placeholder]="'Select ' + field.label.toLowerCase()"
                interface="popover"
              >
                <ion-select-option *ngFor="let option of field.options" [value]="option">
                  {{ option }}
                </ion-select-option>
                <!-- Default options if no specific options provided -->
                <ion-select-option *ngIf="!field.options" value="option1">Option 1</ion-select-option>
                <ion-select-option *ngIf="!field.options" value="option2">Option 2</ion-select-option>
                <ion-select-option *ngIf="!field.options" value="option3">Option 3</ion-select-option>
              </ion-select>
              <ion-note slot="error" *ngIf="hasError(field.name, 'required')">
                {{ getErrorMessage(field.name) }}
              </ion-note>
            </ion-item>

            <!-- Checkbox -->
            <ion-item *ngIf="field.inputType === 'checkbox'" class="form-item">
              <ion-checkbox [formControlName]="field.name" slot="start"></ion-checkbox>
              <ion-label>{{ field.label }}</ion-label>
            </ion-item>

            <!-- Photo Upload -->
            <ion-item *ngIf="field.inputType === 'file'" class="form-item photo-upload-item">
              <ion-label position="stacked">
                {{ field.label }}
                <ion-text color="danger" *ngIf="field.required">*</ion-text>
              </ion-label>
              <div class="photo-upload-container">
                <!-- Hidden file input for photo capture -->
                <input 
                  type="file" 
                  [id]="'photo-' + field.name"
                  (change)="onPhotoSelected($event, field.name)"
                  accept="image/*"
                  capture="camera"
                  hidden
                />
                
                <!-- Photo capture buttons -->
                <div class="photo-buttons">
                  <ion-button 
                    fill="solid" 
                    color="primary"
                    (click)="capturePhoto(field.name)"
                    class="photo-button"
                  >
                    <ion-icon name="camera" slot="start"></ion-icon>
                    Take Photo
                  </ion-button>
                  
                  <ion-button 
                    fill="outline" 
                    color="secondary"
                    (click)="selectFromGallery(field.name)"
                    class="photo-button"
                  >
                    <ion-icon name="images" slot="start"></ion-icon>
                    Gallery
                  </ion-button>
                </div>

                <!-- Photo preview -->
                <div *ngIf="photoPreview[field.name]" class="photo-preview">
                  <img [src]="photoPreview[field.name]" alt="Selected photo" />
                  <div class="photo-info">
                    <ion-chip color="success">
                      <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                      <ion-label>Photo Selected</ion-label>
                    </ion-chip>
                    <ion-button 
                      fill="clear" 
                      color="danger" 
                      size="small"
                      (click)="removePhoto(field.name)"
                    >
                      <ion-icon name="trash" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </div>

                <!-- Photo placeholder -->
                <div *ngIf="!photoPreview[field.name]" class="photo-placeholder">
                  <ion-icon name="camera-outline" color="medium"></ion-icon>
                  <p>No photo selected</p>
                </div>
              </div>
              <ion-note slot="error" *ngIf="hasError(field.name, 'required')">
                {{ getErrorMessage(field.name) }}
              </ion-note>
            </ion-item>

          </div>

          <!-- Submit Button -->
          <div class="submit-section">
            <ion-button 
              expand="block" 
              type="submit" 
              [disabled]="isSubmitting || isLoadingSchema"
              color="primary"
              size="large"
            >
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              <span *ngIf="!isSubmitting">Submit to Caspio</span>
              <span *ngIf="isSubmitting">Submitting...</span>
            </ion-button>
            
            <ion-button 
              expand="block" 
              (click)="testMinimalSubmission()" 
              [disabled]="isSubmitting"
              color="warning"
              fill="outline"
            >
              <ion-icon name="flask" slot="start"></ion-icon>
              Test Minimal Submission
            </ion-button>
            
            <ion-button 
              expand="block" 
              (click)="discoverRealFields()" 
              [disabled]="isSubmitting"
              color="success"
              fill="outline"
            >
              <ion-icon name="search" slot="start"></ion-icon>
              Discover Real Fields
            </ion-button>

            <ion-button 
              expand="block" 
              (click)="testEachFieldIndividually()" 
              [disabled]="isSubmitting"
              color="tertiary"
              fill="outline"
            >
              <ion-icon name="bug" slot="start"></ion-icon>
              Test Each Field
            </ion-button>

            <ion-button 
              expand="block" 
              fill="outline" 
              color="medium"
              (click)="resetForm()"
              [disabled]="isSubmitting || isLoadingSchema"
            >
              <ion-icon name="refresh" slot="start"></ion-icon>
              Reset Form
            </ion-button>
          </div>

        </form>
      </ion-card-content>
    </ion-card>

    <!-- Form Status Info -->
    <ion-card class="status-card">
      <ion-card-content>
        <div class="status-info">
          <ion-chip color="primary">
            <ion-icon name="table" slot="start"></ion-icon>
            <ion-label>Target: TEST Table</ion-label>
          </ion-chip>
          
          <ion-chip [color]="testForm.valid ? 'success' : 'warning'">
            <ion-icon [name]="testForm.valid ? 'checkmark-circle' : 'warning'" slot="start"></ion-icon>
            <ion-label>Form {{ testForm.valid ? 'Valid' : 'Invalid' }}</ion-label>
          </ion-chip>
          
          <ion-chip color="tertiary" *ngIf="tableFields.length > 0">
            <ion-icon name="layers" slot="start"></ion-icon>
            <ion-label>{{ tableFields.length }} Fields</ion-label>
          </ion-chip>
        </div>
        
        <ion-text color="medium" class="form-help">
          <p>
            <ion-icon name="information-circle"></ion-icon>
            Fields marked with <ion-text color="danger">*</ion-text> are required.
            Data will be submitted directly to your Caspio TEST table.
          </p>
        </ion-text>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>