{
  "name": "HUD Template Migration - Engineers-Foundation Style & Dexie-First Implementation",
  "description": "Apply engineers-foundation template styling, AWS middleware integration, and Dexie-first approach (mobile only) to the HUD template while preserving existing folder references and database table connections.",
  "branchName": "feature/hud-dexie-first-migration",
  "userStories": [
    {
      "id": "HUD-001",
      "title": "Create HUD Dexie Tables and Field Repository",
      "description": "Create Dexie tables for HUD data following the engineers-foundation pattern. This includes HudField table for field-level storage and integration with existing LocalImages table for photos. CRITICAL: Dexie-first approach is ONLY for MOBILE APP, not WEBAPP.",
      "acceptanceCriteria": [
        "Create HudField interface in caspio-db.ts matching engineers-foundation VisualField pattern",
        "Add hudFields table to Dexie schema with key pattern: ${serviceId}:${category}:${templateId}",
        "Create HudFieldRepoService following VisualFieldRepo pattern",
        "Implement liveHudFields$(serviceId, category) Observable for reactive UI updates",
        "Implement getField, setField, setPhoto, updateAnswer methods",
        "Add platform detection to enable Dexie-first ONLY on mobile (Capacitor.isNativePlatform())",
        "WEBAPP continues to use direct API calls without Dexie caching",
        "Test on MOBILE DEVICE to verify data persists across navigation"
      ],
      "technicalContext": [
        "MOBILE ONLY: Dexie-first is NOT for webapp",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/services/caspio-db.ts - Add HudField interface and table",
        "File to create: src/app/services/hud-field-repo.service.ts",
        "Pattern (READ-ONLY): Follow VisualFieldRepo from engineers-foundation exactly",
        "Key fields: serviceId, category, templateId, answer, photoCount, dirty flag",
        "Integrate with existing LocalImages table for photo storage",
        "Database Tables: Services_HUD_Templates, Services_HUD, Services_HUD_Attach"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-002",
      "title": "Implement HUD Operations Queue Integration",
      "description": "Integrate HUD with the existing operations-queue.service.ts for offline operation queuing. Add HUD-specific operation types and executors following engineers-foundation pattern.",
      "acceptanceCriteria": [
        "Add HUD operation types: CREATE_HUD_VISUAL, UPDATE_HUD_VISUAL, DELETE_HUD_VISUAL, UPLOAD_HUD_PHOTO",
        "Register executors in operations-queue.service.ts for each HUD operation type",
        "Implement dependency resolution for photo uploads (wait for visual creation)",
        "Add deduplication keys to prevent duplicate HUD operations",
        "Queue operations in IndexedDB (survives app restart)",
        "Auto-process queue when online",
        "Implement retry logic with exponential backoff (max 5 minutes)",
        "MOBILE ONLY: Webapp does NOT use operations queue"
      ],
      "technicalContext": [
        "MOBILE ONLY: Operations queue is for mobile offline support",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/services/operations-queue.service.ts",
        "Follow CREATE_VISUAL, UPDATE_VISUAL pattern from engineers-foundation (READ-ONLY)",
        "DedupeKey format: hud_visual_${serviceId}_${templateId}",
        "Callback support: onSuccess, onError, onProgress (in-memory, not persisted)",
        "Status machine: pending → in-progress → completed | failed | cancelled"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-001"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-003",
      "title": "Implement HUD S3 Upload Service Integration",
      "description": "Integrate HUD photo uploads with the existing offline-s3-upload.service.ts. Photos should be stored locally first and synced to S3 in background.",
      "acceptanceCriteria": [
        "HUD photos stored in LocalImages table immediately on capture",
        "Generate stable UUID for each photo (never changes)",
        "Create object URL for instant thumbnail display",
        "Queue 3-step S3 upload process: (1) Create Caspio record, (2) Upload to S3, (3) Update with S3 key",
        "Use {{requestId.fieldName}} placeholders for dependency resolution",
        "S3 path format: uploads/Services_HUD_Attach/{attachId}/{filename}",
        "displayUrl ALWAYS points to local blob, NEVER swap to server URL",
        "MOBILE ONLY: Webapp uploads directly without local storage"
      ],
      "technicalContext": [
        "MOBILE ONLY: S3 queue is for mobile offline support",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/services/offline-s3-upload.service.ts",
        "File to modify: src/app/services/local-image.service.ts",
        "Follow engineers-foundation 3-step upload pattern exactly (READ-ONLY reference)",
        "LocalImage status: local_only → queued → uploading → uploaded → verified",
        "Separate blob storage (localBlobs table) from metadata (localImages table)"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-001",
        "HUD-002"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-004",
      "title": "Implement HUD Background Sync Service Integration",
      "description": "Integrate HUD with background-sync.service.ts for 60-second rolling window batch sync. Add HUD-specific sync events and dirty flag tracking.",
      "acceptanceCriteria": [
        "Add hudSyncComplete$ Subject to BackgroundSyncService",
        "Add hudPhotoUploadComplete$ Subject for photo sync events",
        "Implement 60-second rolling sync window (resets on each change)",
        "Track dirty HUD fields in Dexie (dirty: true flag)",
        "Batch sync all dirty HUD items together",
        "Emit sync completion events for UI refresh",
        "Clear dirty flags after successful sync",
        "MOBILE ONLY: Webapp syncs immediately without batching"
      ],
      "technicalContext": [
        "MOBILE ONLY: Background sync batching is for mobile",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/services/background-sync.service.ts",
        "Follow engineers-foundation pattern (READ-ONLY): visualSyncComplete$, efeRoomSyncComplete$",
        "Rolling window: Wait 60s after last change before syncing",
        "Section dirty flags for smart reload optimization"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-001",
        "HUD-002",
        "HUD-003"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-005",
      "title": "Apply Engineers-Foundation Navigation Structure to HUD",
      "description": "Restructure HUD to match engineers-foundation container/main/detail pattern. Includes breadcrumbs, sync status widget, and consistent navigation flow.",
      "acceptanceCriteria": [
        "Create hud-container component with breadcrumbs and sync status widget",
        "Create hud-main component as landing page with navigation cards",
        "Move project details to hud-project-details component",
        "Move category items to hud-category-detail component",
        "Implement consistent breadcrumb navigation",
        "Add SyncStatusWidgetComponent to header (shows pending/synced count)",
        "Eager-load all routes (no lazy loading) for offline reliability",
        "Route structure: /hud → /hud/project-details → /hud/category/:categoryId"
      ],
      "technicalContext": [
        "APPLIES TO BOTH: Mobile and webapp get same navigation structure",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "Existing HUD files to modify:",
        "  - src/app/pages/hud/hud-routing.module.ts",
        "  - src/app/pages/hud/hud-container/",
        "  - src/app/pages/hud/hud-main/",
        "  - src/app/pages/hud/hud-project-details/",
        "  - src/app/pages/hud/hud-category-detail/",
        "Reference (READ-ONLY): src/app/pages/engineers-foundation/engineers-foundation-routing.module.ts"
      ],
      "priority": 2,
      "passes": true,
      "dependsOn": [],
      "mobileOnlyFeature": false,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-006",
      "title": "Apply Engineers-Foundation Styling to HUD Container",
      "description": "Apply engineers-foundation styling patterns to HUD container including header, breadcrumbs, and overall layout. Use Noble orange branding and consistent design tokens.",
      "acceptanceCriteria": [
        "Apply --noble-orange (#F15A27) for headers, buttons, highlights",
        "White containers with subtle box shadows (0 1px 3px, 0 2px 6px)",
        "Light gray backgrounds (#f5f5f5, #f8f9fa)",
        "Consistent header styling with orange gradient",
        "Breadcrumb styling matching engineers-foundation",
        "Sync status widget styling with pending/synced badges",
        "Hardware-accelerated transitions (translateZ(0), backface-visibility)",
        "Responsive layout for mobile and web"
      ],
      "technicalContext": [
        "APPLIES TO BOTH: Mobile and webapp get same styling",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/pages/hud/hud-container/hud-container.page.scss",
        "Reference (READ-ONLY): src/app/pages/engineers-foundation/engineers-foundation-container/",
        "CSS Variables: --noble-orange, --noble-gray, --background-light",
        "Copy ion-toolbar, ion-header patterns FROM engineers-foundation TO hud"
      ],
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "HUD-005"
      ],
      "mobileOnlyFeature": false,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-007",
      "title": "Apply Engineers-Foundation Styling to HUD Main Page",
      "description": "Style HUD main landing page with navigation cards matching engineers-foundation pattern. Include icon + title + description + badge pattern.",
      "acceptanceCriteria": [
        "Navigation cards with clickable ion-card pattern",
        "Icon + title + description layout per card",
        "Badge system showing Comments/Limitations/Deficiencies counts",
        "Color-coded badges (green complete, orange incomplete)",
        "Hover effects with subtle shadow increase",
        "Card grid layout (auto-fit, minmax(280px, 1fr))",
        "Orange accent borders on cards",
        "Consistent spacing and typography"
      ],
      "technicalContext": [
        "APPLIES TO BOTH: Mobile and webapp get same styling",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "Files to modify: src/app/pages/hud/hud-main/hud-main.page.scss",
        "Files to modify: src/app/pages/hud/hud-main/hud-main.page.html",
        "Reference (READ-ONLY): src/app/pages/engineers-foundation/engineers-foundation-main/"
      ],
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "HUD-005"
      ],
      "mobileOnlyFeature": false,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-008",
      "title": "Apply Engineers-Foundation Styling to HUD Category Detail",
      "description": "Style HUD category detail page with form groups, photo sections, and accordion patterns matching engineers-foundation. Include skeleton loaders and upload feedback.",
      "acceptanceCriteria": [
        "Form group styling with icon labels and styled inputs",
        "Photo section with 60px-90px thumbnails",
        "Skeleton loaders during photo upload (animated gradient pulse)",
        "Instant preview with blob URLs during upload",
        "Caption input below each photo",
        "Delete and annotation edit buttons per photo",
        "Photo badge counter on camera button",
        "Accordion sections for collapsible content",
        "Completion badges showing section progress (0-100%)"
      ],
      "technicalContext": [
        "APPLIES TO BOTH: Mobile and webapp get same styling",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "Files to modify: src/app/pages/hud/hud-category-detail/hud-category-detail.page.scss",
        "Files to modify: src/app/pages/hud/hud-category-detail/hud-category-detail.page.html",
        "Reference (READ-ONLY): src/app/pages/engineers-foundation/structural-systems/category-detail/"
      ],
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "HUD-005"
      ],
      "mobileOnlyFeature": false,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-009",
      "title": "Update HUD Data Service for Platform-Aware Dexie Integration",
      "description": "Update hud-data.service.ts to use Dexie-first approach on mobile while maintaining direct API calls on webapp. Add platform detection logic.",
      "acceptanceCriteria": [
        "Inject PlatformDetectionService for isMobile() checks",
        "On MOBILE: Read from HudFieldRepo first, sync in background",
        "On WEBAPP: Direct API calls with 5-minute in-memory cache",
        "Queue operations via OperationsQueueService on mobile",
        "Immediate API calls on webapp",
        "Photo uploads use LocalImageService on mobile, direct upload on webapp",
        "Subscribe to sync events on mobile for cache invalidation",
        "Maintain backward compatibility with existing HUD functionality"
      ],
      "technicalContext": [
        "PLATFORM-AWARE: Different behavior on mobile vs webapp",
        "File: src/app/pages/hud/hud-data.service.ts",
        "Inject: PlatformDetectionService, HudFieldRepoService, OperationsQueueService",
        "Pattern: if (this.platform.isMobile()) { /* Dexie-first */ } else { /* Direct API */ }",
        "Maintain existing caches for webapp: projectCache, serviceCache, hudCache"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-001",
        "HUD-002",
        "HUD-003",
        "HUD-004"
      ],
      "mobileOnlyFeature": false,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-010",
      "title": "Implement HUD LiveQuery Subscriptions in Category Detail",
      "description": "Update HUD category detail page to use Dexie liveQuery subscriptions for reactive UI updates on mobile. Photos and data should update automatically when Dexie data changes.",
      "acceptanceCriteria": [
        "Subscribe to liveHudFields$(serviceId, category) on mobile",
        "Auto-update UI when field data changes in Dexie",
        "Photos display immediately from LocalImages (no server round-trip)",
        "Annotations display from cachedAnnotatedImages",
        "displayUrl ALWAYS points to local blob on mobile",
        "Sync completion triggers automatic refresh",
        "Unsubscribe on component destroy to prevent memory leaks",
        "WEBAPP: Use traditional ionViewWillEnter data loading"
      ],
      "technicalContext": [
        "MOBILE ONLY: LiveQuery is for mobile reactive updates",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts",
        "Pattern: this.hudFieldRepo.liveHudFields$(serviceId, category).subscribe(fields => ...)",
        "Use ngOnDestroy to clean up subscriptions",
        "Reference (READ-ONLY): engineers-foundation category-detail populatePhotosFromDexie pattern"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-001",
        "HUD-009"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-011",
      "title": "Implement HUD Photo Persistence on Mobile",
      "description": "Ensure HUD photos persist across navigation and page reload on mobile. Photos should always display from local storage and never disappear after sync.",
      "acceptanceCriteria": [
        "Photos persist in LocalImages table on mobile",
        "Photos survive page navigation (ionViewWillLeave/ionViewWillEnter)",
        "Photos survive app restart",
        "Photos remain visible after sync (displayUrl NOT swapped to server URL)",
        "Annotations and captions persist in Dexie",
        "getDisplayUrl checks for annotated image first",
        "Status tracking: local_only → uploaded → verified",
        "Failed uploads show retry indicator"
      ],
      "technicalContext": [
        "MOBILE ONLY: Photo persistence is critical for mobile field use",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "Files to modify:",
        "  - src/app/services/local-image.service.ts",
        "  - src/app/services/caspio-db.ts (LocalImages table)",
        "  - src/app/pages/hud/hud-category-detail/",
        "Pattern: Photo displayUrl = blob URL from LocalImages, NEVER server URL",
        "Reference (READ-ONLY): engineers-foundation category-detail photo persistence"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-003",
        "HUD-010"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-012",
      "title": "Implement HUD Offline Template Caching",
      "description": "Cache HUD templates locally for offline access on mobile. Templates should be available even without network connection.",
      "acceptanceCriteria": [
        "Cache HUD templates in Dexie cachedTemplates table on mobile",
        "24-hour cache TTL with background refresh when online",
        "Templates available offline immediately after first load",
        "ensureHudTemplatesReady() returns cached data if available",
        "Fallback to empty array if offline with no cache",
        "Template cache invalidation on version change",
        "WEBAPP: Network-first with no local caching"
      ],
      "technicalContext": [
        "MOBILE ONLY: Template caching is for mobile offline support",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/services/offline-template.service.ts",
        "Database table: Services_HUD_Templates",
        "Cache key: hud_templates_${serviceId}",
        "Reference (READ-ONLY): engineers-foundation visual template caching"
      ],
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "HUD-001"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-013",
      "title": "Add Mobile Resilience to HUD Dexie Queries",
      "description": "Add mobile-specific resilience to HUD Dexie queries. Handle IndexedDB connection issues gracefully and return cached data on error.",
      "acceptanceCriteria": [
        "Check DB connection before queries, reopen if needed",
        "On connection error, retry with fresh connection",
        "Cache last known good query result",
        "Return cached data on error (prevents UI clearing)",
        "Log errors with [HUD] prefix for debugging",
        "Handle WebView IndexedDB hiccups gracefully",
        "Never return empty array if cached data exists"
      ],
      "technicalContext": [
        "MOBILE ONLY: Mobile WebView has IndexedDB stability issues",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to create: src/app/services/hud-field-repo.service.ts",
        "Pattern: _lastHudFieldsCache Map for fallback data",
        "Reference (READ-ONLY): engineers-foundation Dexie mobile fixes in caspio-db.ts",
        "Error handling: if (err?.message?.includes('Connection')) { retry }"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-001"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-014",
      "title": "Implement HUD Caption and Annotation Sync",
      "description": "Implement caption and annotation persistence and sync for HUD photos on mobile. Updates should be stored locally and synced in background.",
      "acceptanceCriteria": [
        "Store caption updates in pendingCaptions table on mobile",
        "Store annotations in cachedAnnotatedImages table",
        "Compress annotations using COMPRESSED_V3 format",
        "Sync captions in background via BackgroundSyncService",
        "Emit captionSyncComplete$ event on sync",
        "Display annotations on thumbnails immediately",
        "Merge local updates with server data on refresh",
        "WEBAPP: Direct API calls for caption/annotation updates"
      ],
      "technicalContext": [
        "MOBILE ONLY: Annotation caching is for mobile",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "Files to modify:",
        "  - src/app/services/caspio-db.ts (pendingCaptions table)",
        "  - src/app/utils/annotation-utils.ts (compression)",
        "  - src/app/components/fabric-photo-annotator/",
        "Annotation format: COMPRESSED_V3:{JSON}",
        "Reference (READ-ONLY): engineers-foundation annotation persistence"
      ],
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "HUD-011"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-015",
      "title": "Update HUD PDF Service for Dexie Integration",
      "description": "Update HUD PDF service to read data from Dexie on mobile. PDF should include locally stored photos and annotations.",
      "acceptanceCriteria": [
        "Read HUD data from Dexie hudFields table on mobile",
        "Include locally stored photos from LocalImages",
        "Render annotations on photos using Fabric.js",
        "Handle offline photo blobs (convert to base64)",
        "Progress tracking with real-time UI updates",
        "5-minute cache for PDF data on webapp",
        "Support both mobile and webapp PDF generation",
        "Merge pending local changes into PDF output"
      ],
      "technicalContext": [
        "PLATFORM-AWARE: Read from Dexie on mobile, API on webapp",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/pages/hud/services/hud-pdf.service.ts",
        "Photo conversion: blob/file → base64 for PDF",
        "Progress: Web shows progress bar, mobile shows loading message",
        "Reference (READ-ONLY): src/app/pages/engineers-foundation/services/engineers-foundation-pdf.service.ts"
      ],
      "priority": 3,
      "passes": true,
      "dependsOn": [
        "HUD-009",
        "HUD-011"
      ],
      "mobileOnlyFeature": false,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-016",
      "title": "Implement HUD Sync Status Widget",
      "description": "Add sync status widget to HUD container showing pending/synced item counts and sync progress. Follows engineers-foundation pattern.",
      "acceptanceCriteria": [
        "Display pending item count badge",
        "Display synced item count badge",
        "Show sync in progress indicator (spinner)",
        "Subscribe to BackgroundSyncService.syncStatus$",
        "Click to expand sync details modal",
        "Show failed items with retry option",
        "Real-time updates as items sync",
        "MOBILE ONLY: Widget only visible on mobile"
      ],
      "technicalContext": [
        "MOBILE ONLY: Sync widget is for mobile offline feedback",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "Component to use: src/app/components/sync-status-widget/",
        "File to modify: src/app/pages/hud/hud-container/hud-container.page.html",
        "Subscribe to: syncStatus$, hudSyncComplete$, hudPhotoUploadComplete$",
        "Reference (READ-ONLY): engineers-foundation sync status widget usage"
      ],
      "priority": 3,
      "passes": true,
      "dependsOn": [
        "HUD-004",
        "HUD-006"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-017",
      "title": "Add Skeleton Loaders to HUD Components",
      "description": "Add skeleton loaders to HUD components following engineers-foundation pattern. Use hardware-accelerated animations for smooth loading states.",
      "acceptanceCriteria": [
        "Add skeleton loaders to photo thumbnails during upload",
        "Add skeleton cards during initial data load (web only)",
        "Hardware-accelerated animations (transform: translateZ(0))",
        "Animated gradient pulse effect",
        "Conditional loading: spinner on mobile, skeleton on web",
        "Skeleton matches final content dimensions",
        "Smooth transition from skeleton to content"
      ],
      "technicalContext": [
        "APPLIES TO BOTH: Different loader types per platform",
        "Files:",
        "  - src/app/pages/hud/hud-category-detail/hud-category-detail.page.scss",
        "  - src/app/pages/hud/hud-main/hud-main.page.scss",
        "CSS: @keyframes skeleton-loading, background: linear-gradient",
        "Platform check: this.platform.isCapacitor ? 'spinner' : 'skeleton'"
      ],
      "priority": 3,
      "passes": true,
      "dependsOn": [
        "HUD-008"
      ],
      "mobileOnlyFeature": false,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-018",
      "title": "Implement HUD TempId Mapping System",
      "description": "Implement temp ID mapping for HUD records created offline. Map temp IDs to real IDs after sync completes.",
      "acceptanceCriteria": [
        "Generate temp IDs for offline HUD record creation (format: temp_hud_${uuid})",
        "Store temp ID mappings in tempIdMappings table",
        "Resolve temp IDs to real IDs after sync",
        "Update all references (photos, attachments) with real ID",
        "Handle dependency chains (visual → photo → annotation)",
        "Clean up temp ID mappings after 24 hours",
        "MOBILE ONLY: Webapp creates records with real IDs immediately"
      ],
      "technicalContext": [
        "MOBILE ONLY: TempId mapping is for mobile offline creation",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/services/caspio-db.ts (tempIdMappings table)",
        "Pattern: { tempId: 'temp_hud_xxx', realId: '123', type: 'hud_visual' }",
        "Resolution: After sync, query mapping and update LocalImages.remoteAttachId",
        "Reference (READ-ONLY): engineers-foundation temp ID handling"
      ],
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "HUD-001",
        "HUD-002"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-019",
      "title": "Add HUD Service Metadata Tracking",
      "description": "Track HUD service activity in serviceMetadata table for smart purging and cache management.",
      "acceptanceCriteria": [
        "Track lastTouchedAt timestamp for each HUD service",
        "Track purgeState for each service (active/stale/purged)",
        "Update timestamp on any HUD data access",
        "Identify stale services for soft purge (24+ hours inactive)",
        "Soft purge: Remove full images, keep thumbnails",
        "Hard purge: Remove all local data for service",
        "Prevent purge of services with pending sync items"
      ],
      "technicalContext": [
        "MOBILE ONLY: Service metadata is for mobile storage management",
        "DO NOT MODIFY engineers-foundation - READ-ONLY REFERENCE",
        "File to modify: src/app/services/caspio-db.ts (serviceMetadata table)",
        "Index: [purgeState+lastTouchedAt] for efficient stale service queries",
        "Soft purge: Delete localBlobs, keep localImages with thumbBlobId",
        "Reference (READ-ONLY): engineers-foundation storage management"
      ],
      "priority": 3,
      "passes": true,
      "dependsOn": [
        "HUD-001"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "HUD-020",
      "title": "Integration Testing - HUD Mobile Offline Workflow",
      "description": "Comprehensive integration testing of HUD mobile offline workflow. Verify all Dexie-first features work correctly on actual mobile device.",
      "acceptanceCriteria": [
        "Test on actual mobile device (iOS or Android)",
        "Create HUD visual while offline - data persists in Dexie",
        "Add photo while offline - photo displays immediately",
        "Add annotation while offline - annotation visible on thumbnail",
        "Go online - background sync completes successfully",
        "Photos remain visible after sync (displayUrl NOT swapped)",
        "Navigate away and back - all data persists",
        "Kill app and reopen - all data persists",
        "Generate PDF - includes local photos and annotations"
      ],
      "technicalContext": [
        "MOBILE ONLY: Integration test is for mobile",
        "Test scenarios:",
        "  1. Full offline workflow (airplane mode)",
        "  2. Intermittent connectivity (toggle network)",
        "  3. Multi-photo upload queue",
        "  4. Annotation edit while offline",
        "  5. Sync conflict resolution",
        "Use alert() for debug on mobile, NOT console.log"
      ],
      "priority": 1,
      "passes": true,
      "dependsOn": [
        "HUD-001",
        "HUD-002",
        "HUD-003",
        "HUD-004",
        "HUD-009",
        "HUD-010",
        "HUD-011"
      ],
      "mobileOnlyFeature": true,
      "completionNotes": "Completed by agent"
    }
  ],
  "metadata": {
    "createdAt": "2026-01-22T12:00:00.000Z",
    "updatedAt": "2026-01-23T05:46:57.509Z",
    "version": "1.0.0"
  }
}