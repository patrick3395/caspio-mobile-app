---
phase: 04-validation-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/pages/hud/hud-main/hud-main.page.ts
autonomous: true

must_haves:
  truths:
    - "HUD finalization syncs all pending field operations before completing"
    - "HUD finalization syncs with timeout protection (45 seconds)"
    - "No orphaned data after finalization (field changes persist correctly)"
    - "User sees 'Syncing data...' message during field sync step"
  artifacts:
    - path: "src/app/pages/hud/hud-main/hud-main.page.ts"
      provides: "Complete finalization flow matching EFE pattern"
      contains: "forceSyncAllPendingForService"
  key_links:
    - from: "hud-main.page.ts markReportAsFinalized"
      to: "backgroundSync.forceSyncAllPendingForService"
      via: "Step 1.5 between image sync and pointer update"
      pattern: "forceSyncAllPendingForService.*serviceId"
    - from: "hud-main.page.ts completeFinalization"
      to: "hudFieldRepo.markAllCleanForService"
      via: "Cleanup after successful finalization"
      pattern: "hudFieldRepo\\.markAllCleanForService"
---

<objective>
Add missing finalization sync steps to HUD main page matching engineers-foundation pattern.

Purpose: HUD currently only syncs images before finalization, missing the critical data sync step that syncs field changes queued in HudOperationsQueueService. Without this, field changes made immediately before finalization may be orphaned.

Output: HUD finalization flow matches EFE with timeout-protected data sync and dirty flag cleanup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation-and-polish/04-RESEARCH.md

Reference files:
@src/app/pages/engineers-foundation/engineers-foundation-main/engineers-foundation-main.page.ts (lines 287-525 for finalization pattern)
@src/app/pages/hud/hud-main/hud-main.page.ts (target file)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add withTimeout helper method to HUD main page</name>
  <files>src/app/pages/hud/hud-main/hud-main.page.ts</files>
  <action>
    Add the withTimeout helper method and SYNC_TIMEOUT_MS constant to HudMainPage class, copying from EFE pattern.

    Add near top of class (after other property declarations):
    ```typescript
    private readonly SYNC_TIMEOUT_MS = 45000; // 45 seconds per sync step
    ```

    Add method (before markReportAsFinalized or after completeFinalization):
    ```typescript
    private async withTimeout<T>(
      promise: Promise<T>,
      timeoutMs: number,
      operationName: string
    ): Promise<{ result: T; timedOut: false } | { result: null; timedOut: true }> {
      return Promise.race([
        promise.then(result => ({ result, timedOut: false as const })),
        new Promise<{ result: null; timedOut: true }>((resolve) => {
          setTimeout(() => {
            console.warn(`[HUD Main] ${operationName} timed out after ${timeoutMs}ms`);
            resolve({ result: null, timedOut: true });
          }, timeoutMs);
        })
      ]);
    }
    ```
  </action>
  <verify>grep -n "withTimeout" src/app/pages/hud/hud-main/hud-main.page.ts returns the method</verify>
  <done>HUD main page has withTimeout helper matching EFE pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add data sync step to markReportAsFinalized</name>
  <files>src/app/pages/hud/hud-main/hud-main.page.ts</files>
  <action>
    Modify markReportAsFinalized to add Step 1.5 (data sync) between image sync and image pointer update.

    After the image sync block (after line ~295 `}` closing `if (imageStatus.pending > 0)`), add:

    ```typescript
      // ==========================================
      // STEP 1.5: Sync ALL pending requests/captions (with timeout)
      // ==========================================
      console.log('[HUD Main] Syncing pending requests and captions...');
      loading.message = 'Syncing data...';

      const dataSyncOutcome = await this.withTimeout(
        this.backgroundSync.forceSyncAllPendingForService(
          this.serviceId,
          (status, current, total) => {
            loading.message = status;
          }
        ),
        this.SYNC_TIMEOUT_MS,
        'Data sync'
      );

      console.log('[HUD Main] Data sync result:', dataSyncOutcome);

      // Handle timeout or failure
      if (dataSyncOutcome.timedOut || !dataSyncOutcome.result.success) {
        const failedTotal = dataSyncOutcome.timedOut ? '?' :
          (dataSyncOutcome.result.requestsFailed + dataSyncOutcome.result.captionsFailed);
        const reason = dataSyncOutcome.timedOut ? 'Sync timed out' : 'Some items failed';

        await loading.dismiss();

        const alert = await this.alertController.create({
          header: 'Sync Warning',
          message: `${reason}. ${failedTotal} item(s) may not be synced. Do you want to proceed with finalization anyway?`,
          cssClass: 'custom-document-alert',
          buttons: [
            { text: 'Cancel', role: 'cancel' },
            {
              text: 'Proceed Anyway',
              handler: () => this.completeFinalization(isUpdate)
            }
          ]
        });
        await alert.present();
        return;
      }
    ```

    Also wrap the existing image sync in withTimeout matching EFE pattern (optional but recommended for consistency).
  </action>
  <verify>grep -n "forceSyncAllPendingForService" src/app/pages/hud/hud-main/hud-main.page.ts shows the new sync step</verify>
  <done>HUD finalization has Step 1.5 data sync matching EFE</done>
</task>

<task type="auto">
  <name>Task 3: Add HudFieldRepoService injection and dirty flag cleanup</name>
  <files>src/app/pages/hud/hud-main/hud-main.page.ts</files>
  <action>
    1. Add import for HudFieldRepoService if not already present:
    ```typescript
    import { HudFieldRepoService } from '../services/hud-field-repo.service';
    ```

    2. Add to constructor injection (if not already present):
    ```typescript
    private hudFieldRepo: HudFieldRepoService,
    ```

    3. In completeFinalization, after the blob cleanup and before resetting change tracking flags, add:
    ```typescript
      // Mark all Dexie records as clean (removes dirty flags)
      try {
        await this.hudFieldRepo.markAllCleanForService(this.serviceId);
        console.log('[HUD Main] Marked all Dexie records as clean');
      } catch (err) {
        console.warn('[HUD Main] Failed to mark records clean (non-fatal):', err);
      }
    ```

    This ensures dirty flags don't persist after successful finalization.
  </action>
  <verify>grep -n "markAllCleanForService" src/app/pages/hud/hud-main/hud-main.page.ts shows the cleanup call</verify>
  <done>HUD finalization clears dirty flags after sync like EFE</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Code verification:
   - withTimeout method exists in hud-main.page.ts
   - forceSyncAllPendingForService call exists in markReportAsFinalized
   - markAllCleanForService call exists in completeFinalization
   - HudFieldRepoService is injected

2. Pattern matching:
   - HUD finalization flow matches EFE structure (4 steps not 3)
   - Timeout protection exists for sync operations
   - User-facing messages match EFE pattern
</verification>

<success_criteria>
- HUD markReportAsFinalized has 4 steps: image sync, data sync, pointer update, complete
- withTimeout helper exists with 45-second timeout
- forceSyncAllPendingForService called between image sync and pointer update
- hudFieldRepo.markAllCleanForService called in completeFinalization cleanup
- All sync operations have timeout protection
- User sees appropriate loading messages during each step
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation-and-polish/04-01-SUMMARY.md`
</output>
