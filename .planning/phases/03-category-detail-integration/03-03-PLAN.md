---
phase: 03-category-detail-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Field changes write to Dexie immediately (user sees instant feedback)"
    - "Changes queue to Caspio API via HudOperationsQueueService"
  artifacts:
    - path: "src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts"
      provides: "fieldKey parameter in toggleItemSelection updateVisual calls"
      contains: "updateVisual(visualId, { Notes:"
  key_links:
    - from: "toggleItemSelection"
      to: "HudDataService.updateVisual"
      via: "fieldKey parameter"
      pattern: "updateVisual.*fieldKey"
    - from: "HudDataService.updateVisualMobile"
      to: "HudOperationsQueueService"
      via: "enqueueUpdateHudVisual"
      pattern: "enqueueUpdateHudVisual"
---

<objective>
Wire toggleItemSelection to mobile write-through path by adding fieldKey parameter

Purpose: Close verification gaps - toggleItemSelection calls updateVisual without fieldKey, bypassing the mobile write-through path
Output: toggleItemSelection properly triggers HudDataService.updateVisualMobile -> HudOperationsQueueService chain
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-category-detail-integration/03-VERIFICATION.md

# Source files
@src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts (lines 1630-1680 for toggleItemSelection)
@src/app/pages/hud/hud-data.service.ts (lines 656-692 for updateVisual signature)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fieldKey parameter to toggleItemSelection updateVisual calls</name>
  <files>src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts</files>
  <action>
Find toggleItemSelection method (around line 1627). Locate the two updateVisual calls:

1. Line ~1643 (unhide visual - when item is checked):
```typescript
// Current:
await this.hudData.updateVisual(visualId, { Notes: '' });

// Change to:
const fieldKey = `${this.serviceId}:${category}:${itemId}`;
await this.hudData.updateVisual(visualId, { Notes: '' }, fieldKey);
```

2. Line ~1662 (hide visual - when item is unchecked):
```typescript
// Current:
await this.hudData.updateVisual(visualId, { Notes: 'HIDDEN' });

// Change to:
const fieldKey = `${this.serviceId}:${category}:${itemId}`;
await this.hudData.updateVisual(visualId, { Notes: 'HIDDEN' }, fieldKey);
```

Note: The fieldKey format `serviceId:category:itemId` matches the format expected by HudDataService.updateVisualMobile which parses it with `const [serviceId, category, templateIdStr] = fieldKey.split(':');`

Important:
- `this.serviceId` is already available as a component property
- `category` and `itemId` are parameters to toggleItemSelection(category, itemId)
- The fieldKey enables the mobile path: `if (this.isMobile() && fieldKey)` in updateVisual
  </action>
  <verify>Grep for "updateVisual(visualId, { Notes:" in the file returns matches with fieldKey parameter</verify>
  <done>Both updateVisual calls in toggleItemSelection include fieldKey, wiring to mobile write-through path</done>
</task>

</tasks>

<verification>
- [ ] Line ~1643: updateVisual call includes fieldKey parameter
- [ ] Line ~1662: updateVisual call includes fieldKey parameter
- [ ] fieldKey format is `${this.serviceId}:${category}:${itemId}`
- [ ] On mobile, toggleItemSelection now triggers updateVisualMobile path
- [ ] updateVisualMobile path calls hudFieldRepo.setField (immediate Dexie write)
- [ ] updateVisualMobile path calls hudOpsQueue.enqueueUpdateHudVisual (background sync)
</verification>

<success_criteria>
toggleItemSelection properly wires to mobile Dexie-first pattern:
1. fieldKey parameter passed to both updateVisual calls
2. Mobile path (isMobile && fieldKey) triggers updateVisualMobile
3. updateVisualMobile writes to HudFieldRepo immediately
4. updateVisualMobile queues to HudOperationsQueueService for background sync
5. User sees instant feedback on item toggle (no waiting for API)
</success_criteria>

<output>
After completion, create `.planning/phases/03-category-detail-integration/03-03-SUMMARY.md`
</output>
