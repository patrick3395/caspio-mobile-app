---
phase: 03-category-detail-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
autonomous: true

must_haves:
  truths:
    - "No duplicate photos appear during camera capture"
    - "No duplicate photos appear during multi-image gallery upload"
    - "No UI flickering during rapid Dexie updates"
    - "Concurrent photo load requests for same key are deduplicated"
  artifacts:
    - path: "src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts"
      provides: "Race condition guards matching EFE pattern"
      contains: "liveQueryDebounceTimer"
  key_links:
    - from: "liveQuery subscription handler"
      to: "changeDetectorRef.detectChanges()"
      via: "100ms debounce timer"
      pattern: "liveQueryDebounceTimer.*setTimeout"
---

<objective>
Add race condition guards and debounce patterns to HUD category-detail page

Purpose: Prevent duplicate photos and UI flickering by copying proven guards from engineers-foundation
Output: hud-category-detail.page.ts with all EFE race condition prevention patterns
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-category-detail-integration/03-RESEARCH.md

# Source patterns
@src/app/pages/engineers-foundation/structural-systems/category-detail/category-detail.page.ts (lines 100-180 for property declarations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add race condition guard properties</name>
  <files>src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts</files>
  <action>
Add the following private properties after the existing subscription properties (around line 100):

```typescript
// Debounce timer for liveQuery updates to prevent multiple rapid change detections
private liveQueryDebounceTimer: any = null;

// Guard to prevent concurrent/duplicate loadPhotosForVisual calls for same key
private loadingPhotoPromises: Map<string, Promise<void>> = new Map();

// Suppress liveQuery during batch multi-image upload to prevent race conditions
private isMultiImageUploadInProgress = false;

// Separate flag for camera captures - suppresses liveQuery to prevent duplicates with annotated photos
private isCameraCaptureInProgress = false;

// Track imageIds in current batch to prevent duplicates even if liveQuery fires
private batchUploadImageIds = new Set<string>();

// MUTEX: Prevent concurrent populatePhotosFromDexie calls
private isPopulatingPhotos = false;
```

These match the exact property names and comments from EFE category-detail.page.ts lines 119-172.
  </action>
  <verify>Grep for "liveQueryDebounceTimer" in the file returns a match</verify>
  <done>All 6 race condition guard properties exist in HUD category-detail</done>
</task>

<task type="auto">
  <name>Task 2: Implement liveQuery debounce pattern</name>
  <files>src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts</files>
  <action>
Find the subscribeToLiveHudFields() method (or similar liveQuery subscription handler).

Wrap any change detection calls in a 100ms debounce timer:

```typescript
// In the liveQuery subscription handler:
if (this.liveQueryDebounceTimer) {
  clearTimeout(this.liveQueryDebounceTimer);
}
this.liveQueryDebounceTimer = setTimeout(() => {
  this.liveQueryDebounceTimer = null;

  // Existing change detection code goes here
  this.changeDetectorRef.detectChanges();
}, 100);
```

Also add cleanup in ngOnDestroy():

```typescript
if (this.liveQueryDebounceTimer) {
  clearTimeout(this.liveQueryDebounceTimer);
  this.liveQueryDebounceTimer = null;
}
```

Pattern source: EFE category-detail.page.ts lines 1780-1788
  </action>
  <verify>Grep for "liveQueryDebounceTimer = setTimeout" returns a match</verify>
  <done>LiveQuery updates debounced by 100ms to prevent UI thrashing</done>
</task>

<task type="auto">
  <name>Task 3: Implement camera capture and batch upload guards</name>
  <files>src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts</files>
  <action>
Find the camera capture method (capturePhoto, takePhoto, or similar).

Add guard at start of camera capture:
```typescript
this.isCameraCaptureInProgress = true;
```

Add cleanup in finally block or after manual UI push:
```typescript
this.isCameraCaptureInProgress = false;
```

Find multi-image upload method (handleMultipleFiles, processGalleryPhotos, or similar).

Add guards:
```typescript
// At start of batch upload:
this.isMultiImageUploadInProgress = true;
this.batchUploadImageIds.clear();

// After each image is created (inside loop):
this.batchUploadImageIds.add(imageId);

// In finally block:
this.isMultiImageUploadInProgress = false;
this.batchUploadImageIds.clear();
```

In liveQuery handler, add skip check:
```typescript
// Skip if we're in a batch upload and this image is being tracked
if (this.batchUploadImageIds.has(imageId)) {
  console.log('[HUD-CATEGORY-DETAIL] Skipping batch-tracked image in liveQuery');
  continue; // or return early
}

// Skip if camera capture in progress
if (this.isCameraCaptureInProgress) {
  console.log('[HUD-CATEGORY-DETAIL] Skipping liveQuery during camera capture');
  return;
}
```

Pattern source: EFE category-detail.page.ts lines 5422-5536, 5764-5880
  </action>
  <verify>Grep for "isCameraCaptureInProgress = true" and "isMultiImageUploadInProgress = true" both return matches</verify>
  <done>Camera capture and batch upload operations properly guarded to prevent duplicate photos</done>
</task>

</tasks>

<verification>
- [ ] All 6 race condition guard properties exist
- [ ] liveQuery debounce timer implemented with 100ms timeout
- [ ] Camera capture guard prevents liveQuery duplicates
- [ ] Batch upload tracking prevents liveQuery duplicates
- [ ] Cleanup in ngOnDestroy for debounce timer
</verification>

<success_criteria>
HUD category-detail page has all race condition prevention patterns from EFE:
1. liveQueryDebounceTimer for batching rapid updates
2. batchUploadImageIds for tracking multi-image uploads
3. isCameraCaptureInProgress for camera capture isolation
4. isMultiImageUploadInProgress for batch upload isolation
5. loadingPhotoPromises for concurrent load deduplication
6. isPopulatingPhotos mutex for populatePhotos serialization
</success_criteria>

<output>
After completion, create `.planning/phases/03-category-detail-integration/03-01-SUMMARY.md`
</output>
