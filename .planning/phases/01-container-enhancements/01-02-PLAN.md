---
phase: 01-container-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/pages/hud/hud-container/hud-container.page.ts
autonomous: true

must_haves:
  truths:
    - "User sees 'Restoring data from server...' message when opening a purged HUD service"
    - "User sees HUD #1, HUD #2 in the page header when multiple HUD services exist on a project"
    - "User sees correct instance number in breadcrumbs after navigation"
  artifacts:
    - path: "src/app/pages/hud/hud-container/hud-container.page.ts"
      provides: "Rehydration flow integration"
      contains: "needsRehydration"
    - path: "src/app/pages/hud/hud-container/hud-container.page.ts"
      provides: "Instance number in breadcrumbs"
      contains: "HUD #"
  key_links:
    - from: "hud-container.page.ts"
      to: "HudDataService.needsRehydration"
      via: "call in ngOnInit route params subscription"
      pattern: "hudData\\.needsRehydration"
    - from: "hud-container.page.ts"
      to: "HudDataService.rehydrateService"
      via: "call when needsRehydration returns true"
      pattern: "hudData\\.rehydrateService"
---

<objective>
Integrate rehydration check into HUD container and update breadcrumbs to show service instance numbers.

Purpose: Complete the container enhancements by wiring rehydration into the initialization flow and updating the UI to show correct HUD instance identification.

Output: HUD container with full rehydration support and instance-aware breadcrumbs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-container-enhancements/01-RESEARCH.md
@.planning/phases/01-container-enhancements/01-01-SUMMARY.md
@src/app/pages/hud/hud-container/hud-container.page.ts
@src/app/pages/engineers-foundation/engineers-foundation-container/engineers-foundation-container.page.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rehydration check to ngOnInit</name>
  <files>src/app/pages/hud/hud-container/hud-container.page.ts</files>
  <action>
Add rehydration check in the route.params subscription, AFTER loadServiceInstanceNumber() but BEFORE the isNewService download check.

Copy the pattern from engineers-foundation-container.page.ts lines 142-167:

```typescript
// ========== REHYDRATION CHECK (runs every time, not just new service) ==========
// Check if service was purged and needs data restored
// This must run even for "same service" because user might have force purged
if (!environment.isWeb && this.offlineService.isOnline()) {
  try {
    const needsRehydration = await this.hudData.needsRehydration(newServiceId);
    if (needsRehydration) {
      console.log('[HUD Container] Service needs rehydration - starting...');

      // Show loading screen for rehydration
      this.templateReady = false;
      this.downloadProgress = 'Restoring data from server...';
      this.changeDetectorRef.detectChanges();

      const result = await this.hudData.rehydrateService(newServiceId);

      if (result.success) {
        console.log(`[HUD Container] Rehydration complete: ${result.restored.hudRecords} records, ${result.restored.hudAttachments} attachments`);
      } else {
        console.error(`[HUD Container] Rehydration failed: ${result.error}`);
      }
    }
  } catch (err) {
    console.error('[HUD Container] Rehydration check failed:', err);
  }
}
```

**CRITICAL placement:**
- This block must be AFTER the `loadServiceInstanceNumber()` call
- This block must be BEFORE the `if (isNewService || isFirstLoad)` block that does template download
- This runs on EVERY route param change, not just new service (unlike template download)

The reason: User might purge data while viewing a service, then navigate within it. The rehydration check needs to run every time.
  </action>
  <verify>
TypeScript compilation passes.
Rehydration block is positioned correctly in ngOnInit.
Console logging uses [HUD Container] prefix.
  </verify>
  <done>
Rehydration check runs on every service open in mobile mode.
Loading overlay shows "Restoring data from server..." during rehydration.
Rehydration result is logged with HUD record and attachment counts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update breadcrumbs with instance number</name>
  <files>src/app/pages/hud/hud-container/hud-container.page.ts</files>
  <action>
Modify the updateBreadcrumbs() method to include service instance numbers when multiple HUD services exist.

Copy the pattern from engineers-foundation-container.page.ts lines 322-347:

1. **Update the title reset logic** at the top of updateBreadcrumbs():
   Replace the simple reset:
   ```typescript
   // Reset to default title
   this.currentPageTitle = 'HUD/Manufactured Home';
   this.currentPageShortTitle = 'HUD';
   ```

   With instance-aware reset:
   ```typescript
   // Reset to default title - include instance number if multiple HUD services exist
   if (this.totalHUDServices > 1) {
     this.currentPageTitle = `HUD/Manufactured Home #${this.serviceInstanceNumber}`;
     this.currentPageShortTitle = `HUD #${this.serviceInstanceNumber}`;
   } else {
     this.currentPageTitle = 'HUD/Manufactured Home';
     this.currentPageShortTitle = 'HUD';
   }
   ```

2. **Update the main breadcrumb** that adds the "HUD/Manufactured Home" entry:
   Change from:
   ```typescript
   this.breadcrumbs.push({
     label: 'HUD/Manufactured Home',
     path: '',
     icon: 'clipboard-outline'
   });
   ```

   To:
   ```typescript
   // Always add HUD main page breadcrumb - include instance number if multiple
   const hudLabel = this.totalHUDServices > 1
     ? `HUD/Manufactured Home #${this.serviceInstanceNumber}`
     : 'HUD/Manufactured Home';
   this.breadcrumbs.push({
     label: hudLabel,
     path: '',
     icon: 'clipboard-outline'
   });
   ```

3. **Update router events subscription** in ngOnInit:
   Find the router.events subscription and add the serviceInstanceLoaded guard:
   ```typescript
   this.router.events.pipe(
     filter(event => event instanceof NavigationEnd)
   ).subscribe(() => {
     // Only update breadcrumbs after initial load has completed
     if (this.serviceInstanceLoaded) {
       this.updateBreadcrumbs();
     }
   });
   ```
   This prevents breadcrumbs from showing "HUD" briefly before showing "HUD #1".
  </action>
  <verify>
TypeScript compilation passes.
updateBreadcrumbs uses totalHUDServices and serviceInstanceNumber.
Main breadcrumb includes instance number conditionally.
Router subscription has serviceInstanceLoaded guard.
  </verify>
  <done>
When totalHUDServices > 1, titles show "HUD #N" pattern.
When totalHUDServices === 1, titles show plain "HUD/Manufactured Home".
Breadcrumb label includes instance number when multiple services exist.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Rehydration check is positioned correctly in ngOnInit (after instance load, before template download)
3. Rehydration only runs when NOT on web AND online
4. Breadcrumbs show instance number when multiple HUD services exist
5. Router events subscription guards updateBreadcrumbs with serviceInstanceLoaded
</verification>

<success_criteria>
- Mobile mode: Opening a purged HUD service triggers rehydration with loading overlay
- Mobile mode: Rehydration restores HUD records and attachments from server
- Any mode: When project has 2+ HUD services, header shows "HUD #1", "HUD #2"
- Any mode: When project has 1 HUD service, header shows plain "HUD/Manufactured Home"
- Breadcrumbs update correctly after navigation within the service
</success_criteria>

<output>
After completion, create `.planning/phases/01-container-enhancements/01-02-SUMMARY.md`
</output>
