---
phase: 01-container-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/pages/hud/hud-data.service.ts
  - src/app/pages/hud/hud-container/hud-container.page.ts
autonomous: true

must_haves:
  truths:
    - "Purged HUD service data is restored when user opens the service"
    - "User sees instance numbers (HUD #1, HUD #2) when multiple HUD services exist on a project"
    - "HUD container uses TypeID=2 filtering for all HUD table operations"
  artifacts:
    - path: "src/app/pages/hud/hud-data.service.ts"
      provides: "Rehydration methods for HUD services"
      contains: "async needsRehydration"
    - path: "src/app/pages/hud/hud-data.service.ts"
      provides: "Rehydration execution"
      contains: "async rehydrateService"
    - path: "src/app/pages/hud/hud-container/hud-container.page.ts"
      provides: "Service instance tracking"
      contains: "serviceInstanceNumber"
  key_links:
    - from: "hud-data.service.ts"
      to: "ServiceMetadataService"
      via: "getServiceMetadata call in needsRehydration"
      pattern: "serviceMetadata\\.getServiceMetadata"
    - from: "hud-container.page.ts"
      to: "CaspioService"
      via: "constructor injection and getServicesByProject call"
      pattern: "caspioService\\.getServicesByProject"
    - from: "hud-container.page.ts"
      to: "HUD tables (TypeID=2)"
      via: "verifyCachedDataExists and downloadTemplateData use HUD-specific calls"
      pattern: "TypeID.*2|getServicesHUD"
---

<objective>
Add rehydration support to HudDataService and service instance tracking to HUD container.

Purpose: Enable HUD to recover purged service data and display correct instance numbers (HUD #1, #2) when multiple HUD services exist on the same project.

Output: HudDataService with rehydration methods, HUD container with CaspioService injection and instance tracking properties/methods, verified TypeID=2 filtering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-container-enhancements/01-RESEARCH.md
@src/app/pages/hud/hud-data.service.ts
@src/app/pages/hud/hud-container/hud-container.page.ts
@src/app/pages/engineers-foundation/engineers-foundation-data.service.ts
@src/app/pages/engineers-foundation/engineers-foundation-container/engineers-foundation-container.page.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rehydration methods to HudDataService</name>
  <files>src/app/pages/hud/hud-data.service.ts</files>
  <action>
Add two new methods to HudDataService by copying and adapting from EngineersFoundationDataService:

1. **needsRehydration(serviceId: string): Promise<boolean>**
   - Check ServiceMetadataService.getServiceMetadata(serviceId)
   - Return true if metadata.purgeState === 'PURGED' or 'ARCHIVED'
   - Return false if no metadata (new service)

2. **rehydrateService(serviceId: string): Promise<{success, restored, error}>**
   - Return early with error if offline (check offlineService.isOnline())
   - Clear service caches via clearServiceCaches(serviceId)
   - Fetch HUD records from server using HUD-specific API calls:
     - caspioService.getServicesHUDByServiceId(serviceId) - this returns HUD records (TypeID=2 is implicit in the API endpoint)
   - Cache the data via indexedDb methods
   - For each HUD record, fetch attachments: caspioService.getServiceHUDAttachByHUDId(hudId)
   - Update purge state to ACTIVE: serviceMetadata.setPurgeState(serviceId, 'ACTIVE')
   - Return result object with counts

**IMPORTANT: TypeID=2 filtering note**
HUD uses TypeID=2 (EFE uses TypeID=1). The HUD-specific API endpoints (getServicesHUDByServiceId, getServiceHUDAttachByHUDId) are the correct endpoints that return HUD data. The rehydrateService method must use these HUD-specific endpoints, NOT the generic service endpoints.

Add a comment in the rehydrateService method:
```typescript
// HUD services use TypeID=2 - we use HUD-specific API endpoints that filter correctly
```

Note: HUD is simpler than EFE - no rooms/points, just HUD records and their attachments.

Reference the EngineersFoundationDataService.rehydrateService() method (lines ~1926-2070) for the exact pattern, but simplify for HUD's structure:
- HUD only has: LPS_Services_HUD records + LPS_Services_HUD_Attach attachments
- EFE has: visuals + rooms + points + multiple attachment types

Import OfflineService if not already imported for the isOnline() check.
  </action>
  <verify>
TypeScript compilation passes (no red squiggles in IDE).
Methods exist and have correct signatures.
rehydrateService uses HUD-specific API endpoints (getServicesHUDByServiceId, getServiceHUDAttachByHUDId).
  </verify>
  <done>
HudDataService has needsRehydration() that checks purge state from ServiceMetadataService.
HudDataService has rehydrateService() that fetches data from server using HUD-specific endpoints and restores ACTIVE state.
TypeID=2 filtering is documented via comment and correct API endpoint usage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add service instance tracking to HUD container</name>
  <files>src/app/pages/hud/hud-container/hud-container.page.ts</files>
  <action>
Add service instance tracking by copying the pattern from EngineersFoundationContainerPage:

1. **Add imports** (top of file):
   - Add CaspioService: `import { CaspioService } from '../../../services/caspio.service';`
   - Add firstValueFrom to rxjs imports: `import { firstValueFrom } from 'rxjs';`

2. **Add properties** (after isSubPage property, around line 42):
   ```typescript
   // Service instance tracking for multiple HUD services on same project
   serviceInstanceNumber: number = 1;
   totalHUDServices: number = 1;
   private serviceInstanceLoaded: boolean = false;
   ```

3. **Add CaspioService to constructor** (add after pageTitleService):
   ```typescript
   private caspioService: CaspioService
   ```

4. **Add loadServiceInstanceNumber() method** (after updateBreadcrumbs method):
   Copy from EFE container (lines 250-316) and adapt:
   - Change `totalEFEServices` to `totalHUDServices`
   - Keep the same logic: get current service, find TypeID, filter by same TypeID, sort by PK_ID
   - Note: HUD uses TypeID=2 (EFE uses TypeID=1), but the code filters by same TypeID so no hardcoding needed
   - Call updateBreadcrumbs() and changeDetectorRef.detectChanges() after loading

5. **Update ngOnInit to call loadServiceInstanceNumber()** (inside route.params subscription, after initialize):
   Add similar check to EFE:
   ```typescript
   // Load service instance number (for multiple HUD services on same project)
   if (isNewService || isFirstLoad || !this.serviceInstanceLoaded) {
     await this.loadServiceInstanceNumber();
   }
   ```
   Add this BEFORE the existing `if (isNewService || isFirstLoad)` block that handles project name subscription.

Reference: engineers-foundation-container.page.ts lines 121-128 and 250-316.
  </action>
  <verify>
TypeScript compilation passes.
New properties and method exist with correct types.
CaspioService is injected in constructor.
  </verify>
  <done>
HUD container has serviceInstanceNumber, totalHUDServices, and serviceInstanceLoaded properties.
HUD container has loadServiceInstanceNumber() method that queries CaspioService.
CaspioService is properly injected.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify TypeID=2 filtering in existing HUD container code</name>
  <files>src/app/pages/hud/hud-container/hud-container.page.ts</files>
  <action>
Audit the existing hud-container.page.ts to confirm TypeID=2 is correctly used in all HUD table operations. This is a verification/audit task.

**Check the following methods:**

1. **verifyCachedDataExists()** - Confirm it uses HUD-specific Dexie tables:
   - Should query HUD records table, not generic service records
   - Look for: `db.hudRecords` or similar HUD-specific table access

2. **downloadTemplateData()** - Confirm it uses HUD-specific API calls:
   - Should use: caspioService.getServicesHUDByServiceId() or similar
   - NOT: generic getServicesByServiceId() which returns all service types

3. **Any other data fetching methods** - Check for TypeID filtering:
   - If using generic API calls, ensure TypeID=2 filter is applied
   - If using HUD-specific endpoints, confirm they target HUD tables

**Actions to take:**

- If code already uses HUD-specific endpoints/tables: Add a clarifying comment at the top of the class documenting this (after the class declaration):
  ```typescript
  /**
   * HUD Container Page
   *
   * Data Loading Architecture:
   * - Uses Dexie-first pattern: checks cache before API calls
   * - HUD services use TypeID=2 in LPS_Services table
   * - Template loading uses HUD-specific API endpoints (getServicesHUDByServiceId, etc.)
   * - Attachments use getServiceHUDAttachByHUDId endpoint
   */
  ```

- If any generic calls are found without TypeID filtering: Flag for fix and add the filter

**This task is primarily verification. Expected outcome: existing code already uses correct HUD endpoints.**
  </action>
  <verify>
Audit comments are present in the class documentation.
No generic service API calls without TypeID=2 filtering are present.
All HUD data operations use HUD-specific endpoints or filtered generic endpoints.
  </verify>
  <done>
HUD container is verified to use TypeID=2 filtering for all HUD table operations.
Documentation comment added explaining the Dexie-first architecture and TypeID=2 usage.
MAP-02 and MAP-03 requirements confirmed (HUD tables with TypeID=2 filtering).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. HudDataService has needsRehydration() and rehydrateService() methods
3. rehydrateService uses HUD-specific API endpoints (TypeID=2 implicit)
4. HUD container has service instance properties and loadServiceInstanceNumber() method
5. CaspioService is injected in HUD container constructor
6. TypeID=2 filtering is verified and documented in HUD container
</verification>

<success_criteria>
- HudDataService.needsRehydration(serviceId) returns boolean based on purge state
- HudDataService.rehydrateService(serviceId) fetches and restores HUD data from server using HUD-specific endpoints
- HUD container tracks service instance number via loadServiceInstanceNumber()
- Code follows existing patterns from EngineersFoundationDataService and container
- TypeID=2 filtering is verified for all HUD table operations (MAP-02, MAP-03)
- Documentation comment explains Dexie-first architecture and TypeID usage
</success_criteria>

<output>
After completion, create `.planning/phases/01-container-enhancements/01-01-SUMMARY.md`
</output>
