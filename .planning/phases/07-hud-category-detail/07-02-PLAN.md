---
phase: 07-hud-category-detail
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
autonomous: true

must_haves:
  truths:
    - "All record lookups work with HUD table's HUDID field"
    - "Photo attachments associate correctly using HUDID"
    - "Record updates save to correct HUDID in LPS_Services_HUD table"
  artifacts:
    - path: "src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts"
      provides: "HUDID field support"
      contains: "HUDID"
  key_links:
    - from: "hud-category-detail.page.ts"
      to: "LPS_Services_HUD records"
      via: "HUDID || VisualID fallback pattern"
      pattern: "HUDID \\|\\| .*VisualID"
---

<objective>
Add HUDID field fallback to all VisualID references in hud-category-detail.page.ts.

Purpose: HUD tables use `HUDID` as the primary key field, not `VisualID` (which is for EFE tables). The code was copied from EFE and references `VisualID` in ~38 locations. All lookups, updates, and photo associations will fail until each reference includes `HUDID` fallback.

Output: All VisualID references include HUDID fallback for HUD table compatibility
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hud-category-detail/07-RESEARCH.md
@.planning/phases/07-hud-category-detail/07-01-SUMMARY.md

@src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HUDID fallback to all VisualID references</name>
  <files>src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts</files>
  <action>
Find and update ALL occurrences of VisualID references to include HUDID fallback. There are approximately 38 occurrences. The pattern to apply:

**Pattern A: Record ID extraction (most common)**
```typescript
// BEFORE:
visual.VisualID || visual.PK_ID
// or
visual.VisualID || visual.PK_ID || visual.id

// AFTER:
visual.HUDID || visual.VisualID || visual.PK_ID
// or
visual.HUDID || visual.VisualID || visual.PK_ID || visual.id
```

**Pattern B: Direct property access**
```typescript
// BEFORE:
sampleVisual.VisualID
result.VisualID
photo.VisualID

// AFTER:
sampleVisual.HUDID || sampleVisual.VisualID
result.HUDID || result.VisualID
photo.HUDID || photo.VisualID
```

**Pattern C: Object construction (VisualID as key)**
```typescript
// BEFORE:
VisualID: attach.VisualID || visualIdFromRecord || itemId,

// AFTER:
HUDID: attach.HUDID || attach.VisualID || visualIdFromRecord || itemId,
VisualID: attach.HUDID || attach.VisualID || visualIdFromRecord || itemId,
```
Note: For object construction, keep VisualID property name but populate from HUDID fallback. Also add HUDID property for HUD table writes.

**Specific locations to update (from grep results):**

Line ~725: Debug logging
```typescript
HUDID: sampleVisual.HUDID,
VisualID: sampleVisual.VisualID,
```

Line ~778: Item ID assignment
```typescript
id: visual ? (visual.HUDID || visual.VisualID || visual.PK_ID) : templateId,
```

Line ~803: Visual ID extraction
```typescript
const visualId = visual.HUDID || visual.VisualID || visual.PK_ID;
```

Lines ~1887, 2064, 2681, 2765, 2821, 3023, 3173, 3281, 3423, 4618, 4722, 4812, 4937, 5096, 6081, 6097, 6103, 6238, 6242, 6244, 6245, 6246, 6256, 6258, 6533, 6964, 6966, 6976, 7239, 7457, 7461, 7464, 7466, 7473:
Apply Pattern A or B based on context.

**CRITICAL: Do NOT change:**
- Error message strings (e.g., "Invalid VisualID: ...")
- Console log strings (e.g., "VisualID from response...")
- Type definitions or interface properties

Only change the actual property ACCESS patterns.
  </action>
  <verify>
After changes:
1. Count HUDID occurrences - should be >= 30 (new additions)
2. Count VisualID occurrences - should be ~same (still used as fallback)
3. Every VisualID in a fallback chain should have HUDID before it

```bash
grep -c "HUDID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
# Expected: >= 30

grep -E "\.HUDID \|\| .*\.VisualID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts | wc -l
# Expected: >= 25 (most common pattern)
```
  </verify>
  <done>
All VisualID property access patterns include HUDID as first fallback
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify consistent fallback order throughout file</name>
  <files>src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts</files>
  <action>
Review all changes to ensure consistent fallback order. The standard order should be:

```
HUDID || VisualID || PK_ID || id
```

Search for any inversions or inconsistencies:

```bash
# Find any VisualID that comes BEFORE HUDID (wrong order)
grep -n "VisualID.*HUDID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
```

If any are found, fix them to use HUDID first.

Also verify the error handling patterns:
- Error messages can still say "VisualID" for clarity
- But the actual check should use the same fallback pattern

Example:
```typescript
// CORRECT:
const actualVisualId = visual.HUDID || visual.VisualID || visual.PK_ID;
if (!actualVisualId) {
  throw new Error(`Invalid VisualID: ${actualVisualId}`);  // Message string OK
}
```
  </action>
  <verify>
```bash
# No VisualID before HUDID in fallback chains
grep -E "VisualID \|\| HUDID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
# Expected: 0 results

# Consistent pattern used throughout
grep -c "HUDID || .*VisualID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
# Expected: >= 25
```
  </verify>
  <done>
All fallback chains use consistent HUDID || VisualID || PK_ID order
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. HUDID appears many times (new additions):
```bash
grep -c "HUDID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
# Expected: >= 30
```

2. Fallback pattern is consistent:
```bash
grep -E "\.HUDID \|\| .*\.VisualID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts | head -5
# Should see consistent pattern
```

3. No inverted fallback order:
```bash
grep -E "VisualID \|\| HUDID" src/app/pages/hud/hud-category-detail/hud-category-detail.page.ts
# Expected: 0 results
```
</verification>

<success_criteria>
- [ ] All ~38 VisualID references include HUDID as first fallback
- [ ] Fallback order is consistent: HUDID || VisualID || PK_ID || id
- [ ] No inverted fallback patterns (VisualID before HUDID)
- [ ] Error message strings unchanged (for developer clarity)
- [ ] Debug logging includes both HUDID and VisualID for visibility
</success_criteria>

<output>
After completion, create `.planning/phases/07-hud-category-detail/07-02-SUMMARY.md`
</output>
