---
phase: 07-hud-category-detail
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/pages/hud/hud-data.service.ts
  - src/app/services/local-image.service.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "HUD photo uploads use entityType 'hud' not 'visual'"
    - "entityType 'hud' routes to uploadHUDAttachWithS3() in local-image.service.ts"
    - "Photos upload to LPS_Services_HUD_Attach table not LPS_Services_Visuals_Attach"
  artifacts:
    - path: "src/app/pages/hud/hud-data.service.ts"
      provides: "entityType 'hud' for photo uploads"
      contains: "'hud'"
    - path: "src/app/services/local-image.service.ts"
      provides: "HUD entity type routing to uploadHUDAttachWithS3"
      contains: "entityType === 'hud'"
  key_links:
    - from: "hud-data.service.ts captureImage()"
      to: "local-image.service.ts"
      via: "entityType: 'hud'"
      pattern: "entityType.*'hud'"
    - from: "local-image.service.ts"
      to: "caspio.service.ts uploadHUDAttachWithS3()"
      via: "entityType 'hud' case"
      pattern: "uploadHUDAttachWithS3"
---

<objective>
Fix photo upload routing to use entityType 'hud' and upload to LPS_Services_HUD_Attach

Purpose: HUD photo uploads currently use entityType 'visual' which routes to uploadVisualsAttachWithS3() uploading to the wrong table. This breaks photo storage for HUD services.

Output: Photos upload to correct LPS_Services_HUD_Attach table
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-hud-category-detail/07-VERIFICATION.md
@src/app/pages/hud/hud-data.service.ts
@src/app/services/local-image.service.ts
@src/app/services/caspio.service.ts (uploadHUDAttachWithS3 exists at line 2261)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change entityType from 'visual' to 'hud' in hud-data.service.ts</name>
  <files>src/app/pages/hud/hud-data.service.ts</files>
  <action>
In the uploadVisualPhoto() method (around line 874-876):

Change the entityType from 'visual' to 'hud':

Before:
```typescript
const localImage = await this.localImageService.captureImage(
  file,
  'visual',
  visualIdStr,
  effectiveServiceId,
  caption || '',
  drawings || ''
);
```

After:
```typescript
const localImage = await this.localImageService.captureImage(
  file,
  'hud',
  visualIdStr,
  effectiveServiceId,
  caption || '',
  drawings || ''
);
```

Also update the return object to include HUDID property (already done in 07-02, but verify):
- Should have HUDID: visualIdStr in the return object
  </action>
  <verify>
grep -n "'hud'" src/app/pages/hud/hud-data.service.ts
# Should return match for entityType 'hud'

grep -n "'visual'" src/app/pages/hud/hud-data.service.ts | grep -v "Visual"
# Should NOT return entityType 'visual' (may have other 'visual' references in field names)
  </verify>
  <done>
- entityType changed from 'visual' to 'hud' in captureImage() call
- HUD photo uploads will route to HUD attachment handler
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 'hud' case to local-image.service.ts upload routing</name>
  <files>src/app/services/local-image.service.ts</files>
  <action>
In the uploadImageDirectToS3() method (around line 1135), add a case for 'hud' entityType:

Find the if/else chain that routes based on entityType (around lines 1135-1162):

```typescript
if (entityType === 'visual') {
  result = await this.caspioService.uploadVisualsAttachWithS3(...);
} else if (entityType === 'efe_point') {
  result = await this.caspioService.uploadEFEPointsAttachWithS3(...);
} else if (entityType === 'fdf') {
  result = await this.caspioService.uploadEFEPointsAttachWithS3(...);
} else {
  throw new Error(`Unsupported entity type for web upload: ${entityType}`);
}
```

Add a new case for 'hud' BEFORE the else clause:

```typescript
} else if (entityType === 'hud') {
  // Upload HUD attachment to LPS_Services_HUD_Attach
  result = await this.caspioService.createServicesHUDAttachWithFile(
    parseInt(entityId),
    caption,
    file,
    drawings
  ).toPromise();
```

Note: Use createServicesHUDAttachWithFile() which is the Observable wrapper around uploadHUDAttachWithS3() (see caspio.service.ts line 1792).

The signature differs slightly from visual - it takes (hudId, annotation, file, drawings) where annotation maps to caption.
  </action>
  <verify>
grep -n "entityType === 'hud'" src/app/services/local-image.service.ts
# Should return 1 match

grep -n "createServicesHUDAttachWithFile\|uploadHUDAttachWithS3" src/app/services/local-image.service.ts
# Should return reference to HUD upload method
  </verify>
  <done>
- 'hud' case added to entityType routing in uploadImageDirectToS3()
- HUD photos route to createServicesHUDAttachWithFile() which uploads to LPS_Services_HUD_Attach
  </done>
</task>

</tasks>

<verification>
1. grep for entityType 'hud' in both files - should find matches
2. grep for createServicesHUDAttachWithFile in local-image.service.ts - should find call
3. TypeScript compiles without errors
4. Photo upload path: hud-data.service -> local-image.service -> caspio.service -> LPS_Services_HUD_Attach
</verification>

<success_criteria>
- entityType 'hud' used in hud-data.service.ts photo uploads
- local-image.service.ts routes 'hud' to createServicesHUDAttachWithFile()
- Photos will upload to correct LPS_Services_HUD_Attach table
</success_criteria>

<output>
After completion, create `.planning/phases/07-hud-category-detail/07-06-SUMMARY.md`
</output>
